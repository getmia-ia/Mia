{"createdAt":"2025-08-15T17:34:59.837Z","updatedAt":"2025-10-06T18:34:55.216Z","id":"BItAvETwIGVoDqVw","name":"Mia - 1.2 - Atlas - Extratos e Faturas","active":false,"isArchived":false,"nodes":[{"parameters":{"operation":"append","documentId":{"__rl":true,"value":"1C1DFqk6wSPEEwIh8UyA6ell7VQROCaVvWBwfuUSDFNI","mode":"list","cachedResultName":"Gastos de Casa - Lucas e Isabella","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1C1DFqk6wSPEEwIh8UyA6ell7VQROCaVvWBwfuUSDFNI/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":1843257040,"mode":"list","cachedResultName":"atlas_movimentacoes","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1C1DFqk6wSPEEwIh8UyA6ell7VQROCaVvWBwfuUSDFNI/edit#gid=1843257040"},"columns":{"mappingMode":"autoMapInputData","value":{"Data":"={{ $('Separa todas as Movimentações').item.json.data_conta }}","Transação":"={{ $('Separa todas as Movimentações').item.json.descricao }}","Entrada":"={{ $('Separa todas as Movimentações').item.json.entrada }}","Saída":"={{ $('Separa todas as Movimentações').item.json.saida }}","Categoria":"={{ $('Separa todas as Movimentações').item.json.tipo }}","Mês":"={{ \n  [\"Janeiro\", \"Fevereiro\", \"Março\", \"Abril\", \"Maio\", \"Junho\", \"Julho\", \"Agosto\", \"Setembro\", \"Outubro\", \"Novembro\", \"Dezembro\"][\n    ($('Separa todas as Movimentações').item.json.data_conta.includes(\"/\") ? \n      $('Separa todas as Movimentações').item.json.data_conta.split(\"/\")[1] : \n      $('Separa todas as Movimentações').item.json.data_conta.split(\"-\")[1]\n    ) - 1\n  ] \n}}"},"matchingColumns":[],"schema":[{"id":"Data","displayName":"Data","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Mês","displayName":"Mês","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Transação","displayName":"Transação","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Categoria","displayName":"Categoria","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Entrada","displayName":"Entrada","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"Saída","displayName":"Saída","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"id":"89db81a0-3a99-47f2-ab13-f1428dc7f25c","name":"Insere as Movimentações","type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[1344,288],"credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"content":"","height":644,"width":1432},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[352,128],"id":"559774fc-4b3c-4009-aa28-a975653b293c","name":"Sticky Note3"},{"parameters":{},"id":"41049f53-90ba-4f50-9c3a-da8e32e16898","name":"Executa Workflow","type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1,"position":[400,288]},{"parameters":{"assignments":{"assignments":[{"id":"81416485-6e75-43e6-ab2f-6d2d9130f12c","name":"response","value":"=Lançamentos incluidos no controle financeiro!","type":"string"}]},"options":{}},"id":"41dd09a5-2c54-40e2-bba8-fc8761b564e8","name":"Retorna o Resumo","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1568,288]},{"parameters":{"promptType":"define","text":"=Você é um especialista financeiro.\n\nAbaixo está o conteúdo de um extrato bancário ou fatura de cartão de crédito:\n\n{{ $json.text }}\n\nExtraia todas as transações financeiras individuais e devolva **apenas um JSON válido** no formato especificado.\n\nOs dados normalmente vem desorganizados, por isso e importante entender que sempre que tiver data, descricao e valor, provavelmente se trata de um lancamento, seja de um dinheiro entrando ou saindo, e todos os lancamentos devem estar no controle.\n\n⚠️ Regras:\n- Nao deixe nenhum valor de fora, se houver data, descricao e valor precisa ser lancado\n- Ignore totais e saldos.\n- Cada transação vira um objeto JSON dentro de um array.\n- Use datas no formato DD/MM/YYYY.\n- Valores devem usar vírgula como separador decimal (ex.: 27,90).\n- Saída obrigatória: **somente JSON válido** (sem explicações ou comentários).\n- Nao ignore qualquer valor do documento, seja um valor muito baixo, valor negativo, valor positivo, nao importa. Todos os valores devem ser lancados, para termos confianca de que tudo foi lancado no controle.\n\n### Campos obrigatórios por transação:\n- `Data_lancamento` → sempre a data de hoje.\n- `Data_pagamento` → data no documento.\n- `Classificacao` → null.\n- `Descricao` → texto da transação.\n- `Conta` → null.\n- `Pago_por` → null.\n- `Conta2` →  \n   - \"Banco ou instituicao do documento - Extrato\" se for extrato bancário  \n   - \"Banco ou instituicao do documento  - Cartão de Credito\" se for fatura.\n- `Valor` → número decimal em reais com vírgula.\n\n### Exemplo de saída:\n[\n  {\n    \"Data_lancamento\": \"31/08/2025\",\n    \"Data_pagamento\": \"24/07/2025\",\n    \"Classificacao\": null,\n    \"Descricao\": \"OUTBACK MOEMA SAO PAULO\",\n    \"Conta\": null,\n    \"Pago_por\": null,\n    \"Conta2\": \"Bradesco - Cartão de Credito\",\n    \"Valor\": 286,16\n  }\n]\n\n⚠️ Saída obrigatória: \n- Apenas um array JSON válido. \n- Não coloque aspas externas, não coloque markdown (```json). \n- Cada objeto deve ser um item do array. \n- Exemplo de formato esperado:\n\n[\n  {\n    \"Data_lancamento\": \"31/08/2025\",\n    \"Data_pagamento\": \"26/07/2025\",\n    \"Classificacao\": null,\n    \"Descricao\": \"EBN*SPOTIFY CURITIBA\",\n    \"Conta\": null,\n    \"Pago_por\": null,\n    \"Conta2\": \"Itau - Cartão de Credito\",\n    \"Valor\": 27,90\n  }\n]\n","options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[768,288],"id":"99ad2d67-58a3-42c0-bcc9-7cd8db8725c0","name":"AI Agent"},{"parameters":{"model":"anthropic/claude-opus-4","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[768,512],"id":"7b68d88f-6b5c-4090-8568-bf77beff8bd4","name":"OpenRouter Chat Model","credentials":{"openRouterApi":{"id":"o1ywdYlH64cgqSMT","name":"OpenRouter account"}}},{"parameters":{"assignments":{"assignments":[{"id":"cc237621-3089-4b50-a7db-efc4159829ef","name":"text","value":"={{$json[\"extrato-fatura\"]}}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[592,288],"id":"ed8d4552-6328-4b06-bb2c-f0a4d92aa993","name":"Edit Fields"},{"parameters":{"jsCode":"// 1) Lê o que veio do Agent\nlet raw = $json.output || \"\";\n\n// 2) Remove cercas ```json ... ``` e espaços extras\nraw = raw\n  .replace(/^\\s*```(?:json)?\\s*/i, \"\")\n  .replace(/\\s*```$/i, \"\")\n  .trim();\n\n// 3) Se vier texto antes/depois do array, recorta só o trecho [...]\nconst iStart = raw.indexOf(\"[\");\nconst iEnd   = raw.lastIndexOf(\"]\");\nif (iStart !== -1 && iEnd !== -1 && iEnd > iStart) {\n  raw = raw.slice(iStart, iEnd + 1);\n}\n\n// 4) Converte vírgula para ponto **apenas** em \"Valor\", aceitando milhares e negativos\n//    Ex.: 140,39 -> 140.39 | -4.703,19 -> -4703.19 | 39,90 -> 39.90\nraw = raw.replace(\n  /(\"Valor\"\\s*:\\s*)(-?\\d+(?:\\.\\d{3})*,\\d{1,2})/g,\n  (_, p1, num) => p1 + num.replace(/\\./g, \"\").replace(\",\", \".\")\n);\n\n// 5) Faz o parse do JSON\nconst data = JSON.parse(raw);\n\n// 6) Devolve cada transação como um item separado e normaliza se vier string\nreturn data.map(item => {\n  const o = { ...item };\n  if (typeof o.Valor === \"string\") {\n    const n = Number(o.Valor.replace(/\\./g, \"\").replace(\",\", \".\"));\n    if (!Number.isNaN(n)) o.Valor = n;\n  }\n  return { json: o };\n});\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1120,288],"id":"489beeb5-32c7-427d-8d9e-776ee918f0eb","name":"Code"}],"connections":{"Executa Workflow":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"Insere as Movimentações":{"main":[[{"node":"Retorna o Resumo","type":"main","index":0}]]},"AI Agent":{"main":[[{"node":"Code","type":"main","index":0}]]},"OpenRouter Chat Model":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"Edit Fields":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"Code":{"main":[[{"node":"Insere as Movimentações","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"QdC9qh9DPcT2xcoq"},"staticData":{"node:Lê a pasta Extratos a cada 1 minuto":{"lastTimeChecked":"2025-09-01T00:22:22Z"}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"49acda51-859e-4464-846f-3bb07e8aff30","triggerCount":1,"tags":[{"createdAt":"2025-07-20T15:45:29.310Z","updatedAt":"2025-07-20T15:45:29.310Z","id":"wRUSTJ6mfrXjoMjo","name":"formacao-agentes-n8n"},{"createdAt":"2025-08-01T17:49:59.965Z","updatedAt":"2025-08-01T17:49:59.965Z","id":"uASGs3ovnkwqcA4l","name":"ai-agent"},{"createdAt":"2025-08-01T17:50:00.048Z","updatedAt":"2025-08-01T17:50:00.048Z","id":"95IHATghEwTIe2FR","name":"open-ai"},{"createdAt":"2025-08-01T17:57:59.772Z","updatedAt":"2025-08-01T17:57:59.772Z","id":"DSDfqcFyPwY1Vy7F","name":"google-sheets"},{"createdAt":"2025-08-15T17:34:00.496Z","updatedAt":"2025-08-15T17:34:00.496Z","id":"EDmxLCNqtgvn9jdw","name":"finthrix"},{"createdAt":"2025-08-15T17:34:53.452Z","updatedAt":"2025-08-15T17:34:53.452Z","id":"Y1g65Dys0Cbd8w57","name":"google-drive"},{"createdAt":"2025-08-15T17:34:53.453Z","updatedAt":"2025-08-15T17:34:53.453Z","id":"RLVt0l5zq4OU4jVp","name":"mistral-ai"}]}