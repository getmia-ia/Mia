{"createdAt":"2025-10-02T23:42:34.659Z","updatedAt":"2025-10-29T22:12:59.171Z","id":"C6gdti1wpV5b81rL","name":"ZP - 1.5 - Disparar Not√≠cias (Seg, qua, sex)","active":true,"isArchived":false,"nodes":[{"parameters":{"promptType":"define","text":"={{ $json.prompt }}","options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[1104,1152],"id":"2a0fb8b3-fc2b-43eb-a0f1-024aadd3c154","name":"AI Agent1","executeOnce":true,"onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"dcdb56d1-ac07-4175-b2b8-aec30dec60c5","leftValue":"={{$json.titulo}}","rightValue":"undefined","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[448,1168],"id":"a2039c46-5588-42d3-8447-5cb8451f0705","name":"Verifica se h√° not√≠cia"},{"parameters":{"jsCode":"// Monta o prompt para a IA\n\nconst item = $input.item.json;\n\n// Garante que temos dados para trabalhar\nif (!item || !item.titulo) {\n  return [{ json: { prompt: \"Nenhuma not√≠cia v√°lida encontrada para hoje.\" } }];\n}\n\n// Limita o tamanho da legenda para seguran√ßa\nconst MAX_LEGEND_LENGTH = 800;\nconst cut = (s) => (s || '').toString().trim().slice(0, MAX_LEGEND_LENGTH);\n\nconst titulo = (item.titulo || '').toString().trim();\nconst legenda = cut(item.legenda);\n\n// Cabe√ßalhos\nconst header = `*Bom dia comunidade Radar Corretor!* üì∞\\n\\nConfira o destaque dos √∫ltimos dias:\\n\\n`;\nconst instagramLink = `Acompanhe mais conte√∫dos em nossa p√°gina:\\nhttps://www.instagram.com/radarcorretor`;\n\nconst prompt = `\nVoc√™ √© o editor do briefing matinal da comunidade Radar Corretor no WhatsApp.\nSua tarefa √© reescrever a not√≠cia abaixo em um formato conciso, did√°tico e visual para corretores de im√≥veis.\n\nNOT√çCIA ORIGINAL (use como base):\nT√≠tulo: ${titulo}\nLegenda: ${legenda}\n\nFORMATO EXATO DA SA√çDA (mantenha a estrutura):\n${header}*${titulo}*\n\n[REESCREVA AQUI A LEGENDA em 2 ou 3 par√°grafos curtos, usando uma linguagem direta e objetiva. Explique o ponto principal da not√≠cia.]\n\n*Por que isso importa para o corretor?*\n- (emoji) [Escreva aqui um bullet point pr√°tico e acion√°vel derivado da not√≠cia]\n- (emoji) [Se aplic√°vel, adicione um segundo bullet point com outra dica ou insight]\n\n[INSIRA AQUI uma √öNICA linha com uma frase motivacional de vendas em it√°lico com autor, formato exato: _\"frase\" ‚Äî Autor_]\n\n${instagramLink}\n\nREGRAS OBRIGAT√ìRIAS:\n- Use negrito (*texto*) para o t√≠tulo e para a se√ß√£o \"Por que isso importa...\".\n- Use it√°lico (_texto_) para a cita√ß√£o motivacional.\n- Use emojis para tornar a leitura mais agrad√°vel.\n- Seja direto e n√£o ultrapasse 1524 caracteres no total.\n- N√£o invente informa√ß√µes que n√£o est√£o na not√≠cia original.\n`.trim();\n\nreturn [{ json: { prompt } }];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[864,1152],"id":"a5763301-3b22-4d81-80dc-151686e93ab0","name":"Monta o prompt para o agente3"},{"parameters":{"jsCode":"// n8n Code Node: Apenas ordena e seleciona a mais recente das N√ÉO ENVIADAS\n\n// Pega a lista de not√≠cias J√Å FILTRADAS (apenas as n√£o enviadas)\nconst items = $input.all();\n\nconst parseBR = (s) => {\n  if (!s) return null;\n  const parts = s.split(/[\\/\\s:]+/);\n  if (parts.length < 3) return null;\n  const [dd, mm, yyyy] = parts;\n  return new Date(`${yyyy}-${mm}-${dd}T00:00:00.000Z`);\n};\n\n// Se n√£o houver nenhuma not√≠cia nova para enviar, para o fluxo.\nif (items.length === 0) {\n  return [];\n}\n\n// Ordena a pequena lista de not√≠cias n√£o enviadas\nconst sortedItems = items.sort((a, b) => {\n    const dateA = parseBR(a.json.data_processamento);\n    const dateB = parseBR(b.json.data_processamento);\n    \n    const dateComparison = dateB - dateA;\n    if (dateComparison !== 0) return dateComparison;\n    return b.json.row_number - a.json.row_number;\n  });\n\n// Pega a mais recente da lista e continua o fluxo\nreturn [{ json: sortedItems[0].json }];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[128,1168],"id":"6fb5d20c-3f76-4b4a-8fd9-273e0ecd2700","name":"Encontra a Pr√≥xima Not√≠cia V√°lida"},{"parameters":{"documentId":{"__rl":true,"value":"1Ze1MFqVlu21qakfTTE5ECfAu4iFOoeQMygOCjPW5nek","mode":"list","cachedResultName":"Controle Radar do Corretor","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Ze1MFqVlu21qakfTTE5ECfAu4iFOoeQMygOCjPW5nek/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Ze1MFqVlu21qakfTTE5ECfAu4iFOoeQMygOCjPW5nek/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"status","lookupValue":"postado"},{"lookupColumn":"status_envio_whatsapp","lookupValue":"="}]},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[-160,1168],"id":"445f008d-c262-465a-a0ad-7d0bdb59c3cb","name":"Pega TODAS as not√≠cias","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"operation":"update","documentId":{"__rl":true,"value":"1Ze1MFqVlu21qakfTTE5ECfAu4iFOoeQMygOCjPW5nek","mode":"list","cachedResultName":"Controle Radar Corretor","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Ze1MFqVlu21qakfTTE5ECfAu4iFOoeQMygOCjPW5nek/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Ze1MFqVlu21qakfTTE5ECfAu4iFOoeQMygOCjPW5nek/edit#gid=0"},"columns":{"mappingMode":"defineBelow","value":{"noticia_id":"={{ $('Encontra a Pr√≥xima Not√≠cia V√°lida').item.json.noticia_id }}","status_envio_whatsapp":"enviado"},"matchingColumns":["noticia_id"],"schema":[{"id":"noticia_id","displayName":"noticia_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"data_processamento","displayName":"data_processamento","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"titulo","displayName":"titulo","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"legenda","displayName":"legenda","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"fonte","displayName":"fonte","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"imagem","displayName":"imagem","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"arquivo_base64","displayName":"arquivo_base64","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"imagem_url","displayName":"imagem_url","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"imagem_url2","displayName":"imagem_url2","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"status","displayName":"status","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"nota","displayName":"nota","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"justificativa","displayName":"justificativa","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"output","displayName":"output","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"last_4_days","displayName":"last_4_days","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"status_envio_whatsapp","displayName":"status_envio_whatsapp","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"row_number","displayName":"row_number","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"readOnly":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[2592,1168],"id":"1bbb2ded-98a2-443d-b25d-da9fb985e8d6","name":"Registra envio na comunidade","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[656,1280],"id":"95655088-01e0-45f3-8059-d3ae4e622446","name":"No Operation, do nothing1"},{"parameters":{"rule":{"interval":[{"field":"weeks","triggerAtDay":[1,3,5],"triggerAtHour":8}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-448,1168],"id":"d2e71710-adf4-40d6-93b9-4a4920e42ee2","name":"Schedule Trigger"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[1104,1376],"id":"b159c172-ec0c-4cc5-ae4e-660b93149b80","name":"OpenRouter Chat Model","credentials":{"openRouterApi":{"id":"o1ywdYlH64cgqSMT","name":"OpenRouter account"}}},{"parameters":{"content":"## WORKFLOW: Not√≠cia do Dia para Comunidade WhatsApp\n### OBJETIVO: Enviar a not√≠cia mais recente para a comunidade.\n### GATILHO: Executa toda Segunda, Quarta e Sexta-feira √†s 08:00.\n### L√ìGICA:\n1.  **Leitura Inteligente:** O fluxo inicia e faz uma consulta na planilha Google Sheets (aba 'base'), filtrando apenas as not√≠cias com `status = 'postado'` E cuja coluna `status_envio_whatsapp` esteja VAZIA.\n2.  **Ordena√ß√£o:** A lista de not√≠cias \"n√£o enviadas\" √© ordenada da mais recente para a mais antiga, usando a `data_processamento` como crit√©rio principal e o n√∫mero da linha (`row_number`) como crit√©rio de desempate.\n3.  **Sele√ß√£o:** O c√≥digo seleciona apenas a primeira not√≠cia da lista ordenada (a mais nova e relevante que nunca foi enviada).\n4.  **Valida√ß√£o:** Se nenhuma not√≠cia for encontrada (a lista estiver vazia), o fluxo √© interrompido.\n5.  **Envio:** Caso uma not√≠cia seja selecionada, o fluxo formata a mensagem com a IA, baixa a imagem correspondente e envia para a comunidade no WhatsApp.\n6.  **Atualiza√ß√£o de Status:** Ap√≥s o envio bem-sucedido, o fluxo **atualiza a planilha 'base'**, preenchendo a coluna `status_envio_whatsapp` com o texto \"enviado\" para a not√≠cia que acabou de ser postada, garantindo que ela n√£o seja reenviada no futuro.","height":672,"width":3392,"color":3},"type":"n8n-nodes-base.stickyNote","position":[-544,864],"typeVersion":1,"id":"0512f0e3-f4ab-4d4f-9132-cbfd12aabad2","name":"Sticky Note"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[2016,1152],"id":"fe401eda-7f43-4fbc-9a25-6a09973fe14b","name":"Loop Over Items1"},{"parameters":{"resource":"messages-api","operation":"send-image","instanceName":"social-media-radarcorretor","remoteJid":"120363418028617728@g.us","media":"={{ $json.base64Image }}","caption":"={{ $item(0).$node[\"AI Agent1\"].json.output }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[2288,1168],"id":"b589bf2b-39bb-4349-8f58-f7eb335a3bbb","name":"Envio do post - Whatsapp1","credentials":{"evolutionApi":{"id":"vDN1jxL85cL5Mz2G","name":"Evolution - Radar Corretor"}},"onError":"continueRegularOutput"},{"parameters":{"url":"={{\n  $('Encontra a Pr√≥xima Not√≠cia V√°lida').item.json.imagem_url\n    .replace(\n      /^https:\\/\\/raw\\.githubusercontent\\.com\\/([^/]+)\\/([^/]+)\\/([^/]+)\\/(.*)$/,\n      'https://cdn.jsdelivr.net/gh/$1/$2/$4'\n    )\n}}\n","authentication":"predefinedCredentialType","nodeCredentialType":"githubOAuth2Api","options":{"response":{"response":{"responseFormat":"file"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1488,1152],"id":"ffe24df4-0341-4c03-ba69-a7a71cf2b424","name":"Baixa a img do github1","retryOnFail":true,"waitBetweenTries":5000,"credentials":{"githubApi":{"id":"Gd4bGzglU6thixeI","name":"GitHub account"},"githubOAuth2Api":{"id":"hR55JFsx4bIpxagL","name":"GitHub - Organiza√ß√£o MIA"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// n8n Code node ‚Äì pega o base64 do arquivo baixado no \"Download file\"\n\nconst binAll = $input.item.binary || {};\n\n// tenta 'imagem_final', depois 'data', depois a 1¬™ chave dispon√≠vel\nconst key =\n  binAll.imagem_final ? 'imagem_final' :\n  (binAll.data ? 'data' : Object.keys(binAll)[0]);\n\nif (!key) throw new Error('Nenhum bin√°rio encontrado no item.');\n\nconst bin = binAll[key];\nif (!bin?.data) throw new Error(`Bin√°rio na chave \"${key}\" n√£o possui .data.`);\n\n// j√° vem em base64; n√£o reconverta\nconst base64 = bin.data;\n\nreturn {\n  json: {\n    base64Image: base64,                          // use isto no Evolution (media)\n    mimeType: bin.mimeType || 'application/octet-stream',\n    fileName: bin.fileName || 'arquivo'\n  }\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1712,1152],"id":"e5e3ab6b-9647-4f41-bcfd-9793fa8d4f9c","name":"Converte a img para base"}],"connections":{"AI Agent1":{"main":[[{"node":"Baixa a img do github1","type":"main","index":0}]]},"Verifica se h√° not√≠cia":{"main":[[{"node":"Monta o prompt para o agente3","type":"main","index":0}],[{"node":"No Operation, do nothing1","type":"main","index":0}]]},"Monta o prompt para o agente3":{"main":[[{"node":"AI Agent1","type":"main","index":0}]]},"Encontra a Pr√≥xima Not√≠cia V√°lida":{"main":[[{"node":"Verifica se h√° not√≠cia","type":"main","index":0}]]},"Pega TODAS as not√≠cias":{"main":[[{"node":"Encontra a Pr√≥xima Not√≠cia V√°lida","type":"main","index":0}]]},"Schedule Trigger":{"main":[[{"node":"Pega TODAS as not√≠cias","type":"main","index":0}]]},"OpenRouter Chat Model":{"ai_languageModel":[[{"node":"AI Agent1","type":"ai_languageModel","index":0}]]},"Loop Over Items1":{"main":[[],[{"node":"Envio do post - Whatsapp1","type":"main","index":0}]]},"Envio do post - Whatsapp1":{"main":[[{"node":"Loop Over Items1","type":"main","index":0},{"node":"Registra envio na comunidade","type":"main","index":0}]]},"Baixa a img do github1":{"main":[[{"node":"Converte a img para base","type":"main","index":0}]]},"Converte a img para base":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","executionTimeout":-1,"errorWorkflow":"UldWpZHcKTrRMFpI"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]},"node:Google Sheets Trigger":{"documentId":"1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0","sheetId":0,"lastRevision":271,"lastRevisionLink":"https://docs.google.com/spreadsheets/export?id=1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0&revision=271&exportFormat=xlsx"},"node:Schedule Trigger1":{"recurrenceRules":[]},"node:Trigger nova noticia no sheets":{"documentId":"1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0","sheetId":0,"lastRevision":271,"lastRevisionLink":"https://docs.google.com/spreadsheets/export?id=1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0&revision=271&exportFormat=xlsx"}},"meta":{"templateCredsSetupCompleted":true},"pinData":{"Schedule Trigger":[{"json":{"timestamp":"2025-10-01T17:47:44.002-03:00","Readable date":"October 1st 2025, 5:47:44 pm","Readable time":"5:47:44 pm","Day of week":"Wednesday","Year":"2025","Month":"October","Day of month":"01","Hour":"17","Minute":"47","Second":"44","Timezone":"America/Sao_Paulo (UTC-03:00)"}}]},"versionId":"ca06f83d-40e7-43c2-b42e-a8eb681248bf","triggerCount":1,"tags":[]}