{"createdAt":"2025-10-20T18:55:46.059Z","updatedAt":"2025-10-24T12:41:13.333Z","id":"HJmh6E2HXm8b4Yue","name":"BMS - 6.2 - Consulta Folha","active":false,"isArchived":false,"nodes":[{"parameters":{"inputSource":"jsonExample","jsonExample":"{\n\"pergunta\": \"quanto foi gasto com horas extras em março de 2024\"\n}"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-96,-736],"id":"e33cb870-3ce6-4f60-8161-f95b677655d6","name":"trigger"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[1584,-480],"id":"7ac2a397-9206-40c6-914b-946c37cf0f5b","name":"OpenRouter Chat Model","credentials":{"openRouterApi":{"id":"o1ywdYlH64cgqSMT","name":"OpenRouter account"}}},{"parameters":{"promptType":"define","text":"=### Dia Atual: {{ $now.weekdayLong }},{{ $now.format('dd/MM/yyyy') }},{{ $now.hour.toString().padStart(2, '0') }}:{{ $now.minute.toString().padStart(2, '0')}}\n\nVocê é um interpretador de perguntas sobre folha de pagamento e colaboradores.\n\nSua função é transformar a pergunta do usuário em um JSON com filtros objetivos para montar uma query SQL.\n\nUse os dados de contexto disponíveis em {{ $json.parametros_folha }}, que contêm:\n- rubricas: lista de rubricas e suas categorias macro (campo tipo_custo)\n- empresas: lista de empresas disponíveis\n- áreas, departamentos, centro_de_custo e cargos: estrutura organizacional completa\n\nAnalise a pergunta em {{ $json.pergunta }} e devolva apenas um JSON com os filtros detectados, sem texto adicional.\n\nCampos esperados:\n- mes_inicio (AAAA-MM)\n- mes_fim (AAAA-MM)\n- tipo_custo (ex: Salário, Benefícios, Horas Extras e Adicionais, Encargos, etc.)\n- area\n- departamento\n- centro_de_custo\n- cargo\n- empresa\n- metrica (ex: total_gasto, ranking, media, comparativo)\n- periodo_comparativo (opcional)\n\nRegras:\n- Se o usuário não especificar meses, defina o range como os **últimos 3 meses até o atual**.\n- Se disser “mês passado”, use o mês anterior e os dois anteriores a ele.\n- Se pedir um mês específico, puxe também os dois anteriores.\n- Se disser “ano inteiro”, use o range completo informado.\n- Se a pergunta for genérica (“quanto gastei com pessoas”), use tipo_custo = “todas”.\n- Se não houver filtros de área, departamento, cargo ou empresa, retorne null nesses campos.\n- Sempre responda apenas o JSON, sem explicações.\n\nExemplo de saída:\n{\n  \"mes_inicio\": \"2024-10\",\n  \"mes_fim\": \"2024-12\",\n  \"tipo_custo\": \"Benefícios\",\n  \"area\": \"Financeiro\",\n  \"departamento\": null,\n  \"centro_de_custo\": null,\n  \"cargo\": null,\n  \"empresa\": null,\n  \"metrica\": \"total_gasto\",\n  \"periodo_comparativo\": 3\n}\n","options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[1584,-704],"id":"6140b614-29eb-4f22-8302-bc29c416569b","name":"Interpretar pergunta"},{"parameters":{"operation":"executeQuery","query":"{{$json.query}}"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[2192,-704],"id":"851b7a14-2f0d-433a-b985-1ed4ecf31654","name":"Executar Query","alwaysOutputData":true,"credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"jsCode":"// === INPUTS ===\nconst filtros = $json;\nconst rubricas = $json.parametros_folha?.rubricas || [];\n\n// === LÓGICA DE PERÍODO ===\n// Se usuário pediu um mês específico, usamos +/- 2 meses (total 3 meses)\n// Exemplo: perguntou “2025-09” → puxa “2025-07” a “2025-09”\nconst now = new Date();\nlet mesInicio, mesFim;\n\nif (filtros.mes) {\n  const [ano, mes] = filtros.mes.split('-').map(Number);\n  const dataRef = new Date(ano, mes - 1, 1);\n  const inicio = new Date(dataRef);\n  inicio.setMonth(inicio.getMonth() - 2);\n  const fim = new Date(dataRef);\n  mesInicio = `${inicio.getFullYear()}-${String(inicio.getMonth() + 1).padStart(2, '0')}`;\n  mesFim = `${fim.getFullYear()}-${String(fim.getMonth() + 1).padStart(2, '0')}`;\n} else {\n  // Se não foi informado mês → usa os 3 últimos meses\n  const fim = new Date(now);\n  const inicio = new Date(now);\n  inicio.setMonth(inicio.getMonth() - 2);\n  mesInicio = `${inicio.getFullYear()}-${String(inicio.getMonth() + 1).padStart(2, '0')}`;\n  mesFim = `${fim.getFullYear()}-${String(fim.getMonth() + 1).padStart(2, '0')}`;\n}\n\n// === BASE DA QUERY ===\nlet query = `\nSELECT TOP 1000\n  REPLACE(REPLACE(REPLACE(c.[CPF], '.', ''), '-', ''), ' ', '') AS CPF_Limpo,\n  c.[Nome], c.[Cargo], c.[Departamento], c.[Centro_de_Custo],\n  c.[Salário], c.[Vale_Refeição], c.[Nome_da_Empresa], c.[Área],\n  r.[Código_Rubrica], r.[Descrição_Rubrica], r.[Descrição_Natureza_Rubrica],\n  r.[Valor], r.[Mes_ref_folha]\nFROM [RhTech_fake_Colaboradores] c\nLEFT JOIN [RhTech_fake_Rubricas] r\n  ON REPLACE(REPLACE(REPLACE(c.[CPF], '.', ''), '-', ''), ' ', '') = \n     REPLACE(REPLACE(REPLACE(r.[CPF], '.', ''), '-', ''), ' ', '')\nWHERE 1=1\n`;\n\n// === FILTROS DINÂMICOS ===\nif (filtros.tipo_custo && filtros.tipo_custo !== 'todas') {\n  const descricoes = rubricas\n    .filter(r => r.tipo_custo === filtros.tipo_custo)\n    .map(r => `'${r.Descrição_Natureza_Rubrica.replace(/'/g, \"''\")}'`);\n  if (descricoes.length) {\n    query += ` AND r.[Descrição_Natureza_Rubrica] IN (${descricoes.join(',')})`;\n  }\n}\n\nif (filtros.area) query += ` AND c.[Área] = '${filtros.area.replace(/'/g, \"''\")}'`;\nif (filtros.departamento) query += ` AND c.[Departamento] = '${filtros.departamento.replace(/'/g, \"''\")}'`;\nif (filtros.cargo) query += ` AND c.[Cargo] = '${filtros.cargo.replace(/'/g, \"''\")}'`;\nif (filtros.centro_de_custo) query += ` AND c.[Centro_de_Custo] = '${filtros.centro_de_custo.replace(/'/g, \"''\")}'`;\nif (filtros.empresa) query += ` AND c.[Nome_da_Empresa] = '${filtros.empresa.replace(/'/g, \"''\")}'`;\n\n// === FILTRO TEMPORAL ===\nquery += ` AND r.[Mes_ref_folha] BETWEEN '${mesInicio}' AND '${mesFim}'`;\n\n// === FINAL ===\nquery += ` ORDER BY c.[Nome], r.[Mes_ref_folha];`;\n\nreturn [{ json: { query } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1968,-704],"id":"9a62cafe-7ea8-44cd-8639-da532a293f9a","name":"Criar Query"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[2416,-480],"id":"8f321671-8d20-47df-a15e-130f79cac433","name":"OpenRouter Chat Model1","credentials":{"openRouterApi":{"id":"o1ywdYlH64cgqSMT","name":"OpenRouter account"}}},{"parameters":{"promptType":"define","text":"=Você é a Mindy, diretora de RH virtual. \nRecebeu o resultado de uma consulta SQL com dados reais da folha e deve explicar de forma clara, curta (máx. 400 caracteres) e em tom profissional.\n\nRegras:\n- Sempre mencione o mês e, se houver, o departamento.\n- Para métricas numéricas, arredonde valores e formate em reais (R$ 1.234,00).\n- Se houver mais de 1 linha, resuma com o total e os 3 primeiros destaques (ranking).\n- Não repita o SQL, nem explique o processo técnico.\n- Se não houver resultado, diga: “Não encontrei registros para esse filtro.”\n\nExemplo:\nEntrada:\n[\n  {\"Departamento\": \"Operações\", \"Valor\": 42000},\n  {\"Departamento\": \"Vendas\", \"Valor\": 27000}\n]\n\nSaída:\n\"Em setembro/2025, o maior gasto foi em Operações (R$ 42 mil), seguido por Vendas (R$ 27 mil).\"\n","options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[2416,-704],"id":"0848e062-dfca-4083-beed-246caae858a6","name":"Analisar e Gerar Resposta"},{"parameters":{"assignments":{"assignments":[{"id":"4545f892-fbda-4554-bcdf-29a5962450b1","name":"pergunta","value":"Quanto gastamos de horas extras esse mes?","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-96,-912],"id":"a6a4abe3-9d76-48b9-b2af-39ddee8293d0","name":"Edit Fields"},{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-368,-912],"id":"c34e27ac-b7db-4f90-9d5b-d5f060cdc07c","name":"When clicking ‘Execute workflow’"},{"parameters":{"operation":"executeQuery","query":"SELECT DISTINCT\n  [Código_Rubrica],\n  [Descrição_Rubrica],\n  [Descrição_Natureza_Rubrica]\nFROM [RhTech_fake_Rubricas]\nORDER BY\n  [Código_Rubrica],\n  [Descrição_Rubrica],\n  [Descrição_Natureza_Rubrica];\n"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[2032,-1104],"id":"7d35369c-391b-453d-b43c-677e7a02d8a5","name":"Executar Query1","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"operation":"executeQuery","query":"SELECT DISTINCT\n    --[Cargo]\n    --[Departamento]\n    --[Centro_de_Custo]\n    --[Área]\n    [Nome_da_Empresa]\nFROM [RhTech_fake_Colaboradores]\n"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[2224,-1104],"id":"4cafd7a0-4bd2-4d4f-ac82-606241c5d1c9","name":"Executar Query2","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"documentId":{"__rl":true,"value":"1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0","mode":"list","cachedResultName":"depara_rubricas_folha_pagamento","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"rubricas","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit#gid=0"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[704,-1168],"id":"9a141b17-987f-4744-beca-8c36092dd5c4","name":"rubricas","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"documentId":{"__rl":true,"value":"1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0","mode":"list","cachedResultName":"depara_rubricas_folha_pagamento","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":1086466239,"mode":"list","cachedResultName":"empresas","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit#gid=1086466239"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[704,-992],"id":"56fe9830-f183-4a3e-b61b-5096b21be991","name":"empresas","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"documentId":{"__rl":true,"value":"1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0","mode":"list","cachedResultName":"depara_rubricas_folha_pagamento","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":346942308,"mode":"list","cachedResultName":"areas","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit#gid=346942308"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[704,-816],"id":"47359f26-64c6-433c-9163-05d5be7ba5f7","name":"areas","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"documentId":{"__rl":true,"value":"1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0","mode":"list","cachedResultName":"depara_rubricas_folha_pagamento","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":761659075,"mode":"list","cachedResultName":"departamentos","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit#gid=761659075"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[704,-640],"id":"c4884671-5dd9-4ce7-93ca-c0c4bd780a87","name":"departamentos","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"documentId":{"__rl":true,"value":"1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0","mode":"list","cachedResultName":"depara_rubricas_folha_pagamento","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":1934165408,"mode":"list","cachedResultName":"centro_de_custo","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit#gid=1934165408"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[704,-464],"id":"de4972a1-836e-44ca-97f4-62f48c7a72ea","name":"centro_de_custo","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"documentId":{"__rl":true,"value":"1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0","mode":"list","cachedResultName":"depara_rubricas_folha_pagamento","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":1112723933,"mode":"list","cachedResultName":"cargos","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit#gid=1112723933"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[704,-304],"id":"306cd80a-30c9-40c3-aa21-e145962ed3d7","name":"cargos","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"numberInputs":6},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[1152,-768],"id":"ce4546fa-0b2a-46fd-9a88-ee51b5cbb72f","name":"Merge"},{"parameters":{"jsCode":"// --- Captura dados das planilhas (vindos dos nodes anteriores)\nconst parametros_folha = {\n  rubricas: $('rubricas').all().map(item => item.json),\n  empresas: $('empresas').all().map(item => item.json),\n  areas: $('areas').all().map(item => item.json),\n  departamentos: $('departamentos').all().map(item => item.json),\n  centro_de_custo: $('centro_de_custo').all().map(item => item.json),\n  cargos: $('cargos').all().map(item => item.json)\n};\n\n// --- Captura a pergunta (de Edit Fields ou Trigger)\nlet pergunta = null;\n\ntry {\n  pergunta =\n    $('Edit Fields').first().json.pergunta ||\n    $('trigger').first().json.pergunta ||\n    null;\n} catch (e) {\n  pergunta = null;\n}\n\n// --- Retorna JSON consolidado\nreturn [\n  {\n    json: {\n      pergunta,\n      parametros_folha\n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1360,-704],"id":"c9a01fd1-1626-4a7f-843e-d041e1c8dc58","name":"Code"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[176,-736],"id":"cc3bd75e-c002-4437-b9f2-7f5ec4185a20","name":"No Operation, do nothing"}],"connections":{"trigger":{"main":[[]]},"OpenRouter Chat Model":{"ai_languageModel":[[{"node":"Interpretar pergunta","type":"ai_languageModel","index":0}]]},"Interpretar pergunta":{"main":[[{"node":"Criar Query","type":"main","index":0}]]},"Executar Query":{"main":[[{"node":"Analisar e Gerar Resposta","type":"main","index":0}]]},"Criar Query":{"main":[[{"node":"Executar Query","type":"main","index":0}]]},"OpenRouter Chat Model1":{"ai_languageModel":[[{"node":"Analisar e Gerar Resposta","type":"ai_languageModel","index":0}]]},"When clicking ‘Execute workflow’":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"No Operation, do nothing","type":"main","index":0}]]},"Executar Query1":{"main":[[]]},"rubricas":{"main":[[{"node":"Merge","type":"main","index":0}]]},"empresas":{"main":[[{"node":"Merge","type":"main","index":1}]]},"areas":{"main":[[{"node":"Merge","type":"main","index":2}]]},"departamentos":{"main":[[{"node":"Merge","type":"main","index":3}]]},"centro_de_custo":{"main":[[{"node":"Merge","type":"main","index":4}]]},"cargos":{"main":[[{"node":"Merge","type":"main","index":5}]]},"Merge":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Interpretar pergunta","type":"main","index":0}]]},"No Operation, do nothing":{"main":[[{"node":"rubricas","type":"main","index":0},{"node":"empresas","type":"main","index":0},{"node":"areas","type":"main","index":0},{"node":"departamentos","type":"main","index":0},{"node":"centro_de_custo","type":"main","index":0},{"node":"cargos","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"415ef63d-7dbc-4b7b-a997-cd36b75e6ff4","triggerCount":0,"tags":[]}