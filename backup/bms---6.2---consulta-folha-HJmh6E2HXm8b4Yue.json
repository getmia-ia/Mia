{"createdAt":"2025-10-20T18:55:46.059Z","updatedAt":"2025-11-14T22:15:36.258Z","id":"HJmh6E2HXm8b4Yue","name":"BMS - 6.2 - Consulta Folha","active":false,"isArchived":false,"nodes":[{"parameters":{"inputSource":"jsonExample","jsonExample":"{\n\"pergunta\": \"quanto foi gasto com horas extras em mar√ßo de 2024\"\n}"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-112,-736],"id":"e33cb870-3ce6-4f60-8161-f95b677655d6","name":"trigger"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[1584,-480],"id":"7ac2a397-9206-40c6-914b-946c37cf0f5b","name":"OpenRouter Chat Model","credentials":{"openRouterApi":{"id":"o1ywdYlH64cgqSMT","name":"OpenRouter account"}}},{"parameters":{"promptType":"define","text":"=### Dia Atual: {{ $now.weekdayLong }},{{ $now.format('dd/MM/yyyy') }},{{ $now.hour.toString().padStart(2, '0') }}:{{ $now.minute.toString().padStart(2, '0')}}\n\nVoc√™ √© um interpretador de perguntas sobre folha de pagamento e colaboradores.\n\nSua fun√ß√£o √© transformar a pergunta do usu√°rio em um JSON com filtros objetivos para montar uma query SQL.\n\nUse os dados de contexto dispon√≠veis abaixo:\n\n**Rubricas dispon√≠veis:** {{ [...new Set($json.parametros_folha.rubricas.map(r => r.tipo_custo))].join('; ') }}\n\nas rubricas est√£o separadas por ; e n√£o por , ent√£o \"Comiss√µes, Gratifica√ß√µes e Premia√ß√µes\" √© uma r√∫brica s√≥\n\n**Empresas dispon√≠veis:** {{ $json.parametros_folha.empresas.map(e => e.Nome_da_Empresa).join('; ') }}\n\n**√Åreas dispon√≠veis:** {{ $json.parametros_folha.areas.map(a => a.√Årea).join('; ') }}\n\n**Departamentos dispon√≠veis:** {{ $json.parametros_folha.departamentos.map(d => d.departamentos).join('; ') }}\n\n**Centro de Custo dispon√≠veis:** {{ $json.parametros_folha.centro_de_custo.map(f => f.Centro_de_Custo).join('; ') }}\n\n**Cargos dispon√≠veis:** {{ $json.parametros_folha.cargos.map(c => c.cargos).join('; ') }}\n\nQue cont√™m:\n- rubricas: lista de rubricas e suas categorias macro (campo tipo_custo)\n- empresas: lista de empresas dispon√≠veis\n- √°reas, departamentos, centro_de_custo e cargos: estrutura organizacional completa\n\nAnalise a pergunta em {{ $json.pergunta }} e devolva apenas um JSON com os filtros detectados, sem texto adicional.\n\nCampos esperados:\n- mes_inicio (MM/AAAA)\n- mes_fim (MM/AAAA)\n- tipo_custo (ex: Sal√°rio, Benef√≠cios, Horas Extras e Adicionais, Encargos, etc.)\n- area\n- departamento\n- centro_de_custo\n- cargo\n- empresa\n- metrica (ex: total_gasto, ranking, media, comparativo)\n- periodo_comparativo (opcional)\n- colaborador (nome ou parte do nome ou cpf)\n\nRegras:\n- Se o usu√°rio n√£o especificar meses, defina o range como os **√∫ltimos 3 meses at√© o atual**.\n- Se disser ‚Äúm√™s passado‚Äù, use o m√™s anterior e os dois anteriores a ele.\n- Se pedir um m√™s espec√≠fico, puxe tamb√©m os dois anteriores.\n- Se disser ‚Äúano inteiro‚Äù, use o range completo informado.\n- Sempre considere o m√™s mais recente como o m√™s anterior ao m√™s atual.\n- O m√™s atual nunca deve ser inclu√≠do nos filtros.\n- Se o usu√°rio n√£o especificar meses, defina o range como os √∫ltimos 3 meses at√© o m√™s anterior ao atual.\n- Se disser ‚Äúm√™s passado‚Äù, use o m√™s anterior e os dois anteriores a ele.\n- Se pedir um m√™s espec√≠fico, puxe tamb√©m os dois anteriores, mas nunca inclua o m√™s atual.\n- Se disser ‚Äúano inteiro‚Äù, use o range completo informado, mas n√£o inclua o m√™s atual.\n- Se a pergunta for gen√©rica (‚Äúquanto gastei com pessoas‚Äù), use tipo_custo = ‚Äútodas‚Äù.\n- Se n√£o houver filtros de √°rea, departamento, cargo ou empresa, retorne null nesses campos.\n- Sempre responda apenas o JSON, sem explica√ß√µes.\n- Se area, departamento, tipo_custo, centro_de_custo, cargo ou empresa tiverem mais de um valor, retorne como array. Se n√£o houver valor, retorne null.‚Äù\n- Em casos de perguntas de rankeamento ou ranking ou ordena√ß√£o, defina a metrica como \"ranking\"\n- Quando o usu√°rio disser ‚Äúpor departamento‚Äù, ‚Äúpor √°rea‚Äù, ‚Äúpor cargo‚Äù‚Ä¶ interprete como:\n    departamento = TODOS os departamentos dispon√≠veis\n    (ou √°rea / cargo / empresa / CC)\n    Exemplo:\n    \"por departamento\" -> \"departamento\": [\"TI\", \"Marketing\", \"Financeiro\", ‚Ä¶]\n- Sempre que o usu√°rio mencionar um nome de pessoa, extraia esse nome exatamente como est√° e retorne no campo \"colaborador\".\nCaso mais de um nome seja citado, retorne em array.\nSe n√£o houver nome, retorne \"colaborador\": null.\n\nExemplo:\n{\n  \"mes_inicio\": \"06/2025\",\n  \"mes_fim\": \"11/2025\",\n  \"tipo_custo\": [\"F√©rias\", \"Horas Extras e Adicionais\"],\n  \"area\": null,\n  \"departamento\": [\"TI\", \"Marketing\"],\n  \"centro_de_custo\": null,\n  \"cargo\": null,\n  \"empresa\": null,\n  \"metrica\": \"total_gasto\",\n  \"periodo_comparativo\": 3,\n  \"pergunta\": \"Quanto o departamento de TI e Marketing gastaram com f√©rias e horas extras no √∫ltimo semestre?\"\n}\n\nExemplo de sa√≠da:\n{\n  \"mes_inicio\": \"06/2025\",\n  \"mes_fim\": \"08/2025\",\n  \"tipo_custo\": \"Sal√°rio\",\n  \"colaborador\": \"Ana Sophia Ara√∫jo\",\n  \"area\": null,\n  \"departamento\": null,\n  \"centro_de_custo\": null,\n  \"cargo\": null,\n  \"empresa\": null,\n  \"metrica\": \"total_gasto\",\n  \"periodo_comparativo\": 3,\n  \"pergunta\": {{ $json.pergunta }} \n}\n\n","options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[1584,-704],"id":"6140b614-29eb-4f22-8302-bc29c416569b","name":"Interpretar pergunta"},{"parameters":{"operation":"executeQuery","query":"{{$json.query}}"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[2224,-704],"id":"851b7a14-2f0d-433a-b985-1ed4ecf31654","name":"Executar Query","alwaysOutputData":true,"credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"jsCode":"// === PARSE DE FILTROS ===\nlet filtros;\ntry {\n  let raw = $json.output || $json;\n  if (typeof raw === 'object') {\n    filtros = raw;\n  } else {\n    const clean = raw.replace(/```json\\s*|\\s*```/g, '').trim();\n    filtros = JSON.parse(clean);\n  }\n} catch (e) {\n  console.log('‚ùå Erro ao parsear filtros:', e);\n  filtros = {};\n}\n\n// === NORMALIZA√á√ÉO DE TEXTOS (corrige h√≠fens e espa√ßos inconsistentes) ===\nconst normalizeText = (str) => {\n  if (!str) return str;\n  return str\n    .replace(/[‚Äì‚Äî]/g, '-') // substitui travess√µes por h√≠fen comum\n    .replace(/\\s+/g, ' ')   // normaliza m√∫ltiplos espa√ßos\n    .trim();\n};\n\n// Normaliza todos os campos textuais dos filtros\nconst camposTextuais = ['tipo_custo', 'area', 'departamento', 'centro_de_custo', 'cargo', 'empresa', 'colaborador'];\nfor (const campo of camposTextuais) {\n  const val = filtros[campo];\n  if (Array.isArray(val)) {\n    filtros[campo] = val.map(v => normalizeText(v));\n  } else if (typeof val === 'string') {\n    filtros[campo] = normalizeText(val);\n  }\n}\n\n// === L√ìGICA DE PER√çODO (MM/YYYY) ===\nconst now = new Date();\nlet mesInicio, mesFim;\nif (filtros.mes_inicio && filtros.mes_fim) {\n  mesInicio = filtros.mes_inicio;\n  mesFim = filtros.mes_fim;\n} else {\n  const fim = new Date(now);\n  const inicio = new Date(now);\n  inicio.setMonth(inicio.getMonth() - 2);\n  mesInicio = `${String(inicio.getMonth() + 1).padStart(2, '0')}/${inicio.getFullYear()}`;\n  mesFim = `${String(fim.getMonth() + 1).padStart(2, '0')}/${fim.getFullYear()}`;\n}\n\n// === CONVERTE MM/YYYY ‚Üí YYYYMM (inteiro) ===\nfunction mmyyyyToYYYYMMInt(mmyyyy) {\n  if (!mmyyyy || typeof mmyyyy !== 'string') return null;\n  const [mm, yyyy] = mmyyyy.trim().split('/');\n  return /^\\d{2}$/.test(mm) && /^\\d{4}$/.test(yyyy)\n    ? parseInt(`${yyyy}${mm}`, 10)\n    : null;\n}\nlet startInt = mmyyyyToYYYYMMInt(mesInicio);\nlet endInt = mmyyyyToYYYYMMInt(mesFim);\nif (startInt && endInt && startInt > endInt) [startInt, endInt] = [endInt, startInt];\n\n// === HELPERS ===\nconst escapeSql = (str) => (str == null ? '' : String(str).replace(/'/g, \"''\"));\nconst toInClause = (arr) => arr.map(v => `'${escapeSql(v)}'`).join(', ');\nconst filtroCampoSQL = (alias, campo, valor) =>\n  !valor ? '' : Array.isArray(valor)\n    ? ` AND ${alias}.[${campo}] IN (${toInClause(valor)})`\n    : ` AND ${alias}.[${campo}] = '${escapeSql(valor)}'`;\n\n// === NOVO FILTRO: COLABORADOR ===\nlet colaboradorFiltro = '';\nif (filtros.colaborador) {\n  colaboradorFiltro = Array.isArray(filtros.colaborador)\n    ? ` AND c.[Nome] IN (${toInClause(filtros.colaborador)})`\n    : ` AND c.[Nome] = '${escapeSql(filtros.colaborador)}'`;\n}\n\n// === FILTROS ===\nlet tipoCustoFiltro = '';\nif (filtros.tipo_custo && filtros.tipo_custo !== 'todas') {\n  tipoCustoFiltro = Array.isArray(filtros.tipo_custo)\n    ? ` AND r.[Tipo_Custo] IN (${toInClause(filtros.tipo_custo)})`\n    : ` AND r.[Tipo_Custo] = '${escapeSql(filtros.tipo_custo)}'`;\n}\n\nlet departamentoFiltro = '';\nif (filtros.departamento) {\n  departamentoFiltro = Array.isArray(filtros.departamento)\n    ? ` AND c.[Departamento] IN (${toInClause(filtros.departamento)})`\n    : ` AND c.[Departamento] = '${escapeSql(filtros.departamento)}'`;\n}\n\n// === AGRUPAMENTO ===\nlet agrupamento = [`LTRIM(RTRIM(r.[Mes_ref_folha])) AS Mes`];\nlet groupBy = [`LTRIM(RTRIM(r.[Mes_ref_folha]))`];\nif (filtros.departamento) {\n  agrupamento.push('c.[Departamento]');\n  groupBy.push('c.[Departamento]');\n}\nif (filtros.tipo_custo && filtros.tipo_custo !== 'todas') {\n  agrupamento.push('r.[Tipo_Custo]');\n  groupBy.push('r.[Tipo_Custo]');\n}\n\n// === FILTRO TEMPORAL ===\nlet filtroTemporal = '';\nif (startInt && endInt) {\n  filtroTemporal = startInt === endInt\n    ? `AND LTRIM(RTRIM(r.[Mes_ref_folha])) = '${mesInicio}'`\n    : `AND CAST(RIGHT(LTRIM(RTRIM(r.[Mes_ref_folha])),4) + LEFT(LTRIM(RTRIM(r.[Mes_ref_folha])),2) AS INT)\n       BETWEEN ${startInt} AND ${endInt}`;\n}\n\n// === QUERY BASE ===\nlet query;\n\n// üí∞ Caso 1: Total gasto\nif (filtros.metrica === 'total_gasto' || !filtros.metrica) {\n  const precisaJoin = !!(filtros.departamento || filtros.area || filtros.cargo || filtros.centro_de_custo || filtros.empresa || filtros.colaborador);\n  if (precisaJoin) {\n    query = `\n      SELECT ${agrupamento.join(', ')}, SUM(r.[Valor]) AS Total_Gasto\n      FROM [vw_Rubricas_Classificadas] r\n      LEFT JOIN [RhTech_fake_Colaboradores] c\n        ON REPLACE(REPLACE(REPLACE(c.[CPF], '.', ''), '-', ''), ' ', '') =\n           REPLACE(REPLACE(REPLACE(r.[CPF], '.', ''), '-', ''), ' ', '')\n      WHERE 1=1\n      ${tipoCustoFiltro} ${departamentoFiltro}\n      ${filtroCampoSQL('c', '√Årea', filtros.area)}\n      ${filtroCampoSQL('c', 'Cargo', filtros.cargo)}\n      ${filtroCampoSQL('c', 'Centro_de_Custo', filtros.centro_de_custo)}\n      ${filtroCampoSQL('c', 'Nome_da_Empresa', filtros.empresa)}\n      ${colaboradorFiltro}\n      ${filtroTemporal}\n      GROUP BY ${groupBy.join(', ')}\n      ORDER BY Mes DESC;\n    `;\n  } else {\n    query = `\n      SELECT ${agrupamento.join(', ')}, SUM(r.[Valor]) AS Total_Gasto\n      FROM [vw_Rubricas_Classificadas] r\n      WHERE 1=1 ${tipoCustoFiltro} ${filtroTemporal}\n      GROUP BY ${groupBy.join(', ')}\n      ORDER BY Mes DESC;\n    `;\n  }\n}\n\n// üèÜ Caso 2: Ranking (interpretando quando a pergunta pede pessoas)\nelse if (filtros.metrica === 'ranking') {\n\n  const pergunta = (filtros.pergunta || '').toLowerCase();\n\n  // Detecta inten√ß√£o clara por pessoas\n  const pedePessoas = /\\b(pessoa|pessoas|colaborador|colaboradores|quem|quem mais|quem gastou|nomes)\\b/.test(pergunta);\n\n  // Filtros reutiliz√°veis\n  const filtroArea = filtroCampoSQL('c', '√Årea', filtros.area);\n  const filtroDepartamento = filtroCampoSQL('c', 'Departamento', filtros.departamento);\n  const filtroCentro = filtroCampoSQL('c', 'Centro_de_Custo', filtros.centro_de_custo);\n  const filtroCargo = filtroCampoSQL('c', 'Cargo', filtros.cargo);\n  const filtroEmpresa = filtroCampoSQL('c', 'Nome_da_Empresa', filtros.empresa);\n\n  // ===========================\n  // 1) Ranking por PESSOA\n  // ===========================\n  if (pedePessoas) {\n    query = `\n      SELECT\n        REPLACE(REPLACE(REPLACE(c.[CPF], '.', ''), '-', ''), ' ', '') AS CPF_Limpo,\n        c.[Nome] AS Colaborador,\n        SUM(r.[Valor]) AS Total_Gasto\n      FROM [vw_Rubricas_Classificadas] r\n      INNER JOIN [RhTech_fake_Colaboradores] c\n        ON REPLACE(REPLACE(REPLACE(c.[CPF], '.', ''), '-', ''), ' ', '') =\n           REPLACE(REPLACE(REPLACE(r.[CPF], '.', ''), '-', ''), ' ', '')\n      WHERE 1=1\n        ${tipoCustoFiltro}\n        ${filtroArea}            -- filtra TI, mas n√£o agrupa por √°rea\n        ${filtroDepartamento}    -- se vier departamento, filtra\n        ${filtroCentro}\n        ${filtroCargo}\n        ${filtroEmpresa}\n        ${filtroTemporal}\n      GROUP BY \n        REPLACE(REPLACE(REPLACE(c.[CPF], '.', ''), '-', ''), ' ', ''),\n        c.[Nome]\n      ORDER BY SUM(r.[Valor]) DESC;\n    `;\n  }\n\n  // ===========================\n  // 2) Ranking por categoria (comportamento padr√£o)\n  // ===========================\n  else {\n    let campoRanking = 'c.[Departamento]';\n    if (filtros.cargo) campoRanking = 'c.[Cargo]';\n    else if (filtros.area) campoRanking = 'c.[√Årea]';\n    else if (filtros.centro_de_custo) campoRanking = 'c.[Centro_de_Custo]';\n    else if (filtros.empresa) campoRanking = 'c.[Nome_da_Empresa]';\n\n    query = `\n      SELECT ${campoRanking} AS Categoria, SUM(r.[Valor]) AS Total_Gasto\n      FROM [vw_Rubricas_Classificadas] r\n      INNER JOIN [RhTech_fake_Colaboradores] c\n        ON REPLACE(REPLACE(REPLACE(c.[CPF], '.', ''), '-', ''), ' ', '') =\n           REPLACE(REPLACE(REPLACE(r.[CPF], '.', ''), '-', ''), ' ', '')\n      WHERE 1=1\n        ${tipoCustoFiltro}\n        ${filtroArea}\n        ${filtroDepartamento}\n        ${filtroCentro}\n        ${filtroCargo}\n        ${filtroEmpresa}\n        ${filtroTemporal}\n      GROUP BY ${campoRanking}\n      ORDER BY SUM(r.[Valor]) DESC;\n    `;\n  }\n}\n\n\n// üìã Caso 3: Consulta detalhada\nelse {\n  query = `\n    SELECT TOP 10000\n      REPLACE(REPLACE(REPLACE(c.[CPF], '.', ''), '-', ''), ' ', '') AS CPF_Limpo,\n      c.[Nome], c.[Cargo], c.[Departamento], c.[Centro_de_Custo],\n      c.[Sal√°rio], c.[Vale_Refei√ß√£o], c.[Nome_da_Empresa], c.[√Årea],\n      r.[C√≥digo_Rubrica], r.[Descri√ß√£o_Rubrica], r.[Descri√ß√£o_Natureza_Rubrica],\n      r.[Tipo_Custo], r.[Valor], r.[Mes_ref_folha]\n    FROM [RhTech_fake_Colaboradores] c\n    LEFT JOIN [vw_Rubricas_Classificadas] r\n      ON REPLACE(REPLACE(REPLACE(c.[CPF], '.', ''), '-', ''), ' ', '') =\n         REPLACE(REPLACE(REPLACE(r.[CPF], '.', ''), '-', ''), ' ', '')\n    WHERE 1=1\n      ${tipoCustoFiltro} ${departamentoFiltro}\n      ${filtroCampoSQL('c', '√Årea', filtros.area)}\n      ${filtroCampoSQL('c', 'Cargo', filtros.cargo)}\n      ${filtroCampoSQL('c', 'Centro_de_Custo', filtros.centro_de_custo)}\n      ${filtroCampoSQL('c', 'Nome_da_Empresa', filtros.empresa)}\n      ${colaboradorFiltro}\n      ${filtroTemporal}\n    ORDER BY r.[Mes_ref_folha] DESC, c.[Nome], r.[C√≥digo_Rubrica];\n  `;\n}\n\n// === DEBUG ===\nconsole.log('‚úÖ Query gerada:', query);\nconsole.log('üìä Filtros:', JSON.stringify(filtros, null, 2));\nconsole.log('üóìÔ∏è Per√≠odo:', mesInicio, '‚Üí', mesFim, `(as ints ${startInt} ‚Üí ${endInt})`);\n\nreturn [{ json: { query, filtrosAplicados: filtros, usaFiltroNumerico: !!(startInt && endInt) } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2000,-704],"id":"9a62cafe-7ea8-44cd-8639-da532a293f9a","name":"Criar Query"},{"parameters":{"model":"openai/gpt-4o","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[2672,-480],"id":"8f321671-8d20-47df-a15e-130f79cac433","name":"OpenRouter Chat Model1","credentials":{"openRouterApi":{"id":"o1ywdYlH64cgqSMT","name":"OpenRouter account"}}},{"parameters":{"promptType":"define","text":"=### Dia Atual: {{ $now.weekdayLong }}, {{ $now.format('dd/MM/yyyy') }}, {{ $now.hour.toString().padStart(2, '0') }}:{{ $now.minute.toString().padStart(2, '0') }}\n\nVoc√™ √© a **Mindy**, diretora de RH virtual. \nExplique os resultados da consulta SQL de forma **clara, objetiva e profissional**.\n\n**CONTEXTO**\n- Pergunta do usu√°rio: \"{{ $json.pergunta }}\"\n- Dados da consulta: {{ JSON.stringify($json.resultados, null, 2) }}\n- Filtros aplicados: {{ JSON.stringify($json.filtros, null, 2) }}\n\n**Regras gerais:**\n1. Resuma o per√≠odo completo analisado (‚ÄúNo √∫ltimo trimestre‚Äù, ‚ÄúNos √∫ltimos 3 meses‚Äù, etc.).\n2. Mencione m√™s(es) e, quando aplic√°vel, liste departamentos/√°reas/centros de custo/tipo de custo conforme retornado pela query.\n3. Formate valores em reais (R$ 1,2 mil / R$ 2,3 milh√µes).\n4. Se n√£o houver resultado (array vazio), responda exatamente:\n   { \"resposta\": \"N√£o encontrei registros para esse filtro.\", \"precisaImagem\": false }\n5. Se a pergunta mencionar m√∫ltiplas rubricas (ex: \"f√©rias e 13¬∫\") e a query devolver apenas algumas, descreva os dados encontrados e informe explicitamente quais rubricas n√£o tiveram registros.\ntraga a que existe, explique que n√£o encontrou registros da outra.\n\n**DETERMINAR RANKING vs LISTAGEM COMPLETA**\n- Use **ranking** SOMENTE se a pergunta incluir explicitamente termos como: \"quem mais gastou\", \"quais s√£o os maiores gastos\", \"ranking\", \"top\", \"ordem decrescente\" ou varia√ß√µes √≥bvias.\n- Se **n√£o** pedir ranking, **liste todas** as categorias presentes em `resultados`.\n\n**Regra especial ‚Äî quando for ranking:**\n- Liste as categorias em ordem decrescente de gasto (ex: ‚ÄúOpera√ß√µes R$ 598,6 mil; Comercial R$ 556,8 mil; TI R$ 528,9 mil...‚Äù).\n- Informe o **total geral** do per√≠odo somando todas as categorias.\n- Finalize com uma **s√≠ntese da tend√™ncia geral** (‚Äúos gastos se mant√™m est√°veis‚Äù, ‚Äúhouve leve alta‚Äù, etc.).\n\n**SA√çDA E TEND√äNCIA**\n- Sempre informe o total geral do per√≠odo somando todas as linhas (use Calculator para somar).\n- Se for poss√≠vel inferir tend√™ncia (comparativo entre meses presentes nos resultados), acrescente uma s√≠ntese curta: \"est√°vel\", \"leve alta\" ou \"leve queda\". Caso n√£o seja poss√≠vel inferir, omita essa s√≠ntese.\n\n## FERRAMENTAS:\n**Calculator**\nUse essa ferramenta para te ajudar nos calculos\n\n‚ö†Ô∏è IMPORTANTE:\n- Se o campo {{ JSON.stringify($json.resultados, null, 2) }} estiver vazio (sem registros),\n  **precisaImagem √© false**.\n- Retorne apenas:\n  {\n  \"resposta\": \"N√£o encontrei registros para esse filtro.\",\n  \"precisaImagem\": false\n  }\n- Caso contrario precisaImagem √© true\n\n**Modelos esperados:**\n\n- ‚ÄúNo trimestre, Marketing liderou com R$ 1,2 milh√£o em horas extras, seguido por TI (R$ 940 mil) e RH (R$ 870 mil). O total do per√≠odo foi de R$ 3,5 milh√µes, com tend√™ncia de leve alta.‚Äù\n- ‚ÄúN√£o encontrei registros para esse filtro.‚Äù\n\n## Sa√≠da esperada\n\nRetorne somente este JSON:\n\n{\n  \"resposta\": \"texto explicativo da an√°lise\",\n  \"precisaImagem\": true | false\n}\n\n## Modelos esperados:\n\nSe houver dados:\n{\n  \"resposta\": ‚ÄúNos √∫ltimos 3 meses, os departamentos com maior gasto em f√©rias foram: Opera√ß√µes (R$ 598,6 mil), Comercial (R$ 556,8 mil) e TI (R$ 528,9 mil). O total geral foi de R$ 3,1 milh√µes, indicando estabilidade no per√≠odo.‚Äù,\n  \"precisaImagem\": true\n}\n\nSe n√£o houver registros\n{\n  \"resposta\": \"N√£o encontrei registros para esse filtro.\",\n  \"precisaImagem\": false\n}\n\n\n\n\n","options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[2672,-704],"id":"0848e062-dfca-4083-beed-246caae858a6","name":"Analisar e Gerar Resposta"},{"parameters":{"assignments":{"assignments":[{"id":"4545f892-fbda-4554-bcdf-29a5962450b1","name":"pergunta","value":"Quanto a empresa TechRH Ltda gastou com sal√°rios em agosto?","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-96,-912],"id":"a6a4abe3-9d76-48b9-b2af-39ddee8293d0","name":"Edit Fields"},{"parameters":{"operation":"executeQuery","query":"SELECT DISTINCT\n  [C√≥digo_Rubrica],\n  [Descri√ß√£o_Rubrica],\n  [Descri√ß√£o_Natureza_Rubrica]\nFROM [RhTech_fake_Rubricas]\nORDER BY\n  [C√≥digo_Rubrica],\n  [Descri√ß√£o_Rubrica],\n  [Descri√ß√£o_Natureza_Rubrica];\n"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[2176,-1104],"id":"7d35369c-391b-453d-b43c-677e7a02d8a5","name":"Executar Query1","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"operation":"executeQuery","query":"SELECT DISTINCT\n    --[Cargo]\n    --[Departamento]\n    [Centro_de_Custo]\n    --[√Årea]\n    --[Nome_da_Empresa]\nFROM [RhTech_fake_Colaboradores]\n"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[1968,-1072],"id":"4cafd7a0-4bd2-4d4f-ac82-606241c5d1c9","name":"Executar Query2","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"documentId":{"__rl":true,"value":"1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0","mode":"list","cachedResultName":"depara_rubricas_folha_pagamento","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"rubricas","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit#gid=0"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[704,-1168],"id":"9a141b17-987f-4744-beca-8c36092dd5c4","name":"rubricas","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"documentId":{"__rl":true,"value":"1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0","mode":"list","cachedResultName":"depara_rubricas_folha_pagamento","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":1086466239,"mode":"list","cachedResultName":"empresas","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit#gid=1086466239"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[704,-992],"id":"56fe9830-f183-4a3e-b61b-5096b21be991","name":"empresas","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"documentId":{"__rl":true,"value":"1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0","mode":"list","cachedResultName":"depara_rubricas_folha_pagamento","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":346942308,"mode":"list","cachedResultName":"areas","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit#gid=346942308"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[704,-816],"id":"47359f26-64c6-433c-9163-05d5be7ba5f7","name":"areas","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"documentId":{"__rl":true,"value":"1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0","mode":"list","cachedResultName":"depara_rubricas_folha_pagamento","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":761659075,"mode":"list","cachedResultName":"departamentos","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit#gid=761659075"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[704,-640],"id":"c4884671-5dd9-4ce7-93ca-c0c4bd780a87","name":"departamentos","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"documentId":{"__rl":true,"value":"1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0","mode":"list","cachedResultName":"depara_rubricas_folha_pagamento","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":1934165408,"mode":"list","cachedResultName":"centro_de_custo","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit#gid=1934165408"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[704,-464],"id":"de4972a1-836e-44ca-97f4-62f48c7a72ea","name":"centro_de_custo","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"documentId":{"__rl":true,"value":"1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0","mode":"list","cachedResultName":"depara_rubricas_folha_pagamento","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":1112723933,"mode":"list","cachedResultName":"cargos","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit#gid=1112723933"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[704,-304],"id":"306cd80a-30c9-40c3-aa21-e145962ed3d7","name":"cargos","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"numberInputs":6},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[1152,-768],"id":"ce4546fa-0b2a-46fd-9a88-ee51b5cbb72f","name":"Merge"},{"parameters":{"jsCode":"// --- Captura dados das planilhas (vindos dos nodes anteriores)\nconst parametros_folha = {\n  rubricas: $('rubricas').all().map(item => item.json),\n  empresas: $('empresas').all().map(item => item.json),\n  areas: $('areas').all().map(item => item.json),\n  departamentos: $('departamentos').all().map(item => item.json),\n  centro_de_custo: $('centro_de_custo').all().map(item => item.json),\n  cargos: $('cargos').all().map(item => item.json)\n};\n\n// --- Captura a pergunta (de Edit Fields ou Trigger)\nlet pergunta = null;\n\ntry {\n  pergunta = $('trigger').first().json.pergunta||\n    null;\n} catch (e) {\n  pergunta = null;\n}\n\n// --- Retorna JSON consolidado\nreturn [\n  {\n    json: {\n      pergunta,\n      parametros_folha\n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1360,-704],"id":"c9a01fd1-1626-4a7f-843e-d041e1c8dc58","name":"Code"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[176,-736],"id":"cc3bd75e-c002-4437-b9f2-7f5ec4185a20","name":"No Operation, do nothing"},{"parameters":{"operation":"executeQuery","query":"CREATE OR ALTER VIEW vw_Rubricas_Classificadas AS\nSELECT \n    r.[C√≥digo_Rubrica],\n    r.[Descri√ß√£o_Rubrica],\n    r.[Descri√ß√£o_Natureza_Rubrica],\n    r.[CPF],\n    r.[Valor],\n    r.[Mes_ref_folha],\n    CASE \n        -- Horas Extras e Adicionais\n        WHEN r.[Descri√ß√£o_Rubrica] LIKE '%HORA%EXTRA%' OR \n             r.[Descri√ß√£o_Rubrica] LIKE '%BANCO%HORA%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%SOBREAVISO%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%ADICIONAL%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%NOTURNO%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%INSALUBRIDADE%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%PERICULOSIDADE%'\n        THEN 'Horas Extras e Adicionais'\n        \n        -- Sal√°rio\n        WHEN r.[Descri√ß√£o_Rubrica] LIKE '%SALARI%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%HORA%NORMA%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%DIAS%TRABALHADO%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%PRO-LABORE%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%QUEBRA%CAIXA%'\n        THEN 'Sal√°rio'\n        \n        -- Comiss√µes, Gratifica√ß√µes e Premia√ß√µes\n        WHEN r.[Descri√ß√£o_Rubrica] LIKE '%COMISS%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%GRATIFIC%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%PREMI%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%PRODUTIVIDADE%'\n        THEN 'Comiss√µes, Gratifica√ß√µes e Premia√ß√µes'\n        \n        -- F√©rias\n        WHEN r.[Descri√ß√£o_Rubrica] LIKE '%FERIAS%'\n        THEN 'F√©rias'\n        \n        -- 13¬∫ Sal√°rio\n        WHEN r.[Descri√ß√£o_Rubrica] LIKE '%13%SALARIO%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%13¬∫%'\n        THEN '13 sal√°rio'\n        \n        -- Rescis√£o\n        WHEN r.[Descri√ß√£o_Rubrica] LIKE '%RESCIS%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%AVISO%PREVIO%'\n        THEN 'Rescis√£o'\n        \n        -- Afastamento\n        WHEN r.[Descri√ß√£o_Rubrica] LIKE '%ATESTADO%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%LICENCA%'\n        THEN 'Afastamento'\n        \n        -- Descontos\n        WHEN r.[Descri√ß√£o_Rubrica] LIKE '%REEMBOLSO%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%DESC%'\n        THEN 'Descontos'\n        \n        -- DSR\n        WHEN r.[Descri√ß√£o_Rubrica] LIKE '%DSR%'\n        THEN 'Horas Extras e Adicionais'\n        \n        ELSE 'Outros'\n    END AS Tipo_Custo\n    \nFROM [RhTech_fake_Rubricas] r;"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[1760,-1104],"id":"e37b73b1-beb2-4049-ab32-66f2c1b43e86","name":"Cria View com as Rubricas adequadas","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"numberInputs":6},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[1200,-2080],"id":"a7e47afa-adfb-405b-b702-d9c4c1c1a2f1","name":"Merge1"},{"parameters":{"jsCode":"// --- Captura dados das planilhas (vindos dos nodes anteriores)\nconst parametros_folha = {\n  rubricas: $('Buscar Rubricas Classificadas').all().map(item => item.json),\n  empresas: $('Buscar Empresas').all().map(item => item.json),\n  areas: $('Buscar √Åreas').all().map(item => item.json),\n  departamentos: $('Buscar Departamentos').all().map(item => item.json),\n  centro_de_custo: $('Buscar Centros de Custo').all().map(item => item.json),\n  cargos: $('Buscar Cargos').all().map(item => item.json)\n};\n\n// --- Captura a pergunta (de Edit Fields ou Trigger)\nlet pergunta = null;\n\ntry {\n  pergunta =\n    $('Definir Pergunta Manual').first().json.pergunta ||\n    $('Trigger').first().json.pergunta ||\n    null;\n} catch (e) {\n  pergunta = null;\n}\n\n// --- Retorna JSON consolidado\nreturn [\n  {\n    json: {\n      pergunta,\n      parametros_folha\n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1488,-2016],"id":"dbf2c410-f8df-49f9-b485-bb597b7b61e0","name":"Consolidar Par√¢metros e Pergunta"},{"parameters":{"operation":"executeQuery","query":"-- Buscar apenas tipos de custo √∫nicos (em vez de 300k registros)\nSELECT DISTINCT [Tipo_Custo] \nFROM vw_Rubricas_Classificadas \nWHERE [Tipo_Custo] IS NOT NULL \nORDER BY [Tipo_Custo];"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[688,-2624],"id":"fe1d0dba-ebfa-4aec-b9b8-0930f033d1da","name":"Buscar Rubricas Classificadas","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"operation":"executeQuery","query":"SELECT DISTINCT [Nome_da_Empresa] \nFROM [RhTech_fake_Colaboradores] \nWHERE [Nome_da_Empresa] IS NOT NULL \nORDER BY [Nome_da_Empresa];"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[688,-2400],"id":"2cefdb2d-c944-4e94-b0ca-cb2fee8b3e18","name":"Buscar Empresas","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"operation":"executeQuery","query":"SELECT DISTINCT [√Årea] \nFROM [RhTech_fake_Colaboradores] \nWHERE [√Årea] IS NOT NULL \nORDER BY [√Årea];\n"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[688,-2176],"id":"52f9261d-534c-4852-974e-4d6ddd5373b5","name":"Buscar √Åreas","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"operation":"executeQuery","query":"SELECT DISTINCT [Departamento] \nFROM [RhTech_fake_Colaboradores] \nWHERE [Departamento] IS NOT NULL \nORDER BY [Departamento];"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[688,-1968],"id":"34712d74-7a39-4f71-b20d-59fac43abc76","name":"Buscar Departamentos","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"operation":"executeQuery","query":"SELECT DISTINCT [Centro_de_Custo] \nFROM [RhTech_fake_Colaboradores] \nWHERE [Centro_de_Custo] IS NOT NULL \nORDER BY [Centro_de_Custo];"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[688,-1744],"id":"6923dd9f-5c21-446a-9715-7d37d64846ca","name":"Buscar Centros de Custo","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"operation":"executeQuery","query":"SELECT DISTINCT [Cargo] \nFROM [RhTech_fake_Colaboradores] \nWHERE [Cargo] IS NOT NULL \nORDER BY [Cargo];"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[688,-1520],"id":"71455db8-1e59-4c65-a512-e686f1eec5fd","name":"Buscar Cargos","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"assignments":{"assignments":[{"id":"4545f892-fbda-4554-bcdf-29a5962450b1","name":"pergunta","value":"Quanto gastamos de horas extras esse mes?","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-96,-1936],"id":"7a7b0731-49ff-45f8-a8c5-c9f70dca9962","name":"Definir Pergunta Manual"},{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[2096,-416],"id":"c34e27ac-b7db-4f90-9d5b-d5f060cdc07c","name":"Trigger"},{"parameters":{"operation":"executeQuery","query":"-- Buscar TODAS as tabelas dispon√≠veis (para ver o que existe)\nSELECT \n    TABLE_SCHEMA,\n    TABLE_NAME,\n    TABLE_TYPE\nFROM INFORMATION_SCHEMA.TABLES \nORDER BY TABLE_SCHEMA, TABLE_NAME;"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[2400,-1104],"id":"8f910e9c-a721-486a-8e73-4fe69cb6ab01","name":"Ver todas as tabelas no banco atual","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{},"type":"@n8n/n8n-nodes-langchain.toolCalculator","typeVersion":1,"position":[2864,-480],"id":"7322ac87-3056-45a5-a06d-0ccf3e6abf18","name":"Calculator"},{"parameters":{"jsCode":"// Processar os resultados otimizados\nconst rawData = $('Buscar Parametros Otimizados').first().json;\n\nconst parametros_folha = {\n  rubricas: JSON.parse(rawData.tipos_custo || '[]').map(tipo => ({ \n    Tipo_Custo: tipo.Tipo_Custo \n  })),\n  empresas: JSON.parse(rawData.empresas || '[]').map(emp => ({\n    Nome_da_Empresa: emp.Nome_da_Empresa\n  })),\n  areas: JSON.parse(rawData.areas || '[]').map(area => ({\n    √Årea: area.√Årea\n  })),\n  departamentos: JSON.parse(rawData.departamentos || '[]').map(depto => ({\n    departamentos: depto.Departamento\n  })),\n  centro_de_custo: JSON.parse(rawData.centros_custo || '[]').map(cc => ({\n    Centro_de_Custo: cc.Centro_de_Custo\n  })),\n  cargos: JSON.parse(rawData.cargos || '[]').map(cargo => ({\n    cargos: cargo.Cargo\n  }))\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[336,-1360],"id":"20be992b-fcd8-49fc-989e-6c662cd5e911","name":"Consolidar Par√¢metros e Pergunta1"},{"parameters":{"operation":"executeQuery","query":"SELECT \n  (SELECT DISTINCT [Tipo_Custo] FROM vw_Rubricas_Classificadas WHERE [Tipo_Custo] IS NOT NULL FOR JSON PATH) as tipos_custo,\n  (SELECT DISTINCT [Nome_da_Empresa] FROM [RhTech_fake_Colaboradores] WHERE [Nome_da_Empresa] IS NOT NULL FOR JSON PATH) as empresas,\n  (SELECT DISTINCT [√Årea] FROM [RhTech_fake_Colaboradores] WHERE [√Årea] IS NOT NULL FOR JSON PATH) as areas,\n  (SELECT DISTINCT [Departamento] FROM [RhTech_fake_Colaboradores] WHERE [Departamento] IS NOT NULL FOR JSON PATH) as departamentos,\n  (SELECT DISTINCT [Centro_de_Custo] FROM [RhTech_fake_Colaboradores] WHERE [Centro_de_Custo] IS NOT NULL FOR JSON PATH) as centros_custo,\n  (SELECT DISTINCT [Cargo] FROM [RhTech_fake_Colaboradores] WHERE [Cargo] IS NOT NULL FOR JSON PATH) as cargos;"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[128,-1376],"id":"4b18173c-c124-438a-8c79-e79e1358871f","name":"Buscar Parametros Otimizados","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"operation":"executeQuery","query":"SELECT \n    column_name,\n    data_type,\n    character_maximum_length,\n    is_nullable,\n    column_default\nFROM information_schema.columns\nWHERE table_name = 'vw_Rubricas_Classificadas'\nORDER BY ordinal_position;\n"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[2608,-1104],"id":"0fb85ebd-342b-4ee0-8251-3274b46f735a","name":"Estrutura da tabela","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"operation":"executeQuery","query":"SELECT TOP 10 *\nFROM vw_Rubricas_Classificadas\nWHERE [Tipo_Custo] = 'Horas Extras e Adicionais';\n"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[1168,-2560],"id":"fc0ee28f-2eae-48c7-ade3-1fc59123795e","name":"Buscar Rubricas Classificadas1","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"jsCode":"// === 1Ô∏è‚É£ Agrupa todos os resultados vindos do Executar Query ===\nconst resultados = items.map(item => item.json);\n\n// === 2Ô∏è‚É£ Extrai a pergunta e filtros do n√≥ \"Interpretar pergunta\" ===\nlet data = {};\ntry {\n  data = JSON.parse($('Interpretar pergunta').item.json.output || '{}');\n} catch (e) {\n  console.log('‚ùå Erro ao parsear Interpretar pergunta:', e);\n  data = {};\n}\n\n// === 3Ô∏è‚É£ Retorna tudo junto ===\nreturn [{\n  json: {\n    pergunta: data.pergunta || null,\n    filtros: data,\n    resultados: resultados\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2448,-704],"id":"daa00c61-6b93-4eb3-84b5-73fc4051b69a","name":"Agrupar Resultados + Salvar pergunta"},{"parameters":{"operation":"executeQuery","query":"SELECT r.[CPF]\nFROM [vw_Rubricas_Classificadas] r\nLEFT JOIN [RhTech_fake_Colaboradores] c\n  ON REPLACE(REPLACE(REPLACE(c.[CPF], '.', ''), '-', ''), ' ', '') =\n     REPLACE(REPLACE(REPLACE(r.[CPF], '.', ''), '-', ''), ' ', '')\nWHERE c.[CPF] IS NULL\n"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[2832,-1104],"id":"7cd3c137-c96c-43f0-9c28-aa7f712dbc54","name":"CPF das folhas que n√£o aparecem na tabela de colaboradores","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"description":"Gera gr√°fico base64 a partir dos dados","workflowId":{"__rl":true,"value":"LehnDUuuGefsfACB","mode":"list","cachedResultName":"BMS - 6.3 - Plot Gr√°ficos (Folha)"},"workflowInputs":{"mappingMode":"defineBelow","value":{"pergunta":"={{ $json.pergunta }}","dados":"={{ JSON.stringify($json.resultados, null, 2) }}","filtros":"={{ JSON.stringify($json.filtros, null, 2) }}"},"matchingColumns":[],"schema":[{"id":"pergunta","displayName":"pergunta","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string","removed":false},{"id":"dados","displayName":"dados","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"filtros","displayName":"filtros","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":false}},"type":"@n8n/n8n-nodes-langchain.toolWorkflow","typeVersion":2.2,"position":[2976,-480],"id":"ea22c299-ce7c-4e7e-aad2-53a611de6220","name":"GerarGrafico"},{"parameters":{"jsCode":"// Junta todos os outputs (cada item tem um JSON string dentro de \"output\")\nconst all = items.flatMap(item => {\n  try {\n    let jsonString = item.json.output;\n    \n    // Tenta encontrar conte√∫do entre ```json e ```, ou usa a string inteira\n    const jsonMatch = jsonString.match(/```json\\s*([\\s\\S]*?)\\s*```/);\n    if (jsonMatch) {\n      jsonString = jsonMatch[1].trim();\n    } else {\n      // Se n√£o encontrar blocos de c√≥digo, tenta encontrar JSON entre { e }\n      const jsonContent = jsonString.match(/\\{[\\s\\S]*\\}/);\n      if (jsonContent) {\n        jsonString = jsonContent[0].trim();\n      }\n    }\n    \n    return JSON.parse(jsonString);\n  } catch (e) {\n    console.log('Erro ao fazer parse do JSON:', e);\n    return [];\n  }\n});\n\n// Se o resultado for um array com apenas 1 objeto, retorna s√≥ ele\nconst final = Array.isArray(all) && all.length === 1 ? all[0] : all;\n\n// Retorna no formato que o n8n espera\nreturn [\n  {\n    json: final\n  }\n];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3088,-704],"id":"87d97f93-c308-4469-9364-87a72c4ffbd0","name":"Estrutura√ß√£o do JSON de sa√≠da","onError":"continueRegularOutput"},{"parameters":{"workflowId":{"__rl":true,"value":"LehnDUuuGefsfACB","mode":"list","cachedResultName":"BMS - 6.3 - Plot Gr√°ficos (Folha)"},"workflowInputs":{"mappingMode":"defineBelow","value":{"pergunta":"={{ $('Agrupar Resultados + Salvar pergunta').item.json.pergunta }}","dados":"={{ JSON.stringify($('Agrupar Resultados + Salvar pergunta').item.json.resultados, null, 2) }}","filtros":"={{ JSON.stringify($('Agrupar Resultados + Salvar pergunta').item.json.filtros, null, 2) }}"},"matchingColumns":[],"schema":[{"id":"pergunta","displayName":"pergunta","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"dados","displayName":"dados","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"},{"id":"filtros","displayName":"filtros","required":false,"defaultMatch":false,"display":true,"canBeUsedToMatch":true,"type":"string"}],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{}},"type":"n8n-nodes-base.executeWorkflow","typeVersion":1.2,"position":[3568,-704],"id":"fc055e28-68eb-48aa-98ba-a6feb5ddf6ce","name":"Executa o workflow que gera o gr√°fico","onError":"continueErrorOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"e26017ea-d38f-4d43-b9d3-30763fe6a270","leftValue":"={{ $json.precisaImagem }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3312,-704],"id":"9c9f12cf-8e60-4f21-b44d-fb92f6b027b4","name":"Verifica se gera ou n√£o o gr√°fico"},{"parameters":{"assignments":{"assignments":[{"id":"66c16819-2ec8-4fcf-8441-d7ac8a370fbe","name":"resposta","value":"={{ $('Verifica se gera ou n√£o o gr√°fico').item.json.resposta }}","type":"string"},{"id":"f14a7e86-5803-469e-949c-0232ae6424b0","name":"base64","value":"={{ $json.base64Image }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[3776,-720],"id":"7aadcdf0-7c8b-4669-908c-a5d10a4c8cdf","name":"Monta output final com base64"},{"parameters":{"mode":"raw","jsonOutput":"={\n  \"resposta\": \"{{ $('Estrutura√ß√£o do JSON de sa√≠da').item.json.resposta }}\"\n}\n","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[3568,-496],"id":"efe35abd-321e-4dec-8bcc-f5c83478c5d3","name":"Monta output final sem o base64"},{"parameters":{"content":"## Torna o AI Agente mais eficiente e faz com que o fluxo n√£o seja t√£o demorado como se fosse uma tool","height":480,"width":1008},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[3040,-816],"id":"fdeddbe5-5cb4-48b6-8106-f257392bcb77","name":"Sticky Note"},{"parameters":{"operation":"executeQuery","query":"SELECT *\nfrom vw_Rubricas_Classificadas\n    where [Descri√ß√£o_Rubrica] LIKE '%13%SALARIO%' OR\n             [Descri√ß√£o_Rubrica] LIKE '%13¬∫%';"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[1440,-1200],"id":"b87b1cf1-c330-4483-8baa-f1a299ee023c","name":"13¬∞","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"operation":"executeQuery","query":"SELECT DISTINCT tipo_custo\nfrom vw_Rubricas_Classificadas;"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[1472,-1024],"id":"587081f4-bb19-4c3f-b51b-d49434058070","name":"tipo_custo","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"method":"POST","url":"=https://graph.facebook.com/v22.0/{{ $json.metadata.phone_number_id }}/messages ","authentication":"predefinedCredentialType","nodeCredentialType":"whatsAppApi","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-type","value":"application/json"},{"name":"Authorization","value":"{Your Meta Access Token}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"status\": \"read\",\n  \"message_id\": \"{{ $('Chat Received').item.json.messages[0].id }}\",\n  \"typing_indicator\": {\n    \"type\": \"text\"\n  }\n}\n","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1744,528],"id":"8e6b5179-3ef6-495a-98c2-04a8a904d5d0","name":"Typing...","credentials":{"whatsAppApi":{"id":"dUa8w9ZxjUuS6KYx","name":"WhatsApp account"}}},{"parameters":{"updates":["messages"],"options":{"messageStatusUpdates":[]}},"type":"n8n-nodes-base.whatsAppTrigger","typeVersion":1,"position":[1376,528],"id":"b1e6545a-1e04-4569-b971-9eeaa3f0aac9","name":"Chat Received","webhookId":"ee97c321-89cf-4e99-8552-356abf304948","disabled":true},{"parameters":{"content":"## TYPING","height":240,"color":3},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[1680,464],"id":"c2366003-b485-4e2a-8394-4197fcbd4297","name":"Sticky Note1"},{"parameters":{"content":"## SEND MESSAGE","height":240,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[2224,464],"id":"0caf8a0d-e2a4-4506-aea5-a3fe921de430","name":"Sticky Note2"},{"parameters":{},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[2000,528],"id":"36c0d056-57cb-49a3-8cbd-6baf274c2e71","name":"SIMULATION (Wait 5s)","webhookId":"fc764e57-2100-463c-8702-5037591c1730"},{"parameters":{"operation":"send","phoneNumberId":"684831801379813","recipientPhoneNumber":"={{ $('Chat Received').item.json.contacts[0].wa_id }}","textBody":"Hi Reddit!  u/SaikoToyogun","additionalFields":{}},"type":"n8n-nodes-base.whatsApp","typeVersion":1,"position":[2288,528],"id":"c0adb7e0-89a1-4a64-a2fa-e9289b219437","name":"Send Message","webhookId":"29a2b6cd-384c-4114-8ce7-cd6e50dcbbd4","credentials":{"whatsAppApi":{"id":"dUa8w9ZxjUuS6KYx","name":"WhatsApp account"}}},{"parameters":{"content":"## WAIT MESSAGE","height":240},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[1312,464],"id":"a7b49b30-66ba-4f5e-9cb0-0faf1ae841fd","name":"Sticky Note4"},{"parameters":{"operation":"executeQuery","query":"SELECT *\nfrom RhTech_fake_Colaboradores;"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[1184,-992],"id":"3a6b4541-eac2-48b5-bb6a-495c8d4fb83d","name":"13¬∞1","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}}],"connections":{"trigger":{"main":[[{"node":"No Operation, do nothing","type":"main","index":0}]]},"OpenRouter Chat Model":{"ai_languageModel":[[{"node":"Interpretar pergunta","type":"ai_languageModel","index":0}]]},"Interpretar pergunta":{"main":[[{"node":"Criar Query","type":"main","index":0}]]},"Executar Query":{"main":[[{"node":"Agrupar Resultados + Salvar pergunta","type":"main","index":0}]]},"Criar Query":{"main":[[{"node":"Executar Query","type":"main","index":0}]]},"OpenRouter Chat Model1":{"ai_languageModel":[[{"node":"Analisar e Gerar Resposta","type":"ai_languageModel","index":0}]]},"Edit Fields":{"main":[[]]},"Executar Query1":{"main":[[]]},"rubricas":{"main":[[{"node":"Merge","type":"main","index":0}]]},"empresas":{"main":[[{"node":"Merge","type":"main","index":1}]]},"areas":{"main":[[{"node":"Merge","type":"main","index":2}]]},"departamentos":{"main":[[{"node":"Merge","type":"main","index":3}]]},"centro_de_custo":{"main":[[{"node":"Merge","type":"main","index":4}]]},"cargos":{"main":[[{"node":"Merge","type":"main","index":5}]]},"Merge":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Interpretar pergunta","type":"main","index":0}]]},"No Operation, do nothing":{"main":[[{"node":"rubricas","type":"main","index":0},{"node":"empresas","type":"main","index":0},{"node":"areas","type":"main","index":0},{"node":"departamentos","type":"main","index":0},{"node":"centro_de_custo","type":"main","index":0},{"node":"cargos","type":"main","index":0}]]},"Merge1":{"main":[[{"node":"Consolidar Par√¢metros e Pergunta","type":"main","index":0}]]},"Buscar Rubricas Classificadas":{"main":[[{"node":"Merge1","type":"main","index":0}]]},"Buscar Empresas":{"main":[[{"node":"Merge1","type":"main","index":1}]]},"Buscar √Åreas":{"main":[[{"node":"Merge1","type":"main","index":2}]]},"Buscar Departamentos":{"main":[[{"node":"Merge1","type":"main","index":3}]]},"Buscar Centros de Custo":{"main":[[{"node":"Merge1","type":"main","index":4}]]},"Buscar Cargos":{"main":[[{"node":"Merge1","type":"main","index":5}]]},"Definir Pergunta Manual":{"main":[[{"node":"Buscar Rubricas Classificadas","type":"main","index":0},{"node":"Buscar Empresas","type":"main","index":0},{"node":"Buscar √Åreas","type":"main","index":0},{"node":"Buscar Departamentos","type":"main","index":0},{"node":"Buscar Centros de Custo","type":"main","index":0},{"node":"Buscar Cargos","type":"main","index":0}]]},"Trigger":{"main":[[{"node":"Interpretar pergunta","type":"main","index":0}]]},"Calculator":{"ai_tool":[[{"node":"Analisar e Gerar Resposta","type":"ai_tool","index":0}]]},"Buscar Parametros Otimizados":{"main":[[{"node":"Consolidar Par√¢metros e Pergunta1","type":"main","index":0}]]},"Agrupar Resultados + Salvar pergunta":{"main":[[{"node":"Analisar e Gerar Resposta","type":"main","index":0}]]},"Analisar e Gerar Resposta":{"main":[[{"node":"Estrutura√ß√£o do JSON de sa√≠da","type":"main","index":0}]]},"GerarGrafico":{"ai_tool":[[]]},"Estrutura√ß√£o do JSON de sa√≠da":{"main":[[{"node":"Verifica se gera ou n√£o o gr√°fico","type":"main","index":0}]]},"Executa o workflow que gera o gr√°fico":{"main":[[{"node":"Monta output final com base64","type":"main","index":0}],[{"node":"Monta output final sem o base64","type":"main","index":0}]]},"Verifica se gera ou n√£o o gr√°fico":{"main":[[{"node":"Executa o workflow que gera o gr√°fico","type":"main","index":0}],[{"node":"Monta output final sem o base64","type":"main","index":0}]]},"Typing...":{"main":[[{"node":"SIMULATION (Wait 5s)","type":"main","index":0}]]},"Chat Received":{"main":[[{"node":"Typing...","type":"main","index":0}]]},"SIMULATION (Wait 5s)":{"main":[[{"node":"Send Message","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"GbORhS24Rzw7hHlt"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Trigger":[{"json":{}}],"trigger":[{"json":{"pergunta":"Vou verificar a folha de pagamento para obter o valor exato do sal√°rio recebido pela colaboradora Ana Sophia Ara√∫jo em agosto de 2025. Um momento, por favor."}}]},"versionId":"d5ecbdf7-1594-4009-94da-52e66fa2be9f","triggerCount":0,"tags":[]}