{"createdAt":"2025-10-20T18:55:46.059Z","updatedAt":"2025-11-11T20:53:32.679Z","id":"HJmh6E2HXm8b4Yue","name":"BMS - 6.2 - Consulta Folha","active":false,"isArchived":false,"nodes":[{"parameters":{"inputSource":"jsonExample","jsonExample":"{\n\"pergunta\": \"quanto foi gasto com horas extras em mar√ßo de 2024\"\n}"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-96,-736],"id":"e33cb870-3ce6-4f60-8161-f95b677655d6","name":"trigger"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[1584,-480],"id":"7ac2a397-9206-40c6-914b-946c37cf0f5b","name":"OpenRouter Chat Model","credentials":{"openRouterApi":{"id":"o1ywdYlH64cgqSMT","name":"OpenRouter account"}}},{"parameters":{"promptType":"define","text":"=### Dia Atual: {{ $now.weekdayLong }},{{ $now.format('dd/MM/yyyy') }},{{ $now.hour.toString().padStart(2, '0') }}:{{ $now.minute.toString().padStart(2, '0')}}\n\nVoc√™ √© um interpretador de perguntas sobre folha de pagamento e colaboradores.\n\nSua fun√ß√£o √© transformar a pergunta do usu√°rio em um JSON com filtros objetivos para montar uma query SQL.\n\nUse os dados de contexto dispon√≠veis abaixo:\n\n**Rubricas dispon√≠veis:** {{ [...new Set($json.parametros_folha.rubricas.map(r => r.tipo_custo))].join(', ') }}\n\n**Empresas dispon√≠veis:** {{ $json.parametros_folha.empresas.map(e => e.Nome_da_Empresa).join(', ') }}\n\n**√Åreas dispon√≠veis:** {{ $json.parametros_folha.areas.map(a => a.√Årea).join(', ') }}\n\n**Departamentos dispon√≠veis:** {{ $json.parametros_folha.departamentos.map(d => d.departamentos).join(', ') }}\n\n**Centro de Custo dispon√≠veis:** {{ $json.parametros_folha.centro_de_custo.map(f => f.Centro_de_Custo).join(', ') }}\n\n**Cargos dispon√≠veis:** {{ $json.parametros_folha.cargos.map(c => c.cargos).join(', ') }}\n\nQue cont√™m:\n- rubricas: lista de rubricas e suas categorias macro (campo tipo_custo)\n- empresas: lista de empresas dispon√≠veis\n- √°reas, departamentos, centro_de_custo e cargos: estrutura organizacional completa\n\nAnalise a pergunta em {{ $json.pergunta }} e devolva apenas um JSON com os filtros detectados, sem texto adicional.\n\nCampos esperados:\n- mes_inicio (AAAA-MM)\n- mes_fim (AAAA-MM)\n- tipo_custo (ex: Sal√°rio, Benef√≠cios, Horas Extras e Adicionais, Encargos, etc.)\n- area\n- departamento\n- centro_de_custo\n- cargo\n- empresa\n- metrica (ex: total_gasto, ranking, media, comparativo)\n- periodo_comparativo (opcional)\n\nRegras:\n- Se o usu√°rio n√£o especificar meses, defina o range como os **√∫ltimos 3 meses at√© o atual**.\n- Se disser ‚Äúm√™s passado‚Äù, use o m√™s anterior e os dois anteriores a ele.\n- Se pedir um m√™s espec√≠fico, puxe tamb√©m os dois anteriores.\n- Se disser ‚Äúano inteiro‚Äù, use o range completo informado.\n- Se a pergunta for gen√©rica (‚Äúquanto gastei com pessoas‚Äù), use tipo_custo = ‚Äútodas‚Äù.\n- Se n√£o houver filtros de √°rea, departamento, cargo ou empresa, retorne null nesses campos.\n- Sempre responda apenas o JSON, sem explica√ß√µes.\n\nExemplo de sa√≠da:\n{\n  \"mes_inicio\": \"2024-10\",\n  \"mes_fim\": \"2024-12\",\n  \"tipo_custo\": \"Benef√≠cios\",\n  \"area\": \"Financeiro\",\n  \"departamento\": null,\n  \"centro_de_custo\": null,\n  \"cargo\": null,\n  \"empresa\": null,\n  \"metrica\": \"total_gasto\",\n  \"periodo_comparativo\": 3,\n  \"pergunta\": {{ $json.pergunta }} \n}\n","options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[1584,-704],"id":"6140b614-29eb-4f22-8302-bc29c416569b","name":"Interpretar pergunta"},{"parameters":{"operation":"executeQuery","query":"{{$json.query}}"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[2224,-704],"id":"851b7a14-2f0d-433a-b985-1ed4ecf31654","name":"Executar Query","alwaysOutputData":true,"credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"jsCode":"let filtros;\ntry {\n  if (typeof $json === 'object' && $json.output) {\n    filtros = JSON.parse($json.output);\n  } else {\n    filtros = $json;\n  }\n} catch (e) {\n  console.log('‚ùå Erro ao parsear filtros:', e);\n  filtros = {};\n}\n\n// === L√ìGICA DE PER√çODO ===\nconst now = new Date();\nlet mesInicio, mesFim;\nif (filtros.mes_inicio && filtros.mes_fim) {\n  mesInicio = filtros.mes_inicio;\n  mesFim = filtros.mes_fim;\n} else {\n  const fim = new Date(now);\n  const inicio = new Date(now);\n  inicio.setMonth(inicio.getMonth() - 2);\n  mesInicio = `${inicio.getFullYear()}-${String(inicio.getMonth() + 1).padStart(2, '0')}`;\n  mesFim = `${fim.getFullYear()}-${String(fim.getMonth() + 1).padStart(2, '0')}`;\n}\n\n// === ESCOLHA DE QUERY CONFORME M√âTRICA ===\nlet query;\n\nif (filtros.metrica === 'total_gasto') {\n  // üí∞ Consulta agregada (quanto gastamos)\n  query = `\n    SELECT \n      r.[Tipo_Custo],\n      FORMAT(CONVERT(date, '01/' + r.[Mes_ref_folha], 103), 'yyyy-MM') AS Mes,\n      SUM(r.[Valor]) AS Total_Gasto\n    FROM [vw_Rubricas_Classificadas] r\n    WHERE 1=1\n  `;\n\n  // Filtros din√¢micos\n  if (filtros.tipo_custo && filtros.tipo_custo !== 'todas')\n    query += ` AND r.[Tipo_Custo] = '${filtros.tipo_custo.replace(/'/g, \"''\")}'`;\n\n  query += ` AND FORMAT(CONVERT(date, '01/' + r.[Mes_ref_folha], 103), 'yyyy-MM') BETWEEN '${mesInicio}' AND '${mesFim}'`;\n\n  // Group By\n  query += `\n    GROUP BY r.[Tipo_Custo], FORMAT(CONVERT(date, '01/' + r.[Mes_ref_folha], 103), 'yyyy-MM')\n    ORDER BY Mes DESC;\n  `;\n} else {\n  // üìã Consulta detalhada (para outras m√©tricas)\n  query = `\n    SELECT TOP 1000\n      REPLACE(REPLACE(REPLACE(c.[CPF], '.', ''), '-', ''), ' ', '') AS CPF_Limpo,\n      c.[Nome], c.[Cargo], c.[Departamento], c.[Centro_de_Custo],\n      c.[Sal√°rio], c.[Vale_Refei√ß√£o], c.[Nome_da_Empresa], c.[√Årea],\n      r.[C√≥digo_Rubrica], r.[Descri√ß√£o_Rubrica], r.[Descri√ß√£o_Natureza_Rubrica],\n      r.[Tipo_Custo], r.[Valor], r.[Mes_ref_folha]\n    FROM [RhTech_fake_Colaboradores] c\n    LEFT JOIN [vw_Rubricas_Classificadas] r\n      ON REPLACE(REPLACE(REPLACE(c.[CPF], '.', ''), '-', ''), ' ', '') =\n         REPLACE(REPLACE(REPLACE(r.[CPF], '.', ''), '-', ''), ' ', '')\n    WHERE 1=1\n  `;\n\n  if (filtros.tipo_custo && filtros.tipo_custo !== 'todas')\n    query += ` AND r.[Tipo_Custo] = '${filtros.tipo_custo.replace(/'/g, \"''\")}'`;\n  \n  query += ` AND FORMAT(CONVERT(date, '01/' + r.[Mes_ref_folha], 103), 'yyyy-MM') BETWEEN '${mesInicio}' AND '${mesFim}'`;\n\n  query += ` ORDER BY r.[Mes_ref_folha] DESC, c.[Nome], r.[C√≥digo_Rubrica];`;\n}\n\nconsole.log('‚úÖ Query gerada:', query);\nconsole.log('üìä Filtros recebidos:', filtros);\nconsole.log('üóìÔ∏è Per√≠odo:', mesInicio, '‚Üí', mesFim);\n\nreturn [{ json: { query, filtrosAplicados: filtros } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2000,-704],"id":"9a62cafe-7ea8-44cd-8639-da532a293f9a","name":"Criar Query"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[2672,-480],"id":"8f321671-8d20-47df-a15e-130f79cac433","name":"OpenRouter Chat Model1","credentials":{"openRouterApi":{"id":"o1ywdYlH64cgqSMT","name":"OpenRouter account"}}},{"parameters":{"promptType":"define","text":"=### Dia Atual: {{ $now.weekdayLong }},{{ $now.format('dd/MM/yyyy') }},{{ $now.hour.toString().padStart(2, '0') }}:{{ $now.minute.toString().padStart(2, '0')}}\n\nVoc√™ √© a Mindy, diretora de RH virtual. \nRecebeu o resultado de uma consulta SQL com dados reais da folha e deve explicar de forma clara, curta (m√°x. 400 caracteres) e em tom profissional.\n\n**CONTEXTO IMPORTANTE:**\n- A pergunta do usu√°rio foi: \"{{ $json.pergunta }}\"\n- A consulta SEMPRE retorna os √∫ltimos 3 meses (per√≠odo completo) para an√°lise comparativa\n- Filtros aplicados: {{ JSON.stringify($json.filtros, null, 2) }}\n- Dados da consulta: {{ JSON.stringify($json.resultados, null, 2) }}\n\nINTERPRETA√á√ÉO DOS DADOS\n- Os dados podem ter estruturas como:\n  [{ \"Mes\": \"2025-10\", \"Total_Gasto\": 11783464.59 }] ‚Üí an√°lise de total gasto por m√™s.\n\n  [{ \"Departamento\": \"TI\", \"Valor\": 5400 }, ...] ‚Üí an√°lise por departamento, √°rea ou cargo.\n\n  [] ‚Üí nenhum resultado.\n\nRegras:\n- Sempre mencione o m√™s e o per√≠odo comparativo:\n  + Se o usu√°rio perguntar um m√™s espec√≠fico, compare com o total dos √∫ltimos 3 meses (incluindo esse).\n  + Se n√£o especificar m√™s, apresente o total dos √∫ltimos 3 meses.\n- Foque na an√°lise comparativa e tend√™ncias\n- Sempre mencione o m√™s e, se houver, o departamento.\n- Para m√©tricas num√©ricas, arredonde valores e formate em reais (R$ 1.234,00).\n- Se houver mais de 1 linha, resuma com o total e os 3 primeiros destaques (ranking).\n- N√£o repita o SQL, nem explique o processo t√©cnico.\n- Se n√£o houver resultado, diga: ‚ÄúN√£o encontrei registros para esse filtro.‚Äù\n\nExemplo:\nEntrada:\n[\n  {\"Departamento\": \"Opera√ß√µes\", \"Valor\": 42000},\n  {\"Departamento\": \"Vendas\", \"Valor\": 27000}\n]\n\nSa√≠da:\n\"Em setembro/2025, o maior gasto foi em Opera√ß√µes (R$ 42 mil), seguido por Vendas (R$ 27 mil).\"\n\nEntrada:\n[\n  {\"Mes\": \"out/2025\", \"Departamento\": \"TI\", \"Valor\": 6800},\n  {\"Mes\": \"out/2025\", \"Departamento\": \"Opera√ß√µes\", \"Valor\": 5100},\n  {\"Mes\": \"out/2025\", \"Departamento\": \"Comercial\", \"Valor\": 3300},\n  {\"Periodo\": \"ago-out/2025\", \"Total\": 15200}\n]\n\nSa√≠da:\n‚ÄúEm out/2025, o gasto total foi de R$ 8,4 mil, comparado a R$ 15,2 mil no per√≠odo de ago a out/2025. Principais √°reas: TI (R$ 6,8 mil), Opera√ß√µes (R$ 5,1 mil) e Comercial (R$ 3,3 mil).‚Äù","options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[2672,-704],"id":"0848e062-dfca-4083-beed-246caae858a6","name":"Analisar e Gerar Resposta"},{"parameters":{"assignments":{"assignments":[{"id":"4545f892-fbda-4554-bcdf-29a5962450b1","name":"pergunta","value":"Quanto gastamos com o MKT m√™s passado?","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-96,-912],"id":"a6a4abe3-9d76-48b9-b2af-39ddee8293d0","name":"Edit Fields"},{"parameters":{"operation":"executeQuery","query":"SELECT DISTINCT\n  [C√≥digo_Rubrica],\n  [Descri√ß√£o_Rubrica],\n  [Descri√ß√£o_Natureza_Rubrica]\nFROM [RhTech_fake_Rubricas]\nORDER BY\n  [C√≥digo_Rubrica],\n  [Descri√ß√£o_Rubrica],\n  [Descri√ß√£o_Natureza_Rubrica];\n"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[2176,-1104],"id":"7d35369c-391b-453d-b43c-677e7a02d8a5","name":"Executar Query1","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"operation":"executeQuery","query":"SELECT DISTINCT\n    --[Cargo]\n    --[Departamento]\n    --[Centro_de_Custo]\n    --[√Årea]\n    [Nome_da_Empresa]\nFROM [RhTech_fake_Colaboradores]\n"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[1968,-1104],"id":"4cafd7a0-4bd2-4d4f-ac82-606241c5d1c9","name":"Executar Query2","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"documentId":{"__rl":true,"value":"1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0","mode":"list","cachedResultName":"depara_rubricas_folha_pagamento","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"rubricas","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit#gid=0"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[704,-1168],"id":"9a141b17-987f-4744-beca-8c36092dd5c4","name":"rubricas","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"documentId":{"__rl":true,"value":"1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0","mode":"list","cachedResultName":"depara_rubricas_folha_pagamento","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":1086466239,"mode":"list","cachedResultName":"empresas","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit#gid=1086466239"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[704,-992],"id":"56fe9830-f183-4a3e-b61b-5096b21be991","name":"empresas","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"documentId":{"__rl":true,"value":"1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0","mode":"list","cachedResultName":"depara_rubricas_folha_pagamento","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":346942308,"mode":"list","cachedResultName":"areas","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit#gid=346942308"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[704,-816],"id":"47359f26-64c6-433c-9163-05d5be7ba5f7","name":"areas","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"documentId":{"__rl":true,"value":"1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0","mode":"list","cachedResultName":"depara_rubricas_folha_pagamento","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":761659075,"mode":"list","cachedResultName":"departamentos","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit#gid=761659075"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[704,-640],"id":"c4884671-5dd9-4ce7-93ca-c0c4bd780a87","name":"departamentos","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"documentId":{"__rl":true,"value":"1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0","mode":"list","cachedResultName":"depara_rubricas_folha_pagamento","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":1934165408,"mode":"list","cachedResultName":"centro_de_custo","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit#gid=1934165408"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[704,-464],"id":"de4972a1-836e-44ca-97f4-62f48c7a72ea","name":"centro_de_custo","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"documentId":{"__rl":true,"value":"1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0","mode":"list","cachedResultName":"depara_rubricas_folha_pagamento","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":1112723933,"mode":"list","cachedResultName":"cargos","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1leHKDnmforhDH0-mHFkwwYlmKg3vKwhZTf09BvhGqx0/edit#gid=1112723933"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[704,-304],"id":"306cd80a-30c9-40c3-aa21-e145962ed3d7","name":"cargos","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"numberInputs":6},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[1152,-768],"id":"ce4546fa-0b2a-46fd-9a88-ee51b5cbb72f","name":"Merge"},{"parameters":{"jsCode":"// --- Captura dados das planilhas (vindos dos nodes anteriores)\nconst parametros_folha = {\n  rubricas: $('rubricas').all().map(item => item.json),\n  empresas: $('empresas').all().map(item => item.json),\n  areas: $('areas').all().map(item => item.json),\n  departamentos: $('departamentos').all().map(item => item.json),\n  centro_de_custo: $('centro_de_custo').all().map(item => item.json),\n  cargos: $('cargos').all().map(item => item.json)\n};\n\n// --- Captura a pergunta (de Edit Fields ou Trigger)\nlet pergunta = null;\n\ntry {\n  pergunta =\n    $('Edit Fields').first().json.pergunta ||\n    $('trigger').first().json.pergunta ||\n    null;\n} catch (e) {\n  pergunta = null;\n}\n\n// --- Retorna JSON consolidado\nreturn [\n  {\n    json: {\n      pergunta,\n      parametros_folha\n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1360,-704],"id":"c9a01fd1-1626-4a7f-843e-d041e1c8dc58","name":"Code"},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[176,-736],"id":"cc3bd75e-c002-4437-b9f2-7f5ec4185a20","name":"No Operation, do nothing"},{"parameters":{"operation":"executeQuery","query":"CREATE OR ALTER VIEW vw_Rubricas_Classificadas AS\nSELECT \n    r.[C√≥digo_Rubrica],\n    r.[Descri√ß√£o_Rubrica],\n    r.[Descri√ß√£o_Natureza_Rubrica],\n    r.[CPF],\n    r.[Valor],\n    r.[Mes_ref_folha],\n    CASE \n        -- Horas Extras e Adicionais\n        WHEN r.[Descri√ß√£o_Rubrica] LIKE '%HORA%EXTRA%' OR \n             r.[Descri√ß√£o_Rubrica] LIKE '%BANCO%HORA%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%SOBREAVISO%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%ADICIONAL%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%NOTURNO%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%INSALUBRIDADE%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%PERICULOSIDADE%'\n        THEN 'Horas Extras e Adicionais'\n        \n        -- Sal√°rio\n        WHEN r.[Descri√ß√£o_Rubrica] LIKE '%SALARI%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%HORA%NORMA%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%DIAS%TRABALHADO%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%PRO-LABORE%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%QUEBRA%CAIXA%'\n        THEN 'Sal√°rio'\n        \n        -- Comiss√µes, Gratifica√ß√µes e Premia√ß√µes\n        WHEN r.[Descri√ß√£o_Rubrica] LIKE '%COMISS%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%GRATIFIC%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%PREMI%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%PRODUTIVIDADE%'\n        THEN 'Comiss√µes, Gratifica√ß√µes e Premia√ß√µes'\n        \n        -- F√©rias\n        WHEN r.[Descri√ß√£o_Rubrica] LIKE '%FERIAS%'\n        THEN 'F√©rias'\n        \n        -- 13¬∫ Sal√°rio\n        WHEN r.[Descri√ß√£o_Rubrica] LIKE '%13%SALARIO%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%13¬∫%'\n        THEN '13 sal√°rio'\n        \n        -- Rescis√£o\n        WHEN r.[Descri√ß√£o_Rubrica] LIKE '%RESCIS%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%AVISO%PREVIO%'\n        THEN 'Rescis√£o'\n        \n        -- Afastamento\n        WHEN r.[Descri√ß√£o_Rubrica] LIKE '%ATESTADO%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%LICENCA%'\n        THEN 'Afastamento'\n        \n        -- Descontos\n        WHEN r.[Descri√ß√£o_Rubrica] LIKE '%REEMBOLSO%' OR\n             r.[Descri√ß√£o_Rubrica] LIKE '%DESC%'\n        THEN 'Descontos'\n        \n        -- DSR\n        WHEN r.[Descri√ß√£o_Rubrica] LIKE '%DSR%'\n        THEN 'Horas Extras e Adicionais'\n        \n        ELSE 'Outros'\n    END AS Tipo_Custo\n    \nFROM [RhTech_fake_Rubricas] r;"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[1760,-1104],"id":"e37b73b1-beb2-4049-ab32-66f2c1b43e86","name":"Cria View com as Rubricas adequadas","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"numberInputs":6},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[1200,-2080],"id":"a7e47afa-adfb-405b-b702-d9c4c1c1a2f1","name":"Merge1"},{"parameters":{"jsCode":"// --- Captura dados das planilhas (vindos dos nodes anteriores)\nconst parametros_folha = {\n  rubricas: $('Buscar Rubricas Classificadas').all().map(item => item.json),\n  empresas: $('Buscar Empresas').all().map(item => item.json),\n  areas: $('Buscar √Åreas').all().map(item => item.json),\n  departamentos: $('Buscar Departamentos').all().map(item => item.json),\n  centro_de_custo: $('Buscar Centros de Custo').all().map(item => item.json),\n  cargos: $('Buscar Cargos').all().map(item => item.json)\n};\n\n// --- Captura a pergunta (de Edit Fields ou Trigger)\nlet pergunta = null;\n\ntry {\n  pergunta =\n    $('Definir Pergunta Manual').first().json.pergunta ||\n    $('Trigger').first().json.pergunta ||\n    null;\n} catch (e) {\n  pergunta = null;\n}\n\n// --- Retorna JSON consolidado\nreturn [\n  {\n    json: {\n      pergunta,\n      parametros_folha\n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1488,-2016],"id":"dbf2c410-f8df-49f9-b485-bb597b7b61e0","name":"Consolidar Par√¢metros e Pergunta"},{"parameters":{"operation":"executeQuery","query":"-- Buscar apenas tipos de custo √∫nicos (em vez de 300k registros)\nSELECT DISTINCT [Tipo_Custo] \nFROM vw_Rubricas_Classificadas \nWHERE [Tipo_Custo] IS NOT NULL \nORDER BY [Tipo_Custo];"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[688,-2624],"id":"fe1d0dba-ebfa-4aec-b9b8-0930f033d1da","name":"Buscar Rubricas Classificadas","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"operation":"executeQuery","query":"SELECT DISTINCT [Nome_da_Empresa] \nFROM [RhTech_fake_Colaboradores] \nWHERE [Nome_da_Empresa] IS NOT NULL \nORDER BY [Nome_da_Empresa];"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[688,-2400],"id":"2cefdb2d-c944-4e94-b0ca-cb2fee8b3e18","name":"Buscar Empresas","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"operation":"executeQuery","query":"SELECT DISTINCT [√Årea] \nFROM [RhTech_fake_Colaboradores] \nWHERE [√Årea] IS NOT NULL \nORDER BY [√Årea];\n"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[688,-2176],"id":"52f9261d-534c-4852-974e-4d6ddd5373b5","name":"Buscar √Åreas","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"operation":"executeQuery","query":"SELECT DISTINCT [Departamento] \nFROM [RhTech_fake_Colaboradores] \nWHERE [Departamento] IS NOT NULL \nORDER BY [Departamento];"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[688,-1968],"id":"34712d74-7a39-4f71-b20d-59fac43abc76","name":"Buscar Departamentos","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"operation":"executeQuery","query":"SELECT DISTINCT [Centro_de_Custo] \nFROM [RhTech_fake_Colaboradores] \nWHERE [Centro_de_Custo] IS NOT NULL \nORDER BY [Centro_de_Custo];"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[688,-1744],"id":"6923dd9f-5c21-446a-9715-7d37d64846ca","name":"Buscar Centros de Custo","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"operation":"executeQuery","query":"SELECT DISTINCT [Cargo] \nFROM [RhTech_fake_Colaboradores] \nWHERE [Cargo] IS NOT NULL \nORDER BY [Cargo];"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[688,-1520],"id":"71455db8-1e59-4c65-a512-e686f1eec5fd","name":"Buscar Cargos","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"assignments":{"assignments":[{"id":"4545f892-fbda-4554-bcdf-29a5962450b1","name":"pergunta","value":"Quanto gastamos de horas extras esse mes?","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-96,-1936],"id":"7a7b0731-49ff-45f8-a8c5-c9f70dca9962","name":"Definir Pergunta Manual"},{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[1824,-480],"id":"c34e27ac-b7db-4f90-9d5b-d5f060cdc07c","name":"Trigger"},{"parameters":{"operation":"executeQuery","query":"-- Buscar TODAS as tabelas dispon√≠veis (para ver o que existe)\nSELECT \n    TABLE_SCHEMA,\n    TABLE_NAME,\n    TABLE_TYPE\nFROM INFORMATION_SCHEMA.TABLES \nORDER BY TABLE_SCHEMA, TABLE_NAME;"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[2400,-1104],"id":"8f910e9c-a721-486a-8e73-4fe69cb6ab01","name":"Ver todas as tabelas no banco atual","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{},"type":"@n8n/n8n-nodes-langchain.toolCalculator","typeVersion":1,"position":[2864,-480],"id":"7322ac87-3056-45a5-a06d-0ccf3e6abf18","name":"Calculator"},{"parameters":{"jsCode":"// Processar os resultados otimizados\nconst rawData = $('Buscar Parametros Otimizados').first().json;\n\nconst parametros_folha = {\n  rubricas: JSON.parse(rawData.tipos_custo || '[]').map(tipo => ({ \n    Tipo_Custo: tipo.Tipo_Custo \n  })),\n  empresas: JSON.parse(rawData.empresas || '[]').map(emp => ({\n    Nome_da_Empresa: emp.Nome_da_Empresa\n  })),\n  areas: JSON.parse(rawData.areas || '[]').map(area => ({\n    √Årea: area.√Årea\n  })),\n  departamentos: JSON.parse(rawData.departamentos || '[]').map(depto => ({\n    departamentos: depto.Departamento\n  })),\n  centro_de_custo: JSON.parse(rawData.centros_custo || '[]').map(cc => ({\n    Centro_de_Custo: cc.Centro_de_Custo\n  })),\n  cargos: JSON.parse(rawData.cargos || '[]').map(cargo => ({\n    cargos: cargo.Cargo\n  }))\n};"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[336,-1360],"id":"20be992b-fcd8-49fc-989e-6c662cd5e911","name":"Consolidar Par√¢metros e Pergunta1"},{"parameters":{"operation":"executeQuery","query":"SELECT \n  (SELECT DISTINCT [Tipo_Custo] FROM vw_Rubricas_Classificadas WHERE [Tipo_Custo] IS NOT NULL FOR JSON PATH) as tipos_custo,\n  (SELECT DISTINCT [Nome_da_Empresa] FROM [RhTech_fake_Colaboradores] WHERE [Nome_da_Empresa] IS NOT NULL FOR JSON PATH) as empresas,\n  (SELECT DISTINCT [√Årea] FROM [RhTech_fake_Colaboradores] WHERE [√Årea] IS NOT NULL FOR JSON PATH) as areas,\n  (SELECT DISTINCT [Departamento] FROM [RhTech_fake_Colaboradores] WHERE [Departamento] IS NOT NULL FOR JSON PATH) as departamentos,\n  (SELECT DISTINCT [Centro_de_Custo] FROM [RhTech_fake_Colaboradores] WHERE [Centro_de_Custo] IS NOT NULL FOR JSON PATH) as centros_custo,\n  (SELECT DISTINCT [Cargo] FROM [RhTech_fake_Colaboradores] WHERE [Cargo] IS NOT NULL FOR JSON PATH) as cargos;"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[128,-1376],"id":"4b18173c-c124-438a-8c79-e79e1358871f","name":"Buscar Parametros Otimizados","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"operation":"executeQuery","query":"SELECT \n    column_name,\n    data_type,\n    character_maximum_length,\n    is_nullable,\n    column_default\nFROM information_schema.columns\nWHERE table_name = 'vw_Rubricas_Classificadas'\nORDER BY ordinal_position;\n"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[2608,-1104],"id":"0fb85ebd-342b-4ee0-8251-3274b46f735a","name":"Estrutura da tabela","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"operation":"executeQuery","query":"SELECT TOP 10 *\nFROM vw_Rubricas_Classificadas\nWHERE FORMAT(CONVERT(date, '01/' + [Mes_ref_folha], 103), 'yyyy-MM') BETWEEN '2024-01' AND '2024-03'\nAND [Tipo_Custo] = 'Horas Extras e Adicionais';\n"},"type":"n8n-nodes-base.microsoftSql","typeVersion":1.1,"position":[1168,-2560],"id":"fc0ee28f-2eae-48c7-ade3-1fc59123795e","name":"Buscar Rubricas Classificadas1","credentials":{"microsoftSql":{"id":"WFNrTNj4QqdUC7Gb","name":"Azure - BMS"}}},{"parameters":{"jsCode":"// === 1Ô∏è‚É£ Agrupa todos os resultados vindos do Executar Query ===\nconst resultados = items.map(item => item.json);\n\n// === 2Ô∏è‚É£ Extrai a pergunta e filtros do n√≥ \"Interpretar pergunta\" ===\nlet data = {};\ntry {\n  data = JSON.parse($('Interpretar pergunta').item.json.output || '{}');\n} catch (e) {\n  console.log('‚ùå Erro ao parsear Interpretar pergunta:', e);\n  data = {};\n}\n\n// === 3Ô∏è‚É£ Retorna tudo junto ===\nreturn [{\n  json: {\n    pergunta: data.pergunta || null,\n    filtros: data,\n    resultados: resultados\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2448,-704],"id":"daa00c61-6b93-4eb3-84b5-73fc4051b69a","name":"Agrupar Resultados + Salvar pergunta"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"ca92c640-ddbe-49e0-b341-a71bf0ab64ac","leftValue":"Flag est√° presente","rightValue":"","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1856,-880],"id":"04e30f99-706a-4b72-85e3-cd4f40a8acb5","name":"If"},{"parameters":{"assignments":{"assignments":[{"id":"6d16f99f-2ad6-4533-b9bc-ae8a96ac4da6","name":"Manda de input pro fluxo principal reconduzir a conversa","value":"","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2128,-896],"id":"1205f5c5-d1e2-4cf6-a10a-429b726a3333","name":"Edit Fields1"}],"connections":{"trigger":{"main":[[]]},"OpenRouter Chat Model":{"ai_languageModel":[[{"node":"Interpretar pergunta","type":"ai_languageModel","index":0}]]},"Interpretar pergunta":{"main":[[{"node":"Criar Query","type":"main","index":0}]]},"Executar Query":{"main":[[{"node":"Agrupar Resultados + Salvar pergunta","type":"main","index":0}]]},"Criar Query":{"main":[[{"node":"Executar Query","type":"main","index":0}]]},"OpenRouter Chat Model1":{"ai_languageModel":[[{"node":"Analisar e Gerar Resposta","type":"ai_languageModel","index":0}]]},"Edit Fields":{"main":[[{"node":"No Operation, do nothing","type":"main","index":0}]]},"Executar Query1":{"main":[[]]},"rubricas":{"main":[[{"node":"Merge","type":"main","index":0}]]},"empresas":{"main":[[{"node":"Merge","type":"main","index":1}]]},"areas":{"main":[[{"node":"Merge","type":"main","index":2}]]},"departamentos":{"main":[[{"node":"Merge","type":"main","index":3}]]},"centro_de_custo":{"main":[[{"node":"Merge","type":"main","index":4}]]},"cargos":{"main":[[{"node":"Merge","type":"main","index":5}]]},"Merge":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Interpretar pergunta","type":"main","index":0}]]},"No Operation, do nothing":{"main":[[{"node":"rubricas","type":"main","index":0},{"node":"empresas","type":"main","index":0},{"node":"areas","type":"main","index":0},{"node":"departamentos","type":"main","index":0},{"node":"centro_de_custo","type":"main","index":0},{"node":"cargos","type":"main","index":0}]]},"Merge1":{"main":[[{"node":"Consolidar Par√¢metros e Pergunta","type":"main","index":0}]]},"Buscar Rubricas Classificadas":{"main":[[{"node":"Merge1","type":"main","index":0}]]},"Buscar Empresas":{"main":[[{"node":"Merge1","type":"main","index":1}]]},"Buscar √Åreas":{"main":[[{"node":"Merge1","type":"main","index":2}]]},"Buscar Departamentos":{"main":[[{"node":"Merge1","type":"main","index":3}]]},"Buscar Centros de Custo":{"main":[[{"node":"Merge1","type":"main","index":4}]]},"Buscar Cargos":{"main":[[{"node":"Merge1","type":"main","index":5}]]},"Definir Pergunta Manual":{"main":[[{"node":"Buscar Rubricas Classificadas","type":"main","index":0},{"node":"Buscar Empresas","type":"main","index":0},{"node":"Buscar √Åreas","type":"main","index":0},{"node":"Buscar Departamentos","type":"main","index":0},{"node":"Buscar Centros de Custo","type":"main","index":0},{"node":"Buscar Cargos","type":"main","index":0}]]},"Trigger":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"Calculator":{"ai_tool":[[{"node":"Analisar e Gerar Resposta","type":"ai_tool","index":0}]]},"Buscar Parametros Otimizados":{"main":[[{"node":"Consolidar Par√¢metros e Pergunta1","type":"main","index":0}]]},"Agrupar Resultados + Salvar pergunta":{"main":[[{"node":"Analisar e Gerar Resposta","type":"main","index":0}]]},"If":{"main":[[{"node":"Edit Fields1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Trigger":[{"json":{}}]},"versionId":"1cc641d0-7cd6-4ce1-9ab3-e080d46f9712","triggerCount":0,"tags":[]}