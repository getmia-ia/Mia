{"createdAt":"2025-11-10T20:41:56.989Z","updatedAt":"2025-11-21T17:05:58.958Z","id":"qOYMG7Jl1k2AsoMV","name":"Finamob - 5.4 - SDR Luana IA - Cobran√ßa de retorno","active":true,"isArchived":false,"nodes":[{"parameters":{"operation":"getAll","tableId":"finamob-historico_mensagens","filters":{"conditions":[{"keyName":"telefone","condition":"eq","keyValue":"={{ $json.telefone }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[816,960],"id":"de9258b2-5aad-4fec-bb1f-a089abb6ac60","name":"Pega hist√≥rico de mensagens","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"4MbqyW9T081a3o7d","name":"Finamob"}}},{"parameters":{"jsCode":"// Ordena as mensagens pela data\nitems.sort((a, b) => new Date(a.json.created_at) - new Date(b.json.created_at));\n\nfunction formatarData(isoDate) {\n  const d = new Date(isoDate);\n  const dia = String(d.getDate()).padStart(2, '0');\n  const mes = String(d.getMonth() + 1).padStart(2, '0');\n  const ano = d.getFullYear();\n  return `${dia}/${mes}/${ano}`;\n}\n\nconst historico = [];\n\nfor (const item of items) {\n  const row = item.json;\n  const dataFormatada = formatarData(row.created_at);\n\n  if (row.mensagem_usuario && row.mensagem_usuario.trim() !== \"\") {\n    historico.push(`${dataFormatada} - Usu√°rio: ${row.mensagem_usuario.trim()}`);\n  }\n\n  if (row.mensagem_agente && row.mensagem_agente.trim() !== \"\") {\n    historico.push(`${dataFormatada} - Agente: ${row.mensagem_agente.trim()}`);\n  }\n}\n\nreturn [\n  {\n    json: {\n      historico_conversa: historico.join(\"\\n\\n\")\n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1040,960],"id":"8ad8755b-0548-4ad9-9978-7013685a1a94","name":"Formata hist√≥rico de mensagens"},{"parameters":{"mode":"combine","combineBy":"combineByPosition","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[1312,784],"id":"5b71e3e8-6966-4c7f-a62a-3235b956408e","name":"Merge"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v22.0/869722152886578/messages","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"=\n{\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.telefoneAjustado }}\",\n  \"type\": \"text\",\n  \"text\": {\n    \"preview_url\": false,\n    \"body\": \"{{ $json.mensagem }}\"\n  }\n}\n","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2608,336],"id":"5a976c78-866a-4846-9ec6-47888f91aa60","name":"HTTP Request1","retryOnFail":true,"credentials":{"httpBearerAuth":{"id":"W8jSHgF1bru0lIPY","name":"whatsapp"}},"disabled":true},{"parameters":{"tableId":"finamob-historico_mensagens","fieldsUi":{"fieldValues":[{"fieldId":"mensagem_usuario","fieldValue":"="},{"fieldId":"mensagem_agente","fieldValue":"={{ $('Estrutura√ß√£o do JSON de sa√≠da').item.json.mensagem_template }}"},{"fieldId":"telefone","fieldValue":"={{ $('Edit Fields').item.json.telefone }}"},{"fieldId":"nome_usuario","fieldValue":"={{ $('Edit Fields').item.json.name }}"},{"fieldId":"message_type","fieldValue":"text"},{"fieldId":"ativo","fieldValue":"true"},{"fieldId":"nome_app","fieldValue":"SDR-EMI"},{"fieldId":"id_usuario","fieldValue":"={{ $('Pega hist√≥rico de mensagens').first().json.id_usuario }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[3472,1024],"id":"2c075320-bb80-49c0-a45c-ac9cf9d93bed","name":"Cria Mensagem no Supabase","credentials":{"supabaseApi":{"id":"4MbqyW9T081a3o7d","name":"Finamob"}},"onError":"continueRegularOutput","notes":"Este fluxo √© de propriedade da FORMA√á√ÉO AGENTES DE IA COM N8N -BY RICNEVES"},{"parameters":{"resource":"messages-api","instanceName":"social-media-finamob-oficial","remoteJid":"=5511992486507","messageText":"=Follow up realizado com {{ $('Estrutura√ß√£o do JSON de sa√≠da').item.json.var_1 }}\n\n{{ $('Edit Fields').item.json.url }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[3184,768],"id":"bc9d0a69-3aaa-4130-aa3c-9e57dced00f9","name":"Confirma√ß√£o Primeiro Contato1","credentials":{"evolutionApi":{"id":"4JfTThlwBUF4KuNE","name":"Evolution - social-media-finamob-oficial"}},"onError":"continueErrorOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b5296455-2292-4b5d-8e75-0b156471af30","leftValue":"={{ $json.messages[0].message_status }}","rightValue":"accepted","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2688,784],"id":"19282ff3-acb4-48bb-9297-166bd2cf53cf","name":"If1"},{"parameters":{"resource":"messages-api","instanceName":"social-media-finamob-oficial","remoteJid":"=5511992486507","messageText":"=Erro ao realizar Follow up com {{ $('Estrutura√ß√£o do JSON de sa√≠da').item.json.var_1 }}\n\n{{ $('Edit Fields').item.json.url }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[2960,976],"id":"81f3c2c3-d9da-480b-b461-160b2ce08285","name":"Aviso de erro ao disparar mensagem1","credentials":{"evolutionApi":{"id":"4JfTThlwBUF4KuNE","name":"Evolution - social-media-finamob-oficial"}},"onError":"continueErrorOutput"},{"parameters":{"rule":{"interval":[{"field":"cronExpression","expression":"0 9,19 * * *"}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-496,752],"id":"d5a2a389-f470-4acc-ad04-63da757644c6","name":"Schedule Trigger1"},{"parameters":{"promptType":"define","text":"=### Dia Atual: {{ $now.weekdayLong }},{{ $now.format('dd/MM/yyyy') }},{{ $now.hour.toString().padStart(2, '0') }}:{{ $now.minute.toString().padStart(2, '0')}}\n\nVoc√™ √© a **Luana**, respons√°vel pelo comercial da Escola do Mercado Imobili√°rio.\nA partir de agora, **voc√™ N√ÉO escreve mensagens livres**.\nSeu trabalho √© **analisar o hist√≥rico de conversa do lead e selecionar QUAL template oficial do WhatsApp deve ser usado**, conforme as regras abaixo.\n\nSeu trabalho √©:\nAnalisar o hist√≥rico de conversa.\nIdentificar qual grupo de mensagens se aplica (reuni√£o, pagamento, reengajamento).\nDetectar quais templates j√° foram enviados antes pelo hist√≥rico.\nEscolher um template apropriado que AINDA N√ÉO FOI USADO.\nSe todos os templates do grupo j√° foram usados, escolha o menos recentemente usado.\n\nAs mensagens correspondentes a cada template s√£o:\n- reuniao_interesse_1:\nOi {{ $json.name }}! Tudo bem? Vi que voc√™ demonstrou interesse na imers√£o, mas ainda n√£o marcamos nossa conversa. Que tal alinharmos um hor√°rio r√°pido para eu te explicar os detalhes e tirar suas d√∫vidas? Me diz qual hor√°rio funciona melhor para voc√™.\n\n- reuniao_convite_reforco:\nOl√° {{ $json.name }}! S√≥ passando para refor√ßar o convite para nossa conversa sobre a imers√£o. √â um papo bem r√°pido para te mostrar os pontos principais e te ajudar a avan√ßar. Posso te enviar algumas op√ß√µes de hor√°rio?\n\n- reuniao_continuar_fluxo:\nOi {{ $json.name }}, retomando nossa √∫ltima conversa, queria ver se podemos agendar aquele bate-papo sobre a imers√£o. Assim eu te explico direitinho como funciona e tiro qualquer d√∫vida. Me diz qual hor√°rio fica melhor pra voc√™.\n\n- reuniao_avancar:\nOl√° {{ $json.name }}! Caso ainda esteja avaliando a imers√£o, posso te explicar tudo em uma conversa r√°pida. √â bem mais f√°cil quando alinhamos por voz. Me fala qual hor√°rio funciona para voc√™ e eu organizo aqui.\n\n- pagamento_verificacao_1:\nOi {{ $json.name }}! S√≥ passando para saber se voc√™ conseguiu avan√ßar com o pagamento da imers√£o. Se quiser, posso te ajudar a resolver qualquer detalhe e facilitar essa etapa. Quer que eu te envie alguns hor√°rios para conversarmos?\n\n- pagamento_acompanhamento:\nOi {{ $json.name }}, tudo bem? Caso tenha travado em alguma parte ao tentar finalizar a inscri√ß√£o, posso te acompanhar passo a passo para garantir que d√™ tudo certo. Quer agendar um hor√°rio r√°pido?\n\n- pagamento_retorno_suave:\nOi {{ $json.name }}! Vi que voc√™ tinha pedido o link de pagamento da imers√£o e resolvi passar para saber se deu tudo certo por a√≠. Se quiser, posso te ajudar a finalizar. Precisa de ajuda com alguma coisa?\n\n- pagamento_reengajamento:\nOl√°, {{ $json.name }}, passando novamente para ver se posso facilitar sua inscri√ß√£o na imers√£o. Se preferir, podemos conversar alguns minutinhos e eu te ajudo a concluir tudo sem complica√ß√µes. Qual hor√°rio funciona melhor para voc√™?\n\n- reengajamento_suave_4:\n\"Oi {{ $json.name }}! Como n√£o consegui falar com voc√™ antes, quis voltar para ver se posso te ajudar com alguma d√∫vida sobre a imers√£o.\nSe preferir, podemos conversar. Quer que eu te mande os hor√°rios?\"\n\n- reengajamento_novo_angulo_1:\n\"Ol√° {{ $json.name }}! Voltei porque n√£o queria que voc√™ perdesse a chance de participar da imers√£o. Caso tenha ficado alguma d√∫vida, posso explicar tudo de forma simples em uma conversa r√°pida. Quer que eu te mande algumas op√ß√µes de hor√°rio?\"\n\n- continuar_fluxo_segunda:\n\"Oi, {{ $json.name }}. Tudo bem? \n\nEspero que tenha tido um excelente final de semana. Est√° por a√≠ para continuarmos\"\n\n- continuar_fluxo_vacuo:\n\"Opa {{ $json.name }}, fiquei no v√°cuo, t√° por a√≠?\"\n\n- continuar_fluxo_botao:\n\"Ol√°, *! Tudo bem? T√¥ te mandando essa mensagem rapidinha s√≥ pra entender se faz sentido eu continuar te chamando aqui. Voc√™ ainda tem interesse na imers√£o ou prefiro encerrar seu atendimento por agora?\"\n\n---\n\n# üìå **DADOS RECEBIDOS**\n\n* Nome do lead: **{{ $json.name }}**\n* Hist√≥rico completo: **{{ $json.historico_conversa }}**\n\nRetorne apenas um JSON indicando **qual template usar** e confirmando a vari√°vel 1 (nome).\n\n---\n\n# üß† **REGRAS DE DECIS√ÉO PARA ESCOLHER O TEMPLATE**\n\n### **1. Quando usar templates de REUNI√ÉO**\n\nUse um dos templates abaixo quando:\n\n* o lead demonstrou interesse, mas **n√£o agendou**\n* ainda n√£o existe link de pagamento na conversa\n* h√° continuidade natural do fluxo pr√©-pagamento\n* est√° no in√≠cio da conversa\n\nTemplates dispon√≠veis:\n\n* `reuniao_interesse_1`\n* `reuniao_continuar_fluxo`\n* `reuniao_convite_reforco`\n* `reuniao_avancar`\n\n**Como escolher entre eles:**\n\n* **Primeiro follow-up:** `reuniao_interesse_1`\n* **Lead respondeu antes, mas parou:** `reuniao_continuar_fluxo`\n* **Refor√ßo simples depois de 1‚Äì2 tentativas:** `reuniao_convite_reforco`\n* **Lead ainda avaliando, mas sem decis√£o:** `reuniao_avancar`\n\n---\n\n### **2. Quando usar templates de PAGAMENTO**\n\nUse quando:\n\n* o lead pediu link de pagamento\n* voc√™ enviou o link\n* o lead **n√£o pagou ainda**\n* o lead repetiu pedido de link\n* o pagamento est√° travado\n\nTemplates dispon√≠veis:\n\n* `pagamento_retorno_suave` (primeiro retorno p√≥s-envio)\n* `pagamento_verificacao_1` (verificar se avan√ßou)\n* `pagamento_acompanhamento` (quando o lead trava no processo)\n* `pagamento_reengajamento` (tentativas repetidas sem conclus√£o)\n\n---\n\n### **3. Quando usar templates de REENGAJAMENTO (sumiu / ignorou v√°rias tentativas)**\n\nUse quando:\n\n* j√° houve 3+ tentativas sem resposta, isto √©, tem mais de 3 mensagens seguidas s√≥ do \"Agente\" sem resposta do \"Usu√°rio\" \n* conversa esfriou\n* lead completamente ausente\n\nTemplates dispon√≠veis:\n\n* `reengajamento_suave_4`\n* `reengajamento_novo_angulo_1`\n* `continuar_fluxo_vacuo`\n* `continuar_fluxo_botao`\n\n**Como decidir:**\n\n* **Tentativas iniciais sem resposta:** `reengajamento_suave_4` ou `continuar_fluxo_vacuo`\n* **Muitas tentativas ignoradas:** `reengajamento_novo_angulo_1` ou `continuar_fluxo_botao`\n\n### **4. Se √© segunda-feira:\nUse quando:\n\n* O dia da semana for uma segunda-feira\n\nTemplates disponiveis:\n* `continuar_fluxo_segunda`\n\n---\n\n# ‚ùó **Regra cr√≠tica**\n\nSe houver link de pagamento no hist√≥rico e **nenhum registro de pagamento confirmado**, SEMPRE usar um template de **pagamento**, nunca de reuni√£o.\n\n---\nRegra anti-repeti√ß√£o (obrigat√≥ria)\n\nVoc√™ DEVE:\n‚úî Procurar no hist√≥rico se algum dos templates abaixo j√° foi enviado:\nreuniao_interesse_1\nreuniao_continuar_fluxo\nreuniao_convite_reforco\nreuniao_avancar\npagamento_retorno_suave\npagamento_verificacao_1\npagamento_acompanhamento\npagamento_reengajamento\nreengajamento_suave_4\nreengajamento_novo_angulo_1\n\nN√£o escolher nenhum template j√° presente no hist√≥rico.\nSe todos os templates daquele grupo j√° foram usados:\nEscolha o menos recentemente utilizado dentro do grupo.\n\n# üì§ **FORMATO DE RESPOSTA OBRIGAT√ìRIO (JSON)**\n\nRetorne **apenas**:\n\n{\n  \"template\": \"<nome_do_template_escolhido>\",\n  \"var_1\": \"{{ $json.name }}\",\n  \"telefoneAjustado\": {{ $json.telefoneAjustado }}\n}\n\nNenhum texto fora do JSON.\nNenhuma explica√ß√£o.\nNenhuma mensagem criada.\n\n---\n\n# ‚ö† **IMPORTANTE**\n\nVoc√™ **n√£o deve criar mensagens**.\nVoc√™ **n√£o deve reescrever textos dos templates**.\nVoc√™ apenas escolhe **qual template existente** deve ser usado.\n\n---","options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[1520,784],"id":"ae5e03eb-881d-443d-a2e7-4bd33dee9e03","name":"AI Agent"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[1520,1024],"id":"8f8b6d9f-096f-4ace-a15e-3a965feb35c8","name":"OpenRouter Chat Model","credentials":{"openRouterApi":{"id":"o1ywdYlH64cgqSMT","name":"OpenRouter account"}}},{"parameters":{"jsCode":"return items.map(item => {\n  let raw = item.json.output || \"\";\n  let cleaned = raw;\n\n  // 1. Remove blocos de c√≥digo tipo ```json ... ```\n  cleaned = cleaned.replace(/```json/gi, \"\");\n  cleaned = cleaned.replace(/```/g, \"\");\n\n  cleaned = cleaned.trim();\n\n  let respostaIA = {};\n\n  // 2. Parse seguro\n  try {\n    respostaIA = JSON.parse(cleaned);\n  } catch (e) {\n    respostaIA = {\n      template: \"erro\",\n      var_1: item.json.name || \"\",\n      telefoneAjustado: item.json.telefoneAjustado || \"\",\n    };\n  }\n\n  // 3. Mapa de templates oficiais\n  const templates = {\n    reuniao_interesse_1:\n      \"Oi *{{1}}*! Tudo bem? \\n\\n Vi que voc√™ demonstrou interesse na imers√£o, mas ainda n√£o marcamos nossa conversa. \\n\\n Que tal alinharmos um hor√°rio r√°pido para eu te explicar os detalhes e tirar suas d√∫vidas? Me diz qual hor√°rio funciona melhor para voc√™.\",\n\n    reuniao_convite_reforco:\n      \"Ol√° {{1}}! \\n\\n S√≥ passando para refor√ßar o convite para nossa conversa sobre a imers√£o. √â um papo bem r√°pido para te mostrar os pontos principais e te ajudar a avan√ßar. \\n\\n Posso te enviar algumas op√ß√µes de hor√°rio?\",\n\n    reuniao_continuar_fluxo:\n      \"Oi {{1}}, retomando nossa √∫ltima conversa, queria ver se podemos agendar aquele bate-papo sobre a imers√£o. \\n\\n Assim eu te explico direitinho como funciona e tiro qualquer d√∫vida. Me diz qual hor√°rio fica melhor pra voc√™.\",\n\n    reuniao_avancar:\n      \"Ol√° {{1}}! \\n\\n Caso ainda esteja avaliando a imers√£o, posso te explicar tudo em uma conversa r√°pida. √â bem mais f√°cil quando alinhamos por voz. Me fala qual hor√°rio funciona para voc√™ e eu organizo aqui.\",\n\n    pagamento_verificacao_1:\n      \"Oi {{1}}! \\n\\n S√≥ passando para saber se voc√™ conseguiu avan√ßar com o pagamento da imers√£o. Se quiser, posso te ajudar a resolver qualquer detalhe e facilitar essa etapa. \\n\\n Quer que eu te envie alguns hor√°rios para conversarmos?\",\n\n    pagamento_acompanhamento:\n      \"Oi {{1}}, tudo bem? \\n\\n Caso tenha travado em alguma parte ao tentar finalizar a inscri√ß√£o, posso te acompanhar passo a passo para garantir que d√™ tudo certo. \\n\\n Quer agendar um hor√°rio r√°pido?\",\n\n    pagamento_retorno_suave:\n      \"Oi {{1}}! \\n\\n Vi que voc√™ tinha pedido o link de pagamento da imers√£o e resolvi passar para saber se deu tudo certo por a√≠. Se quiser, posso te ajudar a finalizar. \\n\\n Precisa de ajuda com alguma coisa?\",\n\n    pagamento_reengajamento:\n      \"Ol√°, {{1}}, passando novamente para ver se posso facilitar sua inscri√ß√£o na imers√£o. \\n\\n Se preferir, podemos conversar alguns minutinhos e eu te ajudo a concluir tudo sem complica√ß√µes. Qual hor√°rio funciona melhor para voc√™?\",\n\n    reengajamento_suave_4:\n      \"Oi {{1}}! \\n\\n Como n√£o consegui falar com voc√™ antes, quis voltar para ver se posso te ajudar com alguma d√∫vida sobre a imers√£o. \\n\\n Se preferir, podemos conversar. Quer que eu te mande os hor√°rios?\",\n\n    reengajamento_novo_angulo_1:\n      \"Ol√° *{{1}}*! \\n\\n Voltei porque n√£o queria que voc√™ perdesse a chance de participar da imers√£o. \\n\\n Caso tenha ficado alguma d√∫vida, posso explicar tudo de forma simples em uma conversa r√°pida. Quer que eu te mande algumas op√ß√µes de hor√°rio?\",\n\n    continuar_fluxo_segunda:\n      \"Oi, *{{1}}*. Tudo bem? Espero que tenha tido um excelente final de semana. Est√° por a√≠ para continuarmos nossa conversa?\",\n\n    continuar_fluxo_vacuo:\n      \"Opa *{{1}}*, fiquei no v√°cuo, t√° por a√≠?\",\n\n    continuar_fluxo_botao:\n      \"Ol√°, *{{1}}*! Tudo bem? \\n\\n T√¥ te mandando essa mensagem rapidinha s√≥ pra entender se faz sentido eu continuar te chamando aqui. \\n\\n Voc√™ ainda tem interesse na imers√£o ou prefere encerrar seu atendimento por agora?\"\n\n  };\n\n  const templateName = respostaIA.template;\n  const textoTemplate = templates[templateName] || \"Template n√£o encontrado.\";\n\n  // 4. Substitui {{1}} pelo nome do lead\n  const mensagemFinal = textoTemplate.replace(\"{{1}}\", respostaIA.var_1);\n\n  // 5. Retorno final do node\n  return {\n    json: {\n      ...respostaIA,\n      mensagem_template: mensagemFinal\n    }\n  };\n});\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1984,784],"id":"b4436d91-aca0-4372-a1bb-bf74a204c761","name":"Estrutura√ß√£o do JSON de sa√≠da","onError":"continueRegularOutput"},{"parameters":{"resource":"databasePage","operation":"getAll","databaseId":{"__rl":true,"value":"287c103b-58ba-8057-bd3f-e2b83606d543","mode":"list","cachedResultName":"Leads","cachedResultUrl":"https://www.notion.so/287c103b58ba8057bd3fe2b83606d543"},"returnAll":true,"filterType":"manual","matchType":"allFilters","filters":{"conditions":[{"key":"Etapa|status","condition":"equals","statusValue":"Mensagem encaminhada"}]},"options":{}},"type":"n8n-nodes-base.notion","typeVersion":2.2,"position":[-288,752],"id":"7a47db2b-c178-400b-b88b-17978f615dcf","name":"Pega os leads do Notion","credentials":{"notionApi":{"id":"LULy5XEh4CoWDiW9","name":"finamob-emi"}}},{"parameters":{"jsCode":"function ajustarTelefone(raw) {\n  if (!raw) return null;\n\n  let t = raw.toString();\n\n  // Remove tudo que n√£o √© n√∫mero\n  t = t.replace(/\\D/g, \"\");\n\n  // Se vier com 11 d√≠gitos (celular padr√£o)\n  if (t.length === 11) {\n    t = \"55\" + t;\n  }\n\n  // Se vier com 10 d√≠gitos (fixo)\n  if (t.length === 10) {\n    t = \"55\" + t;\n  }\n\n  // Se j√° vier com 55 no in√≠cio, deixa assim\n  // Se vier com +55, remove o +\n  if (t.startsWith(\"55\")) {\n    return t;\n  }\n\n  // Se vier com +55\n  if (t.startsWith(\"+\" )) {\n    t = t.replace(\"+\", \"\");\n    return t;\n  }\n\n  return t;\n}\n\nreturn items.map(item => {\n  const data = item.json;\n\n  return {\n    json: {\n      name: data.name,\n      etapa: data.property_etapa,\n      url: data.url,\n      telefone: ajustarTelefone(data.property_contato)\n    }\n  };\n});\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-64,752],"id":"dcec0f10-d6aa-459e-885b-772ed2115e72","name":"Normaliza o telefone"},{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[0,480],"id":"241a9546-15bb-41ca-866d-c04d41f94b1b","name":"When clicking ‚ÄòExecute workflow‚Äô","disabled":true},{"parameters":{"assignments":{"assignments":[{"id":"5b6ca92b-2cff-4c1f-ade0-9a600c0fc251","name":"name","value":"=Taysa","type":"string"},{"id":"cfcf4634-e2fa-48a3-8824-e01715f5648e","name":"etapa","value":"=Mensagem encaminhada","type":"string"},{"id":"901826dc-2d94-4924-b751-d89417652c38","name":"telefone","value":"=+5511992486507","type":"string"},{"id":"e7f340eb-00a0-4698-b17d-e2c792322bea","name":"telefoneAjustado","value":"=5511992486507","type":"string"},{"id":"9cfacdf3-f4b4-4fe4-b03b-a73ec3e9f07c","name":"var_1","value":"=Taysa","type":"string"},{"id":"f32aea89-3a65-4736-a10f-12e4f7cafb8b","name":"var_2","value":"imers√£o","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[176,480],"id":"c7bdc222-94cb-45d4-85f0-b65b328b3af4","name":"Edit Fields2","disabled":true},{"parameters":{"assignments":{"assignments":[{"id":"940b2951-9c80-4163-ad9f-fd5296a59997","name":"database_page","value":"={{ $('Pega os leads do Notion').item.json.id }}","type":"string"},{"id":"5b6ca92b-2cff-4c1f-ade0-9a600c0fc251","name":"name","value":"={{ $json.name.split(' ')[0] }}","type":"string"},{"id":"cfcf4634-e2fa-48a3-8824-e01715f5648e","name":"etapa","value":"={{ $json.etapa }}","type":"string"},{"id":"901826dc-2d94-4924-b751-d89417652c38","name":"telefone","value":"={{ $('Pega os leads do Notion').item.json.property_contato }}","type":"string"},{"id":"e7f340eb-00a0-4698-b17d-e2c792322bea","name":"telefoneAjustado","value":"={{ $json.telefone }}","type":"string"},{"id":"9cfacdf3-f4b4-4fe4-b03b-a73ec3e9f07c","name":"var_1","value":"={{ $json.name.split(' ')[0] }}","type":"string"},{"id":"f32aea89-3a65-4736-a10f-12e4f7cafb8b","name":"var_2","value":"imers√£o","type":"string"},{"id":"1cc3014b-f284-429a-aa2e-9ecb0c55daec","name":"url","value":"={{ $json.url }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[512,768],"id":"2dc4cb20-b403-41af-ac3b-263b3b61d974","name":"Edit Fields"},{"parameters":{"batchSize":"=1","options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[176,752],"id":"6c7ada98-e550-4d04-a27d-4671339da80d","name":"Loop Over Items"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v22.0/869722152886578/messages","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.telefoneAjustado }}\",\n  \"type\": \"template\",\n  \"template\": {\n    \"name\": \"{{ $json.template }}\",\n    \"language\": {\n      \"code\": \"pt_BR\"\n    },\n    \"components\": [\n      {\n        \"type\": \"body\",\n        \"parameters\": [\n          { \"type\": \"text\", \"text\": \"{{ $json.var_1 }}\" }\n        ]\n      }\n    ]\n  }\n}\n","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2384,784],"id":"2743f6f7-f5d0-40eb-ac58-6315ac928b3e","name":"HTTP Request","retryOnFail":true,"credentials":{"httpBearerAuth":{"id":"W8jSHgF1bru0lIPY","name":"whatsapp"}}},{"parameters":{"method":"POST","url":"=https://chatwoot.miabuilder.com/api/v1/accounts/3/conversations/{{ $('Pega hist√≥rico de mensagens').first().json.id_usuario }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"api_access_token","value":"wr4beE6ke1EQNaaFqMVJWQmm"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"content","value":"={{ $json.mensagem }}"},{"name":"message_type","value":"outgoing"},{"name":"private","value":"false"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2400,352],"id":"c01237b9-c07b-4ff6-981f-902fc4352551","name":"HTTP Request3","retryOnFail":true,"waitBetweenTries":5000,"disabled":true}],"connections":{"Pega hist√≥rico de mensagens":{"main":[[{"node":"Formata hist√≥rico de mensagens","type":"main","index":0}]]},"Formata hist√≥rico de mensagens":{"main":[[{"node":"Merge","type":"main","index":1}]]},"Merge":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"HTTP Request1":{"main":[[]]},"Cria Mensagem no Supabase":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Confirma√ß√£o Primeiro Contato1":{"main":[[{"node":"Cria Mensagem no Supabase","type":"main","index":0}],[{"node":"Cria Mensagem no Supabase","type":"main","index":0}]]},"If1":{"main":[[{"node":"Confirma√ß√£o Primeiro Contato1","type":"main","index":0}],[{"node":"Aviso de erro ao disparar mensagem1","type":"main","index":0}]]},"Aviso de erro ao disparar mensagem1":{"main":[[{"node":"Loop Over Items","type":"main","index":0}],[{"node":"Loop Over Items","type":"main","index":0}]]},"Schedule Trigger1":{"main":[[{"node":"Pega os leads do Notion","type":"main","index":0}]]},"OpenRouter Chat Model":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"AI Agent":{"main":[[{"node":"Estrutura√ß√£o do JSON de sa√≠da","type":"main","index":0}]]},"Pega os leads do Notion":{"main":[[{"node":"Normaliza o telefone","type":"main","index":0}]]},"Normaliza o telefone":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"When clicking ‚ÄòExecute workflow‚Äô":{"main":[[{"node":"Edit Fields2","type":"main","index":0}]]},"Estrutura√ß√£o do JSON de sa√≠da":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"Edit Fields2":{"main":[[]]},"Edit Fields":{"main":[[{"node":"Pega hist√≥rico de mensagens","type":"main","index":0},{"node":"Merge","type":"main","index":0}]]},"Loop Over Items":{"main":[[],[{"node":"Edit Fields","type":"main","index":0}]]},"HTTP Request3":{"main":[[]]},"HTTP Request":{"main":[[{"node":"If1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"Cem9y3zmcggUQhrp"},"staticData":{"node:Schedule Trigger1":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{"When clicking ‚ÄòExecute workflow‚Äô":[{"json":{}}],"Schedule Trigger1":[{"json":{"timestamp":"2025-11-21T10:37:50.532-03:00","Readable date":"November 21st 2025, 10:37:50 am","Readable time":"10:37:50 am","Day of week":"Friday","Year":"2025","Month":"November","Day of month":"21","Hour":"10","Minute":"37","Second":"50","Timezone":"America/Sao_Paulo (UTC-03:00)"}}]},"versionId":"0efaf09f-ba8a-4c07-aadc-3d8a042897df","triggerCount":1,"tags":[]}