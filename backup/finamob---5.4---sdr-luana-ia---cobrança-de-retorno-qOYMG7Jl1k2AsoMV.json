{"createdAt":"2025-11-10T20:41:56.989Z","updatedAt":"2025-11-18T18:58:35.717Z","id":"qOYMG7Jl1k2AsoMV","name":"Finamob - 5.4 - SDR Luana IA - Cobrança de retorno","active":false,"isArchived":false,"nodes":[{"parameters":{"operation":"getAll","tableId":"finamob-historico_mensagens","filters":{"conditions":[{"keyName":"id_usuario","condition":"eq","keyValue":"={{ $json.telefoneAjustado }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[896,960],"id":"de9258b2-5aad-4fec-bb1f-a089abb6ac60","name":"Pega histórico de mensagens","credentials":{"supabaseApi":{"id":"4MbqyW9T081a3o7d","name":"Finamob"}}},{"parameters":{"jsCode":"// Ordena as mensagens pela data\nitems.sort((a, b) => new Date(a.json.created_at) - new Date(b.json.created_at));\n\nfunction formatarData(isoDate) {\n  const d = new Date(isoDate);\n  const dia = String(d.getDate()).padStart(2, '0');\n  const mes = String(d.getMonth() + 1).padStart(2, '0');\n  const ano = d.getFullYear();\n  return `${dia}/${mes}/${ano}`;\n}\n\nconst historico = [];\n\nfor (const item of items) {\n  const row = item.json;\n  const dataFormatada = formatarData(row.created_at);\n\n  if (row.mensagem_usuario && row.mensagem_usuario.trim() !== \"\") {\n    historico.push(`${dataFormatada} - Usuário: ${row.mensagem_usuario.trim()}`);\n  }\n\n  if (row.mensagem_agente && row.mensagem_agente.trim() !== \"\") {\n    historico.push(`${dataFormatada} - Agente: ${row.mensagem_agente.trim()}`);\n  }\n}\n\nreturn [\n  {\n    json: {\n      historico_conversa: historico.join(\"\\n\\n\")\n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1072,960],"id":"8ad8755b-0548-4ad9-9978-7013685a1a94","name":"Formata histórico de mensagens"},{"parameters":{"mode":"combine","combineBy":"combineByPosition","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[1312,784],"id":"5b71e3e8-6966-4c7f-a62a-3235b956408e","name":"Merge"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v22.0/869722152886578/messages","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.telefoneAjustado }}\",\n  \"type\": \"template\",\n  \"template\": {\n    \"name\": \"campanha_leads_primeira_cobranca\",\n    \"language\": {\n      \"code\": \"pt_BR\"\n    },\n    \"components\": [\n      {\n        \"type\": \"body\",\n        \"parameters\": [\n          { \"type\": \"text\", \"text\": \"{{ $json.var_1 }}\" },\n          { \"type\": \"text\", \"text\": \"{{ $json.var_2 }}\" }\n        ]\n      }\n    ]\n  }\n}\n","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2464,800],"id":"5a976c78-866a-4846-9ec6-47888f91aa60","name":"HTTP Request1","retryOnFail":true,"credentials":{"httpBearerAuth":{"id":"W8jSHgF1bru0lIPY","name":"whatsapp"}}},{"parameters":{"tableId":"finamob-historico_mensagens","fieldsUi":{"fieldValues":[{"fieldId":"mensagem_usuario","fieldValue":"="},{"fieldId":"mensagem_agente","fieldValue":"={{ $('Loop Over Items1').item.json.mensagem }}"},{"fieldId":"telefone","fieldValue":"={{ $('Edit Fields').item.json.telefone }}"},{"fieldId":"nome_usuario","fieldValue":"={{ $('Edit Fields').item.json.name }}"},{"fieldId":"message_type","fieldValue":"text"},{"fieldId":"ativo","fieldValue":"true"},{"fieldId":"nome_app","fieldValue":"SDR-EMI"},{"fieldId":"id_usuario","fieldValue":"={{ $('Edit Fields').item.json.telefoneAjustado }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[3472,1024],"id":"2c075320-bb80-49c0-a45c-ac9cf9d93bed","name":"Cria Mensagem no Supabase","credentials":{"supabaseApi":{"id":"4MbqyW9T081a3o7d","name":"Finamob"}},"onError":"continueRegularOutput","notes":"Este fluxo é de propriedade da FORMAÇÃO AGENTES DE IA COM N8N -BY RICNEVES"},{"parameters":{"resource":"messages-api","instanceName":"social-media-finamob-oficial","remoteJid":"=5511992486507","messageText":"=Cobraça realizada com {{ $(\"Loop Over Items1\").item.json.var_1 }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[3184,784],"id":"bc9d0a69-3aaa-4130-aa3c-9e57dced00f9","name":"Confirmação Primeiro Contato1","credentials":{"evolutionApi":{"id":"4JfTThlwBUF4KuNE","name":"Evolution - social-media-finamob-oficial"}},"onError":"continueErrorOutput"},{"parameters":{"batchSize":"=1","options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[2192,784],"id":"95df2e31-bac1-44c6-bee7-ebb303a5ba91","name":"Loop Over Items1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b5296455-2292-4b5d-8e75-0b156471af30","leftValue":"={{ $json.messages[0].message_status }}","rightValue":"accepted","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2688,800],"id":"19282ff3-acb4-48bb-9297-166bd2cf53cf","name":"If1"},{"parameters":{"resource":"messages-api","instanceName":"social-media-finamob-oficial","remoteJid":"=5511992486507","messageText":"=Erro ao disparar primeira mensagem para {{ $(\"Loop Over Items1\").item.json.var_1 }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[2960,976],"id":"81f3c2c3-d9da-480b-b461-160b2ce08285","name":"Aviso de erro ao disparar mensagem1","credentials":{"evolutionApi":{"id":"4JfTThlwBUF4KuNE","name":"Evolution - social-media-finamob-oficial"}},"onError":"continueErrorOutput"},{"parameters":{"rule":{"interval":[{"field":"cronExpression","expression":"0 9,19 * * *"}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[16,768],"id":"d5a2a389-f470-4acc-ad04-63da757644c6","name":"Schedule Trigger1"},{"parameters":{"promptType":"define","text":"=Você é a Luana, responsável pelo comercial da Escola do Mercado Imobiliário. Abordagem gentil, simpática, educada e orientada à conversão. Objetivo: Marcar uma reunião com um lead; \n\nA Escola do Mercado Imobiliário é uma escola 100% dedicada ao mercado imobiliário, e seus produtos são: Imersões (online e presenciais), infoprodutos, clubs de networking. Todas as infos sobre as imersões estão na base de conhecimento.\n\nVoce SEMPRE deve consultar o historico de mensagens trocadas com o lead, sempre conecte a sua resposta com o historico mantendo uma conversa fluida. No historico onde está \n\"Agente\" significa que foi você, Luana, que enviou a mensagem anteriormente. Se você enviou uma mensagem sobre uma imersão anteriormente e o usuário respondeu agora, você precisa assumir que ele está falando sobre a última mensagem enviada e sempre com o intuito de direcionar para marcar uma reunião.\n\nPor exemplo, se você enviou uma primeira mensagem para o lead, falando sobre a imersão X, e em seguida ele respondeu apenas \"Oi\", você deveria seguir com uma resposta natural como: \"Então {nome_da_pessoa}, vamos marcar a agenda que falamos?\".\n\nA ideia é manter uma conversa fluída, então se tiver histórico precisa deixar de lado formalidades e seguir com um tom simpático e amigável da Luana.\n\nSeu objetivo é analisar o histórico de mensagens e gerar a MELHOR próxima mensagem para aumentar as chances de o lead marcar uma reunião.\n\n### CONTEXTO DO PRODUTO\nVocê representa a EMI e está convidando o lead para agendar uma conversa sobre as imersões e programas oferecidos pela escola. O tom deve ser humano, gentil, profissional e incentivador.\n\n### SUA TAREFA PRINCIPAL\nCom base no histórico de mensagens fornecido em “historico_conversa”, defina qual é o melhor próximo passo e gere **uma única mensagem curta**, clara e personalizada para enviar ao lead agora.\n\n### DADOS DISPONÍVEIS\n- Nome do lead: {{ $json.name }}\n- historico_conversa: {{ $json.historico_conversa }}\nUse tudo isso para personalizar a mensagem ao máximo.\n\n### LÓGICA DE DECISÃO\nAnalise o histórico e identifique:\n\n1. **O lead respondeu recentemente?**  \n   - Se sim, continue o assunto de forma natural.\n\n2. **O lead mostrou interesse mas não agendou?**  \n   Gere uma mensagem do tipo:\n   - “Vi que você demonstrou interesse, mas ainda não conseguimos agendar…”\n\n3. **O lead pediu tempo, marcou uma data futura ou disse que estava ocupado?**  \n   - Retome com delicadeza, contextualize o motivo anterior e avance no convite.\n\n4. **O lead está completamente sumido? (mais de 2 tentativas anteriores sem resposta)**  \n   Gere uma mensagem leve, simpática e curta:\n   - “Passando para não deixar você perder essa oportunidade…”\n\n5. **O lead enviou algo como ‘vou ver’, ‘depois te chamo’, ‘interessante’, ‘quero participar’, mas não concluiu?**  \n   Direcione para a ação:\n   - “Posso te ajudar a escolher o melhor horário agora?”\n\n6. **Se houver qualquer dúvida aberta no histórico**  \n   Responda essa dúvida antes de fazer a cobrança.\n\n### REGRAS DE TOM DE VOZ\n- Educado, simpático e próximo.\n- Pareça humano.  \n- Mensagens curtas (3 a 6 linhas).  \n- Evite pressão.  \n- Incentive sempre a marcar a reunião.\n\n### ESTRUTURA DE RESPOSTA (OBRIGATÓRIA)\nRetorne APENAS um JSON com esta estrutura:\n\n{\n  \"mensagem\": \"<mensagem ideal gerada>\",\n  \"telefoneAjustado\": {{ $json.telefoneAjustado }},\n  \"var_1\": {{ $json.var_1 }}\n  \"var_2\": {{ $json.var_2 }}\n}\n\nSem explicações. Sem texto fora do JSON.\n\n","options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[1520,784],"id":"ae5e03eb-881d-443d-a2e7-4bd33dee9e03","name":"AI Agent"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[1520,1024],"id":"8f8b6d9f-096f-4ace-a15e-3a965feb35c8","name":"OpenRouter Chat Model","credentials":{"openRouterApi":{"id":"o1ywdYlH64cgqSMT","name":"OpenRouter account"}}},{"parameters":{"jsCode":"return items.map(item => {\n  let raw = item.json.output || \"\";\n  let cleaned = raw;\n\n  // 1. Remove blocos de código tipo ```json ... ```\n  cleaned = cleaned.replace(/```json/gi, \"\");\n  cleaned = cleaned.replace(/```/g, \"\");\n\n  // 2. Remove espaços e quebras extras\n  cleaned = cleaned.trim();\n\n  let respostaIA;\n\n  // 3. Faz o parse seguro\n  try {\n    respostaIA = JSON.parse(cleaned);\n  } catch (e) {\n    respostaIA = {\n      mensagem: \"Não consegui gerar a mensagem ideal, mas estou aqui para ajudar!\"\n    };\n  }\n\n  // 4. Retorna item final (apenas a mensagem do agente)\n  return {\n    json: {\n      ...respostaIA\n    }\n  };\n});"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1920,784],"id":"b4436d91-aca0-4372-a1bb-bf74a204c761","name":"Estruturação do JSON de saída","onError":"continueRegularOutput"},{"parameters":{"resource":"databasePage","operation":"getAll","databaseId":{"__rl":true,"value":"287c103b-58ba-8057-bd3f-e2b83606d543","mode":"list","cachedResultName":"Leads","cachedResultUrl":"https://www.notion.so/287c103b58ba8057bd3fe2b83606d543"},"returnAll":true,"filterType":"manual","matchType":"allFilters","filters":{"conditions":[{"key":"Etapa|status","condition":"equals","statusValue":"Mensagem encaminhada"}]},"options":{}},"type":"n8n-nodes-base.notion","typeVersion":2.2,"position":[224,768],"id":"7a47db2b-c178-400b-b88b-17978f615dcf","name":"Pega os leads do Notion","credentials":{"notionApi":{"id":"LULy5XEh4CoWDiW9","name":"finamob-emi"}}},{"parameters":{"jsCode":"function ajustarTelefone(raw) {\n  if (!raw) return null;\n\n  let t = raw.toString();\n\n  // Remove tudo que não é número\n  t = t.replace(/\\D/g, \"\");\n\n  // Se vier com 11 dígitos (celular padrão)\n  if (t.length === 11) {\n    t = \"55\" + t;\n  }\n\n  // Se vier com 10 dígitos (fixo)\n  if (t.length === 10) {\n    t = \"55\" + t;\n  }\n\n  // Se já vier com 55 no início, deixa assim\n  // Se vier com +55, remove o +\n  if (t.startsWith(\"55\")) {\n    return t;\n  }\n\n  // Se vier com +55\n  if (t.startsWith(\"+\" )) {\n    t = t.replace(\"+\", \"\");\n    return t;\n  }\n\n  return t;\n}\n\nreturn items.map(item => {\n  const data = item.json;\n\n  return {\n    json: {\n      name: data.name,\n      etapa: data.property_etapa,\n      telefone: ajustarTelefone(data.property_contato)\n    }\n  };\n});\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[432,768],"id":"dcec0f10-d6aa-459e-885b-772ed2115e72","name":"Normaliza o telefone"},{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[0,480],"id":"241a9546-15bb-41ca-866d-c04d41f94b1b","name":"When clicking ‘Execute workflow’","disabled":true},{"parameters":{"assignments":{"assignments":[{"id":"5b6ca92b-2cff-4c1f-ade0-9a600c0fc251","name":"name","value":"=Lucas","type":"string"},{"id":"cfcf4634-e2fa-48a3-8824-e01715f5648e","name":"etapa","value":"=Mensagem encaminhada","type":"string"},{"id":"901826dc-2d94-4924-b751-d89417652c38","name":"telefone","value":"=5511992486507","type":"string"},{"id":"e7f340eb-00a0-4698-b17d-e2c792322bea","name":"telefoneAjustado","value":"=5511992486507","type":"string"},{"id":"9cfacdf3-f4b4-4fe4-b03b-a73ec3e9f07c","name":"var_1","value":"=Lucas","type":"string"},{"id":"f32aea89-3a65-4736-a10f-12e4f7cafb8b","name":"var_2","value":"imersão","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[176,480],"id":"c7bdc222-94cb-45d4-85f0-b65b328b3af4","name":"Edit Fields2","disabled":true},{"parameters":{"assignments":{"assignments":[{"id":"940b2951-9c80-4163-ad9f-fd5296a59997","name":"database_page","value":"={{ $('Pega os leads do Notion').item.json.id }}","type":"string"},{"id":"5b6ca92b-2cff-4c1f-ade0-9a600c0fc251","name":"name","value":"={{ $json.name }}","type":"string"},{"id":"cfcf4634-e2fa-48a3-8824-e01715f5648e","name":"etapa","value":"={{ $json.etapa }}","type":"string"},{"id":"901826dc-2d94-4924-b751-d89417652c38","name":"telefone","value":"={{ $('Pega os leads do Notion').item.json.property_contato }}","type":"string"},{"id":"e7f340eb-00a0-4698-b17d-e2c792322bea","name":"telefoneAjustado","value":"={{ $json.telefone }}","type":"string"},{"id":"9cfacdf3-f4b4-4fe4-b03b-a73ec3e9f07c","name":"var_1","value":"={{ $json.name }}","type":"string"},{"id":"f32aea89-3a65-4736-a10f-12e4f7cafb8b","name":"var_2","value":"imersão","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[640,768],"id":"2dc4cb20-b403-41af-ac3b-263b3b61d974","name":"Edit Fields"}],"connections":{"Pega histórico de mensagens":{"main":[[{"node":"Formata histórico de mensagens","type":"main","index":0}]]},"Formata histórico de mensagens":{"main":[[{"node":"Merge","type":"main","index":1}]]},"Merge":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"HTTP Request1":{"main":[[{"node":"If1","type":"main","index":0}]]},"Cria Mensagem no Supabase":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"Confirmação Primeiro Contato1":{"main":[[{"node":"Cria Mensagem no Supabase","type":"main","index":0}],[{"node":"Cria Mensagem no Supabase","type":"main","index":0}]]},"Loop Over Items1":{"main":[[],[{"node":"HTTP Request1","type":"main","index":0}]]},"If1":{"main":[[{"node":"Confirmação Primeiro Contato1","type":"main","index":0}],[{"node":"Aviso de erro ao disparar mensagem1","type":"main","index":0}]]},"Aviso de erro ao disparar mensagem1":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}],[{"node":"Loop Over Items1","type":"main","index":0}]]},"Schedule Trigger1":{"main":[[{"node":"Pega os leads do Notion","type":"main","index":0}]]},"OpenRouter Chat Model":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"AI Agent":{"main":[[{"node":"Estruturação do JSON de saída","type":"main","index":0}]]},"Pega os leads do Notion":{"main":[[{"node":"Normaliza o telefone","type":"main","index":0}]]},"Normaliza o telefone":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"When clicking ‘Execute workflow’":{"main":[[{"node":"Edit Fields2","type":"main","index":0}]]},"Estruturação do JSON de saída":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"Edit Fields2":{"main":[[]]},"Edit Fields":{"main":[[{"node":"Pega histórico de mensagens","type":"main","index":0},{"node":"Merge","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":{"node:Schedule Trigger1":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{"Schedule Trigger1":[{"json":{"timestamp":"2025-11-10T19:20:20.003-03:00","Readable date":"November 10th 2025, 7:20:20 pm","Readable time":"7:20:20 pm","Day of week":"Monday","Year":"2025","Month":"November","Day of month":"10","Hour":"19","Minute":"20","Second":"20","Timezone":"America/Sao_Paulo (UTC-03:00)"}}]},"versionId":"d14b639e-1533-4ce4-b97f-3dfd2272bf42","triggerCount":1,"tags":[]}