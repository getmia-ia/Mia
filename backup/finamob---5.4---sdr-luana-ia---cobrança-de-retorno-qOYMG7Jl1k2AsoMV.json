{"createdAt":"2025-11-10T20:41:56.989Z","updatedAt":"2025-11-10T22:30:22.273Z","id":"qOYMG7Jl1k2AsoMV","name":"Finamob - 5.4 - SDR Luana IA - Cobran√ßa de retorno","active":false,"isArchived":false,"nodes":[{"parameters":{"operation":"getAll","tableId":"finamob-historico_mensagens","filters":{"conditions":[{"keyName":"id_usuario","condition":"eq","keyValue":"={{ $json.telefoneAjustado }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[896,960],"id":"de9258b2-5aad-4fec-bb1f-a089abb6ac60","name":"Pega hist√≥rico de mensagens","credentials":{"supabaseApi":{"id":"4MbqyW9T081a3o7d","name":"Finamob"}}},{"parameters":{"jsCode":"// Ordena as mensagens pela data\nitems.sort((a, b) => new Date(a.json.created_at) - new Date(b.json.created_at));\n\nfunction formatarData(isoDate) {\n  const d = new Date(isoDate);\n  const dia = String(d.getDate()).padStart(2, '0');\n  const mes = String(d.getMonth() + 1).padStart(2, '0');\n  const ano = d.getFullYear();\n  return `${dia}/${mes}/${ano}`;\n}\n\nconst historico = [];\n\nfor (const item of items) {\n  const row = item.json;\n  const dataFormatada = formatarData(row.created_at);\n\n  if (row.mensagem_usuario && row.mensagem_usuario.trim() !== \"\") {\n    historico.push(`${dataFormatada} - Usu√°rio: ${row.mensagem_usuario.trim()}`);\n  }\n\n  if (row.mensagem_agente && row.mensagem_agente.trim() !== \"\") {\n    historico.push(`${dataFormatada} - Agente: ${row.mensagem_agente.trim()}`);\n  }\n}\n\nreturn [\n  {\n    json: {\n      historico_conversa: historico.join(\"\\n\\n\")\n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1072,960],"id":"8ad8755b-0548-4ad9-9978-7013685a1a94","name":"Formata hist√≥rico de mensagens"},{"parameters":{"mode":"combine","combineBy":"combineByPosition","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[1312,784],"id":"5b71e3e8-6966-4c7f-a62a-3235b956408e","name":"Merge"},{"parameters":{"resource":"databasePage","operation":"getAll","databaseId":{"__rl":true,"value":"287c103b-58ba-8057-bd3f-e2b83606d543","mode":"list","cachedResultName":"Leads","cachedResultUrl":"https://www.notion.so/287c103b58ba8057bd3fe2b83606d543"},"returnAll":true,"filterType":"manual","matchType":"allFilters","filters":{"conditions":[{"key":"Etapa|status","condition":"equals","statusValue":"Mensagem encaminhada"}]},"options":{}},"type":"n8n-nodes-base.notion","typeVersion":2.2,"position":[224,768],"id":"7a47db2b-c178-400b-b88b-17978f615dcf","name":"Pega os leads do Notion1","credentials":{"notionApi":{"id":"LULy5XEh4CoWDiW9","name":"finamob-emi"}}},{"parameters":{"jsCode":"function ajustarTelefone(raw) {\n  if (!raw) return null;\n\n  let t = raw.toString();\n\n  // Remove tudo que n√£o √© n√∫mero\n  t = t.replace(/\\D/g, \"\");\n\n  // Se vier com 11 d√≠gitos (celular padr√£o)\n  if (t.length === 11) {\n    t = \"55\" + t;\n  }\n\n  // Se vier com 10 d√≠gitos (fixo)\n  if (t.length === 10) {\n    t = \"55\" + t;\n  }\n\n  // Se j√° vier com 55 no in√≠cio, deixa assim\n  // Se vier com +55, remove o +\n  if (t.startsWith(\"55\")) {\n    return t;\n  }\n\n  // Se vier com +55\n  if (t.startsWith(\"+\" )) {\n    t = t.replace(\"+\", \"\");\n    return t;\n  }\n\n  return t;\n}\n\nreturn items.map(item => {\n  const data = item.json;\n\n  return {\n    json: {\n      name: data.name,\n      etapa: data.property_etapa,\n      telefone: ajustarTelefone(data.property_contato)\n    }\n  };\n});\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[432,768],"id":"dcec0f10-d6aa-459e-885b-772ed2115e72","name":"Normaliza o telefone1"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v22.0/869722152886578/messages","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.telefoneAjustado }}\",\n  \"type\": \"template\",\n  \"template\": {\n    \"name\": \"campanha_leads_primeira_cobranca\",\n    \"language\": {\n      \"code\": \"pt_BR\"\n    },\n    \"components\": [\n      {\n        \"type\": \"body\",\n        \"parameters\": [\n          { \"type\": \"text\", \"text\": \"{{ $json.var_1 }}\" },\n          { \"type\": \"text\", \"text\": \"{{ $json.var_2 }}\" }\n        ]\n      }\n    ]\n  }\n}\n","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1840,800],"id":"5a976c78-866a-4846-9ec6-47888f91aa60","name":"HTTP Request1","retryOnFail":true,"credentials":{"httpBearerAuth":{"id":"W8jSHgF1bru0lIPY","name":"whatsapp"}}},{"parameters":{"assignments":{"assignments":[{"id":"940b2951-9c80-4163-ad9f-fd5296a59997","name":"database_page","value":"={{ $('Pega os leads do Notion1').item.json.id }}","type":"string"},{"id":"5b6ca92b-2cff-4c1f-ade0-9a600c0fc251","name":"name","value":"={{ $json.name }}","type":"string"},{"id":"cfcf4634-e2fa-48a3-8824-e01715f5648e","name":"etapa","value":"={{ $json.etapa }}","type":"string"},{"id":"901826dc-2d94-4924-b751-d89417652c38","name":"telefone","value":"={{ $('Pega os leads do Notion1').item.json.property_contato }}","type":"string"},{"id":"e7f340eb-00a0-4698-b17d-e2c792322bea","name":"telefoneAjustado","value":"={{ $json.telefone }}","type":"string"},{"id":"9cfacdf3-f4b4-4fe4-b03b-a73ec3e9f07c","name":"var_1","value":"={{ $json.name }}","type":"string"},{"id":"f32aea89-3a65-4736-a10f-12e4f7cafb8b","name":"var_2","value":"imers√£o","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[640,768],"id":"2dc4cb20-b403-41af-ac3b-263b3b61d974","name":"Edit Fields1"},{"parameters":{"resource":"databasePage","operation":"update","pageId":{"__rl":true,"value":"={{ $('Edit Fields1').item.json.database_page }}","mode":"id"},"propertiesUi":{"propertyValues":[{"key":"Etapa|status","statusValue":"Mensagem encaminhada"}]},"options":{}},"type":"n8n-nodes-base.notion","typeVersion":2.2,"position":[2336,784],"id":"598a1a6e-ed45-4230-9918-21411f6bd5e4","name":"Update a database page1","credentials":{"notionApi":{"id":"LULy5XEh4CoWDiW9","name":"finamob-emi"}}},{"parameters":{"tableId":"finamob-historico_mensagens","fieldsUi":{"fieldValues":[{"fieldId":"mensagem_usuario","fieldValue":"="},{"fieldId":"mensagem_agente","fieldValue":"=Oiii, tudo bem? üòä\n\nAqui √© a *Luana, da Escola do Mercado Imobili√°rio!* Recebi o seu contato pois voc√™ demonstrou interesse em participar da *{{ $('Edit Fields1').item.json.var_1 }}* üëã\n\nEssa √© uma oportunidade √∫nica pra aprender, direto com Murilo Marchesini, *{{ $('Edit Fields1').item.json.var_2 }}*\n\nVamos marcar uma agenda para tirarmos todas as suas d√∫vidas sobre a imers√£o?"},{"fieldId":"telefone","fieldValue":"={{ $('Edit Fields1').item.json.telefone }}"},{"fieldId":"nome_usuario","fieldValue":"={{ $('Edit Fields1').item.json.name }}"},{"fieldId":"message_type","fieldValue":"text"},{"fieldId":"ativo","fieldValue":"true"},{"fieldId":"nome_app","fieldValue":"SDR-EMI"},{"fieldId":"id_usuario","fieldValue":"={{ $('Edit Fields1').item.json.telefoneAjustado }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2848,1024],"id":"2c075320-bb80-49c0-a45c-ac9cf9d93bed","name":"Cria Mensagem no Supabase","credentials":{"supabaseApi":{"id":"4MbqyW9T081a3o7d","name":"Finamob"}},"onError":"continueRegularOutput","notes":"Este fluxo √© de propriedade da FORMA√á√ÉO AGENTES DE IA COM N8N -BY RICNEVES"},{"parameters":{"resource":"messages-api","instanceName":"social-media-finamob-oficial","remoteJid":"=5511992486507","messageText":"=Primeiro contato realizado com {{ $json.name }}\n\n{{ $json.url }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[2560,784],"id":"bc9d0a69-3aaa-4130-aa3c-9e57dced00f9","name":"Confirma√ß√£o Primeiro Contato1","credentials":{"evolutionApi":{"id":"4JfTThlwBUF4KuNE","name":"Evolution - social-media-finamob-oficial"}},"onError":"continueErrorOutput"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[1568,784],"id":"95df2e31-bac1-44c6-bee7-ebb303a5ba91","name":"Loop Over Items1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b5296455-2292-4b5d-8e75-0b156471af30","leftValue":"={{ $json.messages[0].message_status }}","rightValue":"accepted","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2064,800],"id":"19282ff3-acb4-48bb-9297-166bd2cf53cf","name":"If1"},{"parameters":{"resource":"messages-api","instanceName":"social-media-finamob-oficial","remoteJid":"=5511992486507","messageText":"=Erro ao disparar primeira mensagem para {{ $json.name }}\n\n{{ $json.url }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[2336,976],"id":"81f3c2c3-d9da-480b-b461-160b2ce08285","name":"Aviso de erro ao disparar mensagem1","credentials":{"evolutionApi":{"id":"4JfTThlwBUF4KuNE","name":"Evolution - social-media-finamob-oficial"}},"onError":"continueErrorOutput"},{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":20}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[32,768],"id":"d5a2a389-f470-4acc-ad04-63da757644c6","name":"Schedule Trigger1"}],"connections":{"Pega hist√≥rico de mensagens":{"main":[[{"node":"Formata hist√≥rico de mensagens","type":"main","index":0}]]},"Formata hist√≥rico de mensagens":{"main":[[{"node":"Merge","type":"main","index":1}]]},"Merge":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"Pega os leads do Notion1":{"main":[[{"node":"Normaliza o telefone1","type":"main","index":0}]]},"Normaliza o telefone1":{"main":[[{"node":"Edit Fields1","type":"main","index":0}]]},"HTTP Request1":{"main":[[{"node":"If1","type":"main","index":0}]]},"Edit Fields1":{"main":[[{"node":"Merge","type":"main","index":0},{"node":"Pega hist√≥rico de mensagens","type":"main","index":0}]]},"Update a database page1":{"main":[[{"node":"Confirma√ß√£o Primeiro Contato1","type":"main","index":0}]]},"Cria Mensagem no Supabase":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"Confirma√ß√£o Primeiro Contato1":{"main":[[{"node":"Cria Mensagem no Supabase","type":"main","index":0}],[{"node":"Cria Mensagem no Supabase","type":"main","index":0}]]},"Loop Over Items1":{"main":[[],[{"node":"HTTP Request1","type":"main","index":0}]]},"If1":{"main":[[{"node":"Update a database page1","type":"main","index":0}],[{"node":"Aviso de erro ao disparar mensagem1","type":"main","index":0}]]},"Aviso de erro ao disparar mensagem1":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}],[{"node":"Loop Over Items1","type":"main","index":0}]]},"Schedule Trigger1":{"main":[[{"node":"Pega os leads do Notion1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{"Schedule Trigger1":[{"json":{"timestamp":"2025-11-10T19:20:20.003-03:00","Readable date":"November 10th 2025, 7:20:20 pm","Readable time":"7:20:20 pm","Day of week":"Monday","Year":"2025","Month":"November","Day of month":"10","Hour":"19","Minute":"20","Second":"20","Timezone":"America/Sao_Paulo (UTC-03:00)"}}]},"versionId":"ad638b8d-f2e7-4a9b-a055-21da52407c60","triggerCount":0,"tags":[]}