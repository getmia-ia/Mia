{"createdAt":"2025-11-21T10:07:03.122Z","updatedAt":"2025-11-21T19:57:55.577Z","id":"x6xFniblRSY2X4tb","name":"Finamob - 5.6 - SDR Luana IA - Confirma√ß√£o de pagamento","active":true,"isArchived":false,"nodes":[{"parameters":{"tableId":"finamob-historico_mensagens","fieldsUi":{"fieldValues":[{"fieldId":"mensagem_usuario","fieldValue":"="},{"fieldId":"mensagem_agente","fieldValue":"=Oi {{ $('Edit Fields').item.json.var_1 }}! ü•≥üéâ\n\nPassando para te avisar que o seu pagamento foi confirmado‚úÖ\nEstamos muito felizes em ter voc√™ com a gente na {{ $('Edit Fields').item.json.var_2 }}!\n\nSe precisar de qualquer coisa, estou por aqui para te ajudar!"},{"fieldId":"telefone","fieldValue":"={{ $('Edit Fields').item.json.telefone }}"},{"fieldId":"nome_usuario","fieldValue":"={{ $('Edit Fields').item.json.name }}"},{"fieldId":"message_type","fieldValue":"text"},{"fieldId":"ativo","fieldValue":"true"},{"fieldId":"nome_app","fieldValue":"SDR-EMI"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2928,976],"id":"ac5e27a3-dc09-45db-9ad9-538a5ed391a5","name":"Cria Mensagem no Supabase","credentials":{"supabaseApi":{"id":"4MbqyW9T081a3o7d","name":"Finamob"}},"onError":"continueRegularOutput","notes":"Este fluxo √© de propriedade da FORMA√á√ÉO AGENTES DE IA COM N8N -BY RICNEVES"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b5296455-2292-4b5d-8e75-0b156471af30","leftValue":"={{ $json.messages[0].message_status }}","rightValue":"accepted","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2128,752],"id":"bf0577a5-2eef-4097-9b40-ed6c3cdd8496","name":"If1"},{"parameters":{"resource":"messages-api","instanceName":"social-media-finamob-oficial","remoteJid":"=120363421884092746@g.us","messageText":"=Erro ao disparar mensagem de confirma√ß√£o de pagamento para {{ $json.name }}\n\n{{ $json.url }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[2368,928],"id":"cd7f4abc-45ca-4386-ac63-061e3ed878a6","name":"Aviso de erro ao disparar mensagem1","credentials":{"evolutionApi":{"id":"4JfTThlwBUF4KuNE","name":"Evolution - social-media-finamob-oficial"}},"onError":"continueErrorOutput"},{"parameters":{"assignments":{"assignments":[{"id":"940b2951-9c80-4163-ad9f-fd5296a59997","name":"database_page","value":"={{ $('Verifica o status e se j√° foi enviado uma mensagem de confima√ß√£o').item.json.id }}","type":"string"},{"id":"5b6ca92b-2cff-4c1f-ade0-9a600c0fc251","name":"name","value":"={{ $json.name.split(' ')[0] }}","type":"string"},{"id":"cfcf4634-e2fa-48a3-8824-e01715f5648e","name":"etapa","value":"={{ $json.etapa }}","type":"string"},{"id":"901826dc-2d94-4924-b751-d89417652c38","name":"telefone","value":"={{ $('Verifica o status e se j√° foi enviado uma mensagem de confima√ß√£o').item.json.property_contato }}","type":"string"},{"id":"e7f340eb-00a0-4698-b17d-e2c792322bea","name":"telefoneAjustado","value":"={{ $json.telefone }}","type":"string"},{"id":"9cfacdf3-f4b4-4fe4-b03b-a73ec3e9f07c","name":"var_1","value":"={{ $json.name.split(' ')[0] }}","type":"string"},{"id":"f32aea89-3a65-4736-a10f-12e4f7cafb8b","name":"var_2","value":"={{ $('Verifica o status e se j√° foi enviado uma mensagem de confima√ß√£o').item.json.Produto || \"imers√£o\" }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1344,752],"id":"61d242e1-4320-405b-b6ae-0c40b0f47464","name":"Edit Fields"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[1568,752],"id":"9cf14456-c746-464a-8a28-9b511f2bcddb","name":"Loop Over Items"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v22.0/869722152886578/messages","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.telefoneAjustado }}\",\n  \"type\": \"template\",\n  \"template\": {\n    \"name\": \"confirmacao_pagamento\",\n    \"language\": {\n      \"code\": \"pt_BR\"\n    },\n    \"components\": [\n      {\n        \"type\": \"body\",\n        \"parameters\": [\n          { \"type\": \"text\", \"text\": \"{{ $json.var_1 }}\" },\n          { \"type\": \"text\", \"text\": \"{{ $json.var_2 }}\" }\n        ]\n      }\n    ]\n  }\n}\n","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1840,768],"id":"aa491035-6cdb-4690-8651-a0573dbc52e0","name":"HTTP Request","retryOnFail":true,"credentials":{"httpBearerAuth":{"id":"W8jSHgF1bru0lIPY","name":"whatsapp"}},"onError":"continueErrorOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a4c3cc6b-1f7f-4944-91af-826aed4016aa","leftValue":"={{ $json.property_etapa }}","rightValue":"Pagamento conclu√≠do","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"c8da4484-7cad-4e1a-8f2d-4ca6020fbc9d","leftValue":"={{ $json.property_mensagem_pagamento }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[864,768],"id":"474f21df-7497-4048-ae54-21e91c2f5870","name":"Verifica o status e se j√° foi enviado uma mensagem de confima√ß√£o"},{"parameters":{"resource":"databasePage","operation":"update","pageId":{"__rl":true,"value":"={{ $('Edit Fields').item.json.database_page }}","mode":"id"},"propertiesUi":{"propertyValues":[{"key":"Mensagem Pagamento|checkbox","checkboxValue":true}]},"options":{}},"type":"n8n-nodes-base.notion","typeVersion":2.2,"position":[2400,736],"id":"a931c4e3-49ae-4eec-8056-44b3643e6890","name":"Atualiza o status do envio da mensagem de pagamento","credentials":{"notionApi":{"id":"LULy5XEh4CoWDiW9","name":"finamob-emi"}}},{"parameters":{"resource":"messages-api","instanceName":"social-media-finamob-oficial","remoteJid":"=120363421884092746@g.us","messageText":"=Mensagem de confirma√ß√£o de pagamento enviado para {{ $json.name }}\n\n{{ $json.url }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[2656,736],"id":"148be0cc-61d9-47f3-819f-b3cef5b6d8eb","name":"Confirma√ß√£o Primeiro Contato","credentials":{"evolutionApi":{"id":"4JfTThlwBUF4KuNE","name":"Evolution - social-media-finamob-oficial"}},"onError":"continueErrorOutput"},{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":10}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[384,768],"id":"80588182-92d2-4ead-ab34-95a9df6b07ed","name":"Schedule Trigger"},{"parameters":{"resource":"databasePage","operation":"getAll","databaseId":{"__rl":true,"value":"287c103b-58ba-8057-bd3f-e2b83606d543","mode":"list","cachedResultName":"Leads","cachedResultUrl":"https://www.notion.so/287c103b58ba8057bd3fe2b83606d543"},"returnAll":true,"filterType":"manual","matchType":"allFilters","filters":{"conditions":[{"key":"Etapa|status","condition":"equals","statusValue":"Pagamento conclu√≠do"}]},"options":{}},"type":"n8n-nodes-base.notion","typeVersion":2.2,"position":[624,768],"id":"8bd3b327-fe73-4b95-bcbc-48528a9e16f6","name":"Pega os leads do Notion","credentials":{"notionApi":{"id":"LULy5XEh4CoWDiW9","name":"finamob-emi"}}},{"parameters":{"jsCode":"function ajustarTelefone(raw) {\n  if (!raw) return null;\n\n  let t = raw.toString();\n\n  // Remove tudo que n√£o √© n√∫mero\n  t = t.replace(/\\D/g, \"\");\n\n  // Se vier com 11 d√≠gitos (celular padr√£o)\n  if (t.length === 11) {\n    t = \"55\" + t;\n  }\n\n  // Se vier com 10 d√≠gitos (fixo)\n  if (t.length === 10) {\n    t = \"55\" + t;\n  }\n\n  // Se j√° vier com 55 no in√≠cio, deixa assim\n  // Se vier com +55, remove o +\n  if (t.startsWith(\"55\")) {\n    return t;\n  }\n\n  // Se vier com +55\n  if (t.startsWith(\"+\" )) {\n    t = t.replace(\"+\", \"\");\n    return t;\n  }\n\n  return t;\n}\n\nreturn items.map(item => {\n  const data = item.json;\n\n  return {\n    json: {\n      name: data.name,\n      etapa: data.property_etapa,\n      url: data.url,\n      telefone: ajustarTelefone(data.property_contato)\n    }\n  };\n});\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1136,752],"id":"e3079a2b-a809-4ed5-84f8-d99d2a3ec457","name":"Normaliza o telefone"}],"connections":{"Cria Mensagem no Supabase":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"If1":{"main":[[{"node":"Atualiza o status do envio da mensagem de pagamento","type":"main","index":0}],[{"node":"Aviso de erro ao disparar mensagem1","type":"main","index":0}]]},"Aviso de erro ao disparar mensagem1":{"main":[[{"node":"Loop Over Items","type":"main","index":0}],[{"node":"Loop Over Items","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Loop Over Items":{"main":[[],[{"node":"HTTP Request","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"If1","type":"main","index":0}],[{"node":"Aviso de erro ao disparar mensagem1","type":"main","index":0}]]},"Verifica o status e se j√° foi enviado uma mensagem de confima√ß√£o":{"main":[[{"node":"Normaliza o telefone","type":"main","index":0}]]},"Atualiza o status do envio da mensagem de pagamento":{"main":[[{"node":"Confirma√ß√£o Primeiro Contato","type":"main","index":0}]]},"Confirma√ß√£o Primeiro Contato":{"main":[[{"node":"Cria Mensagem no Supabase","type":"main","index":0}],[{"node":"Cria Mensagem no Supabase","type":"main","index":0}]]},"Schedule Trigger":{"main":[[{"node":"Pega os leads do Notion","type":"main","index":0}]]},"Pega os leads do Notion":{"main":[[{"node":"Verifica o status e se j√° foi enviado uma mensagem de confima√ß√£o","type":"main","index":0}]]},"Normaliza o telefone":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"Cem9y3zmcggUQhrp"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]},"node:Notion Trigger":{"lastTimeChecked":"2025-11-21T12:24:00.000Z","possibleDuplicates":["2b0c103b-58ba-8096-bdbf-cbe56ed5af1b"]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"fade4fb2-29b0-4999-80d4-2eb63342c12f","triggerCount":1,"tags":[]}