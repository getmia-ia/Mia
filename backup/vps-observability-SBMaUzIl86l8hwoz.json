{"createdAt":"2025-08-21T14:46:07.440Z","updatedAt":"2025-11-05T20:43:45.214Z","id":"SBMaUzIl86l8hwoz","name":"VPS Observability","active":true,"isArchived":false,"nodes":[{"parameters":{"content":"#  Monitora o uso de CPU, memória e HD de uma VPS e envia uma mensagem de alerta no WhatApp usando Evolution API caso algum desses valores exceda um limite especificado (CPU e memória acima de 80% e HD acima de 85%).\n\n\n\n1. Trigger de Agendamento (Schedule Trigger)\nConfigurado para acionar em intervalos de horas. Verifique se o intervalo está configurado conforme desejado para evitar execuções frequentes desnecessárias.\n2. Comando para Limpeza de Sistema Docker\nEste node SSH executa o comando docker system prune -a --force, que limpa todos os containers, imagens e volumes não utilizados. Este comando é potencialmente destrutivo, pois remove todas as imagens e volumes que não estão em uso. Certifique-se de que deseja essa ação periódica.\n3. Comando para Coletar Dados do Sistema\nEste node SSH coleta dados de CPU, memória e HD e retorna a saída no formato:\nyaml\nCopiar código\nCPU: XX%, MEMÓRIA: XX%, HD: XX%\nEssa estrutura será usada pelo próximo node para extração de valores.\n4. Node de Código (JavaScript)\nEste node Code processa a saída anterior para extrair as porcentagens de CPU, memória e HD utilizando expressões regulares.\nA saída é transformada em um JSON com os valores separados para uso nos próximos nodes.\n5. Condições de Verificação (Node If)\nEste node If verifica se os valores de CPU, memória ou HD ultrapassam os limites configurados:\nCPU ≥ 60%\nMemória ≥ 60%\nHD ≥ 80%\nSe qualquer uma das condições for verdadeira, o fluxo segue para o próximo node para enviar o alerta.\n6. Node de Requisição HTTP\nEste node HTTP Request envia uma mensagem de alerta com os valores de CPU, memória e HD.\nSugestão de melhoria: Se desejar enviar este alerta por meio de um serviço específico (como um bot de Telegram ou outro API), configure o cabeçalho apikey e ajuste o endpoint para o destino desejado.\nPossíveis Ajustes ou Melhorias:\nIntervalo do Trigger: Ajuste o Schedule Trigger para a frequência de monitoramento ideal.\nConfirmação dos Limites de Alerta: Verifique se os valores de limite (CPU e memória em 60%, HD em 80%) estão adequados para o monitoramento da sua VPS.\nEndpoint HTTP para Alerta: Certifique-se de que o endpoint configurado para o alerta está correto e de que a apikey está preenchida corretamente.\n","height":1040,"width":780,"color":7},"type":"n8n-nodes-base.stickyNote","position":[1264,128],"typeVersion":1,"id":"a0e97164-c7ee-4d71-8372-e82dc44d258d","name":"Sticky Note"},{"parameters":{"content":"## Cleanup Automático Semanal no Docker","height":240,"width":840,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-208,272],"typeVersion":1,"id":"70047f2f-d6f9-4666-943f-a568f6699cbd","name":"Sticky Note1"},{"parameters":{"content":"##  Monitora o uso de CPU, Memória e HD \n","height":440,"width":1360,"color":5},"type":"n8n-nodes-base.stickyNote","position":[-208,528],"typeVersion":1,"id":"075690de-6bd6-4c64-a8fe-af987640193a","name":"Sticky Note2"},{"parameters":{"content":"","height":1128,"width":2420,"color":3},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-288,80],"id":"bfb0f67b-5884-4af6-b1d2-e82ec03e1837","name":"Sticky Note4"},{"parameters":{"rule":{"interval":[{"field":"hours"}]}},"id":"e6b82307-41c9-4e60-89fd-a48a4133486b","name":"Executa de Hora em Roda","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-128,688]},{"parameters":{"rule":{"interval":[{"field":"weeks"}]}},"id":"070c7bca-0801-4667-82ef-89c3fff4e107","name":"Semanal - Domingo 12am","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-144,336]},{"parameters":{"command":"echo \"CPU: $(top -bn1 | grep 'Cpu(s)' | sed 's/.*, *\\([0-9.]*\\)%* id.*/\\1/' | awk '{print 100 - $1\"%\"}'), MEMÓRIA: $(free -m | awk '/Mem:/ { printf(\"%.2f%\"), $3/$2 * 100 }'), HD: $(df -h / | awk 'NR==2 {print $5}')\""},"id":"9c5bf310-e53e-4b83-8faf-3e78dc1a7003","name":"Busca Dados da VPS","type":"n8n-nodes-base.ssh","typeVersion":1,"position":[128,336],"credentials":{"sshPassword":{"id":"8KrAEUyoUjRIi6yC","name":"SSH Password account"}}},{"parameters":{"command":"docker system prune -a --force"},"id":"966f3cd6-6003-4528-bf2c-1fae39aa1ad3","name":"Executa Limpeza","type":"n8n-nodes-base.ssh","typeVersion":1,"position":[400,336],"credentials":{"sshPassword":{"id":"8KrAEUyoUjRIi6yC","name":"SSH Password account"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[864,832],"id":"d5044610-a3fa-4019-937a-764d73180a46","name":"No Operation, do nothing"},{"parameters":{"command":"echo \"CPU: $(top -bn1 | grep 'Cpu(s)' | sed 's/.*, *\\([0-9.]*\\)%* id.*/\\1/' | awk '{print 100 - $1\"%\"}'), MEMÓRIA: $(free -m | awk '/Mem:/ { printf(\"%.2f%\"), $3/$2 * 100 }'), HD: $(df -h / | awk 'NR==2 {print $5}')\""},"id":"867d4efc-678e-4dbe-bf6d-3b9ed3c3cc86","name":"Busca Dados","type":"n8n-nodes-base.ssh","typeVersion":1,"position":[128,688],"credentials":{"sshPassword":{"id":"8KrAEUyoUjRIi6yC","name":"SSH Password account"}}},{"parameters":{"jsCode":"// Captura o valor de stdout do node anterior\nconst sshOutput = $json[\"stdout\"];\n\n// Extrair as porcentagens de CPU, Memória e HD usando regex\nconst cpuUsageMatch = sshOutput.match(/CPU: (\\d+(\\.\\d+)?)/);\nconst memoryUsageMatch = sshOutput.match(/MEMÓRIA: (\\d+(\\.\\d+)?)/);\nconst hdUsageMatch = sshOutput.match(/HD: (\\d+(\\.\\d+)?)/);\n\nif (cpuUsageMatch && memoryUsageMatch && hdUsageMatch) {\n    const cpu = parseFloat(cpuUsageMatch[1]);\n    const memoria = parseFloat(memoryUsageMatch[1]);\n    const hd = parseFloat(hdUsageMatch[1]);\n\n    // Retornar as porcentagens como um JSON com os itens separados\n    return {\n        cpu,\n        memoria,\n        hd\n    };\n} else {\n    throw new Error(\"Erro: Não foi possível extrair os valores de CPU, Memória e HD\");\n}"},"id":"23967569-229b-4d37-ae39-d401961865a7","name":"Recupera Estatísticas","type":"n8n-nodes-base.code","typeVersion":2,"position":[320,688]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"7e75fe56-99c8-4e8a-a9b4-ddeb77017bb5","leftValue":"={{ $item(\"0\").$node[\"Recupera Estatísticas\"].json[\"cpu\"] }}","rightValue":75,"operator":{"type":"number","operation":"gte"}},{"id":"daacb5d3-2569-43e5-afc3-ab5a78e4980e","leftValue":"={{ $item(\"0\").$node[\"Recupera Estatísticas\"].json[\"memoria\"] }}","rightValue":75,"operator":{"type":"number","operation":"gte"}},{"id":"0b83b92e-1fee-455f-ba51-da4f8ac50ef7","leftValue":"={{ $item(\"0\").$node[\"Recupera Estatísticas\"].json[\"hd\"] }}","rightValue":80,"operator":{"type":"number","operation":"gte"}}],"combinator":"or"},"looseTypeValidation":true,"options":{}},"id":"51d9991c-7345-4029-9bcb-d22d7d457237","name":"Verifica se está dentro do esperado","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[528,688]},{"parameters":{"resource":"messages-api","instanceName":"pessoal-lucas","remoteJid":"120363421402105782@g.us","messageText":"=ALERTA VPS:\n\nCpu: {{ $json.cpu }}%\n\nMemória: {{ $json.memoria }}%\n\nHD: {{ $json.hd }}%","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[864,544],"id":"b4c4cba2-e4ba-46a6-a728-db2db10b8158","name":"Envia Alerta","credentials":{"evolutionApi":{"id":"PmCvi1sxg0kx1JwA","name":"Evolution - pessoal-lucas"}}}],"connections":{"Executa de Hora em Roda":{"main":[[{"node":"Busca Dados","type":"main","index":0}]]},"Semanal - Domingo 12am":{"main":[[{"node":"Busca Dados da VPS","type":"main","index":0}]]},"Busca Dados da VPS":{"main":[[{"node":"Executa Limpeza","type":"main","index":0}]]},"Busca Dados":{"main":[[{"node":"Recupera Estatísticas","type":"main","index":0}]]},"Recupera Estatísticas":{"main":[[{"node":"Verifica se está dentro do esperado","type":"main","index":0}]]},"Verifica se está dentro do esperado":{"main":[[{"node":"Envia Alerta","type":"main","index":0}],[{"node":"No Operation, do nothing","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":{"node:Executa de Hora em Roda":{"recurrenceRules":[]},"node:Semanal - Domingo 12am":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"e48cbb2a-9430-4450-b357-2f26495c3852","triggerCount":2,"tags":[]}