{"createdAt":"2025-09-03T14:30:02.585Z","updatedAt":"2025-11-05T18:38:03.706Z","id":"WwefHSl7btJDOBg2","name":"BMS - 1.2 - Journal - Aprovador","active":true,"isArchived":false,"nodes":[{"parameters":{"content":"# Fluxo de Aprova√ß√£o dos Posts\n\n### Esse fluxo roda sempre que existe uma alteracao no sheets de controle do journal\n### O AI Agent define se aprova ou rejeita um post baseado em sua imagem e se ja foi postado alguma vez um tema similar","height":1008,"width":2448,"color":3},"type":"n8n-nodes-base.stickyNote","position":[448,-208],"typeVersion":1,"id":"4f4a4aba-effe-4dda-b3ed-3767828e5754","name":"Sticky Note13"},{"parameters":{"promptType":"define","text":"=Voc√™ √© respons√°vel por analisar uma not√≠cia com status \"aguardando\" e decidir se ela deve ser \"aprovada\" ou \"reprovada\".\n\nüìú Hist√≥rico de not√≠cias j√° postadas (use para evitar duplicidade; compare por t√≠tulo/legenda/evento):\n{{ $('Code1').item.json.historico }}\n\nüì∞ Not√≠cia para an√°lise:\nID: {{ $('Code1').item.json.noticia_id }}\nT√≠tulo: {{ $('Code1').item.json.titulo }}\nLegenda: {{ $('Code1').item.json.legenda }}\nDescricao da Imagem: {{ $json.content }}\n\nREGRAS:\n1) Duplicidade:\n   - Reprove se falar do MESMO evento j√° postado\n   - Ao reprovar por duplicidade, CITE o ID correspondente do hist√≥rico.\n   - N√£o reprovar por tema amplo gen√©rico\n\n2) Relev√¢ncia (tribut√°rio):\n-Aprove somente se for realmente relevante para empresas e profissionais do setor tribut√°rio (contadores, advogados tributaristas, empres√°rios, gestores financeiros).\n\n-A not√≠cia deve trazer impacto pr√°tico ou estrat√©gico: mudan√ßas na legisla√ß√£o, decis√µes do STF/STJ, julgamentos no CARF, atos da Receita Federal, altera√ß√µes em regimes (Lucro Real, Presumido, Simples), novos benef√≠cios fiscais ou aumento de carga tribut√°ria.\n\n-Rejeite not√≠cias superficiais, repetitivas, opinativas ou voltadas √† pessoa f√≠sica (IRPF, IPTU, IPVA, CPF).\n\n-Aprove apenas quando a relev√¢ncia for clara o bastante para que um profissional veja valor em buscar uma consultoria tribut√°ria.\n\n3) Imagem: Leia a descricao da imagem recebida e caso nao seja uma boa imagem para fazer a postagem reprove.\n\nSA√çDA (JSON PURO, sem texto extra):\n[\n  {\n    \"noticia_id\": \"{{ $('Code1').item.json.noticia_id }}\",\n    \"status_WhatsApp\": \"aprovado\" | \"reprovado\",\n    \"status_X\": \"aprovado\" | \"reprovado\",\n    \"justificativa\": \"motivo curto e objetivo; se duplicado, cite o ID original\"\n  }\n]\nREGRAS FINAIS:\n- N√£o altere noticia_id.\n- Retorne SOMENTE o array JSON.\n","options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[1872,128],"id":"4b67e903-f5cc-4100-9c3f-3941b495dcc8","name":"AI Agent","executeOnce":false},{"parameters":{"documentId":{"__rl":true,"value":"1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA","mode":"list","cachedResultName":"BMS - Controle Journal","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"status_WhatsApp","lookupValue":"aguardando"},{"lookupColumn":"status_X","lookupValue":"aguardando"}]},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[816,112],"id":"88c52137-2b3d-4b48-881b-acc7cd15c53c","name":"Noticias aguardando aprova√ß√£o","executeOnce":true,"credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}},"onError":"continueRegularOutput"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[1872,304],"id":"d035f1ce-babc-4065-8418-45f503210ce5","name":"gpt-4.1-mini","credentials":{"openRouterApi":{"id":"o1ywdYlH64cgqSMT","name":"OpenRouter account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const raw = $json.output;\nconst parsed = JSON.parse(raw); // Isso vira um array com 1 objeto\n\n// Retorna o primeiro e √∫nico objeto do array\nreturn {\n  json: parsed[0]\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2240,128],"id":"5d1b8142-1845-4338-9743-16a0f8e9a90b","name":"Code"},{"parameters":{"jsCode":"const items = $input.all();\nif (!items.length) return [];\n\nconst histItem = items[items.length - 1];\nconst historico = (histItem?.json?.historico ?? '');\n\n// opcional: corta pra evitar prompt gigante\nconst hist = historico.length > 15000 ? historico.slice(0,15000) : historico;\n\n// tudo menos o √∫ltimo (que √© o hist√≥rico)\nconst noticias = items.slice(0, -1);\n\nreturn noticias.map(i => ({\n  json: { ...i.json, historico: hist }\n}));\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1472,128],"id":"9a3b2176-65d3-4cba-86a9-591f8dd330f6","name":"Code1"},{"parameters":{"documentId":{"__rl":true,"value":"1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA","mode":"list","cachedResultName":"BMS - Controle Journal","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"status_X","lookupValue":"postado"},{"lookupColumn":"status_WhatsApp","lookupValue":"postado"}]},"combineFilters":"OR","options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[816,304],"id":"57bdf823-f38e-417d-ab32-dd9887ac87ac","name":"Noticias Postadas","executeOnce":true,"credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const DIAS = 3;\nconst corte = new Date(); corte.setDate(corte.getDate() - DIAS);\n\nfunction parseBR(v){\n  if (!v) return NaN;\n  if (v instanceof Date) return v;\n  const m = String(v).trim().match(/^(\\d{2})\\/(\\d{2})\\/(\\d{4})$/);\n  if (!m) return NaN;\n  const [_, dd, mm, yyyy] = m.map(Number);\n  return new Date(yyyy, mm-1, dd);\n}\n\n// filtra √∫ltimos DIAS\nconst recentes = $input.all().filter(i=>{\n  const j = i.json||{};\n  const raw = j.data_processamento || j.data_proce || j.data_proces || j.data;\n  const d = parseBR(raw);\n  return d instanceof Date && !isNaN(d) && d >= corte && (j.status||'').toLowerCase()==='aprovado';\n});\n\n// monta string\nlet historico = recentes.map(i=>{\n  const j=i.json||{};\n  return `ID:${j.noticia_id} | ${j.titulo||''} | ${j.legenda||''}`;\n}).join('\\n');\n\n// limita tamanho (evita prompt gigante)\nif (historico.length > 30000) historico = historico.slice(0,30000);\n\n// retorna **um √∫nico item**\nreturn [{ json: { historico } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1008,304],"id":"b71f188e-c52f-4c1b-8935-25aedb09fe01","name":"Code2","alwaysOutputData":true},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[1280,128],"id":"1efaba57-6717-4f03-9b72-7c79f68609d9","name":"Merge"},{"parameters":{"resource":"image","operation":"analyze","modelId":{"__rl":true,"value":"gpt-4o","mode":"list","cachedResultName":"GPT-4O"},"text":"\"Analise a imagem e descreva se ela est√° adequada para um post informativo no Instagram. Informe se a imagem est√° clara, n√≠tida, completa e relevante, ou se est√° borrada, cortada, vazia, sem sentido ou toda preta.\n\nAs vezes vem uma imagem toda escura apenas com legenda, nesses casos pode rejeitar. O importante e analisar a imagem de funto, todas sempre vem com legenda padrao, porem a imagem de fundo que deve ser avaliada.\n\nFundo totalmente escuro deve ser rejeitado\"","imageUrls":"={{ $json.imagem_url }}","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[1680,128],"id":"11319277-6b5a-47f9-9a45-8d148fc7fe8a","name":"Analyze image","credentials":{"openAiApi":{"id":"GLHn0uXL8dRQAYuS","name":"OpenAi account"}}},{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":30}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[576,176],"id":"c078dce4-c9bf-42ce-8038-a1e88c10bf6e","name":"Schedule Trigger"},{"parameters":{"jsCode":"return [items[0]];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1008,112],"id":"d6225a9a-a4e7-437a-af7a-14de3f2a90fa","name":"Code6"},{"parameters":{"operation":"update","documentId":{"__rl":true,"value":"1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA","mode":"list","cachedResultName":"BMS - Controle Journal","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA/edit#gid=0"},"columns":{"mappingMode":"autoMapInputData","value":{},"matchingColumns":["noticia_id"],"schema":[{"id":"noticia_id","displayName":"noticia_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"data_processamento","displayName":"data_processamento","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"titulo","displayName":"titulo","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"legenda","displayName":"legenda","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"legenda_x","displayName":"legenda_x","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"param_2","displayName":"param_2","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"param_3","displayName":"param_3","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"param_4","displayName":"param_4","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"fonte","displayName":"fonte","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"imagem","displayName":"imagem","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"arquivo_base64","displayName":"arquivo_base64","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"arquivo2_base64","displayName":"arquivo2_base64","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"arquivo3_base64","displayName":"arquivo3_base64","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"imagem_url","displayName":"imagem_url","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"imagem_url2","displayName":"imagem_url2","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"imagem_url3","displayName":"imagem_url3","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"status_WhatsApp","displayName":"status_WhatsApp","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"status_X","displayName":"status_X","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"nota","displayName":"nota","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"justificativa","displayName":"justificativa","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"output","displayName":"output","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"row_number","displayName":"row_number","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"readOnly":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[2448,128],"id":"d394a622-37e2-472c-ba87-8e05419bd0ab","name":"Atualizar status da noticia","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}}],"connections":{"AI Agent":{"main":[[{"node":"Code","type":"main","index":0}]]},"Noticias aguardando aprova√ß√£o":{"main":[[{"node":"Code6","type":"main","index":0}]]},"gpt-4.1-mini":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"Code":{"main":[[{"node":"Atualizar status da noticia","type":"main","index":0}]]},"Code1":{"main":[[{"node":"Analyze image","type":"main","index":0}]]},"Noticias Postadas":{"main":[[{"node":"Code2","type":"main","index":0}]]},"Code2":{"main":[[{"node":"Merge","type":"main","index":1}]]},"Merge":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Analyze image":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"Schedule Trigger":{"main":[[{"node":"Noticias aguardando aprova√ß√£o","type":"main","index":0},{"node":"Noticias Postadas","type":"main","index":0}]]},"Code6":{"main":[[{"node":"Merge","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","executionTimeout":-1,"errorWorkflow":"GbORhS24Rzw7hHlt"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]},"node:Google Sheets Trigger":{"documentId":"1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0","sheetId":0,"lastRevision":271,"lastRevisionLink":"https://docs.google.com/spreadsheets/export?id=1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0&revision=271&exportFormat=xlsx"},"node:Schedule Trigger1":{"recurrenceRules":[]},"node:Trigger nova noticia no sheets":{"documentId":"1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA","sheetId":0,"lastRevision":823,"lastRevisionLink":"https://docs.google.com/spreadsheets/export?id=1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA&revision=823&exportFormat=xlsx"}},"meta":{"templateCredsSetupCompleted":true},"pinData":{"Schedule Trigger":[{"json":{"timestamp":"2025-11-04T10:00:00.031-03:00","Readable date":"November 4th 2025, 10:00:00 am","Readable time":"10:00:00 am","Day of week":"Tuesday","Year":"2025","Month":"November","Day of month":"04","Hour":"10","Minute":"00","Second":"00","Timezone":"America/Sao_Paulo (UTC-03:00)"}}]},"versionId":"eb9fee7c-17e6-4d9b-a628-00e5aa47cf89","triggerCount":1,"tags":[]}