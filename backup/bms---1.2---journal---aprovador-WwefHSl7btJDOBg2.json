{"createdAt":"2025-09-03T14:30:02.585Z","updatedAt":"2025-10-28T14:20:34.505Z","id":"WwefHSl7btJDOBg2","name":"BMS - 1.2 - Journal - Aprovador","active":true,"isArchived":false,"nodes":[{"parameters":{"content":"# Fluxo de Aprova√ß√£o dos Posts\n\n### Esse fluxo roda sempre que existe uma alteracao no sheets de controle do journal\n### O AI Agent define se aprova ou rejeita um post baseado em sua imagem e se ja foi postado alguma vez um tema similar","height":1008,"width":5696,"color":3},"type":"n8n-nodes-base.stickyNote","position":[512,-128],"typeVersion":1,"id":"4f4a4aba-effe-4dda-b3ed-3767828e5754","name":"Sticky Note13"},{"parameters":{"promptType":"define","text":"=Voc√™ √© respons√°vel por analisar uma not√≠cia com status \"aguardando\" e decidir se ela deve ser \"aprovada\" ou \"reprovada\".\n\nüìú Hist√≥rico de not√≠cias j√° postadas (use para evitar duplicidade; compare por t√≠tulo/legenda/evento):\n{{ $('Code1').item.json.historico }}\n\nüì∞ Not√≠cia para an√°lise:\nID: {{ $('Code1').item.json.noticia_id }}\nT√≠tulo: {{ $('Code1').item.json.titulo }}\nLegenda: {{ $('Code1').item.json.legenda }}\nDescricao da Imagem: {{ $json.content }}\n\nREGRAS:\n1) Duplicidade:\n   - Reprove se falar do MESMO evento j√° postado\n   - Ao reprovar por duplicidade, CITE o ID correspondente do hist√≥rico.\n   - N√£o reprovar por tema amplo gen√©rico\n\n2) Relev√¢ncia (tribut√°rio):\n-Aprove somente se for realmente relevante para empresas e profissionais do setor tribut√°rio (contadores, advogados tributaristas, empres√°rios, gestores financeiros).\n\n-A not√≠cia deve trazer impacto pr√°tico ou estrat√©gico: mudan√ßas na legisla√ß√£o, decis√µes do STF/STJ, julgamentos no CARF, atos da Receita Federal, altera√ß√µes em regimes (Lucro Real, Presumido, Simples), novos benef√≠cios fiscais ou aumento de carga tribut√°ria.\n\n-Rejeite not√≠cias superficiais, repetitivas, opinativas ou voltadas √† pessoa f√≠sica (IRPF, IPTU, IPVA, CPF).\n\n-Aprove apenas quando a relev√¢ncia for clara o bastante para que um profissional veja valor em buscar uma consultoria tribut√°ria.\n\n3) Imagem: Leia a descricao da imagem recebida e caso nao seja uma boa imagem para fazer a postagem reprove.\n\nSA√çDA (JSON PURO, sem texto extra):\n[\n  {\n    \"noticia_id\": \"{{ $('Code1').item.json.noticia_id }}\",\n    \"status\": \"aprovado\" | \"reprovado\",\n    \"justificativa\": \"motivo curto e objetivo; se duplicado, cite o ID original\"\n  }\n]\nREGRAS FINAIS:\n- N√£o altere noticia_id.\n- Retorne SOMENTE o array JSON.\n","options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[1872,128],"id":"4b67e903-f5cc-4100-9c3f-3941b495dcc8","name":"AI Agent","executeOnce":false},{"parameters":{"documentId":{"__rl":true,"value":"1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA","mode":"list","cachedResultName":"BMS - Controle Journal","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"status","lookupValue":"aguardando"}]},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[816,112],"id":"88c52137-2b3d-4b48-881b-acc7cd15c53c","name":"Noticias aguardando aprova√ß√£o","executeOnce":true,"credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}},"onError":"continueRegularOutput"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[1872,304],"id":"d035f1ce-babc-4065-8418-45f503210ce5","name":"gpt-4.1-mini","credentials":{"openRouterApi":{"id":"o1ywdYlH64cgqSMT","name":"OpenRouter account"}}},{"parameters":{"operation":"update","documentId":{"__rl":true,"value":"1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA","mode":"list","cachedResultName":"BMS - Controle Journal","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA/edit#gid=0"},"columns":{"mappingMode":"autoMapInputData","value":{},"matchingColumns":["noticia_id"],"schema":[{"id":"noticia_id","displayName":"noticia_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"data_processamento","displayName":"data_processamento","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"titulo","displayName":"titulo","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"legenda","displayName":"legenda","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"fonte","displayName":"fonte","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"imagem","displayName":"imagem","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"arquivo_base64","displayName":"arquivo_base64","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"imagem_url","displayName":"imagem_url","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"imagem_url2","displayName":"imagem_url2","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"status","displayName":"status","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"nota","displayName":"nota","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"justificativa","displayName":"justificativa","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"output","displayName":"output","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"row_number","displayName":"row_number","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"readOnly":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[2464,128],"id":"d394a622-37e2-472c-ba87-8e05419bd0ab","name":"Atualizar status da noticia","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const raw = $json.output;\nconst parsed = JSON.parse(raw); // Isso vira um array com 1 objeto\n\n// Retorna o primeiro e √∫nico objeto do array\nreturn {\n  json: parsed[0]\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2240,128],"id":"5d1b8142-1845-4338-9743-16a0f8e9a90b","name":"Code"},{"parameters":{"jsCode":"const items = $input.all();\nif (!items.length) return [];\n\nconst histItem = items[items.length - 1];\nconst historico = (histItem?.json?.historico ?? '');\n\n// opcional: corta pra evitar prompt gigante\nconst hist = historico.length > 15000 ? historico.slice(0,15000) : historico;\n\n// tudo menos o √∫ltimo (que √© o hist√≥rico)\nconst noticias = items.slice(0, -1);\n\nreturn noticias.map(i => ({\n  json: { ...i.json, historico: hist }\n}));\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1472,128],"id":"9a3b2176-65d3-4cba-86a9-591f8dd330f6","name":"Code1"},{"parameters":{"documentId":{"__rl":true,"value":"1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA","mode":"list","cachedResultName":"BMS - Controle Journal","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"status","lookupValue":"aprovado"}]},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[816,304],"id":"57bdf823-f38e-417d-ab32-dd9887ac87ac","name":"Noticias Postadas","executeOnce":true,"credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const DIAS = 3;\nconst corte = new Date(); corte.setDate(corte.getDate() - DIAS);\n\nfunction parseBR(v){\n  if (!v) return NaN;\n  if (v instanceof Date) return v;\n  const m = String(v).trim().match(/^(\\d{2})\\/(\\d{2})\\/(\\d{4})$/);\n  if (!m) return NaN;\n  const [_, dd, mm, yyyy] = m.map(Number);\n  return new Date(yyyy, mm-1, dd);\n}\n\n// filtra √∫ltimos DIAS\nconst recentes = $input.all().filter(i=>{\n  const j = i.json||{};\n  const raw = j.data_processamento || j.data_proce || j.data_proces || j.data;\n  const d = parseBR(raw);\n  return d instanceof Date && !isNaN(d) && d >= corte && (j.status||'').toLowerCase()==='aprovado';\n});\n\n// monta string\nlet historico = recentes.map(i=>{\n  const j=i.json||{};\n  return `ID:${j.noticia_id} | ${j.titulo||''} | ${j.legenda||''}`;\n}).join('\\n');\n\n// limita tamanho (evita prompt gigante)\nif (historico.length > 30000) historico = historico.slice(0,30000);\n\n// retorna **um √∫nico item**\nreturn [{ json: { historico } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1008,304],"id":"b71f188e-c52f-4c1b-8935-25aedb09fe01","name":"Code2","alwaysOutputData":true},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[1280,128],"id":"1efaba57-6717-4f03-9b72-7c79f68609d9","name":"Merge"},{"parameters":{"resource":"fileFolder","searchMethod":"query","queryString":"=name = '{{ $json.arquivo_base64 }}' and trashed = false\n","limit":1,"filter":{},"options":{}},"type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[2672,416],"id":"864956be-49f7-4f61-8864-40cf8a1662d2","name":"Search files and folders","credentials":{"googleDriveOAuth2Api":{"id":"ZkmaJh5Y8Zdz8ju7","name":"Google Drive - lucas@getmia.com.br"}}},{"parameters":{"operation":"download","fileId":{"__rl":true,"value":"={{ $json.id }}","mode":"id"},"options":{}},"type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[2880,416],"id":"a6f02b3e-7d8b-4991-919c-0e9e16f3e25e","name":"Download file","credentials":{"googleDriveOAuth2Api":{"id":"ZkmaJh5Y8Zdz8ju7","name":"Google Drive - lucas@getmia.com.br"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Executar: Run Once for Each Item\nconst i = $itemIndex;\n\n// 1) Buscar dados do Sheets alinhando pelo √≠ndice do item atual\nconst sheetItems = $items('base_noticias');   // <- pega TODOS os itens do n√≥\nconst legenda = sheetItems?.[i]?.json?.legenda || '';\nconst param_2 = sheetItems?.[i]?.json?.param_2 || null;  // üÜï novo campo\nconst param_3 = sheetItems?.[i]?.json?.param_3 || null;  // üÜï novo campo\nconst param_4 = sheetItems?.[i]?.json?.param_4 || null;  // üÜï novo campo\nconst imagem_url = sheetItems?.[i]?.json?.imagem_url || null;  // üÜï novo campo\n\n// 2) Pegar o .txt baixado do Drive (base64 do ARQUIVO .txt)\nconst txtB64 = $input.item?.binary?.data?.data;\nif (!txtB64) {\n  throw new Error('Bin√°rio do .txt n√£o encontrado no node \"Download file\".');\n}\n\n// 3) .txt (base64) -> texto UTF-8 -> que cont√©m o base64 da IMAGEM\nconst content = Buffer.from(txtB64, 'base64').toString('utf8').trim();\n\n// 4) Se vier em dataURI, remover prefixo e capturar MIME\nconst m = content.match(/^data:([^;]+);base64,(.+)$/i);\nlet mimeType = m ? m[1] : null;\nlet base64 = (m ? m[2] : content).replace(/\\s+/g, ''); // remove quebras/espa√ßos\n\n// 5) Detectar MIME pelos \"magic bytes\" caso n√£o tenha\nconst buf = Buffer.from(base64, 'base64');\nif (!mimeType) {\n  const sig = buf.slice(0, 4).toString('hex');\n  if (sig.startsWith('ffd8ff')) mimeType = 'image/jpeg';\n  else if (sig === '89504e47') mimeType = 'image/png';\n  else if (sig.startsWith('47494638')) mimeType = 'image/gif';\n  else if (sig.startsWith('52494646')) mimeType = 'image/webp';\n  else mimeType = 'application/octet-stream';\n}\n\n// 6) Retornar o que outros n√≥s v√£o usar\nreturn {\n  json: {\n    noticiaIndex: i,\n    legenda,\n    param_2,    // üÜï adicionado\n    param_3,    // üÜï adicionado\n    param_4,    // üÜï adicionado\n    imagem_url,\n    mimeType,\n    base64\n  }\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3152,336],"id":"9da03eef-6d66-4082-8846-01b0e2ff5def","name":"Code3"},{"parameters":{"batchSize":"=1","options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[4768,416],"id":"0049c58d-10a6-4ddc-a66e-5bdc2bf54c97","name":"Loop Over Items1"},{"parameters":{"amount":"={{ 5 + Math.floor(Math.random() * 20) }}"},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[5216,416],"id":"f57b68cb-d678-4d19-a4f5-5c92b9b49f7f","name":"Wait","webhookId":"dce9f589-31c7-4599-98e3-e02f77da5852"},{"parameters":{"resource":"messages-api","instanceName":"bms-social-media","remoteJid":"=5511992486507","messageText":"=Mensagem para: {{ $('Wait').item.json.nome }} - {{ $('Wait').item.json.telefone }}\n\nTitulo: {{ $('Wait').item.json.param_2 }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[5696,416],"id":"7be18e39-70f6-4bf4-a889-eb3efc221328","name":"Envio do post - Journal List","credentials":{"evolutionApi":{"id":"vy2ySY8uAchmjNnK","name":"bms"}},"onError":"continueErrorOutput"},{"parameters":{"documentId":{"__rl":true,"value":"1IDXSuMzMhUFDCmKkpS9qSfH3UuBKyoOD66M75UYcgSs","mode":"list","cachedResultName":"CRM - BMS","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1IDXSuMzMhUFDCmKkpS9qSfH3UuBKyoOD66M75UYcgSs/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"journal_list","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1IDXSuMzMhUFDCmKkpS9qSfH3UuBKyoOD66M75UYcgSs/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"status","lookupValue":"ativo"},{"lookupColumn":"novo?","lookupValue":"cadastrado"}]},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[3152,512],"id":"cab43ded-da28-4939-b507-538d92d3112f","name":"Get row(s) in sheet1","executeOnce":true,"credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"resource":"image","operation":"analyze","modelId":{"__rl":true,"value":"gpt-4o","mode":"list","cachedResultName":"GPT-4O"},"text":"\"Analise a imagem e descreva se ela est√° adequada para um post informativo no Instagram. Informe se a imagem est√° clara, n√≠tida, completa e relevante, ou se est√° borrada, cortada, vazia, sem sentido ou toda preta.\n\nAs vezes vem uma imagem toda escura apenas com legenda, nesses casos pode rejeitar. O importante e analisar a imagem de funto, todas sempre vem com legenda padrao, porem a imagem de fundo que deve ser avaliada.\n\nFundo totalmente escuro deve ser rejeitado\"","imageUrls":"={{ $json.imagem_url }}","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[1680,128],"id":"11319277-6b5a-47f9-9a45-8d148fc7fe8a","name":"Analyze image","credentials":{"openAiApi":{"id":"GLHn0uXL8dRQAYuS","name":"OpenAi account"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Normaliza o telefone do item atual\nconst raw = $json.telefone || \"\";\nlet clean = String(raw).replace(/\\D+/g, \"\"); // mant√©m s√≥ os d√≠gitos\n\nif (clean.length === 11) {\n  clean = \"55\" + clean; // adiciona DDI se faltar\n} else if (clean.length === 13 && clean.startsWith(\"55\")) {\n  // j√° est√° ok\n}\n\n// Retorna o item original + o campo novo\nreturn {\n  json: {\n    ...$json,\n    telefoneAjustado: clean\n  }\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3600,432],"id":"49de7b0b-82a1-42fc-a6c0-c91e4bd14672","name":"Code4"},{"parameters":{"documentId":{"__rl":true,"value":"1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA","mode":"list","cachedResultName":"BMS - Controle Journal","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Ze1MFqVlu21qakfTTE5ECfAu4iFOoeQMygOCjPW5nek/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"noticia_id","lookupValue":"={{ $json.noticia_id }}"},{"lookupColumn":"status","lookupValue":"aprovado"}]},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[2464,416],"id":"dc8842f9-4f2b-4cf9-95cd-85c20fcb9dcc","name":"base_noticias","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"mode":"combineBySql","query":"SELECT\n  b.nome AS nome,\n  b.telefone AS telefone,\n  a.legenda AS legenda,\n  a.param_2 AS param_2,\n  a.param_3 AS param_3,\n  a.param_4 AS param_4,\n  a.base64 AS base64,\n  a.imagem_url AS imagem_url,\n  a.mimeType AS mimeType,\n  a.noticiaIndex AS idx\nFROM input1 a\nCROSS JOIN input2 b","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[3408,432],"id":"cf3306cc-551d-4b3f-b2a4-2651beacbaf4","name":"Merge1"},{"parameters":{"tableId":"bms-historico_mensagens","fieldsUi":{"fieldValues":[{"fieldId":"mensagem_usuario","fieldValue":"="},{"fieldId":"mensagem_agente","fieldValue":"={{ $('Wait').item.json.legenda }}"},{"fieldId":"telefone","fieldValue":"={{ $('Wait').item.json.telefone }}"},{"fieldId":"nome_usuario","fieldValue":"={{ $('Wait').item.json.nome }}"},{"fieldId":"message_type","fieldValue":"text"},{"fieldId":"ativo","fieldValue":"true"},{"fieldId":"nome_app","fieldValue":"SDR-BMS"},{"fieldId":"id_usuario","fieldValue":"={{ $('Wait').item.json.telefone }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[5984,512],"id":"126f6680-b549-41b7-9e7e-9e8276dc95b9","name":"Cria Mensagem no Supabase1","credentials":{"supabaseApi":{"id":"9FeQpCfKieI9F2Ms","name":"bms"}},"onError":"continueRegularOutput","notes":"Este fluxo √© de propriedade da FORMA√á√ÉO AGENTES DE IA COM N8N -BY RICNEVES"},{"parameters":{"operation":"getAll","tableId":"bms-historico_mensagens","returnAll":true},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[3856,304],"id":"4b947996-061b-4804-9035-49461441d4ae","name":"Get many rows","executeOnce":true,"credentials":{"supabaseApi":{"id":"9FeQpCfKieI9F2Ms","name":"bms"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"23d972c0-0f5f-48b0-bd9d-488327b1c337","leftValue":"={{ $json.mensagens_hoje }}","rightValue":4,"operator":{"type":"number","operation":"lt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[4976,432],"id":"de12c1c5-e03e-4023-88a6-9bfe42ef53e6","name":"If"},{"parameters":{"jsCode":"// 1Ô∏è‚É£ Captura todas as mensagens do Supabase\nconst mensagens = $items(\"Get many rows\");\n\n// 2Ô∏è‚É£ Captura todos os n√∫meros existentes no Code4 (para garantir que ningu√©m fique de fora)\nconst baseNumeros = $items(\"Code4\").map(item => String(item.json.telefoneAjustado || \"\").replace(/\\D+/g, \"\"));\n\n// 3Ô∏è‚É£ Pega a data de hoje em formato YYYY-MM-DD\nconst hoje = new Date().toISOString().slice(0, 10);\n\n// 4Ô∏è‚É£ Cria um dicion√°rio para contar mensagens por telefone\nconst contagem = {};\n\nfor (const item of mensagens) {\n  const msg = item.json;\n  const telefone = String(msg.telefone || \"\").replace(/\\D+/g, \"\");\n  const dataMsg = msg.created_at ? msg.created_at.slice(0, 10) : \"\";\n\n  // Se for de hoje, incrementa a contagem\n  if (dataMsg === hoje && telefone) {\n    contagem[telefone] = (contagem[telefone] || 0) + 1;\n  }\n}\n\n// 5Ô∏è‚É£ Garante que todos os n√∫meros da base venham com valor (0 se n√£o tiver mensagens hoje)\nfor (const tel of baseNumeros) {\n  if (!contagem[tel]) contagem[tel] = 0;\n}\n\n// 6Ô∏è‚É£ Transforma o dicion√°rio em array (como uma \"tabela\" pra merge)\nconst resultado = Object.entries(contagem).map(([telefone, mensagens_hoje]) => ({\n  json: { telefone, mensagens_hoje }\n}));\n\nreturn resultado;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4032,304],"id":"d1767a41-60f4-4fe2-89f3-d801a6af2cb7","name":"Code5"},{"parameters":{"mode":"combine","advanced":true,"mergeByFields":{"values":[{"field1":"telefone","field2":"telefoneAjustado"}]},"joinMode":"enrichInput2","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[4240,416],"id":"d274a040-0598-44f4-a672-b54d22c78cbd","name":"Merge2"},{"parameters":{"jsCode":"// Cria um mapa para controlar quantas vezes cada telefone aparece\nconst contador = {};\n\n// Percorre todos os itens recebidos (Code7 est√° antes do Loop)\nreturn $input.all().map(item => {\n  const json = item.json;\n  const telefone = json.telefoneAjustado;\n\n  // Valor inicial vindo do Supabase\n  const mensagensHoje = json.mensagens_hoje || 0;\n\n  // Se o telefone ainda n√£o foi visto neste lote, inicia com o valor atual do Supabase\n  if (!contador[telefone]) {\n    contador[telefone] = mensagensHoje;\n  }\n\n  // Incrementa 1 para esta ocorr√™ncia\n  contador[telefone]++;\n\n  // Retorna o item com o novo total\n  return {\n    json: {\n      ...json,\n      mensagens_hoje: contador[telefone],\n    },\n  };\n});\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4464,416],"id":"3439b838-89ba-4598-a69f-126715d2730d","name":"Code7"},{"parameters":{"rule":{"interval":[{"field":"cronExpression","expression":"0 10 * * 1-6"}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[576,176],"id":"c078dce4-c9bf-42ce-8038-a1e88c10bf6e","name":"Schedule Trigger"},{"parameters":{"jsCode":"return [items[0]];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1008,112],"id":"d6225a9a-a4e7-437a-af7a-14de3f2a90fa","name":"Code6"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v22.0/782664311604851/messages","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.telefoneAjustado }}\",\n  \"type\": \"template\",\n  \"template\": {\n    \"name\": \"atualizacao_cliente\",\n    \"language\": {\n      \"code\": \"pt_BR\"\n    },\n    \"components\": [\n      {\n        \"type\": \"header\",\n        \"parameters\": [\n          {\n            \"type\": \"image\",\n            \"image\": {\n              \"link\": \"{{ $json.imagem_url }}\"\n            }\n          }\n        ]\n      },\n      {\n        \"type\": \"body\",\n        \"parameters\": [\n          { \"type\": \"text\", \"text\": \"{{ $json.nome }}\" },\n          { \"type\": \"text\", \"text\": \"{{ $json.param_2 }}\" },\n          { \"type\": \"text\", \"text\": \"{{ $json.param_3 }}\" },\n          { \"type\": \"text\", \"text\": \"{{ $json.param_4 }}\" }\n        ]\n      }\n    ]\n  }\n}\n","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5456,416],"id":"ee2d90a0-7f9d-4ce4-b1ff-61aa86d82b98","name":"HTTP Request","retryOnFail":true,"credentials":{"httpBearerAuth":{"id":"W8jSHgF1bru0lIPY","name":"whatsapp"}}},{"parameters":{"method":"POST","url":"=https://chatwoot.miabuilder.com/api/v1/accounts/8/conversations/{{ $('Vari√°veis do Fluxo').item.json.message.chat_id }}/messages","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"},{"name":"api_access_token","value":"wr4beE6ke1EQNaaFqMVJWQmm"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"content","value":"={{ $json['output.mensagens'] }}"},{"name":"message_type","value":"outgoing"},{"name":"private","value":"false"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[5456,176],"id":"2f87c9d9-5b86-402f-8055-a3b171de9c11","name":"HTTP Request3","disabled":true,"onError":"continueErrorOutput"}],"connections":{"AI Agent":{"main":[[{"node":"Code","type":"main","index":0}]]},"Noticias aguardando aprova√ß√£o":{"main":[[{"node":"Code6","type":"main","index":0}]]},"gpt-4.1-mini":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"Code":{"main":[[{"node":"Atualizar status da noticia","type":"main","index":0},{"node":"base_noticias","type":"main","index":0}]]},"Code1":{"main":[[{"node":"Analyze image","type":"main","index":0}]]},"Noticias Postadas":{"main":[[{"node":"Code2","type":"main","index":0}]]},"Code2":{"main":[[{"node":"Merge","type":"main","index":1}]]},"Merge":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Search files and folders":{"main":[[{"node":"Download file","type":"main","index":0}]]},"Download file":{"main":[[{"node":"Code3","type":"main","index":0},{"node":"Get row(s) in sheet1","type":"main","index":0}]]},"Code3":{"main":[[{"node":"Merge1","type":"main","index":0}]]},"Loop Over Items1":{"main":[[],[{"node":"If","type":"main","index":0}]]},"Wait":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"Envio do post - Journal List":{"main":[[{"node":"Cria Mensagem no Supabase1","type":"main","index":0}],[{"node":"Cria Mensagem no Supabase1","type":"main","index":0}]]},"Get row(s) in sheet1":{"main":[[{"node":"Merge1","type":"main","index":1}]]},"Analyze image":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"Code4":{"main":[[{"node":"Get many rows","type":"main","index":0},{"node":"Merge2","type":"main","index":1}]]},"base_noticias":{"main":[[{"node":"Search files and folders","type":"main","index":0}]]},"Merge1":{"main":[[{"node":"Code4","type":"main","index":0}]]},"Get many rows":{"main":[[{"node":"Code5","type":"main","index":0}]]},"If":{"main":[[{"node":"Wait","type":"main","index":0}],[{"node":"Loop Over Items1","type":"main","index":0}]]},"Cria Mensagem no Supabase1":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"Code5":{"main":[[{"node":"Merge2","type":"main","index":0}]]},"Merge2":{"main":[[{"node":"Code7","type":"main","index":0}]]},"Code7":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"Schedule Trigger":{"main":[[{"node":"Noticias aguardando aprova√ß√£o","type":"main","index":0},{"node":"Noticias Postadas","type":"main","index":0}]]},"Code6":{"main":[[{"node":"Merge","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"Envio do post - Journal List","type":"main","index":0}]]},"HTTP Request3":{"main":[[],[]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","executionTimeout":-1,"errorWorkflow":"GbORhS24Rzw7hHlt"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]},"node:Google Sheets Trigger":{"documentId":"1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0","sheetId":0,"lastRevision":271,"lastRevisionLink":"https://docs.google.com/spreadsheets/export?id=1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0&revision=271&exportFormat=xlsx"},"node:Schedule Trigger1":{"recurrenceRules":[]},"node:Trigger nova noticia no sheets":{"documentId":"1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA","sheetId":0,"lastRevision":823,"lastRevisionLink":"https://docs.google.com/spreadsheets/export?id=1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA&revision=823&exportFormat=xlsx"}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"8842ff43-bed8-45e5-a864-9b011459fee4","triggerCount":1,"tags":[]}