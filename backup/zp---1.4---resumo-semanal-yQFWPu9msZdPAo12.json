{"createdAt":"2025-10-03T16:29:01.736Z","updatedAt":"2025-10-06T17:03:30.813Z","id":"yQFWPu9msZdPAo12","name":"ZP - 1.4 - Resumo Semanal","active":false,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"weeks","triggerAtDay":[1,4],"triggerAtHour":8}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-176,288],"id":"16d34bf9-0aa4-4bb7-a45b-3176061e428d","name":"Schedule Trigger1"},{"parameters":{"documentId":{"__rl":true,"value":"1Ze1MFqVlu21qakfTTE5ECfAu4iFOoeQMygOCjPW5nek","mode":"list","cachedResultName":"Controle Radar do Corretor","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Ze1MFqVlu21qakfTTE5ECfAu4iFOoeQMygOCjPW5nek/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Ze1MFqVlu21qakfTTE5ECfAu4iFOoeQMygOCjPW5nek/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"status","lookupValue":"postado"},{"lookupColumn":"last_4_days","lookupValue":"1"}]},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[144,288],"id":"b595e745-9ec6-4e27-8c2b-ed2c6c463cfd","name":"Get row(s) in sheet","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"jsCode":"// hoje em America/Sao_Paulo\nconst hoje = new Date();\n\n// fim = ontem\nconst fim = new Date(hoje);\nfim.setDate(fim.getDate() - 1);\n\n// início depende do dia da semana\nconst ini = new Date(fim);\n\nif (hoje.getDay() === 1) {\n  // Hoje é segunda → pega de quinta a domingo\n  ini.setDate(fim.getDate() - 3);  // quinta\n} else if (hoje.getDay() === 4) {\n  // Hoje é quinta → pega de segunda a quarta\n  ini.setDate(fim.getDate() - 2);  // segunda\n} else {\n  // fallback: últimos 3 dias\n  ini.setDate(fim.getDate() - 2);\n}\n\n// formatador dd/mm/yyyy\nconst fmt = d => String(d.getDate()).padStart(2,'0') + '/' +\n                 String(d.getMonth()+1).padStart(2,'0') + '/' +\n                 d.getFullYear();\n\nreturn {\n  data_ini: fmt(ini),\n  data_fim: fmt(fim)\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-16,288],"id":"8b5e7286-18a1-4ccd-87e6-a30fe2e31315","name":"Code"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[688,512],"id":"2074554b-d87b-4913-bd38-0cb4911f34ea","name":"OpenRouter Chat Model1","credentials":{"openRouterApi":{"id":"o1ywdYlH64cgqSMT","name":"OpenRouter account"}}},{"parameters":{"jsCode":"const items = $input.all();\nif (!items.length) {\n  return [{ json: { prompt: \"Nenhuma notícia encontrada no período.\" } }];\n}\n\n// datas vindas do primeiro node \"Code\" (ajuste o nome se o seu node tiver outro nome)\nconst { data_ini, data_fim } = $item(0).$node[\"Code\"].json;\n\n// Limita texto da legenda para não estourar token\nconst MAX = 500;\nconst cut = s => (s ?? '').toString().trim().slice(0, MAX);\n\n// Monta contexto com título + legenda reduzida\nconst contexto = items.map(it => {\n  const titulo  = (it.json.titulo  ?? '').toString().trim();\n  const legenda = cut(it.json.legenda);\n  return `• ${titulo}\\n${legenda}`;\n}).join(\"\\n\\n\");\n\n// Cabeçalhos\nconst header1 = `*Bom dia comunidade Radar Corretor!* 📰\\n\\n`;\nconst header2 = `Segue *resumo das notícias da semana*:\\n\\n`;\nconst header3 = `Acompanhe a nossa página no Instagram:\\nhttps://www.instagram.com/radarcorretor\\n\\n`;\n\n// Opcional: rodapé (deixe vazio se não precisar)\nconst footer = ``;\n\nconst prompt = `\nVocê é editor do briefing matinal da comunidade Radar Corretor (WhatsApp).\nProduza UMA mensagem concisa, didática e visual, com base nas notícias entre ${data_ini} e ${data_fim}.\nNão liste notícia por notícia. Não inclua links (além do Instagram já fornecido). Não invente fatos.\n\nBASE (referência; não copie literalmente):\n${contexto}\n\nFORMATO EXATO DA SAÍDA (mantenha as linhas fixas e a ordem):\n${header1}${header2}${header3}[RESUMO CONECTADO EM BLOCOS]\n- Estruture em 2 a 3 blocos, cada um com título em negrito (use negrito do WhatsApp: *texto* - apenas um asterisco, nunca dois)+ emoji na mesma linha (ex.: 📈 Economia, 🏠 Imobiliário, 🤖 Tech/Empresas).\n- Cada bloco deve ter 2 a 3 frases curtas, explicando o que aconteceu e por que importa para o corretor.\n- Separe os blocos com uma linha em branco.\n\nO que muda para o corretor:\n- (emoji) Bullets práticos\n\n[INSIRA AQUI uma ÚNICA linha com **uma frase motivacional de vendas em itálico com autor, formato exato: _\"frase\" — Autor_]\n\n${footer}\n\nREGRAS:\n- PT-BR, claro e objetivo; sem jargão.\n- Priorize números/dados quando existirem; se faltarem, não invente.\n- Obrigatório: a citação deve vir em itálico (use sublinhados do WhatsApp: _texto_).\n- Não adicione seções além das especificadas.\n- Mantenha um limite de 1524 caracteres\n`.trim();\n\nreturn [{ json: { prompt } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[512,288],"id":"92fe290a-33e7-437c-a41b-bc6e8b672585","name":"Code1"},{"parameters":{"content":"# Fluxo de Envio do Resumo Semanal para comunidade Whatsapp\n### Esse fluxo roda todo dia de manhã as 08am\n### Envia um resumo das notícias processadas no dia anterior","height":640,"width":2336,"color":3},"type":"n8n-nodes-base.stickyNote","position":[-224,64],"typeVersion":1,"id":"6ab650c1-8464-48d1-9e85-cb241ceee5fc","name":"Sticky Note15"},{"parameters":{"promptType":"define","text":"={{ $json.prompt }}","options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[688,288],"id":"72f897c9-c5bc-4ee3-bcfa-b0a37ca0efb8","name":"AI Agent1","executeOnce":true,"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const parseBR = (s) => {\n  if (!s) return NaN;\n  const [dd, mm, yyyy] = s.split('/');\n  return new Date(`${yyyy}-${mm}-${dd}T00:00:00-03:00`).getTime();\n};\n\n// pega o intervalo vindo do primeiro Code\nconst data_ini = $item(0).$node[\"Code\"].json.data_ini;\nconst data_fim = $item(0).$node[\"Code\"].json.data_fim;\nconst tIni = parseBR(data_ini);\nconst tFim = parseBR(data_fim);\n\nconst out = $input.all().filter(it => {\n  const st = (it.json.status || '').toLowerCase();\n  const t  = parseBR(it.json.data_processamento);\n  return st === 'postado' && !Number.isNaN(t) && t >= tIni && t <= tFim;\n});\n\nreturn out;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[336,288],"id":"5831f7a2-2d43-4ebc-a93f-781a72db7155","name":"Code2"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[1664,272],"id":"48815b42-557a-4903-8544-9fbda7d7e4ad","name":"Loop Over Items"},{"parameters":{"resource":"messages-api","operation":"send-image","instanceName":"social-media-radarcorretor","remoteJid":"120363418028617728@g.us","media":"={{$json.base64Image}}","caption":"={{ $item(0).$node[\"AI Agent\"].json.output }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1904,288],"id":"680711ef-4e96-464a-8168-00768ec1de6d","name":"Envio do post - Whatsapp","credentials":{"evolutionApi":{"id":"vDN1jxL85cL5Mz2G","name":"Evolution - Radar Corretor"}},"onError":"continueRegularOutput"},{"parameters":{"operation":"download","fileId":{"__rl":true,"value":"1etDnHoDaidl2KZmBpw4Z9RAs8FO18kCq","mode":"id"},"options":{}},"type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[1120,112],"id":"6a29e1e1-4835-4be6-b1f7-0a5c4a05d2bf","name":"Download file","credentials":{"googleDriveOAuth2Api":{"id":"ZkmaJh5Y8Zdz8ju7","name":"Google Drive - lucas@getmia.com.br"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// n8n Code node – pega o base64 do arquivo baixado no \"Download file\"\n\nconst binAll = $input.item.binary || {};\n\n// tenta 'imagem_final', depois 'data', depois a 1ª chave disponível\nconst key =\n  binAll.imagem_final ? 'imagem_final' :\n  (binAll.data ? 'data' : Object.keys(binAll)[0]);\n\nif (!key) throw new Error('Nenhum binário encontrado no item.');\n\nconst bin = binAll[key];\nif (!bin?.data) throw new Error(`Binário na chave \"${key}\" não possui .data.`);\n\n// já vem em base64; não reconverta\nconst base64 = bin.data;\n\nreturn {\n  json: {\n    base64Image: base64,                          // use isto no Evolution (media)\n    mimeType: bin.mimeType || 'application/octet-stream',\n    fileName: bin.fileName || 'arquivo'\n  }\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1328,112],"id":"fadeeb43-d1ba-41c6-96b8-a2556dad15a7","name":"Code3"}],"connections":{"Schedule Trigger1":{"main":[[{"node":"Code","type":"main","index":0}]]},"Get row(s) in sheet":{"main":[[{"node":"Code2","type":"main","index":0}]]},"Code":{"main":[[{"node":"Get row(s) in sheet","type":"main","index":0}]]},"OpenRouter Chat Model1":{"ai_languageModel":[[{"node":"AI Agent1","type":"ai_languageModel","index":0}]]},"Code1":{"main":[[{"node":"AI Agent1","type":"main","index":0}]]},"AI Agent1":{"main":[[{"node":"Download file","type":"main","index":0}]]},"Code2":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Loop Over Items":{"main":[[],[{"node":"Envio do post - Whatsapp","type":"main","index":0}]]},"Envio do post - Whatsapp":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Download file":{"main":[[{"node":"Code3","type":"main","index":0}]]},"Code3":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"UldWpZHcKTrRMFpI"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"b0db439e-f31b-459e-9ed4-9b72925e46b0","triggerCount":0,"tags":[]}