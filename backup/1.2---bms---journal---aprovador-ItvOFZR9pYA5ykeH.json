{"createdAt":"2025-09-30T02:14:22.246Z","updatedAt":"2025-10-06T18:38:25.839Z","id":"ItvOFZR9pYA5ykeH","name":"1.2 - BMS - Journal - Aprovador","active":false,"isArchived":true,"nodes":[{"parameters":{"content":"# Fluxo de Aprovação dos Posts\n\n### Esse fluxo roda sempre que existe uma alteracao no sheets de controle do journal\n### O AI Agent define se aprova ou rejeita um post baseado em sua imagem e se ja foi postado alguma vez um tema similar","height":784,"width":3552,"color":3},"type":"n8n-nodes-base.stickyNote","position":[384,-128],"typeVersion":1,"id":"4f4a4aba-effe-4dda-b3ed-3767828e5754","name":"Sticky Note13"},{"parameters":{"promptType":"define","text":"=Você é responsável por analisar uma notícia com status \"aguardando\" e decidir se ela deve ser \"aprovada\" ou \"reprovada\".\n\n📜 Histórico de notícias já postadas (use para evitar duplicidade; compare por título/legenda/evento):\n{{ $json.historico }}\n\n📰 Notícia para análise:\nID: {{ $json.noticia_id }}\nTítulo: {{ $json.titulo }}\nLegenda: {{ $json.legenda }}\nImagem: {{ $json.imagem_url }}\n\nREGRAS:\n1) Duplicidade:\n   - Reprove se falar do MESMO evento já postado\n   - Ao reprovar por duplicidade, CITE o ID correspondente do histórico.\n   - Não reprovar por tema amplo genérico\n\n2) Imagem:\n   - Reprove se a imagem for toda preta/branca, muito escura, cortada, com logo/marca d’água, baixa resolução ou sem relação clara com o conteúdo.\n\n3) Relevância (tributário):\n   - Aprove somente se for relevante no tema tributário, tem que ser relevante para quem esta recebendo sentir vontade de contratar uma consultoria para entender melhor. Nao aprove noticias superficiais.\n\nSAÍDA (JSON PURO, sem texto extra):\n[\n  {\n    \"noticia_id\": \"{{ $json.noticia_id }}\",\n    \"status\": \"aprovado\" | \"reprovado\",\n    \"justificativa\": \"motivo curto e objetivo; se duplicado, cite o ID original\"\n  }\n]\nREGRAS FINAIS:\n- Não altere noticia_id.\n- Retorne SOMENTE o array JSON.\n","options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[1456,128],"id":"4b67e903-f5cc-4100-9c3f-3941b495dcc8","name":"AI Agent","executeOnce":false},{"parameters":{"pollTimes":{"item":[{"mode":"everyMinute"}]},"documentId":{"__rl":true,"value":"1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA","mode":"list","cachedResultName":"BMS - Controle Journal","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA/edit#gid=0"},"options":{}},"type":"n8n-nodes-base.googleSheetsTrigger","typeVersion":1,"position":[448,112],"id":"66d274ce-9a60-477d-996e-0ef40ed96364","name":"Trigger nova noticia no sheets","credentials":{"googleSheetsTriggerOAuth2Api":{"id":"PvlXorOaq6vxhcle","name":"Google Sheets Trigger account"}}},{"parameters":{"documentId":{"__rl":true,"value":"1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA","mode":"list","cachedResultName":"BMS - Controle Journal","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"status","lookupValue":"aguardando"}]},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[672,112],"id":"88c52137-2b3d-4b48-881b-acc7cd15c53c","name":"Noticias aguardando aprovação","executeOnce":true,"credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}},"onError":"continueRegularOutput"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[1456,304],"id":"d035f1ce-babc-4065-8418-45f503210ce5","name":"gpt-4.1-mini","credentials":{"openRouterApi":{"id":"o1ywdYlH64cgqSMT","name":"OpenRouter account"}}},{"parameters":{"operation":"update","documentId":{"__rl":true,"value":"1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA","mode":"list","cachedResultName":"BMS - Controle Journal","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA/edit#gid=0"},"columns":{"mappingMode":"autoMapInputData","value":{},"matchingColumns":["noticia_id"],"schema":[{"id":"noticia_id","displayName":"noticia_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"data_processamento","displayName":"data_processamento","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"titulo","displayName":"titulo","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"legenda","displayName":"legenda","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"fonte","displayName":"fonte","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"imagem","displayName":"imagem","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"arquivo_base64","displayName":"arquivo_base64","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"imagem_url","displayName":"imagem_url","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"imagem_url2","displayName":"imagem_url2","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"status","displayName":"status","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"nota","displayName":"nota","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"justificativa","displayName":"justificativa","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"output","displayName":"output","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"row_number","displayName":"row_number","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"readOnly":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[2160,128],"id":"d394a622-37e2-472c-ba87-8e05419bd0ab","name":"Atualizar status da noticia","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const raw = $json.output;\nconst parsed = JSON.parse(raw); // Isso vira um array com 1 objeto\n\n// Retorna o primeiro e único objeto do array\nreturn {\n  json: parsed[0]\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1792,128],"id":"5d1b8142-1845-4338-9743-16a0f8e9a90b","name":"Code"},{"parameters":{"jsCode":"const items = $input.all();\nif (!items.length) return [];\n\nconst histItem = items[items.length - 1];\nconst historico = (histItem?.json?.historico ?? '');\n\n// opcional: corta pra evitar prompt gigante\nconst hist = historico.length > 15000 ? historico.slice(0,15000) : historico;\n\n// tudo menos o último (que é o histórico)\nconst noticias = items.slice(0, -1);\n\nreturn noticias.map(i => ({\n  json: { ...i.json, historico: hist }\n}));\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1264,128],"id":"9a3b2176-65d3-4cba-86a9-591f8dd330f6","name":"Code1"},{"parameters":{"documentId":{"__rl":true,"value":"1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA","mode":"list","cachedResultName":"BMS - Controle Journal","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"status","lookupValue":"postado"}]},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[672,304],"id":"57bdf823-f38e-417d-ab32-dd9887ac87ac","name":"Noticias Postadas","executeOnce":true,"credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const DIAS = 3;\nconst corte = new Date(); corte.setDate(corte.getDate() - DIAS);\n\nfunction parseBR(v){\n  if (!v) return NaN;\n  if (v instanceof Date) return v;\n  const m = String(v).trim().match(/^(\\d{2})\\/(\\d{2})\\/(\\d{4})$/);\n  if (!m) return NaN;\n  const [_, dd, mm, yyyy] = m.map(Number);\n  return new Date(yyyy, mm-1, dd);\n}\n\n// filtra últimos DIAS\nconst recentes = $input.all().filter(i=>{\n  const j = i.json||{};\n  const raw = j.data_processamento || j.data_proce || j.data_proces || j.data;\n  const d = parseBR(raw);\n  return d instanceof Date && !isNaN(d) && d >= corte && (j.status||'').toLowerCase()==='postado';\n});\n\n// monta string\nlet historico = recentes.map(i=>{\n  const j=i.json||{};\n  return `ID:${j.noticia_id} | ${j.titulo||''} | ${j.legenda||''}`;\n}).join('\\n');\n\n// limita tamanho (evita prompt gigante)\nif (historico.length > 15000) historico = historico.slice(0,15000);\n\n// retorna **um único item**\nreturn [{ json: { historico } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[864,304],"id":"b71f188e-c52f-4c1b-8935-25aedb09fe01","name":"Code2","alwaysOutputData":true},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[1072,128],"id":"1efaba57-6717-4f03-9b72-7c79f68609d9","name":"Merge"},{"parameters":{"documentId":{"__rl":true,"value":"1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA","mode":"list","cachedResultName":"BMS - Controle Journal","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Ze1MFqVlu21qakfTTE5ECfAu4iFOoeQMygOCjPW5nek/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"noticia_id","lookupValue":"={{ $json.noticia_id }}"}]},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[2160,416],"id":"dc8842f9-4f2b-4cf9-95cd-85c20fcb9dcc","name":"Get row(s) in sheet","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"resource":"fileFolder","searchMethod":"query","queryString":"=name = '{{ $json.arquivo_base64 }}' and trashed = false\n","limit":1,"filter":{},"options":{}},"type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[2368,416],"id":"864956be-49f7-4f61-8864-40cf8a1662d2","name":"Search files and folders","credentials":{"googleDriveOAuth2Api":{"id":"ZkmaJh5Y8Zdz8ju7","name":"Google Drive - lucas@getmia.com.br"}}},{"parameters":{"operation":"download","fileId":{"__rl":true,"value":"={{ $json.id }}","mode":"id"},"options":{}},"type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[2576,416],"id":"a6f02b3e-7d8b-4991-919c-0e9e16f3e25e","name":"Download file","credentials":{"googleDriveOAuth2Api":{"id":"ZkmaJh5Y8Zdz8ju7","name":"Google Drive - lucas@getmia.com.br"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Executar: Run Once for Each Item\nconst i = $itemIndex;\n\n// 1) Buscar a legenda do Sheets alinhando pelo índice do item atual\nconst sheetItems = $items('Get row(s) in sheet');   // <- pega TODOS os itens do nó\nconst legenda = sheetItems?.[i]?.json?.legenda || '';  // usa o i como itemIndex\n\n// 2) Pegar o .txt baixado do Drive (base64 do ARQUIVO .txt)\nconst txtB64 = $input.item?.binary?.data?.data;\nif (!txtB64) {\n  throw new Error('Binário do .txt não encontrado no node \"Download file\".');\n}\n\n// 3) .txt (base64) -> texto UTF-8 -> que contém o base64 da IMAGEM\nconst content = Buffer.from(txtB64, 'base64').toString('utf8').trim();\n\n// 4) Se vier em dataURI, remover prefixo e capturar MIME\nconst m = content.match(/^data:([^;]+);base64,(.+)$/i);\nlet mimeType = m ? m[1] : null;\nlet base64 = (m ? m[2] : content).replace(/\\s+/g, ''); // remove quebras/espaços\n\n// 5) Detectar MIME pelos \"magic bytes\" caso não tenha\nconst buf = Buffer.from(base64, 'base64');\nif (!mimeType) {\n  const sig = buf.slice(0, 4).toString('hex');\n  if (sig.startsWith('ffd8ff')) mimeType = 'image/jpeg';\n  else if (sig === '89504e47') mimeType = 'image/png';\n  else if (sig.startsWith('47494638')) mimeType = 'image/gif';\n  else if (sig.startsWith('52494646')) mimeType = 'image/webp';\n  else mimeType = 'application/octet-stream';\n}\n\n// 6) Retornar o que outros nós vão usar\nreturn {\n  json: {\n    index: i,\n    legenda,\n    mimeType,\n    base64\n    // Se o seu node de envio exigir com prefixo:\n    // base64WithPrefix: `data:${mimeType};base64,${base64}`\n  }\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2784,416],"id":"9da03eef-6d66-4082-8846-01b0e2ff5def","name":"Code3"},{"parameters":{"batchSize":"=1","options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[3264,416],"id":"0049c58d-10a6-4ddc-a66e-5bdc2bf54c97","name":"Loop Over Items1"},{"parameters":{"amount":"={{ 3 + Math.floor(Math.random() * 5) }}"},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[3504,432],"id":"f57b68cb-d678-4d19-a4f5-5c92b9b49f7f","name":"Wait","webhookId":"dce9f589-31c7-4599-98e3-e02f77da5852"},{"parameters":{"resource":"messages-api","operation":"send-image","instanceName":"bms-social-media","remoteJid":"={{ $json.telefone }}","media":"={{ $('Code3').item.json.base64 }}","caption":"=Oi , {{ $json.nome }} tudo bem?  \n\nSegue mais uma notícia sobre o mundo tributário!  \n\n{{ $('Get row(s) in sheet').item.json.legenda }}  \n\nSe não quiser mais receber notícias no seu celular responda essa mensagem com \"opt-out\".","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[3696,432],"id":"7be18e39-70f6-4bf4-a889-eb3efc221328","name":"Envio do post - Journal List","credentials":{"evolutionApi":{"id":"vy2ySY8uAchmjNnK","name":"bms"}},"onError":"continueRegularOutput"},{"parameters":{"documentId":{"__rl":true,"value":"1IDXSuMzMhUFDCmKkpS9qSfH3UuBKyoOD66M75UYcgSs","mode":"list","cachedResultName":"CRM - BMS","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1IDXSuMzMhUFDCmKkpS9qSfH3UuBKyoOD66M75UYcgSs/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Página1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1IDXSuMzMhUFDCmKkpS9qSfH3UuBKyoOD66M75UYcgSs/edit#gid=0"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[2992,416],"id":"cab43ded-da28-4939-b507-538d92d3112f","name":"Get row(s) in sheet1","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}}],"connections":{"AI Agent":{"main":[[{"node":"Code","type":"main","index":0}]]},"Trigger nova noticia no sheets":{"main":[[{"node":"Noticias aguardando aprovação","type":"main","index":0},{"node":"Noticias Postadas","type":"main","index":0}]]},"Noticias aguardando aprovação":{"main":[[{"node":"Merge","type":"main","index":0}]]},"gpt-4.1-mini":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"Code":{"main":[[{"node":"Atualizar status da noticia","type":"main","index":0},{"node":"Get row(s) in sheet","type":"main","index":0}]]},"Code1":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"Noticias Postadas":{"main":[[{"node":"Code2","type":"main","index":0}]]},"Code2":{"main":[[{"node":"Merge","type":"main","index":1}]]},"Merge":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Get row(s) in sheet":{"main":[[{"node":"Search files and folders","type":"main","index":0}]]},"Search files and folders":{"main":[[{"node":"Download file","type":"main","index":0}]]},"Download file":{"main":[[{"node":"Code3","type":"main","index":0}]]},"Code3":{"main":[[{"node":"Get row(s) in sheet1","type":"main","index":0}]]},"Loop Over Items1":{"main":[[],[{"node":"Wait","type":"main","index":0}]]},"Wait":{"main":[[{"node":"Envio do post - Journal List","type":"main","index":0}]]},"Envio do post - Journal List":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"Get row(s) in sheet1":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","executionTimeout":-1,"errorWorkflow":"GbORhS24Rzw7hHlt"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Trigger nova noticia no sheets":[{"json":{"row_number":197,"change_type":"added","noticia_id":"noticia_20250929_183111_001","data_processamento":45929,"titulo":"Segurança jurídica: base essencial para empreendedores inovadores no Brasil","legenda":"A segurança jurídica é fundamental para o crescimento dos pequenos negócios inovadores, garantindo estabilidade e previsibilidade num cenário econômico marcado por constantes mudanças e instabilidade normativa.\n\nSegurança jurídica refere-se à clareza, estabilidade e previsibilidade das regras que governam as relações econômicas e jurídicas, permitindo que empreendedores tomem decisões com confiança e planejamentos de longo prazo.\n\nPara empresários e gestores financeiros, um ambiente jurídico seguro reduz riscos tributários, evita surpresas com normativos fiscais e fortalece a competitividade, incentivando investimentos e inovação.\n\nComo podemos estimular a construção de normas tributárias que acompanhem a inovação sem comprometer a segurança jurídica e o ambiente de negócios?\n\nSe quer garantir que seu negócio esteja preparado para as complexidades legais e tributárias do mercado atual, marque uma agenda com nossos especialistas e otimize sua estratégia tributária.","fonte":"https://g1.globo.com/ma/maranhao/especial-publicitario/federacao-das-industrias-do-estado-do-maranhao-expo-industria-2025/noticia/2025/09/29/a-seguranca-juridica-e-o-alicerce-que-sustenta-a-confianca-do-empreendedor.ghtml","imagem":"https://s.glbimg.com/jo/g1/static/live/imagens/img_facebook.png?g1","arquivo_base64":"noticia_20250929_183111_001.txt","imagem_url":"https://raw.githubusercontent.com/getmia/miabuilder-images/main/images/20250929183109015.jpg","imagem_url2":"https://raw.githubusercontent.com/getmia/miabuilder-images/main/images/202509291831103052.jpg","status":"aguardando","nota":8,"justificativa":"","output":""}}]},"versionId":"d9c30017-1e1a-48f5-9d44-6687b3e61d78","triggerCount":0,"tags":[]}