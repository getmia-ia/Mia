{"createdAt":"2025-11-10T20:00:24.637Z","updatedAt":"2025-11-14T22:16:16.156Z","id":"LehnDUuuGefsfACB","name":"BMS - 6.3 - Plot Gráficos (Folha)","active":false,"isArchived":false,"nodes":[{"parameters":{"content":"## Processar os dados que recebeu","height":304,"width":640,"color":3},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-320,-128],"id":"79af2512-3064-4086-b1f6-9171120847bf","name":"Sticky Note"},{"parameters":{"content":"## Code para preparar a url com os dados ","height":304,"width":432},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[352,-128],"id":"d51a4ed8-ab4c-4a21-8d96-d8a222b40cd7","name":"Sticky Note1"},{"parameters":{"content":"## Converte para base64","height":304,"width":368},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[800,-128],"id":"2b566d0e-5d13-4e36-b239-9051cc5f41a9","name":"Sticky Note2"},{"parameters":{"model":"openai/gpt-4.1","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[0,224],"id":"bbf475d3-bd69-4d4e-990f-27e695931510","name":"OpenRouter Chat Model","credentials":{"openRouterApi":{"id":"o1ywdYlH64cgqSMT","name":"OpenRouter account"}}},{"parameters":{"jsCode":"// === INPUT ===\nlet chart = $json;\n\n// Se vier como string dentro de \"output\", faz o parse\nif (typeof chart.output === 'string') {\n  try {\n    const jsonClean = chart.output\n      .replace(/```json/g, '')   // remove ```json\n      .replace(/```/g, '')       // remove ```\n      .replace(/\\/\\/.*$/gm, '')  // remove // comentários\n      .replace(/\\/\\*[\\s\\S]*?\\*\\//g, ''); // remove /* ... */ comentários\n    chart = JSON.parse(jsonClean);\n  } catch (e) {\n    throw new Error('❌ Falha ao converter chart.output para JSON: ' + e.message);\n  }\n}\n\n\n// === BASE CONFIG ===\nconst baseUrl = 'https://image-charts.com/chart.js/2.8.0';\nconst background = 'white';\nconst colors = [\n  'rgba(78,121,167,0.7)',\n  'rgba(242,142,43,0.7)',\n  'rgba(225,87,89,0.7)',\n  'rgba(118,183,178,0.7)',\n  'rgba(89,161,79,0.7)',\n  'rgba(237,201,73,0.7)',\n  'rgba(175,122,161,0.7)',\n  'rgba(255,157,167,0.7)',\n  'rgba(156,117,95,0.7)',\n  'rgba(186,176,171,0.7)',\n];\n\nlet datasets = [];\nlet config;\n\n// === LINHA ===\nif (chart.tipo === 'linha') {\n  if (Array.isArray(chart.values)) {\n    // apenas uma série\n    datasets = [{\n      label: chart.descricao || 'Valores',\n      data: chart.values,\n      fill: false,\n      borderColor: colors[0].replace('0.7','1'),\n      backgroundColor: colors[0],\n      tension: 0.3,\n      pointRadius: 3\n    }];\n  } else if (typeof chart.values === 'object') {\n    // múltiplas séries\n    datasets = Object.entries(chart.values).map(([label, data], i)=>({\n      label,\n      data,\n      fill: false,\n      borderColor: colors[i % colors.length].replace('0.7','1'),\n      backgroundColor: colors[i % colors.length],\n      tension: 0.3,\n      pointRadius: 3\n    }));\n  }\n\n  config = {\n    type: 'line',\n    data: {\n      labels: chart.labels,\n      datasets\n    },\n    options: {\n      responsive: true,\n      plugins: {\n        legend: { position: 'top' },\n        title: { display: true, text: chart.titulo }\n      },\n      elements: { point: { radius: 3 } }\n    }\n  };\n}\n\n// === PIZZA ===\nelse if (chart.tipo === 'pizza') {\n  datasets = [{\n    data: chart.values,\n    backgroundColor: colors.slice(0, chart.labels.length),\n    borderColor: 'white',\n    borderWidth: 2\n  }];\n\n  const total = chart.values.reduce((sum, value) => sum + value, 0);\n  \n  config = {\n    type: 'pie',\n    data: {\n      labels: chart.labels, // Labels simples\n      datasets\n    },\n    options: {\n      responsive: true,\n      plugins: {\n        legend: { \n          position: 'right',\n          labels: {\n            usePointStyle: true,\n            padding: 15,\n            font: {\n              size: 11\n            },\n            // Legenda customizada com valores\n            generateLabels: function(chart) {\n              const data = chart.data;\n              return data.labels.map((label, i) => {\n                const value = data.datasets[0].data[i];\n                const percentage = Math.round((value / total) * 100);\n                return {\n                  text: `${label}: R$ ${value.toLocaleString('pt-BR')} (${percentage}%)`,\n                  fillStyle: data.datasets[0].backgroundColor[i],\n                  strokeStyle: data.datasets[0].borderColor[i],\n                  lineWidth: data.datasets[0].borderWidth,\n                  pointStyle: 'circle'\n                };\n              });\n            }\n          }\n        },\n        title: { \n          display: true, \n          text: chart.titulo\n        }\n      }\n    }\n  };\n}\n// === HORIZONTAL ===\nelse if (chart.tipo === 'horizontal') {\n  if (Array.isArray(chart.values)) {\n    datasets = [{\n      label: chart.descricao || 'Valores',\n      data: chart.values,\n      backgroundColor: colors.slice(0, chart.labels.length),\n      borderColor: colors.slice(0, chart.labels.length).map(c => c.replace('0.7','1')),\n      borderWidth: 1\n    }];\n  } else if (typeof chart.values === 'object') {\n    datasets = Object.entries(chart.values).map(([label, data], i)=>({\n      label,\n      data,\n      backgroundColor: colors[i % colors.length],\n      borderColor: colors[i % colors.length].replace('0.7','1'),\n      borderWidth: 1\n    }));\n  }\n\n  config = {\n    type: 'bar',\n    data: {\n      labels: chart.labels,\n      datasets\n    },\n    options: {\n      indexAxis: 'y', // horizontal\n      responsive: true,\n      plugins: {\n        legend: { position: 'right' },\n        title: { display: true, text: chart.titulo }\n      }\n    }\n  };\n}\n\n// === BARRAS VERTICAIS ===\nelse {\n  if (Array.isArray(chart.values)) {\n    datasets = [{\n      label: chart.descricao || 'Valores',\n      data: chart.values,\n      backgroundColor: colors.slice(0, chart.labels.length),\n      borderColor: colors.slice(0, chart.labels.length).map(c => c.replace('0.7','1')),\n      borderWidth: 1\n    }];\n  } else if (typeof chart.values === 'object') {\n    datasets = Object.entries(chart.values).map(([label, data], i)=>({\n      label,\n      data,\n      backgroundColor: colors[i % colors.length],\n      borderColor: colors[i % colors.length].replace('0.7','1'),\n      borderWidth: 1\n    }));\n  }\n\n  config = {\n    type: 'bar',\n    data: {\n      labels: chart.labels,\n      datasets\n    },\n    options: {\n      responsive: true,\n      plugins: {\n        legend: { position: 'top' },\n        title: { display: true, text: chart.titulo }\n      }\n    }\n  };\n}\n\n// === FINAL URL ===\nconst jsonConfig = encodeURIComponent(JSON.stringify(config));\nconst url = `${baseUrl}?bkg=${background}&c=${jsonConfig}`;\n\nreturn [{\n  json: { url, chart }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[416,-32],"id":"42718ab4-b595-42bd-9d8d-c07f15f55aea","name":"Prepara a url de requisição da api"},{"parameters":{"url":"={{$json[\"url\"]}}","responseFormat":"file","options":{}},"name":"Chama a api Image-Chart","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[624,-32],"id":"fca1e952-7bd0-406e-aca4-7d77ecb860f3"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const binaryData = $input.item.binary?.[\"data\"];\n\nif (!binaryData || !binaryData.data) {\n  throw new Error(\"Campo 'data' não encontrado no binário.\");\n}\n\nconst base64 = Buffer.from(binaryData.data, 'base64').toString(\"base64\");\n\nreturn {\n  json: {\n    base64Image: base64\n  }\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[928,-32],"id":"511dc25e-f365-434d-b3bf-834340945857","name":"Binary > base64"},{"parameters":{"promptType":"define","text":"=Você é um assistente especializado em geração de gráficos com a API **Image-Charts**.\n\nRecebe uma entrada no formato:\n\n{\n  \"pergunta\": {{ $json.pergunta }},\n  \"filtros\": {{ JSON.stringify($json.filtros, null, 2) }},\n  \"dados\": {{ JSON.stringify($json.dados, null, 2) }}\n}\n\nSeu papel é:\n\n1. **Analisar os dados** para identificar o tipo de relação (temporal, categórica ou proporcional).\n\n2. **Escolher o tipo de gráfico mais adequado** entre:\n\n   * `\"linha\"` → se houver uma coluna de tempo (ex: `Mes`, `Ano`, `Periodo`) ou variação temporal.\n   * `\"pizza\"` → se o total de categorias for ≤ 6 e representar **partes de um todo** (ex: participação, proporção, composição).\n   * `\"barras\"` → se houver **valores comparativos entre categorias** (ex: ranking, total por área, gasto por rubrica).\n   * `\"horizontal\"` → se houver muitas categorias (ex: mais de 10) e a leitura for mais adequada horizontalmente.\n\n3. **Definir automaticamente uma escala adequada para os valores**, conforme:\n\n   * Se os valores forem **maiores que 1.000.000**, converter para **milhões** (dividindo por 1.000.000) e indicar **“(em milhões)”** no título.\n   * Se os valores forem **maiores que 1.000**, converter para **milhares** (dividindo por 1.000) e indicar **“(em milhares)”** no título.\n   * Se menores, manter como estão.\n\n4. **Gerar uma legenda curta e direta** no campo `\"descricao\"`.\n\n   * Deve ter no máximo **10 palavras**.\n   * Exemplos: `\"Gasto mensal por área\"`, `\"Ranking de custos por rubrica\"`, `\"Evolução de férias por mês\"`.\n   * Evite repetições do título.\n\n5. **Escolher o tipo de gráfico com base no formato dos dados**:\n\n   * **Total gasto (com campo “Mes”)** → Gráfico de **linha**. Se houver mais de uma categoria além do mês, gere **múltiplas séries** (uma linha por categoria).\n     Exemplo de resultado:\n     `[{\"Mes\":\"06/2025\",\"Total_Gasto\":1123556.14}, {\"Mes\":\"07/2025\",\"Total_Gasto\":1130000.22}]`.\n   * **Ranking** → Gráfico de **barras** (ou **pizza** se ≤6 categorias).\n     Exemplo:\n     `[{\"Categoria\":\"TI\",\"Total_Gasto\":528894.02}, {\"Categoria\":\"Marketing\",\"Total_Gasto\":511608.41}]`.\n   * **Consulta detalhada** → Não gerar gráfico. Apenas resumo textual.\n     Exemplo:\n     `[{\"Nome\":\"Maria\",\"Cargo\":\"Analista\",\"Departamento\":\"TI\",\"Tipo_Custo\":\"Férias\",\"Valor\":2500.00}]`.\n\nSempre que houver apenas uma série de valores, values deve ser um array de números.\nSempre que houver múltiplas séries, values deve ser um objeto, onde cada chave é o nome da série e o valor é um array de números.\n\nExemplo de uma série:\n{\n  \"tipo\": \"linha\",\n  \"labels\": [\"05/2025\",\"06/2025\",\"07/2025\"],\n  \"values\": [1.1, 1.12, 1.13],\n  \"titulo\": \"...\",\n  \"descricao\": \"...\"\n}\n\nDuas ou mais séries::\n{\n  \"tipo\": \"linha\",\n  \"labels\": [\"05/2025\",\"06/2025\",\"07/2025\"],\n  \"values\": {\n    \"TI\": [1.1, 1.12, 1.13],\n    \"Marketing\": [0.9, 0.95, 1.0]\n  },\n  \"titulo\": \"...\",\n  \"descricao\": \"...\"\n}\n\n6. **Preparar o JSON de saída** com esta estrutura:\n\n{\n  \"tipo\": \"barras\" | \"pizza\" | \"linha\" | \"horizontal\",\n  \"labels\": [\"TI\", \"Marketing\", \"RH\"],\n  \"values\": [528.89, 511.60, 490.98],\n  \"titulo\": \"Gasto por Departamento com Férias (em milhares) - Últimos 3 meses\",\n  \"descricao\": \"Ranking de gastos por departamento\"\n}\n","options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[0,-32],"id":"0075e9d6-57f8-40c1-bbcd-b1ad8c40f318","name":"Define o tipo de gráfico que vai ser gerado"},{"parameters":{"inputSource":"jsonExample","jsonExample":"{\n  \"pergunta\": \"{{ $json.pergunta }}\",\n  \"dados\": \"{{ $json.resultados }}\", \n  \"filtros\": \"{{ $json.filtros }}\"\n}"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-208,-32],"id":"b1247058-1d2e-45fa-837d-f4fae28bcc6c","name":"When Executed by Another Workflow"},{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-464,-16],"id":"3bec7ac8-71ff-4ed1-9103-959da885ba61","name":"When clicking ‘Execute workflow’","disabled":true}],"connections":{"OpenRouter Chat Model":{"ai_languageModel":[[{"node":"Define o tipo de gráfico que vai ser gerado","type":"ai_languageModel","index":0}]]},"Prepara a url de requisição da api":{"main":[[{"node":"Chama a api Image-Chart","type":"main","index":0}]]},"Chama a api Image-Chart":{"main":[[{"node":"Binary > base64","type":"main","index":0}]]},"Define o tipo de gráfico que vai ser gerado":{"main":[[{"node":"Prepara a url de requisição da api","type":"main","index":0}]]},"When Executed by Another Workflow":{"main":[[{"node":"Define o tipo de gráfico que vai ser gerado","type":"main","index":0}]]},"When clicking ‘Execute workflow’":{"main":[[]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"GbORhS24Rzw7hHlt"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"When Executed by Another Workflow":[{"json":{"pergunta":"Vou consultar a folha de pagamento para obter o ranking dos departamentos que mais gastaram com férias no último mês. Um momento, por favor.","dados":"[\n  {\n    \"Categoria\": \"Operações\",\n    \"Total_Gasto\": 1808324.3200000008\n  },\n  {\n    \"Categoria\": \"Comercial\",\n    \"Total_Gasto\": 1646457.429999999\n  },\n  {\n    \"Categoria\": \"TI\",\n    \"Total_Gasto\": 1542011.0699999998\n  },\n  {\n    \"Categoria\": \"Marketing\",\n    \"Total_Gasto\": 1541013.9500000014\n  },\n  {\n    \"Categoria\": \"RH\",\n    \"Total_Gasto\": 1435813.6200000008\n  },\n  {\n    \"Categoria\": \"Financeiro\",\n    \"Total_Gasto\": 1318477.3900000006\n  }\n]","filtros":"{\n  \"mes_inicio\": \"08/2025\",\n  \"mes_fim\": \"10/2025\",\n  \"tipo_custo\": [\n    \"Férias\"\n  ],\n  \"area\": null,\n  \"departamento\": null,\n  \"centro_de_custo\": null,\n  \"cargo\": null,\n  \"empresa\": null,\n  \"metrica\": \"ranking\",\n  \"periodo_comparativo\": 3,\n  \"pergunta\": \"Vou consultar a folha de pagamento para obter o ranking dos departamentos que mais gastaram com férias no último mês. Um momento, por favor.\"\n}"}}]},"versionId":"3fa557a0-2152-4cf2-8a6a-d88834d7800b","triggerCount":0,"tags":[]}