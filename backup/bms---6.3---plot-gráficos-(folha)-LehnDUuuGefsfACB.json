{"createdAt":"2025-11-10T20:00:24.637Z","updatedAt":"2025-11-10T20:32:58.345Z","id":"LehnDUuuGefsfACB","name":"BMS - 6.3 - Plot Gr√°ficos (Folha)","active":false,"isArchived":false,"nodes":[{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-416,-32],"id":"e0fe7569-55f6-44fb-a517-7cd087a13220","name":"Trigger"},{"parameters":{"assignments":{"assignments":[{"id":"4545f892-fbda-4554-bcdf-29a5962450b1","name":"pergunta","value":"Quanto gastamos de horas extras esse mes?","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-208,-32],"id":"3ae9cc86-24b6-43b7-8667-e66dfc601495","name":"Dados da consulta"},{"parameters":{"language":"python","pythonCode":"# Loop over input items and add a new field called 'myNewField' to the JSON of each one\nfor item in _input.all():\n  item.json.myNewField = 1\nreturn _input.all()"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[32,-32],"id":"dfa545f9-c7b9-44b8-be51-b24a5aa8c340","name":"Code"},{"parameters":{},"type":"n8n-nodes-base.executeCommand","typeVersion":1,"position":[320,64],"id":"b2c7ebb2-1a69-4860-b967-796e270623da","name":"Execute Command"},{"parameters":{"url":"={{$node[\"processingData\"].json[\"url\"]}}","responseFormat":"file","options":{}},"name":"HTTP Request","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[288,320],"id":"fca1e952-7bd0-406e-aca4-7d77ecb860f3"},{"parameters":{"jsCode":"//this function proccess the data and generates the url\n\nreturn [{\n    json: {\n        url: 'https://image-charts.com/chart?chbh=20&chco=fdb45c,27c9c2,1869b7&chd=t:5,5,5|10,10,10|15,15,15&chds=0,120&chm=N,000000,0,0,10|N,000000,0,1,10|N,000000,0,2,10|N,000000,1,0,10|N,000000,1,1,10|N,000000,1,2,10|N,000000,2,0,10|N,000000,2,1,10|N,000000,2,2,10&chma=0,0,10,10&chs=700x150&cht=bvs&chxs=0,000000,0,0,_&chxt=y'\n    }\n}]"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[64,336],"id":"42718ab4-b595-42bd-9d8d-c07f15f55aea","name":"Code1"},{"parameters":{"jsCode":"import pandas as pd\nimport matplotlib.pyplot as plt\nimport seaborn as sns\nfrom io import BytesIO\nimport base64\nimport json\nimport matplotlib\nmatplotlib.use('Agg')  # Important√≠ssimo para n8n\n\n# === CONFIGURA√á√ÉO ===\nplt.style.use('default')\nsns.set_palette([\"#2E86AB\", \"#A23B72\", \"#F18F01\", \"#C73E1D\", \"#3B1F2B\"])\n\n# === DADOS DE INPUT ===\n# O n8n automaticamente converte para Python\ndados = items[0][\"json\"][\"$response\"]\npergunta = items[0][\"json\"][\"pergunta_original\"]\nfiltros = items[0][\"json\"][\"filtrosAplicados\"]\n\ntry:\n    # === PROCESSAMENTO DOS DADOS ===\n    df = pd.DataFrame(dados)\n    \n    # Converte colunas num√©ricas\n    if 'Valor' in df.columns:\n        df['Valor'] = pd.to_numeric(df['Valor'], errors='coerce')\n    \n    # Converte datas se existir\n    if 'Mes_ref_folha' in df.columns:\n        df['Mes_ref_folha'] = pd.to_datetime(df['Mes_ref_folha'] + '-01', errors='coerce')\n    \n    # === CRIA√á√ÉO DO GR√ÅFICO ===\n    fig, axes = plt.subplots(1, 2, figsize=(12, 5))\n    \n    # Gr√°fico 1: Evolu√ß√£o Mensal (se tiver dados temporais)\n    if 'Mes_ref_folha' in df.columns and not df['Mes_ref_folha'].isna().all():\n        mensal = df.groupby('Mes_ref_folha')['Valor'].sum().sort_index()\n        axes[0].bar(mensal.index.strftime('%b/%Y'), mensal.values, color='#2E86AB', alpha=0.8)\n        axes[0].set_title('üìà Evolu√ß√£o Mensal', fontweight='bold')\n        axes[0].tick_params(axis='x', rotation=45)\n        axes[0].grid(True, alpha=0.3)\n        \n        # Adiciona valores no topo das barras\n        for i, v in enumerate(mensal.values):\n            axes[0].text(i, v, f'R$ {v:,.0f}', ha='center', va='bottom', fontsize=8)\n    else:\n        axes[0].text(0.5, 0.5, 'Sem dados temporais', ha='center', va='center', transform=axes[0].transAxes)\n        axes[0].set_title('Evolu√ß√£o Mensal')\n    \n    # Gr√°fico 2: Ranking por √Årea/Departamento\n    if '√Årea' in df.columns:\n        por_area = df.groupby('√Årea')['Valor'].sum().sort_values(ascending=False).head(5)\n        if len(por_area) > 0:\n            axes[1].barh(range(len(por_area)), por_area.values, color=sns.color_palette()[:len(por_area)])\n            axes[1].set_yticks(range(len(por_area)))\n            axes[1].set_yticklabels(por_area.index)\n            axes[1].set_title('üèÜ Top √Åreas', fontweight='bold')\n            axes[1].grid(True, alpha=0.3)\n            \n            # Adiciona valores nas barras\n            for i, v in enumerate(por_area.values):\n                axes[1].text(v, i, f' R$ {v:,.0f}', va='center', fontsize=9)\n        else:\n            axes[1].text(0.5, 0.5, 'Sem dados por √°rea', ha='center', va='center', transform=axes[1].transAxes)\n            axes[1].set_title('Top √Åreas')\n    elif 'Departamento' in df.columns:\n        por_depto = df.groupby('Departamento')['Valor'].sum().sort_values(ascending=False).head(5)\n        if len(por_depto) > 0:\n            axes[1].barh(range(len(por_depto)), por_depto.values, color=sns.color_palette()[:len(por_depto)])\n            axes[1].set_yticks(range(len(por_depto)))\n            axes[1].set_yticklabels(por_depto.index)\n            axes[1].set_title('üèÜ Top Departamentos', fontweight='bold')\n    else:\n        axes[1].text(0.5, 0.5, 'Sem dados para ranking', ha='center', va='center', transform=axes[1].transAxes)\n        axes[1].set_title('Distribui√ß√£o')\n    \n    # T√≠tulo principal\n    periodo = f\"{filtros.get('mes_inicio', '')} a {filtros.get('mes_fim', '')}\" if isinstance(filtros, dict) else \"Per√≠odo analisado\"\n    fig.suptitle(f'üìä Dashboard RH - {pergunta}\\n{periodo}', fontsize=14, fontweight='bold')\n    \n    plt.tight_layout()\n    \n    # === CONVERTE PARA BASE64 ===\n    buffer = BytesIO()\n    plt.savefig(buffer, format='png', dpi=100, bbox_inches='tight')\n    buffer.seek(0)\n    imagem_base64 = base64.b64encode(buffer.getvalue()).decode('utf-8')\n    plt.close()\n    \n    # === M√âTRICAS PARA A RESPOSTA ===\n    total = df['Valor'].sum() if 'Valor' in df.columns else 0\n    total_registros = len(df)\n    \n    # === RETORNO PARA n8n ===\n    result = {\n        \"sucesso\": True,\n        \"mensagem\": f\"Dashboard gerado com sucesso! Total: R$ {total:,.2f}\",\n        \"imagem_base64\": imagem_base64,\n        \"total_registros\": total_registros,\n        \"valor_total\": total,\n        \"periodo\": periodo\n    }\n    \n    # Debug no console do n8n\n    print(\"‚úÖ Dashboard gerado com sucesso!\")\n    print(f\"üìä Total de registros: {total_registros}\")\n    print(f\"üí∞ Valor total: R$ {total:,.2f}\")\n\nexcept Exception as e:\n    print(f\"‚ùå Erro ao gerar dashboard: {str(e)}\")\n    result = {\n        \"sucesso\": False,\n        \"erro\": str(e),\n        \"mensagem\": \"Falha ao gerar visualiza√ß√£o\"\n    }\n\n# Retorna para pr√≥ximo n√≥\nreturn [{\"json\": result}]"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-400,272],"id":"efbf3352-1e1f-41de-9438-1c2beba53767","name":"Code2"}],"connections":{"Trigger":{"main":[[{"node":"Dados da consulta","type":"main","index":0}]]},"Dados da consulta":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[]]},"HTTP Request":{"main":[[]]},"Code1":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"a38ee362-3628-48cf-a8fd-5ced078d188a","triggerCount":0,"tags":[]}