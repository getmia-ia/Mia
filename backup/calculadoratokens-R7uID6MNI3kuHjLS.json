{"createdAt":"2025-09-23T17:28:12.211Z","updatedAt":"2025-09-23T17:34:39.616Z","id":"R7uID6MNI3kuHjLS","name":"CalculadoraTokens","active":false,"isArchived":false,"nodes":[{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.chatTrigger","typeVersion":1.1,"position":[1040,208],"id":"e4b02e55-c38e-4349-a0ea-26194bd16a0d","name":"When chat message received","webhookId":"dd24024c-41e2-4127-a6ad-d73c7c10fe9b"},{"parameters":{"tableId":"custo_tokens","fieldsUi":{"fieldValues":[{"fieldId":"Workflow","fieldValue":"={{ $workflow.name }}"},{"fieldId":"Input","fieldValue":"={{ $('When chat message received').item.json.chatInput }}"},{"fieldId":"Output","fieldValue":"={{ $('AI Agent Exemplo').item.json.output }}"},{"fieldId":"PromptTokens","fieldValue":"={{ $json.promptTokens }}"},{"fieldId":"CompletationTokens","fieldValue":"={{ $json.completionTokens }}"},{"fieldId":"CachedTokens","fieldValue":"={{ $json.cachedTokens }}"},{"fieldId":"Cost","fieldValue":"={{ $json.costUSD }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1920,240],"id":"4ddbd168-3ddb-42bc-b325-898dd740360a","name":"Grava no Supabase","credentials":{"supabaseApi":{"id":"smA3dHKgaucYB4Sp","name":"Supabase - Taysa"}}},{"parameters":{"sendTo":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('To', ``, 'string') }}","subject":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Subject', ``, 'string') }}","message":"={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Message', ``, 'string') }}","options":{"appendAttribution":true}},"type":"n8n-nodes-base.gmailTool","typeVersion":2.1,"position":[1456,496],"id":"f5cae05f-fb74-427f-a010-fb97cfa95aa6","name":"Envia Email","webhookId":"18eaba1a-1821-4b08-b623-7496a908f4d3","credentials":{"gmailOAuth2":{"id":"wxKszLTvSeCZk1qL","name":"Gmail - Taysa"}}},{"parameters":{"jsCode":"const PRICE = {\n  input:       1.1   / 1_000_000,\n  inputCached: 0.275 / 1_000_000,\n  output:      4.4   / 1_000_000,\n};\n\nfunction pickUsage(obj = {}) {\n  const v1 = obj.kwargs?.response_metadata?.usage;\n  if (v1) {\n    return {\n      prompt:       v1.prompt_tokens       ?? v1.input_tokens       ?? 0,\n      completion:   v1.completion_tokens   ?? v1.output_tokens      ?? 0,\n      cached:       v1.prompt_tokens_details?.cached_tokens ?? 0,\n    };\n  }\n  const v2 = obj.usage_metadata;\n  if (v2) {\n    return {\n      prompt:       v2.input_tokens  ?? 0,\n      completion:   v2.output_tokens ?? 0,\n      cached:       v2.input_token_details?.cache_read ?? 0,\n    };\n  }\n  const v3 = obj.usage;\n  if (v3) {\n    return {\n      prompt:       v3.prompt_tokens ?? v3.input_tokens ?? 0,\n      completion:   v3.completion_tokens ?? v3.output_tokens ?? 0,\n      cached:       v3.cached_tokens ?? 0,\n    };\n  }\n  return { prompt: 0, completion: 0, cached: 0 };\n}\n\nlet promptT = 0, completionT = 0, cachedT = 0;\nconst steps = [];\nlet summary = '';\n\nfor (const item of $input.all()) {\n  const conversations = Array.isArray(item.json) ? item.json : [item.json];\n\n  for (const convo of conversations) {\n    summary = convo.output ?? summary;\n\n    if (Array.isArray(convo.intermediateSteps)) {\n      for (const step of convo.intermediateSteps) {\n        if (!step.action) continue;\n\n        const msg = step.action.messageLog?.[0] ?? step.action;\n        const u = pickUsage(msg);\n        promptT     += u.prompt;\n        completionT += u.completion;\n        cachedT     += u.cached;\n\n        steps.push({\n          tool:        step.action.tool,\n          toolInput:   step.action.toolInput,\n          observation: step.observation,\n        });\n      }\n    }\n  }\n}\n\nconst nonCached = promptT - cachedT;\nconst cost = (nonCached * PRICE.input) +\n             (cachedT   * PRICE.inputCached) +\n             (completionT * PRICE.output);\n\nconst result = {\n  summary,\n  promptTokens:     promptT,\n  completionTokens: completionT,\n  cachedTokens:     cachedT,\n  costUSD:          +cost.toFixed(6),\n  totalCostUSD:     +cost.toFixed(6), // opcional: pode remover se quiser evitar repetição\n  steps\n};\n\n// --- Normalização pro Supabase (opcional se já tiver campos fixos na tabela) ---\nconst allKeys = [...new Set(Object.keys(result))];\nconst norm = {};\nfor (const key of allKeys) {\n  norm[key] = result[key] ?? null;\n}\n\nreturn [{ json: norm }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1728,240],"id":"3a51896e-e020-4cf5-9969-35714cafd7b3","name":"Calcula Tokens"},{"parameters":{"assignments":{"assignments":[{"id":"d42ab763-bd09-4133-bf1a-9d2dc743047c","name":"","value":"={{ $('AI Agent Exemplo').item.json.output }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2112,240],"id":"ae5bd7f9-db25-4911-8d7f-fac98246edc0","name":"Output do Agent"},{"parameters":{"options":{"returnIntermediateSteps":true}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.9,"position":[1248,208],"id":"c5f536be-b15b-4c07-9cca-4e4099ce667d","name":"AI Agent Exemplo","onError":"continueErrorOutput"},{"parameters":{"content":"## Exemplo de Calculadora de Tokens do seu Agente - Já calcula ferramentas + promtps de INPUT E OUTPUT","height":820,"width":1380,"color":3},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[960,48],"id":"6e9ab31b-4319-48aa-82b6-70611dcb9e53","name":"Sticky Note"},{"parameters":{"operation":"executeQuery","query":"create table public.custo_tokens (\n  id bigint generated by default as identity not null,\n  created_at timestamp with time zone not null default now(),\n  \"Workflow\" text null,\n  \"Input\" text null,\n  \"Output\" text null,\n  \"PromptTokens\" text null,\n  \"CompletationTokens\" text null,\n  \"CachedTokens\" text null,\n  \"Cost\" text null,\n  constraint custo_tokens_pkey primary key (id)\n) TABLESPACE pg_default;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1808,576],"id":"06cf5995-919f-4b1a-8dbd-302db960eea7","name":"Criar tabela de Custos","credentials":{"postgres":{"id":"QgjuCQJgHbZ2Q1u8","name":"Postgres - Taysa"}},"disabled":true},{"parameters":{"content":"## Nó para calcular custos\nVocê de  colocar esse nó depois do seu agente","height":300,"width":380,"color":2},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[1680,128],"id":"da3b480a-b5da-4604-a310-531bc8d61618","name":"Sticky Note1"},{"parameters":{"content":"## Exemplo de Teste","height":480,"width":680,"color":5},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[976,128],"id":"f3a9b7fc-483a-47a1-a79f-de69647b031d","name":"Sticky Note2"},{"parameters":{"content":"## Nó para criar tabela no SUPABASE\nRode apenas uma vez isolado para criar a tabela","height":340,"width":380,"color":2},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[1680,448],"id":"709f03a5-5560-4b6e-aeba-b8c326533b08","name":"Sticky Note3"},{"parameters":{"content":"████████░▄█████▄░██░░██░▄█████░██████▄░░░█████▄░██████░██░░░░░██░░░░░██████░██████▄░▄██████░░░▄████▄░▄██████░▄█████░██████▄░████████░░░░░░░░░░░░░░█████▄░██░░██░░░█████▄░██████░▄█████░██████▄░▄█████░██░░░██░▄█████░▄██████\n░░░██░░░░██░░░██░██░░██░██░░░░░██░░░██░░░██░░██░░░██░░░██░░░░░██░░░░░░░██░░░██░░░██░██░░░░░░░░██░░██░██░░░░░░██░░░░░██░░░██░░░░██░░░░░░░░░░░░░░░░░██░░██░██░░██░░░██░░██░░░██░░░██░░░░░██░░░██░██░░░░░██░░░██░██░░░░░██░░░░░\n░░░██░░░░██░░░██░█████░░█████░░██░░░██░░░█████░░░░██░░░██░░░░░██░░░░░░░██░░░██░░░██░██░░███░░░██░░██░██░░███░█████░░██░░░██░░░░██░░░░░░░░░░░░░░░░░█████░░▀████▀░░░█████▀░░░██░░░██░░░░░██░░░██░█████░░██░░░██░█████░░▀█████▄\n░░░██░░░░██░░░██░██░░██░██░░░░░██░░░██░░░██░░██░░░██░░░██░░░░░██░░░░░░░██░░░██░░░██░██░░░██░░░██████░██░░░██░██░░░░░██░░░██░░░░██░░░░░░░░██████░░░██░░██░░░██░░░░░██░░██░░░██░░░██░░░░░██░░░██░██░░░░░██░░██░░██░░░░░░░░░░██\n░░░██░░░░▀█████▀░██░░██░▀█████░██░░░██░░░█████▀░██████░██████░██████░██████░██░░░██░▀█████▀░░░██░░██░▀█████▀░▀█████░██░░░██░░░░██░░░░░░░░░░░░░░░░░█████▀░░░██░░░░░██░░██░██████░▀█████░██░░░██░▀█████░▀███▀░░░▀█████░██████▀\n░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░","width":2220},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[608,-144],"id":"cf51f4d6-3bc0-4e96-945c-9d18917d0551","name":"Sticky Note4"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[1248,384],"id":"d11b9d3a-14e0-459e-b88a-e97fb939bbcd","name":"Google Gemini Chat Model","credentials":{"googlePalmApi":{"id":"v6lUW97jyBi9uG5M","name":"Google Gemini(PaLM) Api - Taysa"}}}],"connections":{"When chat message received":{"main":[[{"node":"AI Agent Exemplo","type":"main","index":0}]]},"Grava no Supabase":{"main":[[{"node":"Output do Agent","type":"main","index":0}]]},"Envia Email":{"ai_tool":[[{"node":"AI Agent Exemplo","type":"ai_tool","index":0}]]},"Calcula Tokens":{"main":[[{"node":"Grava no Supabase","type":"main","index":0}]]},"AI Agent Exemplo":{"main":[[{"node":"Calcula Tokens","type":"main","index":0}]]},"Google Gemini Chat Model":{"ai_languageModel":[[{"node":"AI Agent Exemplo","type":"ai_languageModel","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"d612ace1-eb3e-4044-b2dc-443ea0727ea7","triggerCount":0,"tags":[]}