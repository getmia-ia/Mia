{"createdAt":"2025-11-03T21:50:36.179Z","updatedAt":"2025-11-04T23:53:47.803Z","id":"YccLaM9IWSOTnAED","name":"BMS - 1.3 - Journal - Post X","active":true,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":60}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-240,400],"id":"cf5d3804-1ce9-4b3f-93be-1cf38827741c","name":"Schedule Trigger"},{"parameters":{"documentId":{"__rl":true,"value":"1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA","mode":"list","cachedResultName":"BMS - Controle Journal","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"status_X","lookupValue":"aprovado"}]},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[-64,400],"id":"54238a2f-452c-4a1c-a9c2-b9c4553781a4","name":"Get row(s) in sheet","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"jsCode":"// Garante 1 por execução (pega a primeira \"aprovado\")\nconst rows = items.map(i => i.json);\n\nconst isApproved = (v) =>\n  String(v || '').trim().toLowerCase() === 'aprovado';\n\nconst first = rows.find(r =>\n  isApproved(r.status_X) &&\n  r.noticia_id &&\n  (r.imagem_url || r.imagem) &&\n  r.legenda_x\n);\n\nif (!first) return []; // nada a postar neste horário\n\nconst out = { ...first };\nout.imagem_url = first.imagem_url || first.imagem;\nreturn [{ json: out }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[128,400],"id":"1134e8d0-f5b8-42d2-b894-f2bcb4dd8715","name":"Code"},{"parameters":{"assignments":{"assignments":[{"id":"68b89233-2740-4afd-a95c-72ed537d12e5","name":"noticia_id","value":"={{ $json.noticia_id }}","type":"string"},{"id":"225df266-bf29-4415-b04c-2750cef4506a","name":"image_url","type":"string","value":"={{ $json.imagem_url }}"},{"id":"f35e3093-1bff-4cc6-a6c4-909dca314cc7","name":"x_post_caption","type":"string","value":"={{ $json.legenda_x }}"}]},"options":{}},"id":"dc1430a8-38f2-49f8-a92f-8d28727c728d","name":"X parametros","type":"n8n-nodes-base.set","position":[512,384],"typeVersion":3.4},{"parameters":{"operation":"update","documentId":{"__rl":true,"value":"1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA","mode":"list","cachedResultName":"BMS - Controle Journal","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA/edit#gid=0"},"columns":{"mappingMode":"autoMapInputData","value":{},"matchingColumns":["noticia_id"],"schema":[{"id":"noticia_id","displayName":"noticia_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"data_processamento","displayName":"data_processamento","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"titulo","displayName":"titulo","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"legenda","displayName":"legenda","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"legenda_x","displayName":"legenda_x","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"param_2","displayName":"param_2","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"param_3","displayName":"param_3","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"param_4","displayName":"param_4","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"fonte","displayName":"fonte","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"imagem","displayName":"imagem","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"arquivo_base64","displayName":"arquivo_base64","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"arquivo2_base64","displayName":"arquivo2_base64","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"arquivo3_base64","displayName":"arquivo3_base64","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"imagem_url","displayName":"imagem_url","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"imagem_url2","displayName":"imagem_url2","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"imagem_url3","displayName":"imagem_url3","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"status_WhatsApp","displayName":"status_WhatsApp","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"status_X","displayName":"status_X","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"nota","displayName":"nota","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"justificativa","displayName":"justificativa","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"output","displayName":"output","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"row_number","displayName":"row_number","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"readOnly":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[2512,368],"id":"ffe37d15-d092-47af-a55e-e7d703608119","name":"Update row in sheet","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"assignments":{"assignments":[{"id":"f2c98e3a-ba6b-4df7-a0c9-96994c91a690","name":"noticia_id","value":"={{ $('X parametros').item.json.noticia_id }}","type":"string"},{"id":"a95682ad-ea9c-4d88-a370-0ffad2b3eea5","name":"status_X","value":"postado","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2304,368],"id":"ab322e56-e429-4f01-8506-cbdcf1940373","name":"Edit Fields"},{"parameters":{"conditions":{"options":{"version":2,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"conditions":[{"id":"0304efee-33b2-499e-bad1-9238c1fc2999","operator":{"type":"string","operation":"notEmpty","singleValue":true},"leftValue":"={{ $json.data && $json.data.id }}","rightValue":"PUBLISHED"}],"combinator":"or"},"options":{}},"id":"5ac7bb65-13d7-4f2c-9024-d4df9b1eea5b","name":"If media status is finished","type":"n8n-nodes-base.if","position":[2064,384],"typeVersion":2.2},{"parameters":{"url":"={{ $('X parametros').item.json.image_url }}","options":{"response":{"response":{"responseFormat":"file"}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[864,384],"id":"04eaedf6-3cbd-4ed7-9de8-84ad15c8eb41","name":"Baixar imagem1"},{"parameters":{},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1472,384],"id":"a3a0211d-2e19-438c-9316-8513e02efe2a","name":"Wait","webhookId":"d8e25052-c339-4ec0-aeca-8a1bbca7dc5d"},{"parameters":{"method":"POST","url":"https://upload.twitter.com/1.1/media/upload.json","authentication":"predefinedCredentialType","nodeCredentialType":"twitterOAuth1Api","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"parameterType":"formBinaryData","name":"media","inputDataFieldName":"data"}]},"options":{}},"id":"da5e1f96-2a42-4789-b564-d3729d84465b","name":"Sobe img 1 no X","type":"n8n-nodes-base.httpRequest","position":[1104,384],"typeVersion":4.2,"credentials":{"twitterOAuth1Api":{"id":"II0aFFf47fmwEbML","name":"X OAuth - BMS"},"twitterOAuth2Api":{"id":"V9dCCc7cxgto1ZK5","name":"X OAuth2 - MIA"}}},{"parameters":{"resource":"messages-api","instanceName":"social-media-mia","remoteJid":"120363421402105782@g.us","messageText":"=Post no X da BMS falhou!","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[2304,576],"id":"64e4e099-a5a8-49dc-ad3d-8fe39ffe2735","name":"Envia log falha","retryOnFail":true,"credentials":{"evolutionApi":{"id":"MuW4REP1kIrolv7W","name":"social-media-mia"}}},{"parameters":{"resource":"messages-api","instanceName":"social-media-mia","remoteJid":"120363421402105782@g.us","messageText":"=Post no X da BMS deu certo!","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[2720,368],"id":"9493f262-2db0-4d15-b2a1-34a1bb931591","name":"Envia log sucesso","retryOnFail":true,"credentials":{"evolutionApi":{"id":"MuW4REP1kIrolv7W","name":"social-media-mia"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"54fa4546-8262-4651-9b0e-ce3a2f66416f","leftValue":"={{ $json.status_X }}","rightValue":"aprovado","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[304,400],"id":"9898a784-93d0-4013-9d84-a5269012e705","name":"Verifica se foi aprovada"},{"parameters":{"method":"POST","url":"https://api.x.com/2/tweets","authentication":"predefinedCredentialType","nodeCredentialType":"twitterOAuth2Api","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1872,384],"id":"e52120ef-a46f-4f1c-a20f-4be99de26968","name":"Publica tweet","credentials":{"twitterOAuth2Api":{"id":"bQYsbhaQPpYnCHL1","name":"X OAuth2 - BMS "}}},{"parameters":{"content":"## Preparação dos dados da notícia do post","height":672,"width":736},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-96,96],"id":"7a40708c-b3a3-4d66-993e-e1fbeac419ae","name":"Sticky Note"},{"parameters":{"content":"## Prepara as imagens para publicação (sobre com API do X OAuth)","height":672,"width":736,"color":6},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[672,96],"id":"6eb8ef36-afc9-46fe-8537-0c30cfa77ced","name":"Sticky Note1"},{"parameters":{"content":"## Publica e atualiza o status na planilha","height":672,"width":1440,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[1440,96],"id":"48e41d07-6e04-4f41-a60f-63f8918ff5e7","name":"Sticky Note2"},{"parameters":{"jsCode":"// Function Node - Versão simplificada\nconst caption = $('X parametros').item.json.x_post_caption;\n\nconst payload = {\n  text: caption,\n  media: {\n    media_ids: [\n      $('Sobe img 1 no X').item.json.media_id_string\n    ].filter(id => id) // Remove valores null/undefined\n  }\n};\n\n// Validação básica\nif (!payload.text) throw new Error('Texto é obrigatório');\nif (payload.media.media_ids.length === 0) throw new Error('Mídias são obrigatórias');\n\nreturn payload;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1680,384],"id":"634b4ef0-f80a-45c8-90a9-661494dcfcd1","name":"Prepara o JSON do Body do Call da API"}],"connections":{"Schedule Trigger":{"main":[[{"node":"Get row(s) in sheet","type":"main","index":0}]]},"Get row(s) in sheet":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Verifica se foi aprovada","type":"main","index":0}]]},"X parametros":{"main":[[{"node":"Baixar imagem1","type":"main","index":0}]]},"Update row in sheet":{"main":[[{"node":"Envia log sucesso","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Update row in sheet","type":"main","index":0}]]},"If media status is finished":{"main":[[{"node":"Edit Fields","type":"main","index":0}],[{"node":"Envia log falha","type":"main","index":0}]]},"Baixar imagem1":{"main":[[{"node":"Sobe img 1 no X","type":"main","index":0}]]},"Wait":{"main":[[{"node":"Prepara o JSON do Body do Call da API","type":"main","index":0}]]},"Sobe img 1 no X":{"main":[[{"node":"Wait","type":"main","index":0}]]},"Verifica se foi aprovada":{"main":[[{"node":"X parametros","type":"main","index":0}]]},"Publica tweet":{"main":[[{"node":"If media status is finished","type":"main","index":0}]]},"Prepara o JSON do Body do Call da API":{"main":[[{"node":"Publica tweet","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","executionTimeout":-1,"errorWorkflow":"QdC9qh9DPcT2xcoq"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]},"node:Google Sheets Trigger":{"documentId":"1Ze1MFqVlu21qakfTTE5ECfAu4iFOoeQMygOCjPW5nek","sheetId":0,"lastRevision":764,"lastRevisionLink":"https://docs.google.com/spreadsheets/export?id=1Ze1MFqVlu21qakfTTE5ECfAu4iFOoeQMygOCjPW5nek&revision=764&exportFormat=xlsx"},"node:Schedule Trigger1":{"recurrenceRules":[]},"node:Trigger nova noticia no sheets":{"documentId":"1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0","sheetId":0,"lastRevision":271,"lastRevisionLink":"https://docs.google.com/spreadsheets/export?id=1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0&revision=271&exportFormat=xlsx"}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"e4a1f2ea-a94e-4e0f-a224-b957f85c6033","triggerCount":1,"tags":[]}