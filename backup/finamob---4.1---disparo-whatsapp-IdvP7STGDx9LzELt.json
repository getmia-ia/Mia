{"createdAt":"2025-09-14T18:46:28.144Z","updatedAt":"2025-10-22T17:17:10.363Z","id":"IdvP7STGDx9LzELt","name":"Finamob - 4.1 - Disparo Whatsapp","active":true,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":10}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-1040,-80],"id":"d2046b40-56a8-4290-b9bf-f04e2bc122a2","name":"Schedule Trigger"},{"parameters":{"operation":"getAll","tableId":"leads","returnAll":true,"filters":{"conditions":[{"keyName":"id_disparo","condition":"eq","keyValue":"={{ $('Pega Disparos Agendados').item.json.id }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-528,-80],"id":"2db247b1-baa2-40c5-8e19-84bf3a75061c","name":"Pega Leads do Supabase","credentials":{"supabaseApi":{"id":"4MbqyW9T081a3o7d","name":"Finamob"}}},{"parameters":{"operation":"getAll","tableId":"disparos","returnAll":true,"matchType":"allFilters","filters":{"conditions":[{"keyName":"data_hora","condition":"lte","keyValue":"={{$json[\"timestamp\"]}}"},{"keyName":"status","condition":"eq","keyValue":"Em andamento"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-816,-80],"id":"51ef4c92-0c18-41eb-b97d-dce8483a5c3b","name":"Pega Disparos Agendados","credentials":{"supabaseApi":{"id":"4MbqyW9T081a3o7d","name":"Finamob"}}},{"parameters":{"assignments":{"assignments":[{"id":"59ff38c0-5bb5-41fb-9e42-bc90aa134824","name":"mensagem","value":"={{ $('Pega Disparos Agendados').item.json.mensagem }}","type":"string"},{"id":"662fdd3a-8574-496b-bcc2-a65311f1ec9b","name":"imagem","value":"={{ $('Pega Disparos Agendados').item.json.imagem_url }}","type":"string"},{"id":"5a1ad5b9-c0f3-4215-a17f-d4832dace959","name":"remetente","value":"","type":"string"},{"id":"d5de298f-2320-448c-a83e-d23b3298260c","name":"nome","value":"={{ $json.nome }}","type":"string"},{"id":"7bc1856e-87c7-485d-9a8b-b411e46cc501","name":"telefone","value":"={{ $json.telefone }}","type":"string"},{"id":"7b3bff14-06dc-4981-8451-5b91a7862538","name":"origem","value":"={{ $('Pega Disparos Agendados').item.json.origem_disparo }}","type":"string"},{"id":"8dc94158-dff7-404e-9d33-1891cf2b76e2","name":"tipo_midia","value":"={{ $('Pega Disparos Agendados').item.json.tipo_midia }}","type":"string"},{"id":"174590f8-2032-4a75-a4e7-ce27a8be9a58","name":"template_name","value":"={{ $('Pega Disparos Agendados').item.json.template_name }}","type":"string"},{"id":"d00fb8f0-2924-4cec-8fd6-c1cf5be44e6c","name":"param_1","value":"={{ $('Pega Disparos Agendados').item.json.param_1 }}","type":"string"},{"id":"f94dc699-b921-4ff0-91ba-61cb2c1e3dfa","name":"param_2","value":"={{ $('Pega Disparos Agendados').item.json.param_2 }}","type":"string"},{"id":"c97bf8e1-1fdb-4b6b-9827-a0ddac1dee22","name":"param_3","value":"={{ $('Pega Disparos Agendados').item.json.param_3 }}","type":"string"},{"id":"ffa48eb6-0344-4bff-8eae-c908565a1f83","name":"param_4","value":"={{ $('Pega Disparos Agendados').item.json.param_4 }}","type":"string"},{"id":"6525d75d-92cc-469b-954d-a2b7f179141d","name":"param_5","value":"={{ $('Pega Disparos Agendados').item.json.param_5 }}","type":"string"},{"id":"8be9705a-3394-429f-b7ff-7a3a62f4c3ce","name":"imagem_url","value":"={{ $('Pega Disparos Agendados').item.json.imagem_url }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[80,-96],"id":"7a7c2bb6-9d70-49ce-9678-1d438a5b46f5","name":"Edit Fields"},{"parameters":{"batchSize":"=1","options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[976,-640],"id":"fff959d0-dcec-4b6c-8b2d-30363bffa526","name":"Loop Over Items1"},{"parameters":{"amount":"={{ 3 + Math.floor(Math.random() * 5) }}"},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1248,-624],"id":"efeb6f65-e455-4233-ad75-5846f744285e","name":"Wait","webhookId":"6686e364-432c-466f-ac33-321c79f8a8a1"},{"parameters":{"resource":"messages-api","operation":"send-image","instanceName":"finamob-avatar-murilo","remoteJid":"={{ $json.telefone }}","media":"={{ $json.base64 }}","caption":"=Oi {{ $json.nome }}, tudo bem?\n\n{{ $json.mensagem }}\n\nSe não quiser mais receber comunicações no seu celular responda essa mensagem com \"opt-out\".","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1328,-384],"id":"2bfc630f-692d-44b0-81ad-9d74ca871f19","name":"Envio do Resumo","credentials":{"evolutionApi":{"id":"TwnJW4TK9NKnvtx3","name":"finamob-avatar-murilo"}},"disabled":true,"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Code node — Mode: Run Once for All Items\n\nfunction normalizeTelefone(raw) {\n  if (raw == null) return \"\";\n  let d = String(raw).replace(/\\D/g, \"\").replace(/^0+/, \"\");\n  return d ? (d.startsWith(\"55\") ? d : \"55\" + d) : \"\";\n}\n\nfunction stripBOM(buf) {\n  return (buf.length >= 3 && buf[0] === 0xEF && buf[1] === 0xBB && buf[2] === 0xBF)\n    ? buf.slice(3)\n    : buf;\n}\n\nfunction fixPngSignature(buf) {\n  // PNG correto: 89 50 4E 47 0D 0A 1A 0A\n  if (buf.length >= 7 &&\n      buf[0] === 0x50 && buf[1] === 0x4E && buf[2] === 0x47 && // \"PNG\"\n      buf[3] === 0x0D && buf[4] === 0x0A && buf[5] === 0x1A && buf[6] === 0x0A) {\n    // faltou 0x89 antes de \"PNG\"\n    return Buffer.concat([Buffer.from([0x89]), buf]);\n  }\n  return buf;\n}\n\nasync function getBinaryWithHeaders(url) {\n  try {\n    const res = await this.helpers.httpRequest({\n      method: 'GET',\n      url,\n      headers: { 'User-Agent': 'Mozilla/5.0' },\n      responseFormat: 'arraybuffer',\n      returnFullResponse: true,\n    });\n    return { buf: Buffer.from(res.data ?? res), mime: res.headers?.['content-type'] || \"\" };\n  } catch {\n    const res = await this.helpers.request({\n      method: 'GET',\n      url,\n      headers: { 'User-Agent': 'Mozilla/5.0' },\n      json: false,\n      encoding: null,\n      resolveWithFullResponse: true,\n    });\n    return { buf: Buffer.from(res.body), mime: res.headers?.['content-type'] || \"\" };\n  }\n}\n\nreturn await Promise.all(items.map(async (item) => {\n  const mensagem      = item.json?.mensagem;\n  const remetente     = item.json?.remetente;\n  const nome          = item.json?.nome;\n  const telefone      = normalizeTelefone(item.json?.telefone);\n  const tipo_midia    = (item.json?.tipo_midia || \"\").toLowerCase();\n  const template_name = item.json?.template_name || \"\";\n\n  // Novos parâmetros\n  const param_1 = item.json?.param_1 || \"\";\n  const param_2 = item.json?.param_2 || \"\";\n  const param_3 = item.json?.param_3 || \"\";\n  const param_4 = item.json?.param_4 || \"\";\n  const param_5 = item.json?.param_5 || \"\";\n\n  // Novo campo imagem_url\n  const imagem_url = (item.json?.imagem_url || \"\").toString().trim();\n\n  // URL de mídia (caso diferente da imagem_url)\n  const url = (item.json?.imagem ?? \"\").toString().trim();\n\n  let base64 = \"\";\n  let mime = \"\";\n\n  if (url) {\n    try {\n      let res = await getBinaryWithHeaders.call(this, url);\n      let buf = Buffer.from(res.buf);\n      mime = res.mime || \"\";\n\n      buf = stripBOM(buf);\n\n      // Corrigir assinatura se for imagem PNG\n      const isPngHint = (mime && mime.includes('png')) ||\n                        (buf.length >= 3 && buf[0] === 0x50 && buf[1] === 0x4E && buf[2] === 0x47);\n      if (tipo_midia === \"imagem\" && isPngHint && buf.length >= 7) {\n        buf = fixPngSignature(buf);\n      }\n\n      base64 = buf.toString('base64');\n    } catch {\n      base64 = \"\";\n    }\n  }\n\n  return {\n    json: {\n      mensagem,\n      remetente,\n      nome,\n      telefone,\n      tipo_midia,\n      mime,\n      base64,\n      imagem_url,\n      template_name,\n      param_1,\n      param_2,\n      param_3,\n      param_4,\n      param_5\n    }\n  };\n}));\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[288,-96],"id":"e669db20-f29d-4557-8652-e8583860a44c","name":"Code"},{"parameters":{"resource":"messages-api","instanceName":"finamob-avatar-murilo","remoteJid":"={{ $json.telefone }}","messageText":"=Oi {{ $json.nome }}, tudo bem?\n\n{{ $json.mensagem }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1120,-384],"id":"660034c3-4cb0-4e70-9dc0-94ab3b6726c1","name":"Envio do Resumo1","credentials":{"evolutionApi":{"id":"TwnJW4TK9NKnvtx3","name":"finamob-avatar-murilo"}},"disabled":true,"onError":"continueRegularOutput"},{"parameters":{"operation":"update","tableId":"disparos","matchType":"allFilters","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $('Pega Leads do Supabase').item.json.id_disparo }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"status","fieldValue":"Enviado"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2208,-624],"id":"f72c1cdf-fb99-4055-9d54-6d9baa5414c7","name":"Update a row","credentials":{"supabaseApi":{"id":"4MbqyW9T081a3o7d","name":"Finamob"}}},{"parameters":{"operation":"get","tableId":"finamob-mensagens","filters":{"conditions":[{"keyName":"telefone","keyValue":"={{ $('Code').item.json.telefone }}"},{"keyName":"nome_app","keyValue":"=SDR-MURILO"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2448,-624],"id":"0bbaedd7-548b-4a61-826b-45792be735f0","name":"Busca Dados","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"4MbqyW9T081a3o7d","name":"Finamob"}},"onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"defac08a-6745-422b-bb05-90da9f47d91b","leftValue":"={{ $('Busca Dados').last().json.values() }}","rightValue":"","operator":{"type":"array","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2688,-624],"id":"79d55a53-64ba-4c7d-ac8c-1cb514d37472","name":"Verifica se encontrou"},{"parameters":{"tableId":"finamob-mensagens","fieldsUi":{"fieldValues":[{"fieldId":"telefone","fieldValue":"={{ $('Code').item.json.telefone }}"},{"fieldId":"updated_at","fieldValue":"={{$now.setLocale('pt-BR')}}"},{"fieldId":"nome_app","fieldValue":"=SDR-MURILO"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2976,-640],"id":"a40abebc-865d-42b8-96c8-f9cfeb39563e","name":"Adiciona Mensagem","credentials":{"supabaseApi":{"id":"4MbqyW9T081a3o7d","name":"Finamob"}},"notes":"Este fluxo é de propriedade da FORMAÇÃO AGENTES DE IA COM N8N -BY RICNEVES"},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3,"position":[3280,-560],"id":"31dad246-461d-41d6-8e98-35fbfe56525b","name":"Faz o Merge","notes":"Este fluxo é de propriedade da FORMAÇÃO AGENTES DE IA COM N8N -BY RICNEVES"},{"parameters":{"tableId":"finamob-historico_mensagens","fieldsUi":{"fieldValues":[{"fieldId":"mensagem_usuario","fieldValue":"="},{"fieldId":"mensagem_agente","fieldValue":"={{ $('Edit Fields').item.json.mensagem }}"},{"fieldId":"telefone","fieldValue":"={{ $('Wait').item.json.telefone }}"},{"fieldId":"nome_usuario","fieldValue":"={{ $('Edit Fields').item.json.nome }}"},{"fieldId":"message_type","fieldValue":"text"},{"fieldId":"ativo","fieldValue":"true"},{"fieldId":"nome_app","fieldValue":"SDR-MURILO"},{"fieldId":"id_usuario","fieldValue":"={{ $('Wait').item.json.telefone }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[3520,-368],"id":"8a15fe51-5537-4eba-9bb3-9b8ac89ecf80","name":"Cria Mensagem no Supabase","credentials":{"supabaseApi":{"id":"4MbqyW9T081a3o7d","name":"Finamob"}},"onError":"continueRegularOutput","notes":"Este fluxo é de propriedade da FORMAÇÃO AGENTES DE IA COM N8N -BY RICNEVES"},{"parameters":{"operation":"update","tableId":"finamob-mensagens","matchType":"allFilters","filters":{"conditions":[{"keyName":"telefone","condition":"eq","keyValue":"={{ $('Code').item.json.telefone }}"},{"keyName":"nome_app","condition":"eq","keyValue":"SDR-MURILO"}]},"fieldsUi":{"fieldValues":[{"fieldId":"updated_at","fieldValue":"={{$now.setLocale('pt-BR')}}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2976,-448],"id":"9a7763ae-b926-4539-9a9c-102c78929afa","name":"Atualiza Mensagem","credentials":{"supabaseApi":{"id":"4MbqyW9T081a3o7d","name":"Finamob"}},"notes":"Este fluxo é de propriedade da FORMAÇÃO AGENTES DE IA COM N8N -BY RICNEVES"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('Pega Disparos Agendados').item.json.origem_disparo }}","rightValue":"Murilo IA","operator":{"type":"string","operation":"equals"},"id":"099e8c7f-0e6f-4c08-a9a7-19e008d71b3e"}],"combinator":"and"},"renameOutput":true,"outputKey":"Murilo IA"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"eb6fa2fd-9350-488a-803d-68facc6b5a36","leftValue":"={{ $('Pega Disparos Agendados').item.json.origem_disparo }}","rightValue":"Diogo IA","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Diogo IA"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[496,-96],"id":"86e3fb32-d776-4489-acad-b9d1cde5e3c0","name":"Switch"},{"parameters":{"height":848,"width":2928},"type":"n8n-nodes-base.stickyNote","position":[768,-928],"typeVersion":1,"id":"f86b33d7-65b6-413e-a67c-9292fe8fa617","name":"Sticky Note"},{"parameters":{"batchSize":"=1","options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[1008,336],"id":"f8c74a87-bd41-4428-aaff-b6bb67049902","name":"Loop Over Items"},{"parameters":{"amount":"={{ 3 + Math.floor(Math.random() * 5) }}"},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1264,352],"id":"492d2eba-0c06-42e7-b15b-323415578821","name":"Wait1","webhookId":"6686e364-432c-466f-ac33-321c79f8a8a1"},{"parameters":{"resource":"messages-api","operation":"send-image","instanceName":"finamob-sdr-diogo","remoteJid":"={{ $json.telefone }}","media":"={{ $json.base64 }}","caption":"=Oi {{ $json.nome }}, tudo bem?\n\n{{ $json.mensagem }}\n\nSe não quiser mais receber comunicações no seu celular responda essa mensagem com \"opt-out\".","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1776,352],"id":"b81a6584-044c-4b68-8a0a-323b75946805","name":"Envio do Resumo2","credentials":{"evolutionApi":{"id":"j82pkEtO22SNtgh3","name":"finamob-sdr-diogo"}},"onError":"continueRegularOutput"},{"parameters":{"resource":"messages-api","instanceName":"finamob-sdr-diogo","remoteJid":"={{ $json.telefone }}","messageText":"=Oi {{ $json.nome }}, tudo bem?\n\n{{ $json.mensagem }}\n","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1776,160],"id":"69451a22-11f7-48f9-986b-2dd2eadaa384","name":"Envio do Resumo3","credentials":{"evolutionApi":{"id":"j82pkEtO22SNtgh3","name":"finamob-sdr-diogo"}},"onError":"continueRegularOutput"},{"parameters":{"operation":"update","tableId":"disparos","matchType":"allFilters","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $('Pega Leads do Supabase').item.json.id_disparo }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"status","fieldValue":"Enviado"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2208,352],"id":"c897bb9e-3112-4d5e-8436-7fcbd175bf82","name":"Update a row1","credentials":{"supabaseApi":{"id":"4MbqyW9T081a3o7d","name":"Finamob"}}},{"parameters":{"operation":"get","tableId":"finamob-mensagens","filters":{"conditions":[{"keyName":"telefone","keyValue":"={{ $('Code').item.json.telefone }}"},{"keyName":"nome_app","keyValue":"=SDR-DIOGO"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2432,352],"id":"88b36dcf-ce9a-469c-a9b0-05b64a407eb2","name":"Busca Dados1","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"4MbqyW9T081a3o7d","name":"Finamob"}},"onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"defac08a-6745-422b-bb05-90da9f47d91b","leftValue":"={{ $('Busca Dados1').last().json.values() }}","rightValue":"","operator":{"type":"array","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2672,352],"id":"aa8c35b2-8c3b-47ec-8839-4a01d52ab087","name":"Verifica se encontrou1"},{"parameters":{"tableId":"finamob-mensagens","fieldsUi":{"fieldValues":[{"fieldId":"telefone","fieldValue":"={{ $('Code').item.json.telefone }}"},{"fieldId":"updated_at","fieldValue":"={{$now.setLocale('pt-BR')}}"},{"fieldId":"nome_app","fieldValue":"=SDR-DIOGO"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2912,272],"id":"06204c1e-8d87-42ec-b825-bd5bef274728","name":"Adiciona Mensagem1","credentials":{"supabaseApi":{"id":"4MbqyW9T081a3o7d","name":"Finamob"}},"notes":"Este fluxo é de propriedade da FORMAÇÃO AGENTES DE IA COM N8N -BY RICNEVES"},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3,"position":[3200,352],"id":"ca9be003-ea7a-477a-85ab-2a5177e74f77","name":"Faz o Merge1","notes":"Este fluxo é de propriedade da FORMAÇÃO AGENTES DE IA COM N8N -BY RICNEVES"},{"parameters":{"tableId":"finamob-historico_mensagens","fieldsUi":{"fieldValues":[{"fieldId":"mensagem_usuario","fieldValue":"="},{"fieldId":"mensagem_agente","fieldValue":"={{ $('Edit Fields').item.json.mensagem }}"},{"fieldId":"telefone","fieldValue":"={{ $('Wait1').item.json.telefone }}"},{"fieldId":"nome_usuario","fieldValue":"={{ $('Edit Fields').item.json.nome }}"},{"fieldId":"message_type","fieldValue":"text"},{"fieldId":"ativo","fieldValue":"true"},{"fieldId":"nome_app","fieldValue":"SDR-DIOGO"},{"fieldId":"id_usuario","fieldValue":"={{ $('Wait1').item.json.telefone }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[3488,544],"id":"3fefa089-578d-4b28-a103-fa881bd32827","name":"Cria Mensagem no Supabase1","credentials":{"supabaseApi":{"id":"4MbqyW9T081a3o7d","name":"Finamob"}},"onError":"continueRegularOutput","notes":"Este fluxo é de propriedade da FORMAÇÃO AGENTES DE IA COM N8N -BY RICNEVES"},{"parameters":{"operation":"update","tableId":"finamob-mensagens","matchType":"allFilters","filters":{"conditions":[{"keyName":"telefone","condition":"eq","keyValue":"={{ $('Code').item.json.telefone }}"},{"keyName":"nome_app","condition":"eq","keyValue":"SDR-DIOGO"}]},"fieldsUi":{"fieldValues":[{"fieldId":"updated_at","fieldValue":"={{$now.setLocale('pt-BR')}}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2912,464],"id":"2107fb28-8819-46ed-a425-00feb1b3db2c","name":"Atualiza Mensagem1","credentials":{"supabaseApi":{"id":"4MbqyW9T081a3o7d","name":"Finamob"}},"notes":"Este fluxo é de propriedade da FORMAÇÃO AGENTES DE IA COM N8N -BY RICNEVES"},{"parameters":{"height":848,"width":2928},"type":"n8n-nodes-base.stickyNote","position":[768,-16],"typeVersion":1,"id":"23667331-1281-41de-80e1-ec909b66a05b","name":"Sticky Note1"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"635ac4f0-7983-4784-8e4f-6f969c0f173a","leftValue":"={{ $json.tipo_midia }}","rightValue":"","operator":{"type":"string","operation":"empty","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"null"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.tipo_midia }}","rightValue":"imagem","operator":{"type":"string","operation":"equals"},"id":"18e41898-3ae2-4b09-b0f3-7ff87c97cc6b"}],"combinator":"and"},"renameOutput":true,"outputKey":"imagem"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"27101683-43e7-43bf-98aa-64f04e1421dd","leftValue":"={{ $json.tipo_midia }}","rightValue":"video","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"video"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[1504,-640],"id":"1ace5086-e2ca-4fb3-904a-82dffb11d314","name":"Switch1"},{"parameters":{"resource":"messages-api","operation":"send-video","instanceName":"finamob-sdr-diogo","remoteJid":"={{ $json.telefone }}","media":"={{ $json.base64 }}","caption":"=Oi {{ $json.nome }}, tudo bem?\n\n{{ $json.mensagem }}\n\nSe não quiser mais receber comunicações no seu celular responda essa mensagem com \"opt-out\".","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1776,544],"id":"07fd4b3b-e349-4039-8890-a25c4945d5d7","name":"Envio do Resumo5","credentials":{"evolutionApi":{"id":"j82pkEtO22SNtgh3","name":"finamob-sdr-diogo"}},"onError":"continueRegularOutput"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"635ac4f0-7983-4784-8e4f-6f969c0f173a","leftValue":"={{ $json.tipo_midia }}","rightValue":"","operator":{"type":"string","operation":"empty","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"null"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.tipo_midia }}","rightValue":"imagem","operator":{"type":"string","operation":"equals"},"id":"18e41898-3ae2-4b09-b0f3-7ff87c97cc6b"}],"combinator":"and"},"renameOutput":true,"outputKey":"imagem"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"27101683-43e7-43bf-98aa-64f04e1421dd","leftValue":"={{ $json.tipo_midia }}","rightValue":"video","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"video"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[1504,336],"id":"6613c8de-2ceb-4477-91d0-371a4c8b6a74","name":"Switch2"},{"parameters":{"documentId":{"__rl":true,"value":"1JoARK3rKD-WHDk8LUDHRmo03eLMGdKWyN-msVFiygvQ","mode":"list","cachedResultName":"CRM - Finamob","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1JoARK3rKD-WHDk8LUDHRmo03eLMGdKWyN-msVFiygvQ/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":2099019423,"mode":"list","cachedResultName":"opt-out","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1JoARK3rKD-WHDk8LUDHRmo03eLMGdKWyN-msVFiygvQ/edit#gid=2099019423"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[-528,-272],"id":"86e2416d-54ac-4128-9d7d-dddf2f8ce992","name":"Get row(s) in sheet","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"jsCode":"// Entradas: Supabase (leads) e Sheets (blacklist)\nconst leads = items;\nconst blacklist = $items('Get row(s) in sheet', 0, 0);\n\n// --- Função robusta para normalizar telefone ---\nfunction normalizePhone(phone) {\n  if (!phone) return '';\n\n  let clean = String(phone).replace(/\\D/g, ''); // remove tudo que não é número\n\n  // Remove prefixo internacional 55 se existir\n  if (clean.startsWith('55')) clean = clean.slice(2);\n\n  // Se tiver mais de 11 dígitos (erro comum em planilhas), pega só os últimos 11\n  if (clean.length > 11) clean = clean.slice(-11);\n\n  // Se tiver menos de 11 e mais de 8 (fixo sem DDD), ignora\n  if (clean.length < 10) return '';\n\n  // Corrige se for 10 dígitos (sem o 9)\n  if (clean.length === 10) {\n    clean = clean.slice(0, 2) + '9' + clean.slice(2);\n  }\n\n  return clean;\n}\n\n// --- Cria lista de bloqueados normalizados ---\nconst blacklistPhones = blacklist\n  .map(b => normalizePhone(b.json.Telefone || b.json.telefone))\n  .filter(Boolean);\n\n// --- Filtra os leads que NÃO estão na blacklist ---\nconst filteredLeads = leads.filter(l => {\n  const leadPhone = normalizePhone(l.json.telefone);\n  const isBlocked = blacklistPhones.includes(leadPhone);\n  return leadPhone && !isBlocked;\n});\n\n// --- Logs úteis para debug ---\nconsole.log('Blacklisted phones:', blacklistPhones);\nconsole.log('Total leads recebidos:', leads.length);\nconsole.log('Leads após filtro:', filteredLeads.length);\n\nreturn filteredLeads;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-128,-96],"id":"6c577703-f498-4c7e-8473-b415462ce40f","name":"Code1"},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[-304,-96],"id":"1e49e614-f4ec-4f78-a72c-441028f84b56","name":"Merge"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v22.0/869722152886578/messages","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.telefone }}\",\n  \"type\": \"template\",\n  \"template\": {\n    \"name\": \"{{ $json.template_name }}\",\n    \"language\": { \"code\": \"pt_BR\" },\n    \"components\": [\n      {\n        \"type\": \"header\",\n        \"parameters\": [\n          {\n            \"type\": \"image\",\n            \"image\": { \"link\": \"{{ $json.imagem_url }}\" }\n          }\n        ]\n      },\n      {\n        \"type\": \"body\",\n        \"parameters\": {{ \n          JSON.stringify(\n            [\n              { \"type\": \"text\", \"text\": $json.param_1 },\n              { \"type\": \"text\", \"text\": $json.param_2 },\n              { \"type\": \"text\", \"text\": $json.param_3 },\n              { \"type\": \"text\", \"text\": $json.param_4 },\n              { \"type\": \"text\", \"text\": $json.param_5 }\n            ].filter(p => p.text && p.text.trim() !== \"\")\n          )\n        }}\n      }\n    ]\n  }\n}\n","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1824,-624],"id":"5d309619-d7a6-49c6-98bb-2325ac2b7c8c","name":"HTTP Request","retryOnFail":true,"credentials":{"httpBearerAuth":{"id":"W8jSHgF1bru0lIPY","name":"whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v22.0/869722152886578/messages","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.telefone }}\",\n  \"type\": \"template\",\n  \"template\": {\n    \"name\": \"{{ $json.template_name }}\",\n    \"language\": { \"code\": \"pt_BR\" },\n    \"components\": [\n      {\n        \"type\": \"body\",\n        \"parameters\": {{ \n          JSON.stringify(\n            [\n              { \"type\": \"text\", \"text\": $json.param_1 },\n              { \"type\": \"text\", \"text\": $json.param_2 },\n              { \"type\": \"text\", \"text\": $json.param_3 },\n              { \"type\": \"text\", \"text\": $json.param_4 },\n              { \"type\": \"text\", \"text\": $json.param_5 }\n            ].filter(p => p.text && p.text.trim() !== \"\")\n          )\n        }}\n      }\n    ]\n  }\n}\n","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1824,-832],"id":"25d82dc8-5ce5-4915-8a41-0b654c1aa648","name":"HTTP Request1","retryOnFail":true,"credentials":{"httpBearerAuth":{"id":"W8jSHgF1bru0lIPY","name":"whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v22.0/869722152886578/messages","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.telefone }}\",\n  \"type\": \"template\",\n  \"template\": {\n    \"name\": \"{{ $json.template_name }}\",\n    \"language\": { \"code\": \"pt_BR\" },\n    \"components\": [\n      {\n        \"type\": \"header\",\n        \"parameters\": [\n          {\n            \"type\": \"image\",\n            \"image\": { \"link\": \"{{ $json.imagem_url }}\" }\n          }\n        ]\n      },\n      {\n        \"type\": \"body\",\n        \"parameters\": {{ \n          JSON.stringify(\n            [\n              { \"type\": \"text\", \"text\": $json.param_1 },\n              { \"type\": \"text\", \"text\": $json.param_2 },\n              { \"type\": \"text\", \"text\": $json.param_3 },\n              { \"type\": \"text\", \"text\": $json.param_4 },\n              { \"type\": \"text\", \"text\": $json.param_5 }\n            ].filter(p => p.text && p.text.trim() !== \"\")\n          )\n        }}\n      }\n    ]\n  }\n}\n","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1824,-416],"id":"043c65e6-97fa-4a35-bc61-48daabc16e3f","name":"Nao funciona","retryOnFail":true,"credentials":{"httpBearerAuth":{"id":"W8jSHgF1bru0lIPY","name":"whatsapp"}}}],"connections":{"Schedule Trigger":{"main":[[{"node":"Pega Disparos Agendados","type":"main","index":0}]]},"Pega Disparos Agendados":{"main":[[{"node":"Get row(s) in sheet","type":"main","index":0},{"node":"Pega Leads do Supabase","type":"main","index":0}]]},"Pega Leads do Supabase":{"main":[[{"node":"Merge","type":"main","index":1}]]},"Loop Over Items1":{"main":[[],[{"node":"Wait","type":"main","index":0}]]},"Wait":{"main":[[{"node":"Switch1","type":"main","index":0}]]},"Envio do Resumo":{"main":[[]]},"Edit Fields":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Switch","type":"main","index":0}]]},"Envio do Resumo1":{"main":[[]]},"Update a row":{"main":[[{"node":"Busca Dados","type":"main","index":0}]]},"Busca Dados":{"main":[[{"node":"Verifica se encontrou","type":"main","index":0}]]},"Verifica se encontrou":{"main":[[{"node":"Adiciona Mensagem","type":"main","index":0}],[{"node":"Atualiza Mensagem","type":"main","index":0}]]},"Adiciona Mensagem":{"main":[[{"node":"Faz o Merge","type":"main","index":0}]]},"Faz o Merge":{"main":[[{"node":"Cria Mensagem no Supabase","type":"main","index":0}]]},"Atualiza Mensagem":{"main":[[{"node":"Faz o Merge","type":"main","index":1}]]},"Cria Mensagem no Supabase":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}],[{"node":"Loop Over Items","type":"main","index":0}]]},"Loop Over Items":{"main":[[],[{"node":"Wait1","type":"main","index":0}]]},"Wait1":{"main":[[{"node":"Switch2","type":"main","index":0}]]},"Envio do Resumo2":{"main":[[{"node":"Update a row1","type":"main","index":0}]]},"Envio do Resumo3":{"main":[[{"node":"Update a row1","type":"main","index":0}]]},"Update a row1":{"main":[[{"node":"Busca Dados1","type":"main","index":0}]]},"Busca Dados1":{"main":[[{"node":"Verifica se encontrou1","type":"main","index":0}]]},"Verifica se encontrou1":{"main":[[{"node":"Adiciona Mensagem1","type":"main","index":0}],[{"node":"Atualiza Mensagem1","type":"main","index":0}]]},"Adiciona Mensagem1":{"main":[[{"node":"Faz o Merge1","type":"main","index":0}]]},"Faz o Merge1":{"main":[[{"node":"Cria Mensagem no Supabase1","type":"main","index":0}]]},"Cria Mensagem no Supabase1":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Atualiza Mensagem1":{"main":[[{"node":"Faz o Merge1","type":"main","index":1}]]},"Switch1":{"main":[[{"node":"HTTP Request1","type":"main","index":0}],[{"node":"HTTP Request","type":"main","index":0}],[{"node":"Nao funciona","type":"main","index":0}]]},"Switch2":{"main":[[{"node":"Envio do Resumo3","type":"main","index":0}],[{"node":"Envio do Resumo2","type":"main","index":0}],[{"node":"Envio do Resumo5","type":"main","index":0}]]},"Envio do Resumo5":{"main":[[{"node":"Update a row1","type":"main","index":0}]]},"Get row(s) in sheet":{"main":[[{"node":"Merge","type":"main","index":0}]]},"Code1":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"Merge":{"main":[[{"node":"Code1","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"Update a row","type":"main","index":0}]]},"HTTP Request1":{"main":[[{"node":"Update a row","type":"main","index":0}]]},"Nao funciona":{"main":[[{"node":"Update a row","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"e66f9e74-1a2d-4295-a5ab-92427c7a1153","triggerCount":1,"tags":[]}