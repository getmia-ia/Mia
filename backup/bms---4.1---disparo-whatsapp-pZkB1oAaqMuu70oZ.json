{"createdAt":"2025-09-30T11:42:14.425Z","updatedAt":"2025-10-14T17:58:52.246Z","id":"pZkB1oAaqMuu70oZ","name":"BMS - 4.1 - Disparo Whatsapp","active":true,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":10}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[0,0],"id":"d1abaeb4-abd4-4b83-830a-f94c73c4d810","name":"Schedule Trigger"},{"parameters":{"operation":"getAll","tableId":"leads","returnAll":true,"filters":{"conditions":[{"keyName":"id_disparo","condition":"eq","keyValue":"={{ $json.id }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[416,0],"id":"12f9f3ca-6986-4d86-9c09-30325cb7e742","name":"Pega Leads do Supabase","credentials":{"supabaseApi":{"id":"9FeQpCfKieI9F2Ms","name":"bms"}}},{"parameters":{"operation":"getAll","tableId":"disparos","returnAll":true,"matchType":"allFilters","filters":{"conditions":[{"keyName":"data_hora","condition":"lte","keyValue":"={{$json[\"timestamp\"]}}"},{"keyName":"status","condition":"eq","keyValue":"Em andamento"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[208,0],"id":"5c00bd48-a925-428a-afe4-ba0cb95370e3","name":"Pega Disparos Agendados","credentials":{"supabaseApi":{"id":"9FeQpCfKieI9F2Ms","name":"bms"}}},{"parameters":{"assignments":{"assignments":[{"id":"59ff38c0-5bb5-41fb-9e42-bc90aa134824","name":"mensagem","value":"={{ $('Pega Disparos Agendados').item.json.mensagem }}","type":"string"},{"id":"662fdd3a-8574-496b-bcc2-a65311f1ec9b","name":"imagem","value":"={{ $('Pega Disparos Agendados').item.json.imagem_url }}","type":"string"},{"id":"5a1ad5b9-c0f3-4215-a17f-d4832dace959","name":"remetente","value":"","type":"string"},{"id":"d5de298f-2320-448c-a83e-d23b3298260c","name":"nome","value":"={{ $json.nome }}","type":"string"},{"id":"7bc1856e-87c7-485d-9a8b-b411e46cc501","name":"telefone","value":"={{ $json.telefone }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[624,0],"id":"51e409ba-f2e6-4e2d-af3f-1c08a208d002","name":"Edit Fields"},{"parameters":{"batchSize":"=1","options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[1104,0],"id":"7b2f8ce9-91c5-48d6-82f1-466c8c226719","name":"Loop Over Items1"},{"parameters":{"amount":"={{ 3 + Math.floor(Math.random() * 5) }}"},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1344,16],"id":"9816b8ac-5c33-4ddb-b2ee-e27214e705f8","name":"Wait","webhookId":"a2788908-cd68-4ade-8249-4715395d842b"},{"parameters":{"resource":"messages-api","operation":"send-image","instanceName":"bms-comunidade","remoteJid":"={{ $json.telefone }}","media":"={{ $json.base64 }}","caption":"=Oi {{ $json.nome }}, tudo bem?\n\n{{ $json.mensagem }}\n\nSe não quiser mais receber comunicações no seu celular responda essa mensagem com \"opt-out\".","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1840,240],"id":"13284f4f-3bbc-4cd1-9ef2-44e8152fa1df","name":"Envio do Resumo","credentials":{"evolutionApi":{"id":"sK3i6SFD2rDiHvNg","name":"BMS2"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Code node — Mode: Run Once for All Items\nfunction normalizeTelefone(raw) {\n  if (raw == null) return \"\";\n  let d = String(raw).replace(/\\D/g, \"\").replace(/^0+/, \"\");\n  return d ? (d.startsWith(\"55\") ? d : \"55\" + d) : \"\";\n}\n\nfunction stripBOM(buf) {\n  return (buf.length >= 3 && buf[0] === 0xEF && buf[1] === 0xBB && buf[2] === 0xBF)\n    ? buf.slice(3)\n    : buf;\n}\n\nfunction fixPngSignature(buf) {\n  // PNG correto: 89 50 4E 47 0D 0A 1A 0A\n  if (buf.length >= 7 &&\n      buf[0] === 0x50 && buf[1] === 0x4E && buf[2] === 0x47 && // \"PNG\"\n      buf[3] === 0x0D && buf[4] === 0x0A && buf[5] === 0x1A && buf[6] === 0x0A) {\n    // faltou 0x89 antes de \"PNG\"\n    return Buffer.concat([Buffer.from([0x89]), buf]);\n  }\n  return buf;\n}\n\nasync function getBinaryWithHeaders(url) {\n  try {\n    const res = await this.helpers.httpRequest({\n      method: 'GET',\n      url,\n      headers: { 'User-Agent': 'Mozilla/5.0' },\n      responseFormat: 'arraybuffer',\n      returnFullResponse: true,\n    });\n    return { buf: Buffer.from(res.data ?? res), mime: res.headers?.['content-type'] || \"\" };\n  } catch {\n    const res = await this.helpers.request({\n      method: 'GET',\n      url,\n      headers: { 'User-Agent': 'Mozilla/5.0' },\n      json: false,\n      encoding: null,\n      resolveWithFullResponse: true,\n    });\n    return { buf: Buffer.from(res.body), mime: res.headers?.['content-type'] || \"\" };\n  }\n}\n\nreturn await Promise.all(items.map(async (item) => {\n  const mensagem  = item.json?.mensagem;\n  const remetente = item.json?.remetente;\n  const nome      = item.json?.nome;\n  const telefone  = normalizeTelefone(item.json?.telefone);\n  const url       = (item.json?.imagem ?? \"\").toString().trim();\n\n  let base64 = \"\";\n\n  if (url) {\n    try {\n      let { buf, mime } = await getBinaryWithHeaders.call(this, url);\n      buf = Buffer.from(buf);\n      buf = stripBOM(buf);\n      // Se for PNG sem 0x89 no início, corrige\n      const isPngHint = (mime && mime.includes('png')) ||\n                        (buf.length >= 3 && buf[0] === 0x50 && buf[1] === 0x4E && buf[2] === 0x47);\n      if (isPngHint && buf.length >= 7) buf = fixPngSignature(buf);\n      base64 = buf.toString('base64');\n    } catch {\n      base64 = \"\";\n    }\n  }\n\n  return {\n    json: { mensagem, remetente, nome, telefone, base64 }\n  };\n}));\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[832,0],"id":"e1731667-ba59-41d2-873f-0803393fc0df","name":"Code"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"d7e64dd7-1f48-4920-86a9-cf7e9d63d4c5","leftValue":"={{ $json.base64 }}","rightValue":"","operator":{"type":"string","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1552,16],"id":"027b7a54-20d6-4a7e-aaf3-38b69efdb121","name":"If"},{"parameters":{"resource":"messages-api","instanceName":"bms-comunidade","remoteJid":"={{ $json.telefone }}","messageText":"=Oi {{ $json.nome }}, tudo bem?\n\n{{ $json.mensagem }}\n\nSe não quiser mais receber comunicações no seu celular responda essa mensagem com \"opt-out\".","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1840,0],"id":"6a8263c8-2df5-41af-8787-d6f17cab3e51","name":"Envio do Resumo1","credentials":{"evolutionApi":{"id":"sK3i6SFD2rDiHvNg","name":"BMS2"}},"onError":"continueRegularOutput"},{"parameters":{"operation":"update","tableId":"disparos","matchType":"allFilters","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $('Pega Leads do Supabase').item.json.id_disparo }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"status","fieldValue":"Enviado"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2272,240],"id":"b6570a20-8f5b-4fa7-ad43-2150d712f06a","name":"Update a row","credentials":{"supabaseApi":{"id":"9FeQpCfKieI9F2Ms","name":"bms"}}},{"parameters":{"operation":"get","tableId":"bms-mensagens","filters":{"conditions":[{"keyName":"telefone","keyValue":"={{ $('If').item.json.telefone }}"},{"keyName":"nome_app","keyValue":"=SDR-BMS2"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2496,240],"id":"1a4bb7aa-3221-4877-871a-496d92c1c4ee","name":"Busca Dados","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"9FeQpCfKieI9F2Ms","name":"bms"}},"onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"defac08a-6745-422b-bb05-90da9f47d91b","leftValue":"={{ $('Busca Dados').last().json.values() }}","rightValue":"","operator":{"type":"array","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2736,240],"id":"3e2bf7f4-6c9d-4e52-a36b-bef5e27aa362","name":"Verifica se encontrou"},{"parameters":{"tableId":"bms-mensagens","fieldsUi":{"fieldValues":[{"fieldId":"telefone","fieldValue":"={{ $('If').item.json.telefone }}"},{"fieldId":"update_at","fieldValue":"={{$now.setLocale('pt-BR')}}"},{"fieldId":"nome_app","fieldValue":"=SDR-BMS2"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2976,160],"id":"b761cbab-f1b1-4728-99f9-cf0765d05043","name":"Adiciona Mensagem","credentials":{"supabaseApi":{"id":"9FeQpCfKieI9F2Ms","name":"bms"}},"notes":"Este fluxo é de propriedade da FORMAÇÃO AGENTES DE IA COM N8N -BY RICNEVES"},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3,"position":[3264,240],"id":"734fe97f-d4df-4ea9-aa4a-6c31de634640","name":"Faz o Merge","notes":"Este fluxo é de propriedade da FORMAÇÃO AGENTES DE IA COM N8N -BY RICNEVES"},{"parameters":{"tableId":"bms-historico_mensagens","fieldsUi":{"fieldValues":[{"fieldId":"mensagem_usuario","fieldValue":"="},{"fieldId":"mensagem_agente","fieldValue":"={{ $('Edit Fields').item.json.mensagem }}"},{"fieldId":"telefone","fieldValue":"={{ $('Wait').item.json.telefone }}"},{"fieldId":"nome_usuario","fieldValue":"={{ $('Edit Fields').item.json.nome }}"},{"fieldId":"message_type","fieldValue":"text"},{"fieldId":"ativo","fieldValue":"true"},{"fieldId":"nome_app","fieldValue":"SDR-BMS2"},{"fieldId":"id_usuario","fieldValue":"={{ $('Wait').item.json.telefone }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[3552,432],"id":"cd8c0786-fba9-48ea-954f-8e6b0219797d","name":"Cria Mensagem no Supabase","credentials":{"supabaseApi":{"id":"9FeQpCfKieI9F2Ms","name":"bms"}},"onError":"continueRegularOutput","notes":"Este fluxo é de propriedade da FORMAÇÃO AGENTES DE IA COM N8N -BY RICNEVES"},{"parameters":{"operation":"update","tableId":"bms-mensagens","matchType":"allFilters","filters":{"conditions":[{"keyName":"telefone","condition":"eq","keyValue":"={{ $('If').item.json.telefone }}"},{"keyName":"nome_app","condition":"eq","keyValue":"SDR-BMS2"}]},"fieldsUi":{"fieldValues":[{"fieldId":"update_at","fieldValue":"={{$now.setLocale('pt-BR')}}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2976,352],"id":"0c996582-5ebf-4ebd-a408-71e8e09dfa71","name":"Atualiza Mensagem","credentials":{"supabaseApi":{"id":"9FeQpCfKieI9F2Ms","name":"bms"}},"notes":"Este fluxo é de propriedade da FORMAÇÃO AGENTES DE IA COM N8N -BY RICNEVES"}],"connections":{"Schedule Trigger":{"main":[[{"node":"Pega Disparos Agendados","type":"main","index":0}]]},"Pega Disparos Agendados":{"main":[[{"node":"Pega Leads do Supabase","type":"main","index":0}]]},"Pega Leads do Supabase":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"Loop Over Items1":{"main":[[],[{"node":"Wait","type":"main","index":0}]]},"Wait":{"main":[[{"node":"If","type":"main","index":0}]]},"Envio do Resumo":{"main":[[{"node":"Update a row","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"If":{"main":[[{"node":"Envio do Resumo1","type":"main","index":0}],[{"node":"Envio do Resumo","type":"main","index":0}]]},"Envio do Resumo1":{"main":[[{"node":"Update a row","type":"main","index":0}]]},"Update a row":{"main":[[{"node":"Busca Dados","type":"main","index":0}]]},"Busca Dados":{"main":[[{"node":"Verifica se encontrou","type":"main","index":0}]]},"Verifica se encontrou":{"main":[[{"node":"Adiciona Mensagem","type":"main","index":0}],[{"node":"Atualiza Mensagem","type":"main","index":0}]]},"Adiciona Mensagem":{"main":[[{"node":"Faz o Merge","type":"main","index":0}]]},"Faz o Merge":{"main":[[{"node":"Cria Mensagem no Supabase","type":"main","index":0}]]},"Atualiza Mensagem":{"main":[[{"node":"Faz o Merge","type":"main","index":1}]]},"Cria Mensagem no Supabase":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"GbORhS24Rzw7hHlt"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"39c71f9f-314b-48b1-afeb-0da5005ee3a4","triggerCount":1,"tags":[]}