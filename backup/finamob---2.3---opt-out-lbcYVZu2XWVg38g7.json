{"createdAt":"2025-08-29T16:24:33.618Z","updatedAt":"2025-10-06T14:39:46.281Z","id":"lbcYVZu2XWVg38g7","name":"Finamob - 2.3 - Opt-out","active":false,"isArchived":false,"nodes":[{"parameters":{},"id":"30c8b8ee-2fec-4925-95ec-7c817ebdddac","name":"Executa Workflow","type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1,"position":[16,-16]},{"parameters":{"url":"https://api.stripe.com/v1/customers/search","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"query","value":"=phone:\"{{ $json.phone_e164 }}\""}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[432,-16],"id":"3afb9485-a8a1-4656-acab-e7a34cadff46","name":"HTTP Request1","credentials":{"httpBasicAuth":{"id":"PVN6vyGsqfocZ4rZ","name":"Stripe"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3b995210-14b4-47cd-860d-e855c2fec1c0","leftValue":"={{$json.data && $json.data.length}}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[640,-16],"id":"14797fe1-0767-4ecf-b4d9-6d8b6b18fcbb","name":"If"},{"parameters":{"jsCode":"const list = items[0].json;\nif (!list.data || !list.data.length) return [];  // nada encontrado\n\n// pega o customer mais recente\nconst customer = list.data[0];\nconst immediate = ($json.text || '').includes('agora'); // se usuário digitou \"opt-out agora\"\nreturn [{ json: { customer_id: customer.id, immediate } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[880,-112],"id":"2c10a88c-1213-47e6-a672-824b0171903b","name":"Code5"},{"parameters":{"url":"https://api.stripe.com/v1/subscriptions","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"customer","value":"={{$json.customer_id}}"},{"name":"status","value":"active"},{"name":"price","value":"price_1S1SraRuKlw6o0HgiTFNxo5L"},{"name":"limit","value":"100"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1056,-112],"id":"fc8a4e18-6b66-44fb-85f9-6209c7ceeef9","name":"HTTP Request2","credentials":{"httpBasicAuth":{"id":"PVN6vyGsqfocZ4rZ","name":"Stripe"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"bfdb44dd-00cb-46de-ba68-cff5991bdfd9","leftValue":"={{$json.data && $json.data.length}}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1264,-112],"id":"828d65b9-5eb4-4745-be33-34fac06c6f2c","name":"If1"},{"parameters":{"jsCode":"const subs = items[0].json.data || [];\n// se houver mais de uma, pegue a mais recente\nconst sub = subs.sort((a,b) => (b.start_date||0) - (a.start_date||0))[0];\nreturn [{ json: { sub_id: sub.id, immediate: $json.immediate } }];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1536,-208],"id":"b66b2ad1-b52a-44be-8396-37487de854e9","name":"Code6"},{"parameters":{"method":"POST","url":"https://api.stripe.com/v1/subscriptions/{{$json.sub_id}}","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendQuery":true,"queryParameters":{"parameters":[{"name":"cancel_at_period_end","value":"=true"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1968,-96],"id":"3902fdcc-88fb-4dd4-917d-d534ff2696de","name":"Cancelar (aguarda fim do periodo)","credentials":{"httpBasicAuth":{"id":"PVN6vyGsqfocZ4rZ","name":"Stripe"}}},{"parameters":{"method":"DELETE","url":"=https://api.stripe.com/v1/subscriptions/{{$json.sub_id}}","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","sendQuery":true,"queryParameters":{"parameters":[{}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1968,-352],"id":"d3f20265-933f-4bf1-8421-d7576e9447f1","name":"Cancelar (imediato)","credentials":{"httpBasicAuth":{"id":"PVN6vyGsqfocZ4rZ","name":"Stripe"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"552a3fdd-a2cf-4e2c-8cfa-45232e9e3920","leftValue":"={{ $('Code').item.json.modo_cancelamento }}","rightValue":"imediato","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1712,-208],"id":"e698ceb3-0518-4313-9d18-63f5831a31f1","name":"If2"},{"parameters":{"assignments":{"assignments":[{"id":"ca36ce04-105c-4491-bea3-fb23788bd346","name":"=phone_e164","value":"992486507","type":"string"},{"id":"cccd3077-afff-4069-89c3-9f942e44dd7f","name":"modo_cancelamento","value":"imediato","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[16,-224],"id":"82c4b912-c0b5-4d08-96e1-34c260294c33","name":"Edit Fields","disabled":true},{"parameters":{"assignments":{"assignments":[{"id":"81416485-6e75-43e6-ab2f-6d2d9130f12c","name":"response","value":"=Assinatura cancelada com sucesso!","type":"string"}]},"options":{}},"id":"7b231167-facd-44fe-8f64-3663829ddfe2","name":"Resposta Positiva","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2384,-224]},{"parameters":{"assignments":{"assignments":[{"id":"81416485-6e75-43e6-ab2f-6d2d9130f12c","name":"response","value":"=Não conseguimos cancelar a assinatura, verificar o número cadastrado!","type":"string"}]},"options":{}},"id":"7fdc658a-35da-4853-ac40-aa17cc344bae","name":"Resposta Negativa","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2384,224]},{"parameters":{"height":960,"width":2656},"type":"n8n-nodes-base.stickyNote","position":[-64,-496],"typeVersion":1,"id":"93d25c3a-9736-4f83-9b9d-c962ee2fd86a","name":"Sticky Note"},{"parameters":{"jsCode":"// Aceita direto ou dentro de $json.query\nlet payload = $json;\nif ($json.query) {\n  try {\n    payload = typeof $json.query === 'string' ? JSON.parse($json.query) : $json.query;\n  } catch (e) {\n    payload = {};\n  }\n}\n\nreturn [{\n  json: {\n    phone_e164: String(payload.phone_e164 || '').trim(),\n    modo_cancelamento: String(payload.modo_cancelamento || '').trim().toLowerCase()\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[240,-16],"id":"6ff661f5-c000-47ef-9644-6d91544c1b8e","name":"Code"}],"connections":{"HTTP Request1":{"main":[[{"node":"If","type":"main","index":0}]]},"If":{"main":[[{"node":"Code5","type":"main","index":0}],[{"node":"Resposta Negativa","type":"main","index":0}]]},"Code5":{"main":[[{"node":"HTTP Request2","type":"main","index":0}]]},"HTTP Request2":{"main":[[{"node":"If1","type":"main","index":0}]]},"If1":{"main":[[{"node":"Code6","type":"main","index":0}],[{"node":"Resposta Negativa","type":"main","index":0}]]},"Code6":{"main":[[{"node":"If2","type":"main","index":0}]]},"If2":{"main":[[{"node":"Cancelar (imediato)","type":"main","index":0}],[{"node":"Cancelar (aguarda fim do periodo)","type":"main","index":0}]]},"Edit Fields":{"main":[[]]},"Executa Workflow":{"main":[[{"node":"Code","type":"main","index":0}]]},"Cancelar (imediato)":{"main":[[{"node":"Resposta Positiva","type":"main","index":0}]]},"Cancelar (aguarda fim do periodo)":{"main":[[{"node":"Resposta Positiva","type":"main","index":0}]]},"Code":{"main":[[{"node":"HTTP Request1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"Cem9y3zmcggUQhrp"},"staticData":null,"meta":null,"pinData":{},"versionId":"6c16df75-5436-4d96-9eb1-ff80868e8253","triggerCount":0,"tags":[]}