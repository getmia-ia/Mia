{"createdAt":"2025-08-22T15:54:39.628Z","updatedAt":"2025-10-02T17:12:10.287Z","id":"N7XuMXPZS3plGs7V","name":"1.4 - ZP - Resumo Semanal","active":false,"isArchived":true,"nodes":[{"parameters":{"rule":{"interval":[{"field":"weeks","triggerAtDay":[1,4],"triggerAtHour":8}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[432,752],"id":"a048f8a5-84cd-47b6-b9f0-f04af15cdfd3","name":"Schedule Trigger1"},{"parameters":{"documentId":{"__rl":true,"value":"1Ze1MFqVlu21qakfTTE5ECfAu4iFOoeQMygOCjPW5nek","mode":"list","cachedResultName":"Controle Radar do Corretor","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Ze1MFqVlu21qakfTTE5ECfAu4iFOoeQMygOCjPW5nek/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Ze1MFqVlu21qakfTTE5ECfAu4iFOoeQMygOCjPW5nek/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"status","lookupValue":"postado"},{"lookupColumn":"last_4_days","lookupValue":"1"}]},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[752,752],"id":"2c9eef5e-053e-4b20-833c-7c43be76552a","name":"Get row(s) in sheet","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"jsCode":"// hoje em America/Sao_Paulo\nconst hoje = new Date();\n\n// fim = ontem\nconst fim = new Date(hoje);\nfim.setDate(fim.getDate() - 1);\n\n// início depende do dia da semana\nconst ini = new Date(fim);\n\nif (hoje.getDay() === 1) {\n  // Hoje é segunda → pega de quinta a domingo\n  ini.setDate(fim.getDate() - 3);  // quinta\n} else if (hoje.getDay() === 4) {\n  // Hoje é quinta → pega de segunda a quarta\n  ini.setDate(fim.getDate() - 2);  // segunda\n} else {\n  // fallback: últimos 3 dias\n  ini.setDate(fim.getDate() - 2);\n}\n\n// formatador dd/mm/yyyy\nconst fmt = d => String(d.getDate()).padStart(2,'0') + '/' +\n                 String(d.getMonth()+1).padStart(2,'0') + '/' +\n                 d.getFullYear();\n\nreturn {\n  data_ini: fmt(ini),\n  data_fim: fmt(fim)\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[592,752],"id":"b7cad0c4-e7d8-4984-b7ac-63a41aff6a7f","name":"Code"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[1296,976],"id":"e346fc85-8e24-4a4e-a22b-90c733538cf2","name":"OpenRouter Chat Model1","credentials":{"openRouterApi":{"id":"o1ywdYlH64cgqSMT","name":"OpenRouter account"}}},{"parameters":{"jsCode":"const items = $input.all();\nif (!items.length) {\n  return [{ json: { prompt: \"Nenhuma notícia encontrada no período.\" } }];\n}\n\n// datas vindas do primeiro node \"Code\" (ajuste o nome se o seu node tiver outro nome)\nconst { data_ini, data_fim } = $item(0).$node[\"Code\"].json;\n\n// Limita texto da legenda para não estourar token\nconst MAX = 500;\nconst cut = s => (s ?? '').toString().trim().slice(0, MAX);\n\n// Monta contexto com título + legenda reduzida\nconst contexto = items.map(it => {\n  const titulo  = (it.json.titulo  ?? '').toString().trim();\n  const legenda = cut(it.json.legenda);\n  return `• ${titulo}\\n${legenda}`;\n}).join(\"\\n\\n\");\n\n// Cabeçalhos\nconst header1 = `*Bom dia comunidade Radar Corretor!* 📰\\n\\n`;\nconst header2 = `Segue *resumo das notícias da semana*:\\n\\n`;\nconst header3 = `Acompanhe a nossa página no Instagram:\\nhttps://www.instagram.com/radarcorretor\\n\\n`;\n\n// Opcional: rodapé (deixe vazio se não precisar)\nconst footer = ``;\n\nconst prompt = `\nVocê é editor do briefing matinal da comunidade Radar Corretor (WhatsApp).\nProduza UMA mensagem concisa, didática e visual, com base nas notícias entre ${data_ini} e ${data_fim}.\nNão liste notícia por notícia. Não inclua links (além do Instagram já fornecido). Não invente fatos.\n\nBASE (referência; não copie literalmente):\n${contexto}\n\nFORMATO EXATO DA SAÍDA (mantenha as linhas fixas e a ordem):\n${header1}${header2}${header3}[RESUMO CONECTADO EM BLOCOS]\n- Estruture em 2 a 3 blocos, cada um com título em negrito (use negrito do WhatsApp: *texto* - apenas um asterisco, nunca dois)+ emoji na mesma linha (ex.: 📈 Economia, 🏠 Imobiliário, 🤖 Tech/Empresas).\n- Cada bloco deve ter 2 a 3 frases curtas, explicando o que aconteceu e por que importa para o corretor.\n- Separe os blocos com uma linha em branco.\n\nO que muda para o corretor:\n- (emoji) Bullets práticos\n\n[INSIRA AQUI uma ÚNICA linha com **uma frase motivacional de vendas em itálico com autor, formato exato: _\"frase\" — Autor_]\n\n${footer}\n\nREGRAS:\n- PT-BR, claro e objetivo; sem jargão.\n- Priorize números/dados quando existirem; se faltarem, não invente.\n- Obrigatório: a citação deve vir em itálico (use sublinhados do WhatsApp: _texto_).\n- Não adicione seções além das especificadas.\n- Mantenha um limite de 1524 caracteres\n`.trim();\n\nreturn [{ json: { prompt } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1120,752],"id":"c8d20e33-b6db-4208-830b-e93c2bd91f7b","name":"Code1"},{"parameters":{"content":"# Fluxo de Envio do Resumo Semanal para comunidade Whatsapp\n### Esse fluxo roda todo dia de manhã as 08am\n### Envia um resumo das notícias processadas no dia anterior","height":640,"width":2336,"color":3},"type":"n8n-nodes-base.stickyNote","position":[384,528],"typeVersion":1,"id":"a0f19bb9-54ad-49ff-bff8-968a5280a6da","name":"Sticky Note15"},{"parameters":{"promptType":"define","text":"={{ $json.prompt }}","options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[1296,752],"id":"6b588658-8562-405c-8b0d-e94b5f0f226b","name":"AI Agent1","executeOnce":true,"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const parseBR = (s) => {\n  if (!s) return NaN;\n  const [dd, mm, yyyy] = s.split('/');\n  return new Date(`${yyyy}-${mm}-${dd}T00:00:00-03:00`).getTime();\n};\n\n// pega o intervalo vindo do primeiro Code\nconst data_ini = $item(0).$node[\"Code\"].json.data_ini;\nconst data_fim = $item(0).$node[\"Code\"].json.data_fim;\nconst tIni = parseBR(data_ini);\nconst tFim = parseBR(data_fim);\n\nconst out = $input.all().filter(it => {\n  const st = (it.json.status || '').toLowerCase();\n  const t  = parseBR(it.json.data_processamento);\n  return st === 'postado' && !Number.isNaN(t) && t >= tIni && t <= tFim;\n});\n\nreturn out;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[944,752],"id":"4b704632-2ebf-4e93-9422-7afb8be42a39","name":"Code2"},{"parameters":{"options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[2272,736],"id":"341ca33b-10a3-49b0-a68e-93df239a0a41","name":"Loop Over Items"},{"parameters":{"resource":"messages-api","operation":"send-image","instanceName":"social-media-radarcorretor","remoteJid":"120363418028617728@g.us","media":"={{ $json.base64Image }}","caption":"={{ $item(0).$node[\"AI Agent1\"].json.output }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[2512,752],"id":"8c466569-7e4c-4dcc-a695-5988278ef6e6","name":"Envio do post - Whatsapp","credentials":{"evolutionApi":{"id":"vDN1jxL85cL5Mz2G","name":"Evolution - Radar Corretor"}},"onError":"continueRegularOutput"},{"parameters":{"operation":"download","fileId":{"__rl":true,"value":"1etDnHoDaidl2KZmBpw4Z9RAs8FO18kCq","mode":"id"},"options":{}},"type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[1728,576],"id":"09b5eae3-d689-4727-a072-2b37f1f1a0fa","name":"Download file","credentials":{"googleDriveOAuth2Api":{"id":"ZkmaJh5Y8Zdz8ju7","name":"Google Drive - lucas@getmia.com.br"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// n8n Code node – pega o base64 do arquivo baixado no \"Download file\"\n\nconst binAll = $input.item.binary || {};\n\n// tenta 'imagem_final', depois 'data', depois a 1ª chave disponível\nconst key =\n  binAll.imagem_final ? 'imagem_final' :\n  (binAll.data ? 'data' : Object.keys(binAll)[0]);\n\nif (!key) throw new Error('Nenhum binário encontrado no item.');\n\nconst bin = binAll[key];\nif (!bin?.data) throw new Error(`Binário na chave \"${key}\" não possui .data.`);\n\n// já vem em base64; não reconverta\nconst base64 = bin.data;\n\nreturn {\n  json: {\n    base64Image: base64,                          // use isto no Evolution (media)\n    mimeType: bin.mimeType || 'application/octet-stream',\n    fileName: bin.fileName || 'arquivo'\n  }\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1936,576],"id":"4b436b51-0541-4e66-80f5-c7bc693993a7","name":"Code3"}],"connections":{"Schedule Trigger1":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Get row(s) in sheet","type":"main","index":0}]]},"Get row(s) in sheet":{"main":[[{"node":"Code2","type":"main","index":0}]]},"OpenRouter Chat Model1":{"ai_languageModel":[[{"node":"AI Agent1","type":"ai_languageModel","index":0}]]},"Code1":{"main":[[{"node":"AI Agent1","type":"main","index":0}]]},"AI Agent1":{"main":[[{"node":"Download file","type":"main","index":0}]]},"Code2":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Loop Over Items":{"main":[[],[{"node":"Envio do post - Whatsapp","type":"main","index":0}]]},"Envio do post - Whatsapp":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Download file":{"main":[[{"node":"Code3","type":"main","index":0}]]},"Code3":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","executionTimeout":-1,"errorWorkflow":"UldWpZHcKTrRMFpI"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]},"node:Google Sheets Trigger":{"documentId":"1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0","sheetId":0,"lastRevision":271,"lastRevisionLink":"https://docs.google.com/spreadsheets/export?id=1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0&revision=271&exportFormat=xlsx"},"node:Schedule Trigger1":{"recurrenceRules":[]},"node:Trigger nova noticia no sheets":{"documentId":"1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0","sheetId":0,"lastRevision":271,"lastRevisionLink":"https://docs.google.com/spreadsheets/export?id=1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0&revision=271&exportFormat=xlsx"}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"61bf00d5-3991-435f-81b5-2b8817790358","triggerCount":1,"tags":[]}