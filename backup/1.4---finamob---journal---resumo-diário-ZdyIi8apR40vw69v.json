{"createdAt":"2025-08-04T02:42:37.105Z","updatedAt":"2025-09-24T17:31:48.517Z","id":"ZdyIi8apR40vw69v","name":"1.4 - Finamob - Journal - Resumo Di√°rio","active":false,"isArchived":true,"nodes":[{"parameters":{"rule":{"interval":[{"field":"weeks","triggerAtDay":[2,3,4,5,6,0],"triggerAtHour":8}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[448,752],"id":"ec0bc80e-fcbf-49fe-b635-bcae1d67e4c5","name":"Schedule Trigger1"},{"parameters":{"documentId":{"__rl":true,"value":"1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0","mode":"list","cachedResultName":"Controle Journal","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"data_processamento","lookupValue":"={{ $json.data_processamento }}"},{"lookupColumn":"status","lookupValue":"postado"}]},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[864,752],"id":"f06f0a88-83d8-4940-aa89-c799c740e555","name":"Get row(s) in sheet","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"jsCode":"const ontem = new Date();\nontem.setDate(ontem.getDate() - 1);\n\nconst dia = String(ontem.getDate()).padStart(2, '0');\nconst mes = String(ontem.getMonth() + 1).padStart(2, '0');\nconst ano = ontem.getFullYear();\n\nreturn {\n  data_processamento: `${dia}/${mes}/${ano}`\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[656,752],"id":"ff9ad4a1-b341-44a2-8849-f1a0675dc24b","name":"Code"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[1296,976],"id":"11d5c99f-3104-4c57-bdfb-4b57156e486a","name":"OpenRouter Chat Model1","credentials":{"openRouterApi":{"id":"o1ywdYlH64cgqSMT","name":"OpenRouter account"}}},{"parameters":{"jsCode":"const items = $input.all();\nif (!items.length) {\n  return [{ json: { prompt: \"Nenhuma not√≠cia foi processada.\" } }];\n}\n\nconst data = items[0]?.json?.data_processamento || \"DATA_N√ÉO_ENCONTRADA\";\n\n// Contexto curto para guiar o modelo (sem ficar gigantesco)\nconst MAX = 500;\nconst cut = s => (s || '').trim().slice(0, MAX);\nconst contexto = items.map(it => `‚Ä¢ ${(it.json.titulo||'').trim()}\\n${cut(it.json.legenda)}`).join(\"\\n\\n\");\n\n// Linhas FIXAS (n√£o alterar)\nconst header1 = ``;\nconst header2 = `Segue resumo de not√≠cias do dia *${data}*:\\n\\n`;\nconst header3 = `Acompanhe a nossa p√°gina no Instagram:\\nhttps://www.instagram.com/escoladomercadoimobiliario\\n\\n`;\n\nconst prompt = `\nVoc√™ √© editor do briefing matinal da comunidade EMI (WhatsApp).\nProduza UMA mensagem concisa, did√°tica e **visual**, com base nas not√≠cias de *${data}*.\nN√£o liste not√≠cia por not√≠cia. N√£o inclua links (al√©m do Instagram j√° fornecido). N√£o invente fatos.\n\nBASE (refer√™ncia; n√£o copie literalmente):\n${contexto}\n\nFORMATO EXATO DA SA√çDA (mantenha as linhas fixas e a ordem):\n${header1}${header2}${header3}[RESUMO CONECTADO EM BLOCOS]\n- Estruture em **2 a 3 blocos**, cada um com **t√≠tulo em negrito + emoji** \n- Cada bloco deve ter **2 a 3 frases curtas**, explicando *o que aconteceu* e *por que importa para o corretor*.\n- Use **1 emoji no t√≠tulo**. Separe os blocos com uma linha em branco.\n\n*Como isso impacta para o incorporador?:*\n\n- Escreva entre 1 e 2 paragrafos sobre como essas noticias impactam a vida do incorporador\n\n*Manchetes do dia:*\n- coloque em listas com emoji de 1Ô∏è‚É£,2Ô∏è‚É£, etc..\n\nREGRAS:\n- PT-BR, claro e objetivo; sem jarg√£o.\n- Priorize n√∫meros/dados quando existirem; se faltarem, n√£o invente.\n- N√£o adicione se√ß√µes al√©m das especificadas.\n`.trim();\n\nreturn [{ json: { prompt } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1072,752],"id":"81c79c48-27ef-480e-adb8-3e30dc218ce1","name":"Code1"},{"parameters":{"content":"# Fluxo de Envio do Resumo Di√°rio para comunidade Whatsapp\n### Esse fluxo roda todo dia de manh√£ as 08am\n### Envia um resumo das not√≠cias processadas no dia anterior","height":752,"width":3152,"color":3},"type":"n8n-nodes-base.stickyNote","position":[384,416],"typeVersion":1,"id":"beec8bec-85e8-485c-a18b-3c034d2a2b90","name":"Sticky Note15"},{"parameters":{"operation":"download","fileId":{"__rl":true,"value":"19P4-Hrzc6ZaMUsfnC5fTT4uoduwGXGdt","mode":"id"},"options":{}},"type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[1616,752],"id":"db510b6f-8b87-4407-aa7e-6276cdf57f69","name":"Download file","credentials":{"googleDriveOAuth2Api":{"id":"ZkmaJh5Y8Zdz8ju7","name":"Google Drive - lucas@getmia.com.br"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// n8n Code node ‚Äì pega o base64 do arquivo baixado no \"Download file\"\n\nconst binAll = $input.item.binary || {};\n\n// tenta 'imagem_final', depois 'data', depois a 1¬™ chave dispon√≠vel\nconst key =\n  binAll.imagem_final ? 'imagem_final' :\n  (binAll.data ? 'data' : Object.keys(binAll)[0]);\n\nif (!key) throw new Error('Nenhum bin√°rio encontrado no item.');\n\nconst bin = binAll[key];\nif (!bin?.data) throw new Error(`Bin√°rio na chave \"${key}\" n√£o possui .data.`);\n\n// j√° vem em base64; n√£o reconverta\nconst base64 = bin.data;\n\nreturn {\n  json: {\n    base64Image: base64,                          // use isto no Evolution (media)\n    mimeType: bin.mimeType || 'application/octet-stream',\n    fileName: bin.fileName || 'arquivo'\n  }\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1808,752],"id":"dc3e1648-ca48-47e9-bc93-d0c29c670418","name":"Code2"},{"parameters":{"promptType":"define","text":"={{ $json.prompt }}","options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[1296,752],"id":"41dab09e-948d-4d12-84f8-21952622f93c","name":"AI Agent1","executeOnce":true,"onError":"continueRegularOutput"},{"parameters":{"mode":"combine","combineBy":"combineAll","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[2656,736],"id":"d72dd117-60e4-4470-a213-bcc5ac51d7f9","name":"Merge1"},{"parameters":{"batchSize":"=1","options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[2928,736],"id":"f492505c-2555-4673-8217-54aed429e686","name":"Loop Over Items1"},{"parameters":{"amount":"={{ 3 + Math.floor(Math.random() * 5) }}"},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[3168,752],"id":"bf2219aa-adc5-4e44-ac7b-b88bfeab730d","name":"Wait","webhookId":"6686e364-432c-466f-ac33-321c79f8a8a1"},{"parameters":{"resource":"messages-api","operation":"send-image","instanceName":"social-media-finamob-oficial","remoteJid":"120363418841788220@g.us","media":"={{ $json.base64Image }}","caption":"=Bom dia comunidade EMI!* üì∞\n\n{{ $('AI Agent1').item.json.output }}\n\nhttps://www.instagram.com/escoladomercadoimobiliario/","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[2656,976],"id":"4e142576-7560-470b-98a3-8500c1006618","name":"Envio do post - Comunidade Whatsapp","credentials":{"evolutionApi":{"id":"4JfTThlwBUF4KuNE","name":"Evolution - social-media-finamob-oficial"}},"disabled":true,"onError":"continueRegularOutput"},{"parameters":{"resource":"messages-api","operation":"send-image","instanceName":"social-media-finamob-oficial","remoteJid":"={{ $json.jid }}","media":"={{ $json.base64Image }}","caption":"=Oi , {{ $json.Nome }} tudo bem?\n\n{{ $('AI Agent1').item.json.output }}\n\nhttps://www.instagram.com/escoladomercadoimobiliario/\n\nSe n√£o quiser mais receber not√≠cias no seu celular responda essa mensagem com \"opt-out\".","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[3360,752],"id":"b2b96c13-fa19-42ce-9f13-147501590559","name":"Envio do Resumo","credentials":{"evolutionApi":{"id":"4JfTThlwBUF4KuNE","name":"Evolution - social-media-finamob-oficial"}},"onError":"continueRegularOutput"},{"parameters":{"url":"https://api.stripe.com/v1/subscriptions?status=active&price=price_1S1SraRuKlw6o0HgiTFNxo5L&expand[]=data.customer","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2000,512],"id":"acea0e35-9169-49d6-a75b-d4b6cebfa112","name":"HTTP Request","credentials":{"httpBasicAuth":{"id":"PVN6vyGsqfocZ4rZ","name":"Stripe"}}},{"parameters":{"jsCode":"// items[0].json √© o objeto \"list\" do Stripe com data=[...]\nconst list = items[0].json;\nconst subs = Array.isArray(list?.data) ? list.data : [];\nconst now = Math.floor(Date.now() / 1000);\n\n// Valida√ß√£o estrita de telefone BR -> E.164, sem completar DDD.\n// Aceita: \"+55\" + 10 ou 11 d√≠gitos, ou \"55\" + 10/11 d√≠gitos (sem +).\nfunction toE164StrictBR(raw) {\n  const s = String(raw || '').trim();\n  if (!s) return { e164: '', ok: false, motivo: 'sem_telefone' };\n\n  // \"+55\" + 10/11 d√≠gitos\n  if (/^\\+55\\d{10,11}$/.test(s)) return { e164: s, ok: true, motivo: '' };\n\n  // \"55\" + 10/11 d√≠gitos (sem \"+\")\n  if (/^55\\d{10,11}$/.test(s)) return { e164: `+${s}`, ok: true, motivo: '' };\n\n  // qualquer outra coisa = inv√°lido / possivelmente sem DDD\n  return { e164: '', ok: false, motivo: 'telefone_mal_formatado_ou_sem_ddd' };\n}\n\nconst out = [];\n\nfor (const s of subs) {\n  const c = s.customer || {};\n  const phone_raw = c.phone || c.metadata?.whatsapp || '';\n\n  const { e164: phone_e164, ok: phone_ok, motivo: motivoFone } = toE164StrictBR(phone_raw);\n\n  const status_stripe = s.status || '';\n  const cancel_at     = s.cancel_at || null;\n  const period_end    = s.current_period_end || null;\n  const paid_until    = period_end ? new Date(period_end * 1000).toISOString().slice(0, 10) : '';\n\n  // Ativo no Stripe (sem considerar telefone)\n  const stripeAtivo = (status_stripe === 'active') &&\n                      (!cancel_at) &&\n                      (!period_end || period_end >= now);\n\n  // Deriva√ß√£o do status_final\n  let status_final = 'inativo';\n  let motivo = '';\n\n  if (!phone_raw) {\n    status_final = 'validar';\n    motivo = 'sem_telefone';\n  } else if (!phone_ok) {\n    status_final = 'validar';\n    motivo = motivoFone; // mal formatado / sem DDD\n  } else if (stripeAtivo) {\n    status_final = 'ativo';\n  } else {\n    status_final = 'inativo';\n    motivo = status_stripe !== 'active' ? `status_${status_stripe}` :\n             cancel_at ? 'cancelado_ao_fim_do_ciclo' :\n             (period_end && period_end < now) ? 'periodo_vencido' : '';\n  }\n\n  out.push({\n    json: {\n      name: c.name || '',\n      email: c.email || '',\n      phone_raw,              // exatamente como veio do Stripe\n      phone_e164,             // s√≥ se v√°lido sem \"chute\"\n      stripe_customer_id: c.id || '',\n      stripe_subscription_id: s.id,\n      status_stripe,\n      cancel_at,\n      paid_until,\n      status_final,           // ativo | inativo | validar\n      motivo                  // ajuda a entender por que est√° \"validar\" ou \"inativo\"\n    }\n  });\n}\n\nreturn out;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2208,512],"id":"dceb8fa0-36e1-4499-ac3e-ff92113cb710","name":"Code4"},{"parameters":{"jsCode":"const COUNTRY = '55';\nconst onlyDigits = s => String(s ?? '').replace(/\\D/g, '').replace(/^0+/, '');\nconst toE164NoPlus = d => d ? (d.startsWith(COUNTRY) ? d : COUNTRY + d) : '';\nconst toJid = e164 => e164 ? `${e164}@s.whatsapp.net` : '';\n\nconst out = [];\nconst seen = new Set();\n\nfor (const { json } of items) {\n  // prioriza o j√° normalizado; cai para o bruto se precisar\n  const rawDigits = onlyDigits(json.phone_e164 || json.phone_raw);\n  if (!rawDigits) continue;\n\n  const e164 = toE164NoPlus(rawDigits); // sem sinal de +\n  if (!e164) continue;\n\n  if (seen.has(e164)) continue;\n  seen.add(e164);\n\n  const firstName = String(json.name || '').trim().split(/\\s+/)[0] || '';\n\n  out.push({\n    json: {\n      ...json,\n      e164,                  // ex: 5511999999999\n      jid: toJid(e164),      // ex: 5511999999999@s.whatsapp.net\n      firstName\n    }\n  });\n}\n\nreturn out;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2432,512],"id":"0cc7a436-a4b3-4992-992f-f16cf9e2bcc3","name":"Normalizar telefone e criar JID1"}],"connections":{"Schedule Trigger1":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Get row(s) in sheet","type":"main","index":0}]]},"Get row(s) in sheet":{"main":[[{"node":"Code1","type":"main","index":0}]]},"OpenRouter Chat Model1":{"ai_languageModel":[[{"node":"AI Agent1","type":"ai_languageModel","index":0}]]},"Code1":{"main":[[{"node":"AI Agent1","type":"main","index":0}]]},"Download file":{"main":[[{"node":"Code2","type":"main","index":0}]]},"Code2":{"main":[[{"node":"Merge1","type":"main","index":1},{"node":"HTTP Request","type":"main","index":0}]]},"AI Agent1":{"main":[[{"node":"Download file","type":"main","index":0}]]},"Merge1":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"Loop Over Items1":{"main":[[],[{"node":"Wait","type":"main","index":0}]]},"Wait":{"main":[[{"node":"Envio do Resumo","type":"main","index":0}]]},"Envio do Resumo":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"Code4","type":"main","index":0}]]},"Code4":{"main":[[{"node":"Normalizar telefone e criar JID1","type":"main","index":0}]]},"Normalizar telefone e criar JID1":{"main":[[{"node":"Merge1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","executionTimeout":-1,"errorWorkflow":"Cem9y3zmcggUQhrp"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]},"node:Google Sheets Trigger":{"documentId":"1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0","sheetId":0,"lastRevision":271,"lastRevisionLink":"https://docs.google.com/spreadsheets/export?id=1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0&revision=271&exportFormat=xlsx"},"node:Schedule Trigger1":{"recurrenceRules":[]},"node:Trigger nova noticia no sheets":{"documentId":"1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0","sheetId":0,"lastRevision":271,"lastRevisionLink":"https://docs.google.com/spreadsheets/export?id=1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0&revision=271&exportFormat=xlsx"}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"3e6b121e-df32-494b-ada4-fcb4f751d21e","triggerCount":1,"tags":[]}