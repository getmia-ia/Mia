{"createdAt":"2025-10-02T01:14:38.723Z","updatedAt":"2025-11-14T18:45:37.415Z","id":"SgANXIxy89SYLRHH","name":"BMS - 5.1 - Analise de Contrato","active":true,"isArchived":false,"nodes":[{"parameters":{"operation":"getAll","tableId":"contratos_analise","returnAll":true,"filters":{"conditions":[{"keyName":"analise_ia","condition":"is","keyValue":"null"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[272,-272],"id":"2809b388-f34a-4c5e-a2c5-f49d711e9044","name":"Get many rows","credentials":{"supabaseApi":{"id":"9FeQpCfKieI9F2Ms","name":"bms"}},"disabled":true},{"parameters":{"url":"={{ $('Webhook').item.json.body.arquivoUrl }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[848,0],"id":"b8137d83-df3b-4d0f-871e-cba10856adfb","name":"Download docx"},{"parameters":{"method":"POST","url":"https://api.cloudconvert.com/v2/jobs","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendBody":true,"specifyBody":"json","jsonBody":"{\n  \"tasks\": {\n    \"import-my-file\": {\n      \"operation\": \"import/upload\"\n    },\n    \"convert-my-file\": {\n      \"operation\": \"convert\",\n      \"input\": [\"import-my-file\"],\n      \"input_format\": \"docx\",\n      \"output_format\": \"txt\"\n    },\n    \"export-my-file\": {\n      \"operation\": \"export/url\",\n      \"input\": [\"convert-my-file\"]\n    }\n  }\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[608,16],"id":"02070c7e-c1b3-4b76-b8f0-026ed252efe4","name":"Cloud Convert 1","retryOnFail":true,"credentials":{"httpBearerAuth":{"id":"5SMBJ5YIlKBp5V2J","name":"cloudconvert"}}},{"parameters":{"method":"POST","url":"={{ $node[\"Cloud Convert 1\"].json[\"data\"][\"tasks\"][0][\"result\"][\"form\"][\"url\"] }}","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"acl","value":"={{ $node[\"Cloud Convert 1\"].json[\"data\"][\"tasks\"][0][\"result\"][\"form\"][\"parameters\"][\"acl\"] }}"},{"name":"key","value":"={{ $node[\"Cloud Convert 1\"].json[\"data\"][\"tasks\"][0][\"result\"][\"form\"][\"parameters\"][\"key\"] }}"},{"name":"success_action_status","value":"={{ $node[\"Cloud Convert 1\"].json[\"data\"][\"tasks\"][0][\"result\"][\"form\"][\"parameters\"][\"success_action_status\"] }}"},{"name":"X-Amz-Credential","value":"={{ $node[\"Cloud Convert 1\"].json[\"data\"][\"tasks\"][0][\"result\"][\"form\"][\"parameters\"][\"X-Amz-Credential\"] }}"},{"name":"X-Amz-Algorithm","value":"={{ $node[\"Cloud Convert 1\"].json[\"data\"][\"tasks\"][0][\"result\"][\"form\"][\"parameters\"][\"X-Amz-Algorithm\"] }}"},{"name":"X-Amz-Date","value":"={{ $node[\"Cloud Convert 1\"].json[\"data\"][\"tasks\"][0][\"result\"][\"form\"][\"parameters\"][\"X-Amz-Date\"] }}"},{"name":"Policy","value":"={{ $node[\"Cloud Convert 1\"].json[\"data\"][\"tasks\"][0][\"result\"][\"form\"][\"parameters\"][\"Policy\"] }}"},{"name":"X-Amz-Signature","value":"={{ $node[\"Cloud Convert 1\"].json[\"data\"][\"tasks\"][0][\"result\"][\"form\"][\"parameters\"][\"X-Amz-Signature\"] }}"},{"parameterType":"formBinaryData","name":"file","inputDataFieldName":"data"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[208,512],"id":"3366b618-ac20-43b7-9102-7b077dd6b0dd","name":"Cloud Convert 2","disabled":true},{"parameters":{"url":"=https://api.cloudconvert.com/v2/jobs/{{ $('Cloud Convert 1').item.json.data.id }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[416,512],"id":"e1fe20fd-7b7f-46fd-aa6c-5b7607aa37dc","name":"Cloud Convert 3","credentials":{"httpBearerAuth":{"id":"5SMBJ5YIlKBp5V2J","name":"cloudconvert"}},"disabled":true},{"parameters":{"url":"={{ $json[\"data\"][\"tasks\"][0][\"result\"][\"files\"][0][\"url\"] }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[896,496],"id":"9fd1deae-ea28-45f8-b332-1297259f4146","name":"Arquivo txt","disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c80cf2d7-1a7d-4105-9cce-94a5fdccf2f1","leftValue":"={{ $json[\"data\"][\"tasks\"].find(t => t.name === \"export-my-file\").status }}","rightValue":"finished","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[624,512],"id":"c69d590f-6fdf-4c16-a76a-defaf007d370","name":"If","disabled":true},{"parameters":{"amount":3},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[864,688],"id":"ce1c4922-d83b-4778-93b5-ddb1e417f8d5","name":"Wait","webhookId":"8d351566-c0ae-4e40-b2e4-875447ff5cd7","disabled":true},{"parameters":{"resource":"file","options":{"purpose":"assistants"}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[1040,0],"id":"a2b42365-db68-4e9e-b285-110c5a56b1db","name":"Upload a file","credentials":{"openAiApi":{"id":"GLHn0uXL8dRQAYuS","name":"OpenAi account"}}},{"parameters":{"method":"POST","url":"https://api.openai.com/v1/threads","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"OpenAI-Beta","value":"assistants=v2"}]},"sendBody":true,"specifyBody":"json","jsonBody":"{}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[400,16],"id":"3f2e2718-6b89-4e0e-b76b-6c27fd854f24","name":"Criar Thread","credentials":{"httpBearerAuth":{"id":"OnuV9uSBe5dFCABf","name":"OpenAI"}}},{"parameters":{"method":"POST","url":"=https://api.openai.com/v1/threads/{{ $('Criar Thread').item.json.id }}/messages","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"OpenAI-Beta","value":"assistants=v2"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"role\": \"user\",\n  \"content\": [\n    {\n      \"type\": \"text\",\n      \"text\": \"Analise o contrato anexado comparando com o modelo {{ $('Webhook').item.json.body.tipoDocumento }}. Identifique cada cl√°usula divergente e apresente o texto completo da cl√°usula no contrato modelo e no contrato do cliente. N√£o resuma ‚Äî reproduza integralmente as cl√°usulas e destaque as diferen√ßas entre elas, conforme o formato de relat√≥rio jur√≠dico j√° configurado no sistema.\"\n    }\n  ],\n  \"attachments\": [\n    {\n      \"file_id\": \"{{ $json.id }}\",\n      \"tools\": [\n        {\n          \"type\": \"file_search\"\n        }\n      ]\n    }\n  ]\n}\n","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1248,0],"id":"a1a1980c-0c7d-4417-b492-1f2c8dc0a2f8","name":"Adicionar docs na thread","credentials":{"httpBearerAuth":{"id":"OnuV9uSBe5dFCABf","name":"OpenAI"}}},{"parameters":{"method":"POST","url":"=https://api.openai.com/v1/threads/{{ $json.thread_id }}/runs","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"OpenAI-Beta","value":"assistants=v2"},{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"assistant_id\": \"asst_ni2gQtWvfl5nArr3CNYxY2ap\", \n  \"instructions\": \"Compare o contrato do cliente com o modelo do tipo {{ $('Webhook').item.json.body.tipoDocumento }}. IMPORTANTE: independentemente do nome, logotipo, empresa ou cabe√ßalho que apare√ßa no PDF do modelo, SEMPRE considere esse documento como o *modelo padr√£o oficial da BMS*. Ignore totalmente quaisquer refer√™ncias internas no PDF que indiquem outras empresas (como LEGALMIND, GILRAT, etc.). Ao gerar a compara√ß√£o, trate o modelo APENAS como 'Modelo Padr√£o BMS ‚Äì {{ $('Webhook').item.json.body.tipoDocumento }}'. Nunca utilize o nome encontrado dentro do PDF do modelo. Siga todas as instru√ß√µes do sistema j√° configuradas no assistant.\"\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1456,0],"id":"991b67df-5806-49fb-9e1a-58b10558fb1d","name":"Criar a run","credentials":{"httpBearerAuth":{"id":"OnuV9uSBe5dFCABf","name":"OpenAI"}}},{"parameters":{"url":"=https://api.openai.com/v1/threads/{{ $json.thread_id }}/runs/{{ $json.id }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"OpenAI-Beta","value":"assistants=v2"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1648,0],"id":"0180eed3-4244-4160-9504-dc1ae5aba8dc","name":"Status run","credentials":{"httpBearerAuth":{"id":"OnuV9uSBe5dFCABf","name":"OpenAI"}}},{"parameters":{"url":"=https://api.openai.com/v1/threads/{{ $json.thread_id }}/messages","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"OpenAI-Beta","value":"assistants=v2"},{"name":"Content-Type","value":"application/json"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2176,-16],"id":"e02068e2-a686-4b05-a717-1e3ed21e633a","name":"response openai","credentials":{"httpBearerAuth":{"id":"OnuV9uSBe5dFCABf","name":"OpenAI"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"0ce43a8e-fad6-4dbc-b0b3-cd5f2eb61703","leftValue":"={{ $json.status }}","rightValue":"completed","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1856,0],"id":"b3555196-34b3-4206-a10b-1a0fadf2084d","name":"If1"},{"parameters":{"amount":10},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[2176,208],"id":"0657c14e-98de-409d-ab31-ad9db8a9e1c3","name":"Wait1","webhookId":"0c2a1fad-219f-4ccc-b99b-d484cecd7aa6"},{"parameters":{"promptType":"define","text":"=**Voc√™ √© um assistente jur√≠dico especializado em an√°lise comparativa de contratos.**\nReceber√° um **JSON estruturado** com diverg√™ncias e riscos contratuais (produzido por outro agente).\nCada item cont√©m: tema, cl√°usula, trechos do contrato modelo e do cliente, severidade, impacto e refer√™ncias.\n\nRespeite o formato de Markdown com duas quebras de linha (\\n\\n) entre se√ß√µes, blocos e par√°grafos.\n\nCada campo (Cliente, Modelo, Coment√°rio, Severidade, etc.) deve sempre estar em linhas separadas.\n\nUse sempre o padr√£o de t√≠tulo e subt√≠tulo em Markdown (##, ###, **negrito**, > cita√ß√µes).\n\n    IMPORTANTE para tabelas markdown:\n\n        A linha separadora (com ---) deve ter pelo menos 3 h√≠fens por coluna\n        O n√∫mero de h√≠fens pode ser qualquer valor ‚â• 3, mas deve ter o mesmo n√∫mero de colunas que o cabe√ßalho\n        Mantenha o alinhamento visual das colunas usando espa√ßos\n\n### Input:\n\n{{ $json.data[0].content[0].text.value }}\n\nTRATAMENTO DO INPUT:\n- O texto recebido pode conter partes que N√ÉO fazem parte das diverg√™ncias estruturadas.\n- O assistente deve considerar como conte√∫do preservado somente os blocos que come√ßam em t√≠tulos de cl√°usulas (ex.: ‚Äú### 1.‚Äù, ‚Äú### 2.‚Äù, etc.) e terminam no fim da √∫ltima diverg√™ncia.\n- Ignore completamente:\n  ‚Ä¢ qualquer texto ANTES da primeira cl√°usula numerada (ex.: \"Segue o relat√≥rio jur√≠dico comparativo...\")\n  ‚Ä¢ qualquer texto DEPOIS da √∫ltima cl√°usula numerada (ex.: \"Caso deseje a an√°lise de outras cl√°usulas...\")\n- Preserve INTEGRALMENTE:\n  ‚Ä¢ t√≠tulos das cl√°usulas\n  ‚Ä¢ trechos do cliente\n  ‚Ä¢ trechos do modelo\n  ‚Ä¢ an√°lises DIFEREN√áA\n  ‚Ä¢ cita√ß√µes de arquivos (ex.: :contentReference[oaicite:1]{index=1})\n- N√ÉO modifique NADA nos blocos das diverg√™ncias.\n\n---\n\nVARI√ÅVEL DO MODELO: o tipo do modelo a ser tratado √© {{ $('Webhook').item.json.body.tipoDocumento }}.  \n- Se for `\"nda\"`: referencie sempre **\"Modelo Padr√£o BMS ‚Äì NDA\"** como o modelo.  \n- Se for `\"gilrat\"`: referencie sempre **\"Modelo Padr√£o BMS ‚Äì GILRAT\"**.  \n\n---\n\nPRINC√çPIOS ABSOLUTOS (n√£o negoci√°veis)\n1. **Preserva√ß√£o integral** ‚Äî N√£o modifique, resuma, corte ou reescreva os trechos das cl√°usulas fornecidos na entrada. Reproduza todos os blocos de cl√°usulas *na √≠ntegra* quando for necess√°rio exibi-los.  \n2. **N√£o inventar** ‚Äî N√£o crie cl√°usulas, fatos, n√∫meros, nomes, percentuais, ou refer√™ncias que n√£o estejam na entrada. Se algo faltar, marque como **INCONCLUSIVO** e explique o que falta.  \n3. **N√£o reordenar** ‚Äî Mantenha a ordem original das diverg√™ncias/t√≠tulos do relat√≥rio de entrada.  \n4. **Fontes** ‚Äî Use apenas o conte√∫do que veio na entrada.\n---\n\nRESTRI√á√ÉO ABSOLUTA CONTRA CORTE DE TEXTO\n\nA se√ß√£o de diverg√™ncias pode ser longa. Portanto:\n\nATEN√á√ÉO ‚Äî PRODU√á√ÉO DE TEXTO OBRIGAT√ìRIA:\n\nSe o conte√∫do exceder o limite interno de gera√ß√£o,\ncontinue automaticamente a resposta at√© copiar 100% das diverg√™ncias do input.\n\nN√ÉO pe√ßa autoriza√ß√£o.\n\nN√ÉO resuma.\n\nN√ÉO substitua por retic√™ncias.\n\nA resposta s√≥ termina quando todas as diverg√™ncias forem copiadas integralmente.\n\n---\n\nOBJETIVO (o que deve sair)\n- Produza um documento que **seja essencialmente o mesmo relat√≥rio recebido**, mas **enriquecido** com uma an√°lise cr√≠tica e visual para facilitar a leitura do time jur√≠dico.  \n- A sa√≠da deve come√ßar **exatamente** com a Introdu√ß√£o / Resumo Executivo Aten√ß√£o:\nO conte√∫do fornecido na entrada corresponde apenas √† an√°lise de diverg√™ncias\nproduzida pelo agente anterior. Ele N√ÉO cont√©m introdu√ß√£o, resumo executivo\nou se√ß√£o de riscos cr√≠ticos.\n\nPortanto:\n\n1. Voc√™ deve PRESERVAR integralmente o conte√∫do recebido, na ordem exata.\n2. Esse conte√∫do preservado dever√° ser tratado como a se√ß√£o:\n   ‚Äúüìö Diverg√™ncias (narrativas ‚Äî an√°lise cr√≠tica)‚Äù.\n3. Voc√™ DEVE obrigatoriamente adicionar\n   (nesta ordem):\n   - üìö Diverg√™ncias (narrativas ‚Äî an√°lise cr√≠tica):\n   NESSA SESS√ÉO REPRODUZA INTEGRALMENTE o conte√∫do do input correspondente √†s diverg√™ncias (blocos que come√ßam em ‚Äú### 1.‚Äù, ‚Äú### 2.‚Äù, etc.), sem qualquer modifica√ß√£o. \nN√£o resuma, n√£o reescreva, n√£o remova as cita√ß√µes de arquivo, n√£o traduza e n√£o substitua por \"...\".\n\nEsse conte√∫do deve ser exibido exatamente como recebido, preservando:\n- t√≠tulos\n- trechos do Cliente (em blockquote)\n- trechos do Modelo Padr√£o BMS (em blockquote)\n- blocos \"DIFEREN√áA:\"\n- file citations (ex.: :contentReference[oaicite:2]{index=2})\n- quebras de linha\n\nN√£o inclua textos que venham ANTES da primeira cl√°usula numerada ou DEPOIS da √∫ltima.\n\n   - üìä Tabelas (resumo visual): Crie **uma tabela Markdown** que resuma, por linha, as diverg√™ncias mais relevantes (m√°x. 10 linhas ‚Äî priorize por severidade). Colunas recomendadas: **Tema | Contrato (trecho resumido de at√© 20 palavras) | Modelo (trecho resumido de at√© 20 palavras) | Severidade | Impacto | Observa√ß√£o r√°pida**.  \n**Aten√ß√£o:** os resumos linha devem ser par√°frases curtas do que j√° consta na entrada ‚Äî **n√£o invente n√∫meros**. Se um valor num√©rico aparece na entrada, transcreva-o exatamente.\n\nEssas se√ß√µes sintetizam, analisam e reorganizam VISUALMENTE as diverg√™ncias j√°\npresentes no relat√≥rio da entrada, sem criar fatos novos.\n\n---  \n## Regras de formato e finaliza√ß√£o\n- Preserve as quebras duplas `\\n\\n` entre se√ß√µes.  \n- Use t√≠tulos em Markdown (##, ###) exatamente como acima.  \n- Mantenha todas as cita√ß√µes de arquivos (file citations) tal como vieram.  \n- No final coloque a linha:  \n  `> *Este relat√≥rio tem car√°ter informativo e n√£o substitui consulta jur√≠dica individualizada.*`\n- IMPORTANTE:\nA se√ß√£o ‚Äúüìö Diverg√™ncias (narrativas ‚Äî an√°lise cr√≠tica)‚Äù √© a parte PRINCIPAL e PRIORIT√ÅRIA do relat√≥rio.\n\nEla deve sempre vir COMPLETA antes de qualquer outra se√ß√£o.\nNenhuma outra se√ß√£o deve reduzir, limitar ou substituir o conte√∫do desta parte.\n- Se o conte√∫do exceder o limite interno de gera√ß√£o, voc√™ deve automaticamente CONTINUAR a resposta at√© completar 100% do conte√∫do original, sem pedir autoriza√ß√£o.\n- N√ÉO resumir, N√ÉO omitir, N√ÉO cortar\n- A resposta s√≥ termina ap√≥s a √∫ltima linha da nota final\n---  \n\nRESTRI√á√ÉO ABSOLUTA CONTRA CORTE:\n- Se durante a gera√ß√£o ocorrer **qualquer** interrup√ß√£o por limite de tokens, voc√™ DEVE retomar automaticamente **na mesma resposta** (sem pedir autoriza√ß√£o) e continuar copiando **exatamente** do ponto onde parou at√© que **100% do conte√∫do preservado** e **100% do checklist** estejam conclu√≠dos.\n- Para sinalizar retomada, insira o marcador `---CONTINUA√á√ÉO AUTOM√ÅTICA---` no in√≠cio da continua√ß√£o; continue a reprodu√ß√£o literal sem qualquer modifica√ß√£o.\n- **N√£o** substitua por retic√™ncias, nem resuma. A resposta s√≥ termina quando todo o conte√∫do preservado + as se√ß√µes adicionais estiverem completas.\n\nCONFIGURA√á√ÉO RECOMENDADA PARA A CHAMADA DO MODELO:\n- `temperature: 0`  \n- `top_p: 1`  \n- `max_tokens`: o m√°ximo permitido para o modelo\n- `stop`: nenhum stop token (ou vazio)\n\n","options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[2416,-16],"id":"3b8332d7-9e03-410e-acb5-630e2b42afd3","name":"AI Agent"},{"parameters":{"model":"openai/gpt-4o","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[2416,160],"id":"f3029111-cf74-49e6-b515-a4683091c0d7","name":"OpenRouter Chat Model","credentials":{"openRouterApi":{"id":"o1ywdYlH64cgqSMT","name":"OpenRouter account"}}},{"parameters":{"operation":"update","tableId":"contratos_analise","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $('Webhook').first().json.body.contratoId }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"analise_ia","fieldValue":"={{ $('AI Agent').first().json.output }}"},{"fieldId":"url_download_word","fieldValue":"={{ $json.pdf }}"},{"fieldId":"status","fieldValue":"concluido"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[3232,-16],"id":"47c3a720-20cd-48e8-9b62-a949d786943d","name":"Update Supabase","credentials":{"supabaseApi":{"id":"9FeQpCfKieI9F2Ms","name":"bms"}}},{"parameters":{"jsCode":"// Converte o texto em Markdown que chega em $json.output para HTML b√°sico\n// Sa√≠da: { html: \"<!doctype html>... </html>\" }\n\nconst md = ($json.output ?? '').toString();\n\n// 1) Escapa HTML bruto para evitar quebras\nfunction escapeHtml(s) {\n  return s.replace(/&/g, '&amp;')\n          .replace(/</g, '&lt;')\n          .replace(/>/g, '&gt;');\n}\nlet html = escapeHtml(md);\n\n// 2) T√≠tulos (#, ##, ### ...)\nhtml = html\n  .replace(/^###### (.*)$/gm, '<h6>$1</h6>')\n  .replace(/^##### (.*)$/gm, '<h5>$1</h5>')\n  .replace(/^#### (.*)$/gm,  '<h4>$1</h4>')\n  .replace(/^### (.*)$/gm,   '<h3>$1</h3>')\n  .replace(/^## (.*)$/gm,    '<h2>$1</h2>')\n  .replace(/^# (.*)$/gm,     '<h1>$1</h1>');\n\n// 3) Negrito e it√°lico (**texto**, *texto*)\nhtml = html\n  .replace(/\\*\\*(.+?)\\*\\*/g, '<strong>$1</strong>')\n  // it√°lico com cuidado para n√£o pegar * em listas\n  .replace(/(^|[\\s(])\\*(?!\\s)(.+?)(?<!\\s)\\*(?=[\\s).,;:!?]|$)/g, '$1<em>$2</em>');\n\n// 4) Constr√≥i listas e par√°grafos\nconst lines = html.split(/\\r?\\n/);\nlet out = [];\nlet inUl = false, inOl = false;\n\nfunction closeLists() {\n  if (inUl) { out.push('</ul>'); inUl = false; }\n  if (inOl) { out.push('</ol>'); inOl = false; }\n}\n\nfor (const line of lines) {\n  let m;\n  if ((m = line.match(/^\\s*[-‚Ä¢*]\\s+(.*)$/))) {\n    if (inOl) { out.push('</ol>'); inOl = false; }\n    if (!inUl) { out.push('<ul>'); inUl = true; }\n    out.push(`<li>${m[1]}</li>`);\n  } else if ((m = line.match(/^\\s*\\d+\\.\\s+(.*)$/))) {\n    if (inUl) { out.push('</ul>'); inUl = false; }\n    if (!inOl) { out.push('<ol>'); inOl = true; }\n    out.push(`<li>${m[1]}</li>`);\n  } else {\n    closeLists();\n    if (line.trim() === '') {\n      out.push('<br/>');\n    } else {\n      out.push(`<p>${line}</p>`);\n    }\n  }\n}\ncloseLists();\n\nconst body = out.join('\\n');\n\n// 5) HTML final com estilo simples (bom para convers√£o a DOCX)\nconst fullHtml = `<!doctype html>\n<html lang=\"pt-BR\">\n<head>\n  <meta charset=\"utf-8\">\n  <style>\n    body{font-family: Arial, Helvetica, sans-serif; line-height:1.38; color:#111; margin:24px;}\n    h1{font-size:20pt;margin:0 0 8px} h2{font-size:16pt;margin:16px 0 6px} h3{font-size:13pt;margin:14px 0 6px}\n    h4,h5,h6{margin:12px 0 6px}\n    p{margin:6px 0}\n    ul,ol{margin:6px 0 12px 22px} li{margin:2px 0}\n    strong{font-weight:700} em{font-style:italic}\n    table{border-collapse:collapse;margin:8px 0;width:100%}\n    th,td{border:1px solid #ccc;padding:6px;vertical-align:top}\n  </style>\n</head>\n<body>\n${body}\n</body>\n</html>`;\n\nreturn [{ json: { html: fullHtml } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2784,-16],"id":"d280bb6f-aa91-4e7c-abd2-68e64f103848","name":"Code"},{"parameters":{"method":"POST","url":"https://v2.api2pdf.com/chrome/html","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"bodyParameters":{"parameters":[{"name":"html","value":"={{ $json.html }}"},{"name":"inlinePdf","value":"false"}]},"options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2992,-16],"id":"ce0ba2bb-5c6c-4782-8d9c-bd3ee686f5bb","name":"Convert PDF - api2pdf","credentials":{"httpHeaderAuth":{"id":"7eI6uGOUWvQGoTTl","name":"api2pdf"}}},{"parameters":{"httpMethod":"POST","path":"analise-de-contrato","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[160,16],"id":"d9fba96e-b59b-4b0f-91da-d48ef179cb11","name":"Webhook","webhookId":"2cd7bf52-87fb-43d1-be9d-8fd115885e32"},{"parameters":{"method":"POST","url":"https://xqyxalqwsxqndjetgzry.supabase.co/functions/v1/webhook-n8n-defesas","authentication":"predefinedCredentialType","nodeCredentialType":"supabaseApi","sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"defensaId\": \"{{ $json.defensaId }}\",\n  \"erro\": \"{{ $json.erro }}\"\n}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[784,208],"id":"df8af228-b128-4b56-9269-15ed369a9fa6","name":"Informa o supabase que deu erro na requisi√ß√£o de uma defesa5","credentials":{"supabaseApi":{"id":"9FeQpCfKieI9F2Ms","name":"bms"}}},{"parameters":{"jsCode":"// N√≥ Code para limpar e formatar os dados de erro\nconst contratoId = $('Webhook').first().json.body.contratoId;\nlet erro = $json.erro || $input.first().json.erro || 'Erro desconhecido';\n\n// Remove aspas problem√°ticas e limpa o texto do erro\nerro = erro.toString()\n  .replace(/\"/g, \"'\")  // Substitui aspas duplas por simples\n  .replace(/{/g, '[')  // Substitui chaves se necess√°rio\n  .replace(/}/g, ']')\n  .substring(0, 1000); // Limita o tamanho se for muito longo\n\nreturn [\n  {\n    json: {\n      contratoId: contratoId,\n      erro: erro,\n      workflow: \"BMS - 6.1 - Analise de Contrato\",\n      node: \"Upload\"\n    }\n  }\n];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[624,208],"id":"a325d304-67e0-4d34-8f31-5e737c311d9b","name":"Code5","disabled":true}],"connections":{"Get many rows":{"main":[[]]},"Download docx":{"main":[[{"node":"Upload a file","type":"main","index":0}]]},"Cloud Convert 1":{"main":[[{"node":"Download docx","type":"main","index":0}],[]]},"Cloud Convert 2":{"main":[[{"node":"Cloud Convert 3","type":"main","index":0}]]},"Cloud Convert 3":{"main":[[{"node":"If","type":"main","index":0}]]},"If":{"main":[[{"node":"Arquivo txt","type":"main","index":0}],[{"node":"Wait","type":"main","index":0}]]},"Wait":{"main":[[{"node":"Cloud Convert 3","type":"main","index":0}]]},"Arquivo txt":{"main":[[]]},"Upload a file":{"main":[[{"node":"Adicionar docs na thread","type":"main","index":0}]]},"Criar Thread":{"main":[[{"node":"Cloud Convert 1","type":"main","index":0}]]},"Adicionar docs na thread":{"main":[[{"node":"Criar a run","type":"main","index":0}]]},"Criar a run":{"main":[[{"node":"Status run","type":"main","index":0}]]},"Status run":{"main":[[{"node":"If1","type":"main","index":0}]]},"If1":{"main":[[{"node":"response openai","type":"main","index":0}],[{"node":"Wait1","type":"main","index":0}]]},"Wait1":{"main":[[{"node":"Status run","type":"main","index":0}]]},"response openai":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"OpenRouter Chat Model":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"AI Agent":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Convert PDF - api2pdf","type":"main","index":0}]]},"Convert PDF - api2pdf":{"main":[[{"node":"Update Supabase","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"Criar Thread","type":"main","index":0}]]},"Code5":{"main":[[{"node":"Informa o supabase que deu erro na requisi√ß√£o de uma defesa5","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"GbORhS24Rzw7hHlt"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{"Get many rows":[{"json":{"id":"55013e04-f455-4218-b4c8-e73ecdc93cc5","user_id":"64c5ed3a-8526-4261-8ecc-10d3e0cd10ab","arquivo_url":"https://xqyxalqwsxqndjetgzry.supabase.co/storage/v1/object/sign/contratos/64c5ed3a-8526-4261-8ecc-10d3e0cd10ab/1763053672966_NDA%20-%20SANKHYA%20JIVA%20TECNOLOGIA%20E%20INOVACAO%20LTDA.docx?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV83NDlmNGU5My0zMGY1LTQwNzctYTFmZi1mNTE4MzE0M2NlYTIiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJjb250cmF0b3MvNjRjNWVkM2EtODUyNi00MjYxLThlY2MtMTBkM2UwY2QxMGFiLzE3NjMwNTM2NzI5NjZfTkRBIC0gU0FOS0hZQSBKSVZBIFRFQ05PTE9HSUEgRSBJTk9WQUNBTyBMVERBLmRvY3giLCJpYXQiOjE3NjMwNTM3MTgsImV4cCI6MTc2MzY1ODUxOH0.vtMD7s42p_DrbwLKB_GIPPrwj6bY_pedD-lmNl2Tkgk","nome_arquivo":"NDA - SANKHYA JIVA TECNOLOGIA E INOVACAO LTDA.docx","tipo_documento":"NDA","analise_ia":null,"url_download_word":null,"created_at":"2025-11-13T17:08:38.948218+00:00","updated_at":"2025-11-13T17:08:39.539315+00:00","status":"processando","erro_mensagem":null}},{"json":{"id":"8caac189-0ca3-416f-9331-ce8b9b85b7df","user_id":"64c5ed3a-8526-4261-8ecc-10d3e0cd10ab","arquivo_url":"https://xqyxalqwsxqndjetgzry.supabase.co/storage/v1/object/sign/contratos/64c5ed3a-8526-4261-8ecc-10d3e0cd10ab/1763049192363_NDA%20-%20SANKHYA%20JIVA%20TECNOLOGIA%20E%20INOVACAO%20LTDA.docx?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV83NDlmNGU5My0zMGY1LTQwNzctYTFmZi1mNTE4MzE0M2NlYTIiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJjb250cmF0b3MvNjRjNWVkM2EtODUyNi00MjYxLThlY2MtMTBkM2UwY2QxMGFiLzE3NjMwNDkxOTIzNjNfTkRBIC0gU0FOS0hZQSBKSVZBIFRFQ05PTE9HSUEgRSBJTk9WQUNBTyBMVERBLmRvY3giLCJpYXQiOjE3NjMwNDkyMzcsImV4cCI6MTc2MzY1NDAzN30.Z9KQS7YrGurBcWKrTsKdRvA8xxeyzqSC0PcnRmZ28Mg","nome_arquivo":"NDA - SANKHYA JIVA TECNOLOGIA E INOVACAO LTDA.docx","tipo_documento":"NDA","analise_ia":null,"url_download_word":null,"created_at":"2025-11-13T15:53:57.939346+00:00","updated_at":"2025-11-13T15:53:58.671644+00:00","status":"processando","erro_mensagem":null}}]},"versionId":"cdf21111-8590-4c19-bffa-5f3a9b275eb2","triggerCount":1,"tags":[]}