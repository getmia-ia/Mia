{"createdAt":"2025-10-13T20:13:59.908Z","updatedAt":"2025-10-14T17:40:34.844Z","id":"icgKsILXtYBIwRcq","name":"Finamob - 1.4 - Journal - Resumo Diário","active":true,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"weeks","triggerAtDay":[2,3,4,5,6,0],"triggerAtHour":8}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-480,48],"id":"5f634fa2-812e-48cc-8616-1610e8dec8ff","name":"Schedule Trigger1"},{"parameters":{"documentId":{"__rl":true,"value":"1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0","mode":"list","cachedResultName":"Finamob - Controle Journal","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"data_processamento","lookupValue":"={{ $json.data_processamento }}"},{"lookupColumn":"status","lookupValue":"postado"}]},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[-64,48],"id":"df3b5d76-85c5-47aa-8568-c0d613c0573c","name":"Get row(s) in sheet","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"jsCode":"const ontem = new Date();\nontem.setDate(ontem.getDate() - 1);\n\nconst dia = String(ontem.getDate()).padStart(2, '0');\nconst mes = String(ontem.getMonth() + 1).padStart(2, '0');\nconst ano = ontem.getFullYear();\n\nreturn {\n  data_processamento: `${dia}/${mes}/${ano}`\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-272,48],"id":"09cb6e36-c0dd-4297-9e75-6f61935e819c","name":"Code"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[368,272],"id":"125c8c03-c90d-478d-a750-4850e734ea5d","name":"OpenRouter Chat Model1","credentials":{"openRouterApi":{"id":"o1ywdYlH64cgqSMT","name":"OpenRouter account"}}},{"parameters":{"jsCode":"const items = $input.all();\nif (!items.length) {\n  return [{ json: { prompt: \"Nenhuma notícia foi processada.\" } }];\n}\n\nconst data = items[0]?.json?.data_processamento || \"DATA_NÃO_ENCONTRADA\";\n\n// Contexto curto para guiar o modelo (sem ficar gigantesco)\nconst MAX = 500;\nconst cut = s => (s || '').trim().slice(0, MAX);\nconst contexto = items.map(it => `• ${(it.json.titulo||'').trim()}\\n${cut(it.json.legenda)}`).join(\"\\n\\n\");\n\n// Linhas FIXAS (não alterar)\nconst header1 = ``;\nconst header2 = `Segue resumo de notícias do dia *${data}*:\\n\\n`;\nconst header3 = `Acompanhe a nossa página no Instagram:\\nhttps://www.instagram.com/escoladomercadoimobiliario\\n\\n`;\n\nconst prompt = `\nVocê é editor do briefing matinal da comunidade EMI (WhatsApp).\nProduza UMA mensagem concisa, didática e **visual**, com base nas notícias de *${data}*.\nNão liste notícia por notícia. Não inclua links (além do Instagram já fornecido). Não invente fatos.\n\nBASE (referência; não copie literalmente):\n${contexto}\n\nFORMATO EXATO DA SAÍDA (mantenha as linhas fixas e a ordem):\n${header1}${header2}${header3}[RESUMO CONECTADO EM BLOCOS]\n- Estruture em **2 a 3 blocos**, cada um com **título em negrito + emoji** \n- Cada bloco deve ter **2 a 3 frases curtas**, explicando *o que aconteceu* e *por que importa para o corretor*.\n- Use **1 emoji no título**. Separe os blocos com uma linha em branco.\n\n*Como isso impacta para o incorporador?:*\n\n- Escreva entre 1 e 2 paragrafos sobre como essas noticias impactam a vida do incorporador\n\n*Manchetes do dia:*\n- coloque em listas com emoji de 1️⃣,2️⃣, etc..\n\nREGRAS:\n- PT-BR, claro e objetivo; sem jargão.\n- Priorize números/dados quando existirem; se faltarem, não invente.\n- Não adicione seções além das especificadas.\n`.trim();\n\nreturn [{ json: { prompt } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[144,48],"id":"ef9951e6-29db-495f-a2de-f8cb93eceff7","name":"Code1"},{"parameters":{"content":"# Fluxo de Envio do Resumo Diário para comunidade Whatsapp\n### Esse fluxo roda todo dia de manhã as 08am\n### Envia um resumo das notícias processadas no dia anterior","height":752,"width":3152,"color":3},"type":"n8n-nodes-base.stickyNote","position":[-544,-288],"typeVersion":1,"id":"a9a12853-9af2-4e30-a267-2567e737478f","name":"Sticky Note15"},{"parameters":{"operation":"download","fileId":{"__rl":true,"value":"19P4-Hrzc6ZaMUsfnC5fTT4uoduwGXGdt","mode":"id"},"options":{}},"type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[688,48],"id":"5049fc94-c70a-48ab-acc2-3d3dd9a06415","name":"Download file","credentials":{"googleDriveOAuth2Api":{"id":"ZkmaJh5Y8Zdz8ju7","name":"Google Drive - lucas@getmia.com.br"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// n8n Code node – pega o base64 do arquivo baixado no \"Download file\"\n\nconst binAll = $input.item.binary || {};\n\n// tenta 'imagem_final', depois 'data', depois a 1ª chave disponível\nconst key =\n  binAll.imagem_final ? 'imagem_final' :\n  (binAll.data ? 'data' : Object.keys(binAll)[0]);\n\nif (!key) throw new Error('Nenhum binário encontrado no item.');\n\nconst bin = binAll[key];\nif (!bin?.data) throw new Error(`Binário na chave \"${key}\" não possui .data.`);\n\n// já vem em base64; não reconverta\nconst base64 = bin.data;\n\nreturn {\n  json: {\n    base64Image: base64,                          // use isto no Evolution (media)\n    mimeType: bin.mimeType || 'application/octet-stream',\n    fileName: bin.fileName || 'arquivo'\n  }\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[880,48],"id":"46dd50c9-34ae-4637-a7a3-083e56e8b1f8","name":"Code2"},{"parameters":{"promptType":"define","text":"={{ $json.prompt }}","options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[368,48],"id":"f9db915a-364e-4504-b5ed-0c42534b7718","name":"AI Agent1","executeOnce":true,"onError":"continueRegularOutput"},{"parameters":{"mode":"combine","combineBy":"combineAll","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[1728,32],"id":"397cc568-747b-44de-9ddc-f0283a0b788c","name":"Merge1"},{"parameters":{"batchSize":"=1","options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[2000,32],"id":"b53eba2d-ef2d-46b9-b812-268216ffa83e","name":"Loop Over Items1"},{"parameters":{"amount":"={{ 3 + Math.floor(Math.random() * 5) }}"},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[2240,48],"id":"947ae618-a751-427d-9a61-834e419eb900","name":"Wait","webhookId":"6686e364-432c-466f-ac33-321c79f8a8a1"},{"parameters":{"options_Create_instance":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1728,272],"id":"584e3d9b-92ed-4730-8670-e58cf088ac4b","name":"Envio do post - Comunidade Whatsapp","disabled":true,"onError":"continueRegularOutput"},{"parameters":{"resource":"messages-api","operation":"send-image","instanceName":"social-media-finamob-oficial","remoteJid":"={{ $json.phone_raw }}","media":"={{ $json.base64Image }}","caption":"={{ $('Download file').item.json.output }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[2432,48],"id":"e1fcaf40-20f2-462b-ae97-c428d2994dc1","name":"Envio do Resumo","credentials":{"evolutionApi":{"id":"4JfTThlwBUF4KuNE","name":"Evolution - social-media-finamob-oficial"}},"onError":"continueRegularOutput"},{"parameters":{"url":"https://api.stripe.com/v1/subscriptions?status=active&price=price_1S1SraRuKlw6o0HgiTFNxo5L&expand[]=data.customer","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1072,-192],"id":"a4dd04b6-8649-401e-bb28-840230e46377","name":"HTTP Request","credentials":{"httpBasicAuth":{"id":"PVN6vyGsqfocZ4rZ","name":"Stripe"}}},{"parameters":{"jsCode":"// items[0].json é o objeto \"list\" do Stripe com data=[...]\nconst list = items[0].json;\nconst subs = Array.isArray(list?.data) ? list.data : [];\nconst now = Math.floor(Date.now() / 1000);\n\n// Validação estrita de telefone BR -> E.164, sem completar DDD.\n// Aceita: \"+55\" + 10 ou 11 dígitos, ou \"55\" + 10/11 dígitos (sem +).\nfunction toE164StrictBR(raw) {\n  const s = String(raw || '').trim();\n  if (!s) return { e164: '', ok: false, motivo: 'sem_telefone' };\n\n  // \"+55\" + 10/11 dígitos\n  if (/^\\+55\\d{10,11}$/.test(s)) return { e164: s, ok: true, motivo: '' };\n\n  // \"55\" + 10/11 dígitos (sem \"+\")\n  if (/^55\\d{10,11}$/.test(s)) return { e164: `+${s}`, ok: true, motivo: '' };\n\n  // qualquer outra coisa = inválido / possivelmente sem DDD\n  return { e164: '', ok: false, motivo: 'telefone_mal_formatado_ou_sem_ddd' };\n}\n\nconst out = [];\n\nfor (const s of subs) {\n  const c = s.customer || {};\n  const phone_raw = c.phone || c.metadata?.whatsapp || '';\n\n  const { e164: phone_e164, ok: phone_ok, motivo: motivoFone } = toE164StrictBR(phone_raw);\n\n  const status_stripe = s.status || '';\n  const cancel_at     = s.cancel_at || null;\n  const period_end    = s.current_period_end || null;\n  const paid_until    = period_end ? new Date(period_end * 1000).toISOString().slice(0, 10) : '';\n\n  // Ativo no Stripe (sem considerar telefone)\n  const stripeAtivo = (status_stripe === 'active') &&\n                      (!cancel_at) &&\n                      (!period_end || period_end >= now);\n\n  // Derivação do status_final\n  let status_final = 'inativo';\n  let motivo = '';\n\n  if (!phone_raw) {\n    status_final = 'validar';\n    motivo = 'sem_telefone';\n  } else if (!phone_ok) {\n    status_final = 'validar';\n    motivo = motivoFone; // mal formatado / sem DDD\n  } else if (stripeAtivo) {\n    status_final = 'ativo';\n  } else {\n    status_final = 'inativo';\n    motivo = status_stripe !== 'active' ? `status_${status_stripe}` :\n             cancel_at ? 'cancelado_ao_fim_do_ciclo' :\n             (period_end && period_end < now) ? 'periodo_vencido' : '';\n  }\n\n  out.push({\n    json: {\n      name: c.name || '',\n      email: c.email || '',\n      phone_raw,              // exatamente como veio do Stripe\n      phone_e164,             // só se válido sem \"chute\"\n      stripe_customer_id: c.id || '',\n      stripe_subscription_id: s.id,\n      status_stripe,\n      cancel_at,\n      paid_until,\n      status_final,           // ativo | inativo | validar\n      motivo                  // ajuda a entender por que está \"validar\" ou \"inativo\"\n    }\n  });\n}\n\nreturn out;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1280,-192],"id":"26538a2e-a61b-4d13-b7f3-bb6137150514","name":"Code4"},{"parameters":{"jsCode":"const COUNTRY = '55';\nconst onlyDigits = s => String(s ?? '').replace(/\\D/g, '').replace(/^0+/, '');\nconst toE164NoPlus = d => d ? (d.startsWith(COUNTRY) ? d : COUNTRY + d) : '';\nconst toJid = e164 => e164 ? `${e164}@s.whatsapp.net` : '';\n\nconst out = [];\nconst seen = new Set();\n\nfor (const { json } of items) {\n  // prioriza o já normalizado; cai para o bruto se precisar\n  const rawDigits = onlyDigits(json.phone_e164 || json.phone_raw);\n  if (!rawDigits) continue;\n\n  const e164 = toE164NoPlus(rawDigits); // sem sinal de +\n  if (!e164) continue;\n\n  if (seen.has(e164)) continue;\n  seen.add(e164);\n\n  const firstName = String(json.name || '').trim().split(/\\s+/)[0] || '';\n\n  out.push({\n    json: {\n      ...json,\n      e164,                  // ex: 5511999999999\n      jid: toJid(e164),      // ex: 5511999999999@s.whatsapp.net\n      firstName\n    }\n  });\n}\n\nreturn out;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1504,-192],"id":"fe694ab4-0658-40b3-8a0b-50c566608ded","name":"Normalizar telefone e criar JID1"}],"connections":{"Schedule Trigger1":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Get row(s) in sheet","type":"main","index":0}]]},"Get row(s) in sheet":{"main":[[{"node":"Code1","type":"main","index":0}]]},"OpenRouter Chat Model1":{"ai_languageModel":[[{"node":"AI Agent1","type":"ai_languageModel","index":0}]]},"Code1":{"main":[[{"node":"AI Agent1","type":"main","index":0}]]},"Download file":{"main":[[{"node":"Code2","type":"main","index":0}]]},"Code2":{"main":[[{"node":"HTTP Request","type":"main","index":0},{"node":"Merge1","type":"main","index":1}]]},"AI Agent1":{"main":[[{"node":"Download file","type":"main","index":0}]]},"Merge1":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"Loop Over Items1":{"main":[[],[{"node":"Wait","type":"main","index":0}]]},"Wait":{"main":[[{"node":"Envio do Resumo","type":"main","index":0}]]},"Envio do Resumo":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"Code4","type":"main","index":0}]]},"Code4":{"main":[[{"node":"Normalizar telefone e criar JID1","type":"main","index":0}]]},"Normalizar telefone e criar JID1":{"main":[[{"node":"Merge1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"Cem9y3zmcggUQhrp"},"staticData":{"node:Schedule Trigger1":{"recurrenceRules":[]}},"meta":null,"pinData":{},"versionId":"bdd1defc-29d8-4a38-b0a5-7c0c4ab9ef1d","triggerCount":1,"tags":[]}