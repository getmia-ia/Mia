{"createdAt":"2025-10-22T16:52:17.136Z","updatedAt":"2025-10-23T17:51:13.586Z","id":"lqDWYmLeXmJ6jNA3","name":"BMS - 4.2- Disparo Eventos","active":false,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":10}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-768,2992],"id":"50778925-c902-4ad8-a1a7-673d73a385a2","name":"Schedule Trigger1"},{"parameters":{"operation":"getAll","tableId":"disparos","returnAll":true,"filters":{"conditions":[{"keyName":"status","condition":"eq","keyValue":"agendado"},{"keyName":"status","condition":"eq","keyValue":"convidado"},{"keyName":"status","condition":"eq","keyValue":"aprovado"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-448,2992],"id":"1fb6d7db-76d3-446b-b4e7-fc67bb6308a7","name":"Busca Todos Disparos Elegíveis","credentials":{"supabaseApi":{"id":"9FeQpCfKieI9F2Ms","name":"bms"}}},{"parameters":{"jsCode":"const now = new Date();\n\nreturn items.flatMap(disparo => {\n  const status = disparo.json.status;\n  const numeroDisparo = disparo.json.qtd_disparo || 0;\n  const ultimoDisparo = disparo.json.ultimo_disparo_em ? new Date(disparo.json.ultimo_disparo_em) : null;\n  const dataEvento = disparo.json.data_evento ? new Date(disparo.json.data_evento) : null;\n  const confirmado = disparo.json.confirmado === 'sim';\n  \n  let deveDisparar = false;\n  let tipoDisparo = '';\n  \n  // LÓGICA PARA CONVITES (status: agendado/convidado)\n  if (status === 'agendado' && numeroDisparo === 0) {\n    // Primeiro disparo - na data agendada\n    const dataDisparo = new Date(disparo.json.data_hora);\n    deveDisparar = dataDisparo <= now;\n    tipoDisparo = 'primeiro_convite';\n  }\n  else if (status === 'convidado' && numeroDisparo === 1) {\n    // Segundo disparo - 1 dia depois do primeiro\n    const dataProximoDisparo = new Date(ultimoDisparo);\n    dataProximoDisparo.setDate(dataProximoDisparo.getDate() + 1);\n    deveDisparar = dataProximoDisparo <= now;\n    tipoDisparo = 'segundo_convite';\n  }\n  else if (status === 'convidado' && numeroDisparo === 2) {\n    // Terceiro disparo - 1 dia depois do segundo  \n    const dataProximoDisparo = new Date(ultimoDisparo);\n    dataProximoDisparo.setDate(dataProximoDisparo.getDate() + 1);\n    deveDisparar = dataProximoDisparo <= now;\n    tipoDisparo = 'terceiro_convite';\n  }\n  \n  // LÓGICA PARA APROVADOS CONFIRMADOS\n  else if (status === 'aprovado' && confirmado && dataEvento) {\n    // Disparo 1 dia antes do evento\n    const dataDisparo = new Date(dataEvento);\n    dataDisparo.setDate(dataDisparo.getDate() - 1);\n    deveDisparar = dataDisparo <= now;\n    tipoDisparo = 'lembrete_evento';\n  }\n  \n  return deveDisparar ? [{\n    json: {\n      ...disparo.json,\n      _tipo_disparo: tipoDisparo,\n      _deve_incrementar: tipoDisparo.includes('convite')\n    }\n  }] : [];\n});"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-208,2992],"id":"68eb0444-e8a7-421e-859c-a2ed2e19b563","name":"Filtra por Lógica de Sequência"},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[320,2976],"id":"f77363a1-d005-43b1-a96a-af2ac7c70e14","name":"Merge2"},{"parameters":{"operation":"getAll","tableId":"leads","returnAll":true,"filters":{"conditions":[{"keyName":"id_disparo","condition":"eq","keyValue":"={{ $('Filtra por Lógica de Sequência').item.json.id }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[80,2992],"id":"bdc1b80e-b03d-4080-a317-44dbbedde55e","name":"Pega Leads do Supabase","credentials":{"supabaseApi":{"id":"4MbqyW9T081a3o7d","name":"Finamob"}}},{"parameters":{"documentId":{"__rl":true,"value":"1YINmfZ9TyC0rGNllwxW6H16g1pn3rF0AHhilEtKbIAg","mode":"list","cachedResultName":"EVENTOS - BMS","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1YINmfZ9TyC0rGNllwxW6H16g1pn3rF0AHhilEtKbIAg/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"opt-out","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1YINmfZ9TyC0rGNllwxW6H16g1pn3rF0AHhilEtKbIAg/edit#gid=0"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[80,2816],"id":"61240bac-8411-406a-af7c-1ee2a0ff8d3c","name":"Verifica opt-out2","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"content":"## Adiciona disparos no histórico de mensagens","height":848,"width":1296,"color":4},"type":"n8n-nodes-base.stickyNote","position":[3184,2656],"typeVersion":1,"id":"cd7b03a3-b104-4e47-9ca5-7176f1c3bfb7","name":"Sticky Note4"},{"parameters":{"batchSize":"=1","options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[1248,2976],"id":"7c46c476-d23c-4856-9a83-975ff77bb8ea","name":"Loop Over Items"},{"parameters":{"amount":"={{ 3 + Math.floor(Math.random() * 5) }}"},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1536,2992],"id":"750f4cf7-17ad-446f-b79c-b1f589e048a0","name":"Wait","webhookId":"6686e364-432c-466f-ac33-321c79f8a8a1"},{"parameters":{"operation":"get","tableId":"bms-mensagens","filters":{"conditions":[{"keyName":"telefone","keyValue":"={{ $('Prepara Mensagens e Mídias').item.json.telefone }}"},{"keyName":"nome_app","keyValue":"SDR-EVENTOS"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[3264,2960],"id":"001b713f-6e4d-44f8-afdb-5c4818bea0d1","name":"Busca Dados","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"9FeQpCfKieI9F2Ms","name":"bms"}},"onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"defac08a-6745-422b-bb05-90da9f47d91b","leftValue":"={{ $('Busca Dados').last().json.values() }}","rightValue":"","operator":{"type":"array","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3568,2960],"id":"225f4c8e-7780-4e79-a70e-3b954cd81a18","name":"Verifica se encontrou"},{"parameters":{"tableId":"bms-mensagens","fieldsUi":{"fieldValues":[{"fieldId":"telefone","fieldValue":"={{ $('Prepara Mensagens e Mídias').item.json.telefone }}"},{"fieldId":"update_at","fieldValue":"={{$now.setLocale('pt-BR')}}"},{"fieldId":"nome_app","fieldValue":"SDR-EVENTOS"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[3856,2848],"id":"8e54d5cb-0cc1-483f-9b48-57852f34dc78","name":"Adiciona Mensagem","credentials":{"supabaseApi":{"id":"9FeQpCfKieI9F2Ms","name":"bms"}},"notes":"Este fluxo é de propriedade da FORMAÇÃO AGENTES DE IA COM N8N -BY RICNEVES"},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3,"position":[4144,2960],"id":"0ad1cd40-59a5-4623-9272-ed48faea4d91","name":"Faz o Merge","notes":"Este fluxo é de propriedade da FORMAÇÃO AGENTES DE IA COM N8N -BY RICNEVES"},{"parameters":{"tableId":"bms-historico_mensagens","fieldsUi":{"fieldValues":[{"fieldId":"mensagem_usuario"},{"fieldId":"mensagem_agente","fieldValue":"={{ $('Processa Campos').item.json.mensagem }}"},{"fieldId":"telefone","fieldValue":"={{ $('Processa Campos').item.json.telefone }}"},{"fieldId":"nome_usuario","fieldValue":"={{ $('Processa Campos').item.json.nome }}"},{"fieldId":"message_type","fieldValue":"text"},{"fieldId":"id_usuario","fieldValue":"={{ $('Wait').item.json.telefone }}"},{"fieldId":"nome_app","fieldValue":"SDR-EVENTOS"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[4144,3264],"id":"f6917946-8842-48c0-a97b-05c714af73cc","name":"Cria Mensagem no Supabase","credentials":{"supabaseApi":{"id":"9FeQpCfKieI9F2Ms","name":"bms"}},"onError":"continueRegularOutput","notes":"Este fluxo é de propriedade da FORMAÇÃO AGENTES DE IA COM N8N -BY RICNEVES"},{"parameters":{"operation":"update","tableId":"finamob-mensagens","matchType":"allFilters","filters":{"conditions":[{"keyName":"telefone","condition":"eq","keyValue":"={{ $('Prepara Mensagens e Mídias').item.json.telefone }}"},{"keyName":"nome_app","condition":"eq","keyValue":"SDR-EVENTOS"}]},"fieldsUi":{"fieldValues":[{"fieldId":"updated_at","fieldValue":"={{$now.setLocale('pt-BR')}}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[3856,3056],"id":"3be89989-a668-4acc-bc78-84f056164f45","name":"Atualiza Mensagem","credentials":{"supabaseApi":{"id":"4MbqyW9T081a3o7d","name":"Finamob"}},"notes":"Este fluxo é de propriedade da FORMAÇÃO AGENTES DE IA COM N8N -BY RICNEVES"},{"parameters":{"jsCode":"const item = items[0].json;\nconst tipoDisparo = item._tipo_disparo;\nconst deveIncrementar = item._deve_incrementar;\n\nlet novoStatus = item.status;\nlet numeroDisparo = item.numero_disparo || 0;\n\nif (deveIncrementar) {\n  numeroDisparo += 1;\n  \n  // Atualiza status baseado no número do disparo\n  if (numeroDisparo === 1) {\n    novoStatus = 'convidado'; // Primeiro disparo concluído\n  } else if (numeroDisparo === 2) {\n    novoStatus = 'convidado'; // Segundo disparo, ainda permite próximo\n  } else if (numeroDisparo === 3) {\n    novoStatus = 'limiteConvite'; // Após o terceiro disparo não permite mais disparos\n  }\n}\n\n// Para lembrete_evento, não muda status nem incrementa\nif (tipoDisparo === 'lembrete_evento') {\n    novoStatus = 'finalizado'; \n}\n\nreturn [{\n  json: {\n    disparo_id: item.disparo_id,\n    novo_status: novoStatus,\n    novo_numero_disparo: numeroDisparo,\n    // Mantém outros campos necessários para o fluxo\n    telefone: item.telefone,\n    nome: item.nome\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2432,2960],"id":"3ae03b4e-8934-4967-a873-73013f7466e9","name":"Atualiza Status Adequado e Incrementa o n° de convites"},{"parameters":{"jsCode":"// Entradas: Supabase (leads) e Sheets (blacklist)\nconst leads = items;\nconst blacklist = $items('Verifica opt-out', 0, 0);\n\n// --- Função robusta para normalizar telefone ---\nfunction normalizePhone(phone) {\n  if (!phone) return '';\n\n  let clean = String(phone).replace(/\\D/g, ''); // remove tudo que não é número\n\n  // Remove prefixo internacional 55 se existir\n  if (clean.startsWith('55')) clean = clean.slice(2);\n\n  // Se tiver mais de 11 dígitos (erro comum em planilhas), pega só os últimos 11\n  if (clean.length > 11) clean = clean.slice(-11);\n\n  // Se tiver menos de 11 e mais de 8 (fixo sem DDD), ignora\n  if (clean.length < 10) return '';\n\n  // Corrige se for 10 dígitos (sem o 9)\n  if (clean.length === 10) {\n    clean = clean.slice(0, 2) + '9' + clean.slice(2);\n  }\n\n  return clean;\n}\n\n// --- Cria lista de bloqueados normalizados ---\nconst blacklistPhones = blacklist\n  .map(b => normalizePhone(b.json.Telefone || b.json.telefone))\n  .filter(Boolean);\n\n// --- Filtra os leads que NÃO estão na blacklist ---\nconst filteredLeads = leads.filter(l => {\n  const leadPhone = normalizePhone(l.json.telefone);\n  const isBlocked = blacklistPhones.includes(leadPhone);\n  return leadPhone && !isBlocked;\n});\n\n// --- Logs úteis para debug ---\nconsole.log('Blacklisted phones:', blacklistPhones);\nconsole.log('Total leads recebidos:', leads.length);\nconsole.log('Leads após filtro:', filteredLeads.length);\n\nreturn filteredLeads;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[528,2976],"id":"db080b9f-b961-4d35-b528-97e920a1f44d","name":"Filtragem de Leads Opt-out"},{"parameters":{"jsCode":"// Code node — Mode: Run Once for All Items\n\nfunction normalizeTelefone(raw) {\n  if (raw == null) return \"\";\n  let d = String(raw).replace(/\\D/g, \"\").replace(/^0+/, \"\");\n  return d ? (d.startsWith(\"55\") ? d : \"55\" + d) : \"\";\n}\n\nfunction stripBOM(buf) {\n  return (buf.length >= 3 && buf[0] === 0xEF && buf[1] === 0xBB && buf[2] === 0xBF)\n    ? buf.slice(3)\n    : buf;\n}\n\nfunction fixPngSignature(buf) {\n  // PNG correto: 89 50 4E 47 0D 0A 1A 0A\n  if (buf.length >= 7 &&\n      buf[0] === 0x50 && buf[1] === 0x4E && buf[2] === 0x47 && // \"PNG\"\n      buf[3] === 0x0D && buf[4] === 0x0A && buf[5] === 0x1A && buf[6] === 0x0A) {\n    // faltou 0x89 antes de \"PNG\"\n    return Buffer.concat([Buffer.from([0x89]), buf]);\n  }\n  return buf;\n}\n\nasync function getBinaryWithHeaders(url) {\n  try {\n    const res = await this.helpers.httpRequest({\n      method: 'GET',\n      url,\n      headers: { 'User-Agent': 'Mozilla/5.0' },\n      responseFormat: 'arraybuffer',\n      returnFullResponse: true,\n    });\n    return { buf: Buffer.from(res.data ?? res), mime: res.headers?.['content-type'] || \"\" };\n  } catch {\n    const res = await this.helpers.request({\n      method: 'GET',\n      url,\n      headers: { 'User-Agent': 'Mozilla/5.0' },\n      json: false,\n      encoding: null,\n      resolveWithFullResponse: true,\n    });\n    return { buf: Buffer.from(res.body), mime: res.headers?.['content-type'] || \"\" };\n  }\n}\n\nreturn await Promise.all(items.map(async (item) => {\n  const mensagem      = item.json?.mensagem;\n  const remetente     = item.json?.remetente;\n  const nome          = item.json?.nome;\n  const telefone      = normalizeTelefone(item.json?.telefone);\n  const tipo_midia    = (item.json?.tipo_midia || \"\").toLowerCase();\n  const template_name = item.json?.template_name || \"\";\n  const _tipo_disparo = item.json?._tipo_disparo;\n  const _deve_incrementar = item.json?._deve_incrementar;\n  const disparo_id = item.json?.disparo_id;\n  // Novos parâmetros\n  const param_1 = item.json?.param_1 || \"\";\n  const param_2 = item.json?.param_2 || \"\";\n  const param_3 = item.json?.param_3 || \"\";\n  const param_4 = item.json?.param_4 || \"\";\n  const param_5 = item.json?.param_5 || \"\";\n\n  // Novo campo imagem_url\n  const imagem_url = (item.json?.imagem_url || \"\").toString().trim();\n\n  let base64 = \"\";\n  let mime = \"\";\n\n  if (imagem_url) {\n    try {\n      let res = await getBinaryWithHeaders.call(this, imagem_url);\n      let buf = Buffer.from(res.buf);\n      mime = res.mime || \"\";\n\n      buf = stripBOM(buf);\n\n      // Corrigir assinatura se for imagem PNG\n      const isPngHint = (mime && mime.includes('png')) ||\n                        (buf.length >= 3 && buf[0] === 0x50 && buf[1] === 0x4E && buf[2] === 0x47);\n      if (tipo_midia === \"imagem\" && isPngHint && buf.length >= 7) {\n        buf = fixPngSignature(buf);\n      }\n\n      base64 = buf.toString('base64');\n    } catch {\n      base64 = \"\";\n    }\n  }\n\n  return {\n    json: {\n      mensagem,\n      remetente,\n      nome,\n      telefone,\n      tipo_midia,\n      mime,\n      base64,\n      imagem_url,\n      template_name,\n      param_1,\n      param_2,\n      param_3,\n      param_4,\n      param_5,\n      _tipo_disparo,\n      _deve_incrementar,\n      disparo_id\n    }\n  };\n}));\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[960,2976],"id":"94ac35b4-a886-48b2-970e-57c1a5e04e62","name":"Prepara Mensagens e Mídias"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"635ac4f0-7983-4784-8e4f-6f969c0f173a","leftValue":"={{ $json.tipo_midia }}","rightValue":"","operator":{"type":"string","operation":"empty","singleValue":true}}],"combinator":"and"},"renameOutput":true,"outputKey":"null"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.tipo_midia }}","rightValue":"imagem","operator":{"type":"string","operation":"equals"},"id":"18e41898-3ae2-4b09-b0f3-7ff87c97cc6b"}],"combinator":"and"},"renameOutput":true,"outputKey":"imagem"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[1808,2992],"id":"aec9dd38-8867-4d31-84e9-ea18758f2e35","name":"Direciona o fluxo dependendo se tem mídia"},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v22.0/869722152886578/messages","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.telefone }}\",\n  \"type\": \"template\",\n  \"template\": {\n    \"name\": \"{{ $json.template_name }}\",\n    \"language\": { \"code\": \"pt_BR\" },\n    \"components\": [\n      {\n        \"type\": \"header\",\n        \"parameters\": [\n          {\n            \"type\": \"image\",\n            \"image\": { \"link\": \"{{ $json.imagem_url }}\" }\n          }\n        ]\n      },\n      {\n        \"type\": \"body\",\n        \"parameters\": {{ \n          JSON.stringify(\n            [\n              { \"type\": \"text\", \"text\": $json.param_1 },\n              { \"type\": \"text\", \"text\": $json.param_2 },\n              { \"type\": \"text\", \"text\": $json.param_3 },\n              { \"type\": \"text\", \"text\": $json.param_4 },\n              { \"type\": \"text\", \"text\": $json.param_5 }\n            ].filter(p => p.text && p.text.trim() !== \"\")\n          )\n        }}\n      }\n    ]\n  }\n}\n","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2128,3072],"id":"5d919dc1-eef2-45ea-9f0f-874d9c8d162d","name":"Envia template de mensagem com mídia (API OFICIAL)","retryOnFail":true,"credentials":{"httpBearerAuth":{"id":"W8jSHgF1bru0lIPY","name":"whatsapp"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v22.0/869722152886578/messages","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $json.telefone }}\",\n  \"type\": \"template\",\n  \"template\": {\n    \"name\": \"{{ $json.template_name }}\",\n    \"language\": { \"code\": \"pt_BR\" },\n    \"components\": [\n      {\n        \"type\": \"body\",\n        \"parameters\": {{ \n          JSON.stringify(\n            [\n              { \"type\": \"text\", \"text\": $json.param_1 },\n              { \"type\": \"text\", \"text\": $json.param_2 },\n              { \"type\": \"text\", \"text\": $json.param_3 },\n              { \"type\": \"text\", \"text\": $json.param_4 },\n              { \"type\": \"text\", \"text\": $json.param_5 }\n            ].filter(p => p.text && p.text.trim() !== \"\")\n          )\n        }}\n      }\n    ]\n  }\n}\n","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2128,2864],"id":"e3ebf437-b9ce-4f37-80cc-2e8ae6c8948d","name":"Envia template de mensagem sem mídia (API OFICIAL)","retryOnFail":true,"credentials":{"httpBearerAuth":{"id":"W8jSHgF1bru0lIPY","name":"whatsapp"}}},{"parameters":{"content":"## Busca os disparos elegíveis e encaminha por etapa lógica o seguimento","height":848,"width":1632,"color":3},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-528,2656],"id":"f66547d6-0894-479e-9f6d-7080c9bea0b5","name":"Sticky Note5"},{"parameters":{"assignments":{"assignments":[{"id":"59ff38c0-5bb5-41fb-9e42-bc90aa134824","name":"mensagem","value":"={{ $('Filtra por Lógica de Sequência').item.json.mensagem }}","type":"string"},{"id":"8be9705a-3394-429f-b7ff-7a3a62f4c3ce","name":"imagem_url","value":"={{ $('Filtra por Lógica de Sequência').item.json.imagem_url }}","type":"string"},{"id":"5a1ad5b9-c0f3-4215-a17f-d4832dace959","name":"remetente","value":"","type":"string"},{"id":"d5de298f-2320-448c-a83e-d23b3298260c","name":"nome","value":"={{ $json.nome }}","type":"string"},{"id":"7bc1856e-87c7-485d-9a8b-b411e46cc501","name":"telefone","value":"={{ $json.telefone }}","type":"string"},{"id":"8dc94158-dff7-404e-9d33-1891cf2b76e2","name":"tipo_midia","value":"={{ $('Filtra por Lógica de Sequência').item.json.tipo_midia }}","type":"string"},{"id":"174590f8-2032-4a75-a4e7-ce27a8be9a58","name":"template_name","value":"={{ $('Filtra por Lógica de Sequência').item.json.template_name }}","type":"string"},{"id":"d00fb8f0-2924-4cec-8fd6-c1cf5be44e6c","name":"param_1","value":"={{ $('Filtra por Lógica de Sequência').item.json.param_1 }}","type":"string"},{"id":"f94dc699-b921-4ff0-91ba-61cb2c1e3dfa","name":"param_2","value":"={{ $('Filtra por Lógica de Sequência').item.json.param_2 }}","type":"string"},{"id":"c97bf8e1-1fdb-4b6b-9827-a0ddac1dee22","name":"param_3","value":"={{ $('Filtra por Lógica de Sequência').item.json.param_3 }}","type":"string"},{"id":"ffa48eb6-0344-4bff-8eae-c908565a1f83","name":"param_4","value":"={{ $('Filtra por Lógica de Sequência').item.json.param_4 }}","type":"string"},{"id":"6525d75d-92cc-469b-954d-a2b7f179141d","name":"param_5","value":"={{ $('Filtra por Lógica de Sequência').item.json.param_5 }}","type":"string"},{"id":"384e3512-079e-4c3c-849d-32dac41aad0d","name":"_tipo_disparo","value":"={{ $('Filtra por Lógica de Sequência').item.json._tipo_disparo }}","type":"string"},{"id":"cea0a140-01c0-4bd5-9d25-aabc377e33e8","name":"disparo_id","value":"={{ $('Filtra por Lógica de Sequência').item.json.id }}","type":"string"},{"id":"6470a313-eb52-4965-a884-e0f464c0c95b","name":"_deve_incrementar","value":"={{ $('Filtra por Lógica de Sequência').item.json._deve_incrementar }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[752,2976],"id":"449a00d9-93cb-443f-936c-1dbb517b6055","name":"Processa Campos"},{"parameters":{"operation":"update","tableId":"disparos","matchType":"allFilters","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $json.disparo_id }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"status","fieldValue":"={{ $json.novo_status }}"},{"fieldId":"=numero_disparo","fieldValue":"={{ $json.novo_numero_disparo }}"},{"fieldId":"=ultimo_disparo_em","fieldValue":"={{ $now.toISO() }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2736,2960],"id":"3078a897-0b21-4a52-b6a1-2fab2afe0566","name":"Atualiza o status","credentials":{"supabaseApi":{"id":"9FeQpCfKieI9F2Ms","name":"bms"}}},{"parameters":{"content":"## Dispara a mensagem via API oficial e atualiza no banco e na planilha","height":848,"width":2000},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[1152,2656],"id":"48e1fbc9-ef34-4066-9ed3-23e5f360919f","name":"Sticky Note"}],"connections":{"Schedule Trigger1":{"main":[[{"node":"Busca Todos Disparos Elegíveis","type":"main","index":0}]]},"Busca Todos Disparos Elegíveis":{"main":[[{"node":"Filtra por Lógica de Sequência","type":"main","index":0}]]},"Pega Leads do Supabase":{"main":[[{"node":"Merge2","type":"main","index":1}]]},"Verifica opt-out2":{"main":[[{"node":"Merge2","type":"main","index":0}]]},"Filtra por Lógica de Sequência":{"main":[[{"node":"Pega Leads do Supabase","type":"main","index":0},{"node":"Verifica opt-out2","type":"main","index":0}]]},"Merge2":{"main":[[{"node":"Filtragem de Leads Opt-out","type":"main","index":0}]]},"Loop Over Items":{"main":[[],[{"node":"Wait","type":"main","index":0}]]},"Wait":{"main":[[{"node":"Direciona o fluxo dependendo se tem mídia","type":"main","index":0}]]},"Busca Dados":{"main":[[{"node":"Verifica se encontrou","type":"main","index":0}]]},"Verifica se encontrou":{"main":[[{"node":"Adiciona Mensagem","type":"main","index":0}],[{"node":"Atualiza Mensagem","type":"main","index":0}]]},"Adiciona Mensagem":{"main":[[{"node":"Faz o Merge","type":"main","index":0}]]},"Faz o Merge":{"main":[[{"node":"Cria Mensagem no Supabase","type":"main","index":0}]]},"Cria Mensagem no Supabase":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Atualiza Mensagem":{"main":[[{"node":"Faz o Merge","type":"main","index":1}]]},"Atualiza Status Adequado e Incrementa o n° de convites":{"main":[[{"node":"Atualiza o status","type":"main","index":0}]]},"Filtragem de Leads Opt-out":{"main":[[{"node":"Processa Campos","type":"main","index":0}]]},"Prepara Mensagens e Mídias":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Direciona o fluxo dependendo se tem mídia":{"main":[[{"node":"Envia template de mensagem sem mídia (API OFICIAL)","type":"main","index":0}],[{"node":"Envia template de mensagem com mídia (API OFICIAL)","type":"main","index":0}]]},"Envia template de mensagem com mídia (API OFICIAL)":{"main":[[{"node":"Atualiza Status Adequado e Incrementa o n° de convites","type":"main","index":0}]]},"Envia template de mensagem sem mídia (API OFICIAL)":{"main":[[{"node":"Atualiza Status Adequado e Incrementa o n° de convites","type":"main","index":0}]]},"Processa Campos":{"main":[[{"node":"Prepara Mensagens e Mídias","type":"main","index":0}]]},"Atualiza o status":{"main":[[{"node":"Busca Dados","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"GbORhS24Rzw7hHlt"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"554f9449-ab29-40ff-b6e9-3df0584b2b2b","triggerCount":1,"tags":[]}