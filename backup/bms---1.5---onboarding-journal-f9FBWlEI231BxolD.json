{"createdAt":"2025-10-01T15:21:13.309Z","updatedAt":"2025-10-21T14:44:04.294Z","id":"f9FBWlEI231BxolD","name":"BMS - 1.5 - Onboarding Journal","active":true,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"triggerAtHour":9}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[496,-16],"id":"96daa1bb-64c0-4bd7-be5d-c11a46b3fa51","name":"Schedule Trigger"},{"parameters":{"documentId":{"__rl":true,"value":"1IDXSuMzMhUFDCmKkpS9qSfH3UuBKyoOD66M75UYcgSs","mode":"list","cachedResultName":"CRM - BMS","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1IDXSuMzMhUFDCmKkpS9qSfH3UuBKyoOD66M75UYcgSs/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"journal_list","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1IDXSuMzMhUFDCmKkpS9qSfH3UuBKyoOD66M75UYcgSs/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"status","lookupValue":"ativo"},{"lookupColumn":"novo?","lookupValue":"novo"}]},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[928,-16],"id":"21d6dd3e-36f6-45dc-9190-39597569a9ef","name":"Get row(s) in sheet","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"operation":"download","fileId":{"__rl":true,"value":"1K1BLNdsAoVhCCP-A7Ot7ILaNbRGkQcn1","mode":"id"},"options":{}},"type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[496,-240],"id":"ef926c0d-428f-4cd8-b6f2-c60abc940ca6","name":"Download file","credentials":{"googleDriveOAuth2Api":{"id":"ZkmaJh5Y8Zdz8ju7","name":"Google Drive - lucas@getmia.com.br"}},"disabled":true},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// n8n Code node ‚Äì pega o base64 do arquivo baixado no \"Download file\"\n\nconst binAll = $input.item.binary || {};\n\n// tenta 'imagem_final', depois 'data', depois a 1¬™ chave dispon√≠vel\nconst key =\n  binAll.imagem_final ? 'imagem_final' :\n  (binAll.data ? 'data' : Object.keys(binAll)[0]);\n\nif (!key) throw new Error('Nenhum bin√°rio encontrado no item.');\n\nconst bin = binAll[key];\nif (!bin?.data) throw new Error(`Bin√°rio na chave \"${key}\" n√£o possui .data.`);\n\n// j√° vem em base64; n√£o reconverta\nconst base64 = bin.data;\n\nreturn {\n  json: {\n    base64Image: base64,                          // use isto no Evolution (media)\n    mimeType: bin.mimeType || 'application/octet-stream',\n    fileName: bin.fileName || 'arquivo'\n  }\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[704,-240],"id":"a214e043-00a7-4ecf-880f-da1b1a1b7a23","name":"Code2","disabled":true},{"parameters":{"operation":"update","documentId":{"__rl":true,"value":"1IDXSuMzMhUFDCmKkpS9qSfH3UuBKyoOD66M75UYcgSs","mode":"list","cachedResultName":"CRM - BMS","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1IDXSuMzMhUFDCmKkpS9qSfH3UuBKyoOD66M75UYcgSs/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"journal_list","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1IDXSuMzMhUFDCmKkpS9qSfH3UuBKyoOD66M75UYcgSs/edit#gid=0"},"columns":{"mappingMode":"defineBelow","value":{"novo?":"cadastrado","row_number":"={{ $('Get row(s) in sheet').item.json.row_number }}"},"matchingColumns":["row_number"],"schema":[{"id":"nome","displayName":"nome","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"telefone","displayName":"telefone","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"empresa","displayName":"empresa","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"email","displayName":"email","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"status","displayName":"status","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"novo?","displayName":"novo?","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"row_number","displayName":"row_number","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"readOnly":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[2432,112],"id":"73744163-7f44-46f8-a59c-46ce5f0f56b9","name":"Update row in sheet","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"batchSize":"=1","options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[1376,-16],"id":"381d134f-f94b-4197-8612-2db4c495e2b6","name":"Loop Over Items1"},{"parameters":{"jsCode":"// Pega o image_url do node anterior (Set)\nconst image_url = $items(\"Edit Fields\")[0].json.image_url;\n\n// Pega todas as linhas do Sheets\nconst rows = $input.all();\n\n// Cria a sa√≠da final com o telefone formatado e o image_url incluso\nreturn rows.map(item => {\n  const data = item.json;\n\n  // Normaliza√ß√£o do telefone\n  const raw = data.telefone || \"\";\n  let clean = String(raw).replace(/\\D+/g, \"\");\n\n  if (clean.length === 11) {\n    clean = \"55\" + clean;\n  } else if (clean.length === 13 && clean.startsWith(\"55\")) {\n    // j√° est√° ok\n  }\n\n  return {\n    json: {\n      ...data,\n      telefoneFormatado: clean,\n      image_url: image_url // üîß pega do node anterior (Set)\n    }\n  };\n});\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1136,-16],"id":"ee558308-fddd-4c6a-8945-3ab1f32c99c3","name":"Code"},{"parameters":{"amount":"={{ 3 + Math.floor(Math.random() * 5) }}"},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1648,0],"id":"ea2759de-1cb8-4694-8bf4-407ef77ae04a","name":"Wait","webhookId":"6686e364-432c-466f-ac33-321c79f8a8a1"},{"parameters":{"operation":"update","documentId":{"__rl":true,"value":"1IDXSuMzMhUFDCmKkpS9qSfH3UuBKyoOD66M75UYcgSs","mode":"list","cachedResultName":"CRM - BMS","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1IDXSuMzMhUFDCmKkpS9qSfH3UuBKyoOD66M75UYcgSs/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"journal_list","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1IDXSuMzMhUFDCmKkpS9qSfH3UuBKyoOD66M75UYcgSs/edit#gid=0"},"columns":{"mappingMode":"defineBelow","value":{"novo?":"erro","telefone":"={{ $('Code').item.json.telefone }}"},"matchingColumns":["telefone"],"schema":[{"id":"nome","displayName":"nome","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"telefone","displayName":"telefone","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"empresa","displayName":"empresa","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"email","displayName":"email","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"status","displayName":"status","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":true},{"id":"novo?","displayName":"novo?","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"row_number","displayName":"row_number","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"readOnly":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[2432,480],"id":"b100e5f1-808a-4e5c-a91e-e03d0d9c6c3b","name":"Update row in sheet1","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"method":"POST","url":"https://graph.facebook.com/v22.0/782664311604851/messages","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"messaging_product\": \"whatsapp\",\n  \"to\": \"{{ $('Code').item.json.telefoneFormatado }}\",\n  \"type\": \"template\",\n  \"template\": {\n    \"name\": \"onboarding_clientes\",\n    \"language\": {\n      \"code\": \"pt_BR\"\n    },\n    \"components\": [\n      {\n        \"type\": \"header\",\n        \"parameters\": [\n          {\n            \"type\": \"image\",\n            \"image\": {\n              \"link\": \"{{ $('Code').item.json.image_url }}\"\n            }\n          }\n        ]\n      },\n      {\n        \"type\": \"body\",\n        \"parameters\": [\n          { \"type\": \"text\", \"text\": \"{{ $('Code').item.json.nome }}\" }        ]\n      }\n    ]\n  }\n}\n","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1824,0],"id":"2f91388a-ea03-43fd-ba2c-9dd90cbb9b10","name":"HTTP Request","credentials":{"httpBearerAuth":{"id":"W8jSHgF1bru0lIPY","name":"whatsapp"}},"onError":"continueErrorOutput"},{"parameters":{"assignments":{"assignments":[{"id":"7cb664e6-78c7-4a23-8b5f-eeaa449a710e","name":"image_url","value":"https://bmsprojetos.com/wp-content/uploads/2024/08/BMS.jpg","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[704,-16],"id":"ef58c788-6942-4344-86bf-d7e0a89e6a20","name":"Edit Fields"},{"parameters":{"resource":"messages-api","instanceName":"bms-social-media","remoteJid":"=5511992486507","messageText":"=Onboarding enviado para: {{ $('Code').item.json.nome }} - {{ $('Code').item.json.telefoneFormatado }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[2112,-16],"id":"4b554c4d-6213-4c82-9b89-50660bdd22db","name":"Envio do post - Journal List","credentials":{"evolutionApi":{"id":"vy2ySY8uAchmjNnK","name":"bms"}},"onError":"continueErrorOutput"},{"parameters":{"resource":"messages-api","instanceName":"bms-social-media","remoteJid":"=5511992486507","messageText":"=Onboarding deu erro para: {{ $('Code').item.json.nome }} - {{ $('Code').item.json.telefoneFormatado }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[2112,368],"id":"7a796de9-2c87-437e-98ad-b7c3259e11bd","name":"Envio do post - Journal List1","credentials":{"evolutionApi":{"id":"vy2ySY8uAchmjNnK","name":"bms"}},"onError":"continueErrorOutput"}],"connections":{"Schedule Trigger":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"Get row(s) in sheet":{"main":[[{"node":"Code","type":"main","index":0}]]},"Download file":{"main":[[{"node":"Code2","type":"main","index":0}]]},"Code2":{"main":[[]]},"Loop Over Items1":{"main":[[],[{"node":"Wait","type":"main","index":0}]]},"Update row in sheet":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"Code":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"Wait":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"Update row in sheet1":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"Envio do post - Journal List","type":"main","index":0}],[{"node":"Envio do post - Journal List1","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Get row(s) in sheet","type":"main","index":0}]]},"Envio do post - Journal List":{"main":[[{"node":"Update row in sheet","type":"main","index":0}],[{"node":"Update row in sheet","type":"main","index":0}]]},"Envio do post - Journal List1":{"main":[[{"node":"Update row in sheet1","type":"main","index":0}],[{"node":"Update row in sheet1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"GbORhS24Rzw7hHlt"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"301f7636-cc22-4a0d-b57e-d34def6184c7","triggerCount":1,"tags":[]}