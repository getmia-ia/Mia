{"createdAt":"2025-08-04T03:03:29.309Z","updatedAt":"2025-09-24T17:31:45.275Z","id":"9HC0jl2bniADZqcs","name":"1.2 - Finamob - Journal - Aprovador","active":false,"isArchived":true,"nodes":[{"parameters":{"content":"# Fluxo de Aprova√ß√£o dos Posts\n\n### Esse fluxo roda sempre que existe uma alteracao no sheets de controle do journal\n### O AI Agent define se aprova ou rejeita um post baseado em sua imagem e se ja foi postado alguma vez um tema similar","height":784,"width":4304,"color":3},"type":"n8n-nodes-base.stickyNote","position":[384,-128],"typeVersion":1,"id":"23ffb2af-7ef1-48c2-9273-78e39ec20840","name":"Sticky Note13"},{"parameters":{"promptType":"define","text":"=Voc√™ √© respons√°vel por analisar uma not√≠cia com status \"aguardando\" e decidir se ela deve ser \"aprovada\" ou \"reprovada\".\n\nüìú Hist√≥rico de not√≠cias j√° postadas (use para evitar duplicidade; compare por t√≠tulo/legenda/evento):\n{{ $json.historico }}\n\nüì∞ Not√≠cia para an√°lise:\nID: {{ $json.noticia_id }}\nT√≠tulo: {{ $json.titulo }}\nLegenda: {{ $json.legenda }}\nImagem: {{ $json.imagem_url }}\n\nREGRAS:\n1) Duplicidade:\n   - Reprove se falar do MESMO evento j√° postado (mesma decis√£o do Copom, mesmo projeto de lei, mesma a√ß√£o/julgamento, mesma divulga√ß√£o de resultado, etc.).\n   - Ao reprovar por duplicidade, CITE o ID correspondente do hist√≥rico.\n   - N√£o reprovar por tema amplo gen√©rico (ex.: ‚Äújuros‚Äù em abstrato) se n√£o for o mesmo evento.\n\n2) Imagem:\n   - Reprove se a imagem for toda preta/branca, muito escura, cortada, com logo/marca d‚Äô√°gua, baixa resolu√ß√£o ou sem rela√ß√£o clara com o conte√∫do.\n\n3) Relev√¢ncia (mercado imobili√°rio):\n   - Aprove somente se houver liga√ß√£o direta: pre√ßos de im√≥veis, financiamento/cr√©dito/juros que impactem im√≥veis, constru√ß√£o civil, habita√ß√£o, infraestrutura, FIIs, pol√≠ticas/leis do setor.\n   - N√£o aprove economia geral sem conex√£o pr√°tica com im√≥veis.\n\nSA√çDA (JSON PURO, sem texto extra):\n[\n  {\n    \"noticia_id\": \"{{ $json.noticia_id }}\",\n    \"status\": \"aprovado\" | \"reprovado\",\n    \"justificativa\": \"motivo curto e objetivo; se duplicado, cite o ID original\"\n  }\n]\nREGRAS FINAIS:\n- N√£o altere noticia_id.\n- Retorne SOMENTE o array JSON.\n","options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[1456,128],"id":"18bd2b07-0925-4e03-8821-2ee40d3baef4","name":"AI Agent","executeOnce":false},{"parameters":{"pollTimes":{"item":[{"mode":"everyMinute"}]},"documentId":{"__rl":true,"value":"1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0","mode":"list","cachedResultName":"Finamob - Controle Journal","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0/edit#gid=0"},"options":{}},"type":"n8n-nodes-base.googleSheetsTrigger","typeVersion":1,"position":[448,112],"id":"8230ca52-87da-4e20-9951-0448effe4a81","name":"Trigger nova noticia no sheets","credentials":{"googleSheetsTriggerOAuth2Api":{"id":"PvlXorOaq6vxhcle","name":"Google Sheets Trigger account"}}},{"parameters":{"documentId":{"__rl":true,"value":"1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0","mode":"list","cachedResultName":"Finamob - Controle Journal","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"status","lookupValue":"aguardando"}]},"combineFilters":"OR","options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[672,112],"id":"0535bad3-6f22-43fe-88c9-6f25d3292e2c","name":"Noticias aguardando aprova√ß√£o","executeOnce":true,"credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}},"onError":"continueRegularOutput"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[1456,304],"id":"9ef651dc-49e7-4643-88e9-b5899f04d06b","name":"gpt-4.1-mini","credentials":{"openRouterApi":{"id":"o1ywdYlH64cgqSMT","name":"OpenRouter account"}}},{"parameters":{"operation":"update","documentId":{"__rl":true,"value":"1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0","mode":"list","cachedResultName":"Finamob - Controle Journal","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0/edit#gid=0"},"columns":{"mappingMode":"autoMapInputData","value":{},"matchingColumns":["noticia_id"],"schema":[{"id":"noticia_id","displayName":"noticia_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"data_processamento","displayName":"data_processamento","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"titulo","displayName":"titulo","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"legenda","displayName":"legenda","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"fonte","displayName":"fonte","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"imagem","displayName":"imagem","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"arquivo_base64","displayName":"arquivo_base64","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"imagem_url","displayName":"imagem_url","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"status","displayName":"status","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"nota","displayName":"nota","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"justificativa","displayName":"justificativa","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"output","displayName":"output","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"row_number","displayName":"row_number","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"readOnly":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[2160,128],"id":"a9964358-135c-44c2-9911-95cc15be622f","name":"Atualizar status da noticia","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const raw = $json.output;\nconst parsed = JSON.parse(raw); // Isso vira um array com 1 objeto\n\n// Retorna o primeiro e √∫nico objeto do array\nreturn {\n  json: parsed[0]\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1792,128],"id":"ee9e5edb-e75a-404f-8b20-0b4787320d72","name":"Code"},{"parameters":{"jsCode":"const items = $input.all();\nif (!items.length) return [];\n\nconst histItem = items[items.length - 1];\nconst historico = (histItem?.json?.historico ?? '');\n\n// opcional: corta pra evitar prompt gigante\nconst hist = historico.length > 15000 ? historico.slice(0,15000) : historico;\n\n// tudo menos o √∫ltimo (que √© o hist√≥rico)\nconst noticias = items.slice(0, -1);\n\nreturn noticias.map(i => ({\n  json: { ...i.json, historico: hist }\n}));\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1264,128],"id":"0cfbc567-8a13-4345-9910-d904dbdd31e2","name":"Code1"},{"parameters":{"documentId":{"__rl":true,"value":"1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0","mode":"list","cachedResultName":"Finamob - Controle Journal","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"status","lookupValue":"postado"}]},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[672,304],"id":"cbe2a855-9a68-430f-9d88-5692974bb48c","name":"Noticias Postadas","executeOnce":true,"credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const DIAS = 3;\nconst corte = new Date(); corte.setDate(corte.getDate() - DIAS);\n\nfunction parseBR(v){\n  if (!v) return NaN;\n  if (v instanceof Date) return v;\n  const m = String(v).trim().match(/^(\\d{2})\\/(\\d{2})\\/(\\d{4})$/);\n  if (!m) return NaN;\n  const [_, dd, mm, yyyy] = m.map(Number);\n  return new Date(yyyy, mm-1, dd);\n}\n\n// filtra √∫ltimos DIAS\nconst recentes = $input.all().filter(i=>{\n  const j = i.json||{};\n  const raw = j.data_processamento || j.data_proce || j.data_proces || j.data;\n  const d = parseBR(raw);\n  return d instanceof Date && !isNaN(d) && d >= corte && (j.status||'').toLowerCase()==='postado';\n});\n\n// monta string\nlet historico = recentes.map(i=>{\n  const j=i.json||{};\n  return `ID:${j.noticia_id} | ${j.titulo||''} | ${j.legenda||''}`;\n}).join('\\n');\n\n// limita tamanho (evita prompt gigante)\nif (historico.length > 15000) historico = historico.slice(0,15000);\n\n// retorna **um √∫nico item**\nreturn [{ json: { historico } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[864,304],"id":"1584c425-a7b4-4f1d-96be-247e118d89a9","name":"Code2","alwaysOutputData":true},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[1072,128],"id":"5cd701df-6dda-4eff-89bd-8b3b213b117d","name":"Merge"},{"parameters":{"documentId":{"__rl":true,"value":"1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0","mode":"list","cachedResultName":"Finamob - Controle Journal","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Ze1MFqVlu21qakfTTE5ECfAu4iFOoeQMygOCjPW5nek/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"noticia_id","lookupValue":"={{ $json.noticia_id }}"}]},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[2160,416],"id":"61fc5897-f3ee-4b71-8cf4-65a34ab4d687","name":"Get row(s) in sheet","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"resource":"fileFolder","searchMethod":"query","queryString":"=name = '{{ $json.arquivo_base64 }}' and trashed = false\n","limit":1,"filter":{},"options":{}},"type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[2368,416],"id":"6349c0f5-a20d-474f-83eb-2ad335915231","name":"Search files and folders","credentials":{"googleDriveOAuth2Api":{"id":"ZkmaJh5Y8Zdz8ju7","name":"Google Drive - lucas@getmia.com.br"}}},{"parameters":{"operation":"download","fileId":{"__rl":true,"value":"={{ $json.id }}","mode":"id"},"options":{}},"type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[2576,416],"id":"1c7688c9-14b7-4632-9b99-0279e4b1e595","name":"Download file","credentials":{"googleDriveOAuth2Api":{"id":"ZkmaJh5Y8Zdz8ju7","name":"Google Drive - lucas@getmia.com.br"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Executar: Run Once for Each Item\nconst i = $itemIndex;\n\n// 1) Buscar a legenda do Sheets alinhando pelo √≠ndice do item atual\nconst sheetItems = $items('Get row(s) in sheet');   // <- pega TODOS os itens do n√≥\nconst legenda = sheetItems?.[i]?.json?.legenda || '';  // usa o i como itemIndex\n\n// 2) Pegar o .txt baixado do Drive (base64 do ARQUIVO .txt)\nconst txtB64 = $input.item?.binary?.data?.data;\nif (!txtB64) {\n  throw new Error('Bin√°rio do .txt n√£o encontrado no node \"Download file\".');\n}\n\n// 3) .txt (base64) -> texto UTF-8 -> que cont√©m o base64 da IMAGEM\nconst content = Buffer.from(txtB64, 'base64').toString('utf8').trim();\n\n// 4) Se vier em dataURI, remover prefixo e capturar MIME\nconst m = content.match(/^data:([^;]+);base64,(.+)$/i);\nlet mimeType = m ? m[1] : null;\nlet base64 = (m ? m[2] : content).replace(/\\s+/g, ''); // remove quebras/espa√ßos\n\n// 5) Detectar MIME pelos \"magic bytes\" caso n√£o tenha\nconst buf = Buffer.from(base64, 'base64');\nif (!mimeType) {\n  const sig = buf.slice(0, 4).toString('hex');\n  if (sig.startsWith('ffd8ff')) mimeType = 'image/jpeg';\n  else if (sig === '89504e47') mimeType = 'image/png';\n  else if (sig.startsWith('47494638')) mimeType = 'image/gif';\n  else if (sig.startsWith('52494646')) mimeType = 'image/webp';\n  else mimeType = 'application/octet-stream';\n}\n\n// 6) Retornar o que outros n√≥s v√£o usar\nreturn {\n  json: {\n    index: i,\n    legenda,\n    mimeType,\n    base64\n    // Se o seu node de envio exigir com prefixo:\n    // base64WithPrefix: `data:${mimeType};base64,${base64}`\n  }\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2784,416],"id":"c2b343f2-b165-4197-8c2d-338425b7a8ef","name":"Code3"},{"parameters":{"mode":"combine","combineBy":"combineAll","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[3776,400],"id":"86295dbf-0333-43cd-bded-03bc00bd5f9d","name":"Merge1"},{"parameters":{"jsCode":"const COUNTRY = '55';\nconst onlyDigits = s => String(s ?? '').replace(/\\D/g, '').replace(/^0+/, '');\nconst toE164NoPlus = d => d ? (d.startsWith(COUNTRY) ? d : COUNTRY + d) : '';\nconst toJid = e164 => e164 ? `${e164}@s.whatsapp.net` : '';\n\nconst out = [];\nconst seen = new Set();\n\nfor (const { json } of items) {\n  // prioriza o j√° normalizado; cai para o bruto se precisar\n  const rawDigits = onlyDigits(json.phone_e164 || json.phone_raw);\n  if (!rawDigits) continue;\n\n  const e164 = toE164NoPlus(rawDigits); // sem sinal de +\n  if (!e164) continue;\n\n  if (seen.has(e164)) continue;\n  seen.add(e164);\n\n  const firstName = String(json.name || '').trim().split(/\\s+/)[0] || '';\n\n  out.push({\n    json: {\n      ...json,\n      e164,                  // ex: 5511999999999\n      jid: toJid(e164),      // ex: 5511999999999@s.whatsapp.net\n      firstName\n    }\n  });\n}\n\nreturn out;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3552,288],"id":"1f123d4c-32a9-4f35-8abb-2ec74bcf1d3b","name":"Normalizar telefone e criar JID"},{"parameters":{"batchSize":"=1","options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[4048,400],"id":"d8684a20-8850-4f11-9021-5c596822aeb4","name":"Loop Over Items1"},{"parameters":{"amount":"={{ 3 + Math.floor(Math.random() * 5) }}"},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[4288,416],"id":"ea6e37aa-6ce2-45cd-8246-d814656e7948","name":"Wait","webhookId":"6686e364-432c-466f-ac33-321c79f8a8a1"},{"parameters":{"resource":"messages-api","operation":"send-image","instanceName":"social-media-finamob-oficial","remoteJid":"120363418841788220@g.us","media":"={{ $json.base64 }}","caption":"={{ $('Get row(s) in sheet').item.json.legenda }}\n\nhttps://www.instagram.com/escoladomercadoimobiliario/","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[3120,32],"id":"76347bf3-d6bb-48da-8749-7bed3c51d02a","name":"Envio do post - Comunidade Whatsapp","credentials":{"evolutionApi":{"id":"4JfTThlwBUF4KuNE","name":"Evolution - social-media-finamob-oficial"}},"disabled":true,"onError":"continueRegularOutput"},{"parameters":{"resource":"messages-api","operation":"send-image","instanceName":"social-media-finamob-oficial","remoteJid":"={{ $json.jid }}","media":"={{ $json.base64 }}","caption":"=Oi , {{ $json.firstName }} tudo bem?\n\nSegue mais uma not√≠cia sobre o mercado imobili√°rio!\n\n{{ $('Get row(s) in sheet').item.json.legenda }}\n\nhttps://www.instagram.com/imobjournal.ia\n\nSe n√£o quiser mais receber not√≠cias no seu celular responda essa mensagem com \"opt-out\".","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[4480,416],"id":"835ed0b7-2ff8-4053-be5b-5f7c707fe620","name":"Envio do post - Journal List","credentials":{"evolutionApi":{"id":"4JfTThlwBUF4KuNE","name":"Evolution - social-media-finamob-oficial"}},"onError":"continueRegularOutput"},{"parameters":{"url":"https://api.stripe.com/v1/subscriptions?status=active&price=price_1S1SraRuKlw6o0HgiTFNxo5L&expand[]=data.customer","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[3120,288],"id":"a4876114-3324-4db8-a04b-22500fc0d325","name":"HTTP Request","credentials":{"httpBasicAuth":{"id":"PVN6vyGsqfocZ4rZ","name":"Stripe"}}},{"parameters":{"jsCode":"// items[0].json √© o objeto \"list\" do Stripe com data=[...]\nconst list = items[0].json;\nconst subs = Array.isArray(list?.data) ? list.data : [];\nconst now = Math.floor(Date.now() / 1000);\n\n// Valida√ß√£o estrita de telefone BR -> E.164, sem completar DDD.\n// Aceita: \"+55\" + 10 ou 11 d√≠gitos, ou \"55\" + 10/11 d√≠gitos (sem +).\nfunction toE164StrictBR(raw) {\n  const s = String(raw || '').trim();\n  if (!s) return { e164: '', ok: false, motivo: 'sem_telefone' };\n\n  // \"+55\" + 10/11 d√≠gitos\n  if (/^\\+55\\d{10,11}$/.test(s)) return { e164: s, ok: true, motivo: '' };\n\n  // \"55\" + 10/11 d√≠gitos (sem \"+\")\n  if (/^55\\d{10,11}$/.test(s)) return { e164: `+${s}`, ok: true, motivo: '' };\n\n  // qualquer outra coisa = inv√°lido / possivelmente sem DDD\n  return { e164: '', ok: false, motivo: 'telefone_mal_formatado_ou_sem_ddd' };\n}\n\nconst out = [];\n\nfor (const s of subs) {\n  const c = s.customer || {};\n  const phone_raw = c.phone || c.metadata?.whatsapp || '';\n\n  const { e164: phone_e164, ok: phone_ok, motivo: motivoFone } = toE164StrictBR(phone_raw);\n\n  const status_stripe = s.status || '';\n  const cancel_at     = s.cancel_at || null;\n  const period_end    = s.current_period_end || null;\n  const paid_until    = period_end ? new Date(period_end * 1000).toISOString().slice(0, 10) : '';\n\n  // Ativo no Stripe (sem considerar telefone)\n  const stripeAtivo = (status_stripe === 'active') &&\n                      (!cancel_at) &&\n                      (!period_end || period_end >= now);\n\n  // Deriva√ß√£o do status_final\n  let status_final = 'inativo';\n  let motivo = '';\n\n  if (!phone_raw) {\n    status_final = 'validar';\n    motivo = 'sem_telefone';\n  } else if (!phone_ok) {\n    status_final = 'validar';\n    motivo = motivoFone; // mal formatado / sem DDD\n  } else if (stripeAtivo) {\n    status_final = 'ativo';\n  } else {\n    status_final = 'inativo';\n    motivo = status_stripe !== 'active' ? `status_${status_stripe}` :\n             cancel_at ? 'cancelado_ao_fim_do_ciclo' :\n             (period_end && period_end < now) ? 'periodo_vencido' : '';\n  }\n\n  out.push({\n    json: {\n      name: c.name || '',\n      email: c.email || '',\n      phone_raw,              // exatamente como veio do Stripe\n      phone_e164,             // s√≥ se v√°lido sem \"chute\"\n      stripe_customer_id: c.id || '',\n      stripe_subscription_id: s.id,\n      status_stripe,\n      cancel_at,\n      paid_until,\n      status_final,           // ativo | inativo | validar\n      motivo                  // ajuda a entender por que est√° \"validar\" ou \"inativo\"\n    }\n  });\n}\n\nreturn out;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3328,288],"id":"44bc251f-5eee-4856-9281-65deeab703d1","name":"Code4"}],"connections":{"AI Agent":{"main":[[{"node":"Code","type":"main","index":0}]]},"Trigger nova noticia no sheets":{"main":[[{"node":"Noticias aguardando aprova√ß√£o","type":"main","index":0},{"node":"Noticias Postadas","type":"main","index":0}]]},"Noticias aguardando aprova√ß√£o":{"main":[[{"node":"Merge","type":"main","index":0}]]},"gpt-4.1-mini":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"Code":{"main":[[{"node":"Atualizar status da noticia","type":"main","index":0},{"node":"Get row(s) in sheet","type":"main","index":0}]]},"Code1":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"Noticias Postadas":{"main":[[{"node":"Code2","type":"main","index":0}]]},"Code2":{"main":[[{"node":"Merge","type":"main","index":1}]]},"Merge":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Get row(s) in sheet":{"main":[[{"node":"Search files and folders","type":"main","index":0}]]},"Search files and folders":{"main":[[{"node":"Download file","type":"main","index":0}]]},"Download file":{"main":[[{"node":"Code3","type":"main","index":0}]]},"Code3":{"main":[[{"node":"Merge1","type":"main","index":1},{"node":"HTTP Request","type":"main","index":0}]]},"Normalizar telefone e criar JID":{"main":[[{"node":"Merge1","type":"main","index":0}]]},"Loop Over Items1":{"main":[[],[{"node":"Wait","type":"main","index":0}]]},"Merge1":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"Wait":{"main":[[{"node":"Envio do post - Journal List","type":"main","index":0}]]},"Envio do post - Comunidade Whatsapp":{"main":[[]]},"Envio do post - Journal List":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"Code4","type":"main","index":0}]]},"Code4":{"main":[[{"node":"Normalizar telefone e criar JID","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","executionTimeout":-1,"errorWorkflow":"Cem9y3zmcggUQhrp"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]},"node:Google Sheets Trigger":{"documentId":"1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0","sheetId":0,"lastRevision":271,"lastRevisionLink":"https://docs.google.com/spreadsheets/export?id=1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0&revision=271&exportFormat=xlsx"},"node:Schedule Trigger1":{"recurrenceRules":[]},"node:Trigger nova noticia no sheets":{"documentId":"1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0","sheetId":0,"lastRevision":2130,"lastRevisionLink":"https://docs.google.com/spreadsheets/export?id=1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0&revision=2130&exportFormat=xlsx"}},"meta":{"templateCredsSetupCompleted":true},"pinData":{"Trigger nova noticia no sheets":[{"json":{"row_number":689,"change_type":"added","noticia_id":"noticia_20250922_133101_001","data_processamento":45922,"titulo":"Reforma do IR pode afetar lucro e investimentos no mercado imobili√°rio","legenda":"O deputado Hugo Motta anunciou que a proposta de reforma do Imposto de Renda ser√° levada ao plen√°rio da C√¢mara na pr√≥xima semana. Al√©m disso, ele informou que o texto da reforma administrativa ser√° entregue nos pr√≥ximos dias. Essas mudan√ßas envolvem ajustes em tributos que incidem sobre pessoas f√≠sicas e jur√≠dicas, incluindo as empresas do setor imobili√°rio.\n\nO Imposto de Renda √© um tributo federal que incide sobre a renda e o lucro de pessoas e empresas. No caso das companhias, como incorporadoras e construtoras, ele incide sobre os lucros apurados, influenciando a rentabilidade e o caixa para novos investimentos. A reforma administrativa, por sua vez, pode alterar regras do funcionalismo p√∫blico, impactando despesas governamentais e pol√≠ticas de urbanismo.\n\nPara incorporadores e investidores, a revis√£o do Imposto de Renda pode afetar a carga tribut√°ria e a capacidade de reinvestimento dos lucros em novos projetos. Mudan√ßas no regime de tributa√ß√£o podem alterar a rentabilidade esperada, influenciando decis√µes de financiamento e aquisi√ß√£o de terrenos. A reforma administrativa pode alterar o ambiente regulat√≥rio e os prazos para aprova√ß√µes urban√≠sticas, impactando cronogramas e custos.\n\nVoc√™ acredita que a reforma do IR poder√° facilitar ou complicar os investimentos no setor imobili√°rio? Qual o impacto dessa incerteza tribut√°ria para suas estrat√©gias atuais de desenvolvimento e capta√ß√£o de recursos? Compartilhe sua vis√£o nos coment√°rios.\n\nSiga @imobjournal.ia para ficar por dentro das principais not√≠cias do mercado imobili√°rio!","fonte":"https://www.camara.leg.br/noticias/1202722-hugo-motta-quer-levar-imposto-de-renda-ao-plenario-na-proxima-semana/","imagem":"https://www.camara.leg.br/midias/image/2025/09/img20250918154754454-768x473.jpg","arquivo_base64":"noticia_20250922_133101_001.txt","imagem_url":"https://raw.githubusercontent.com/getmia/miabuilder-images/main/images/20250922133059174.jpg","imagem_url2":"https://raw.githubusercontent.com/getmia/miabuilder-images/main/images/202509221331007552.jpg","status":"aguardando","nota":8,"justificativa":"","output":""}}]},"versionId":"dbe626f8-e0ff-4d19-8e34-ccc0a06ed282","triggerCount":1,"tags":[]}