{"createdAt":"2025-09-24T21:05:55.294Z","updatedAt":"2025-11-10T01:42:03.970Z","id":"FQ85KEmkO3Tr1eok","name":"Finamob - 5.3 - SDR Luana IA - Calendar","active":false,"isArchived":false,"nodes":[{"parameters":{"content":"## Preparacao de valores","height":1232,"width":816,"color":7},"type":"n8n-nodes-base.stickyNote","position":[-272,64],"typeVersion":1,"id":"248f34df-01f4-4552-bcb6-99a516e13788","name":"Sticky Note"},{"parameters":{"mode":"raw","jsonOutput":"{\n  \"timezone\": \"America/Sao_Paulo\",\n  \"timeBetweenMeetingsMinutes\": 30,\n  \"schedule\": [\n    {\n      \"day\": \"SEG\",\n      \"available\": true,\n      \"hours\": [\n        { \"after\": \"10:00\", \"before\": \"12:00\" },\n        { \"after\": \"14:00\", \"before\": \"18:00\" }\n      ]\n    },\n    {\n      \"day\": \"TER\",\n      \"available\": true,\n      \"hours\": [\n        { \"after\": \"10:00\", \"before\": \"12:00\" },\n        { \"after\": \"14:00\", \"before\": \"18:00\" }\n      ]\n    },\n    {\n      \"day\": \"QUA\",\n      \"available\": true,\n      \"hours\": [\n        { \"after\": \"10:00\", \"before\": \"12:00\" },\n        { \"after\": \"14:00\", \"before\": \"18:00\" }\n      ]\n    },\n    {\n      \"day\": \"QUI\",\n      \"available\": true,\n      \"hours\": [\n        { \"after\": \"10:00\", \"before\": \"12:00\" },\n        { \"after\": \"14:00\", \"before\": \"18:00\" }\n      ]\n    },\n    {\n      \"day\": \"SEX\",\n      \"available\": true,\n      \"hours\": [\n        { \"after\": \"10:00\", \"before\": \"12:00\" },\n        { \"after\": \"14:00\", \"before\": \"18:00\" }\n      ]\n    },\n    {\n      \"day\": \"SAB\",\n      \"available\": false,\n      \"hours\": []\n    },\n    {\n      \"day\": \"DOM\",\n      \"available\": false,\n      \"hours\": []\n    }\n  ]\n}\n","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[48,640],"id":"46a7f986-5383-4212-a951-7ed0284395a3","name":"Definir Agenda"},{"parameters":{"inputSource":"jsonExample","jsonExample":"{\n\"type\": \"listarHorarios\",\n\"tema\": \"funding imobiliario\",\n\"dia\": \"2025-09-10\",\n\"horario\": \"2025-09-10\",\n\"email\": \"usuario@email.com\",\n\"telefone\": \"5511999999999\",\n\"nome\": \"Jo√£o da Silva\",\n\"empresa\": \"Empresa X\"\n}"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-192,640],"id":"375f255c-daea-4bd8-96f0-93e3f4149abd","name":"trigger"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('trigger').item.json.type }}","rightValue":"listarHorarios","operator":{"type":"string","operation":"equals"},"id":"2d821077-bb35-4636-ac10-7ad6c459876b"}],"combinator":"and"},"renameOutput":true,"outputKey":"listarHorarios"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2c971151-b71a-4f4e-9e2a-222c8047ce1a","leftValue":"={{ $('trigger').item.json.type }}","rightValue":"agendarReuniao","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"agendarReuniao"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c547c9e1-f130-4390-9088-65fd9282edfc","leftValue":"={{ $('trigger').item.json.type }}","rightValue":"encontrarReuniao","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"encontrarReuniao"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"de18d8e3-b6df-4754-940b-2b534d4e4ce1","leftValue":"={{ $('trigger').item.json.type }}","rightValue":"mudarReuniao","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"mudarReuniao"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4260bfd0-cf2f-4f30-a395-69e4e4bc95be","leftValue":"={{ $('trigger').item.json.type }}","rightValue":"cancelarReuniao","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"cancelarReuniao"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[240,592],"id":"bf913c97-bffb-4e0a-ab9e-720b18085592","name":"Switch2"},{"parameters":{"content":"## Mudar Evento","height":384,"width":1600,"color":2},"type":"n8n-nodes-base.stickyNote","position":[608,912],"typeVersion":1,"id":"920b1a35-7493-44c7-93f7-f55735f80485","name":"Sticky Note8"},{"parameters":{"operation":"getAll","calendar":{"__rl":true,"value":"nicolas.pereira022022@gmail.com","mode":"list","cachedResultName":"nicolas.pereira022022@gmail.com"},"returnAll":true,"timeMax":"={{ $now.plus({ week: 2 }) }}","options":{}},"type":"n8n-nodes-base.googleCalendar","typeVersion":1.3,"position":[672,1056],"id":"86f39e32-88b5-463d-8c2a-57fac873c2f7","name":"Listar Eventos4","credentials":{"googleCalendarOAuth2Api":{"id":"iXoqyD421T6fmy1X","name":"Google Calendar account"}}},{"parameters":{"jsCode":"// --- Email vindo do node \"trigger\" (flat) ou do pr√≥prio item atual como fallback\nconst emailTrigger = String(\n  $node[\"trigger\"]?.json?.email ?? $json?.email ?? \"\"\n).trim().toLowerCase();\n\nif (!emailTrigger) {\n  return [{ json: { error: \"email ausente no trigger\" } }];\n}\n\n// --- Todos os items que chegam neste Code (devem ser os eventos)\nconst items = await $input.all();\n\n// --- Mant√©m s√≥ eventos onde attendees cont√©m o e-mail do trigger\nconst filtrados = items.filter(it => {\n  const attendees = it.json?.attendees;\n  return Array.isArray(attendees) &&\n    attendees.some(a => String(a.email || \"\").trim().toLowerCase() === emailTrigger);\n});\n\n// --- Sa√≠da\nreturn filtrados;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[880,1056],"id":"87beb55a-2346-49c1-927f-3386aeb4ae0c","name":"Filtrar Eventos"},{"parameters":{"jsCode":"// Entram aqui os eventos j√° filtrados (cada item = 1 evento)\nconst items = await $input.all();\n\nif (!items.length) {\n  return [{ json: { mensagem: \"N√£o encontrei eventos para esse e-mail.\", eventos: [] } }];\n}\n\nconst TZ = \"America/Sao_Paulo\";\n\n// helpers\nconst toDate = (d) => d ? new Date(d) : null;\nconst sameYmd = (a, b) => a.toLocaleString(\"sv-SE\", { timeZone: TZ }).slice(0,10) === b.toLocaleString(\"sv-SE\", { timeZone: TZ }).slice(0,10);\n\n// hoje (SP)\nconst agora = new Date();\nconst hojeSP = new Date(new Date().toLocaleString(\"en-US\", { timeZone: TZ }));\n\n// normaliza -> filtra inv√°lidos -> filtra futuros e n√£o-hoje -> ordena\nconst normalizados = items\n  .map((it) => it.json)\n  .map((ev) => {\n    const start = toDate(ev.start?.dateTime || ev.start);\n    const end   = toDate(ev.end?.dateTime   || ev.end);\n    return { ev, start, end, tz: ev.start?.timeZone || TZ };\n  })\n  .filter(x => x.ev?.id && x.start instanceof Date && !isNaN(x.start))\n  .filter(x => x.start > agora && !sameYmd(x.start, hojeSP))\n  .sort((a, b) => a.start - b.start);\n\nif (!normalizados.length) {\n  return [{ json: { mensagem: \"N√£o h√° eventos futuros (exceto hoje).\", eventos: [] } }];\n}\n\nfunction fmtLinha(x, i) {\n  const ev = x.ev;\n  const tz = x.tz;\n  const s = x.start;\n  const e = x.end instanceof Date && !isNaN(x.end) ? x.end : null;\n\n  const dia   = s.toLocaleDateString(\"pt-BR\", { timeZone: tz });\n  const hIni  = s.toLocaleTimeString(\"pt-BR\", { timeZone: tz, hour: \"2-digit\", minute: \"2-digit\" });\n  const hFim  = e ? e.toLocaleTimeString(\"pt-BR\", { timeZone: tz, hour: \"2-digit\", minute: \"2-digit\" }) : null;\n\n  return {\n    numero: i + 1,\n    id: ev.id,\n    assunto: ev.summary || \"Sem t√≠tulo\",\n    dia,\n    horaInicio: hIni,\n    horaFim: hFim,\n    timezone: tz,\n    link: ev.htmlLink || ev.hangoutLink || null,\n  };\n}\n\nconst essenciais = normalizados.map(fmtLinha);\n\n// monta mensagem (limita a 10 linhas para n√£o estourar UI)\nconst linhasMsg = essenciais.slice(0, 10).map(e =>\n  `${e.numero} - ${e.assunto}, ${e.dia}, ${e.horaInicio}${e.horaFim ? \"-\" + e.horaFim : \"\"}, id ${e.id}`\n);\n\nconst mensagem =\n  `Temos os seguintes eventos nesse e-mail:\\n\\n` +\n  linhasMsg.join(\"\\n\") +\n  `\\n\\nMe informe o n√∫mero do evento que voc√™ deseja alterar ou cancelar.`;\n\nreturn [{\n  json: {\n    mensagem,\n    eventos: essenciais,\n    numeroParaId: Object.fromEntries(essenciais.map(e => [String(e.numero), e.id]))\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1088,1056],"id":"47e8cd42-4c1a-4c6e-b986-c272d77f2af2","name":"Response"},{"parameters":{"operation":"update","calendar":{"__rl":true,"mode":"list","value":""},"updateFields":{}},"type":"n8n-nodes-base.googleCalendar","typeVersion":1.3,"position":[672,1488],"id":"d31a38ee-c783-4dbe-80ef-498cd535bb6d","name":"Update an event","credentials":{"googleCalendarOAuth2Api":{"id":"iXoqyD421T6fmy1X","name":"Google Calendar account"}},"disabled":true},{"parameters":{"content":"## Reagendar Consulta","height":352,"width":1600,"color":2},"type":"n8n-nodes-base.stickyNote","position":[608,1344],"typeVersion":1,"id":"4817c68d-d0f4-415f-ad37-1b99cad456fd","name":"Sticky Note7"},{"parameters":{"content":"## Cancelar Consulta","height":352,"width":1600,"color":3},"type":"n8n-nodes-base.stickyNote","position":[608,1728],"typeVersion":1,"id":"98dda3e1-30c6-43f7-8fb7-a0549f8d83bf","name":"Sticky Note6"},{"parameters":{"assignments":{"assignments":[{"id":"383df707-d58b-4770-a5d8-aa14b37d6d3d","name":"response","value":"Como voc√™ sabe, sou a Emi, uma agente de IA üòä. Ainda n√£o me treinaram para reagendar ou cancelar reuni√µes por aqui. Pode fazer direto no Google Calendar ou falar com o especialista por e-mail ‚Äî voc√™ consegue sugerir as mudan√ßas por l√°. Tenho certeza de que logo, logo chega o meu treinamento pra eu fazer isso por voc√™ por aqui!  Quer que eu te ajude com mais alguma coisa agora?","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1296,1056],"id":"23cb4209-5be0-4867-a15f-2bc6658fcea5","name":"response2"},{"parameters":{"resource":"messages-api","instanceName":"social-media-finamob-oficial","remoteJid":"5511992486507","messageText":"Evento criado","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1904,704],"id":"3a358de6-ecf2-481a-a0c6-eb23260a5ce0","name":"Enviar texto","credentials":{"evolutionApi":{"id":"4JfTThlwBUF4KuNE","name":"Evolution - social-media-finamob-oficial"}}},{"parameters":{"content":"## Buscar Horarios","height":352,"width":1600,"color":5},"type":"n8n-nodes-base.stickyNote","position":[608,64],"typeVersion":1,"id":"560c737a-86db-41c9-99b6-b8eecf0a9046","name":"Sticky Note9"},{"parameters":{"content":"## Marcar Consulta","height":432,"width":1600,"color":4},"type":"n8n-nodes-base.stickyNote","position":[608,448],"typeVersion":1,"id":"7b548d43-3e26-40c8-bdaf-e2186251360c","name":"Sticky Note10"},{"parameters":{"calendar":{"__rl":true,"value":"nicolas.pereira022022@gmail.com","mode":"list","cachedResultName":"nicolas.pereira022022@gmail.com"},"start":"={{ $json.dados.inicio.dateTime }}","end":"={{ $json.dados.fim.dateTime }}","additionalFields":{"attendees":["={{ $json.dados.email }}"],"description":"=whatsapp  {{ $json.dados.nome }}: {{ $json.dados.telefone }}","summary":"=Reuni√£o Finamob com {{ $json.dados.nome }} - {{ $json.dados.empresa }}"}},"type":"n8n-nodes-base.googleCalendar","typeVersion":1.3,"position":[1648,704],"id":"de5c1032-2b33-4175-ac31-8a6bfb7678ac","name":"agendar consulta","credentials":{"googleCalendarOAuth2Api":{"id":"iXoqyD421T6fmy1X","name":"Google Calendar account"}}},{"parameters":{"jsCode":"// === Pega a agenda (objeto √∫nico) ===\nconst agenda = $node[\"Definir Agenda\"].json;\n\n// === Pega todos os eventos (array de items) ===\nconst eventosRaw = $items(\"Listar Eventos2\").map(item => item.json);\n\n// Normaliza eventos garantindo timezone coerente\nconst eventos = eventosRaw.map(ev => ({\n  start: new Date(ev.start.dateTime),\n  end: new Date(ev.end.dateTime),\n}));\n\nconst intervaloMin = agenda.timeBetweenMeetingsMinutes;\nconst diasSemana = { DOM: 0, SEG: 1, TER: 2, QUA: 3, QUI: 4, SEX: 5, SAB: 6 };\n\n// TZ e string do dia corrente (YYYY-MM-DD) no fuso da agenda\nconst tz = agenda.timezone || \"America/Sao_Paulo\";\nconst hojeStr = new Date().toLocaleString(\"sv-SE\", { timeZone: tz }).slice(0,10);\n\n// Fun√ß√£o auxiliar: pr√≥xima data para um dia da semana (pode retornar hoje)\nfunction getProximaData(dia) {\n  const hoje = new Date();\n  let data = new Date(hoje);\n  while (data.getDay() !== diasSemana[dia]) {\n    data.setDate(data.getDate() + 1);\n  }\n  return data;\n}\n\n// === Gera√ß√£o dos slots dispon√≠veis ===\nlet slotsLivres = [];\n\nfor (const dia of agenda.schedule) {\n  if (!dia.available) continue;\n\n  const dataAlvo = getProximaData(dia.day);\n\n  // Garante que hours seja sempre array\n  const faixas = Array.isArray(dia.hours) ? dia.hours : [dia.hours];\n\n  for (const faixa of faixas) {\n    const [hIni, mIni] = faixa.after.split(\":\").map(Number);\n    const [hFim, mFim] = faixa.before.split(\":\").map(Number);\n\n    const inicioDia = new Date(dataAlvo);\n    inicioDia.setHours(hIni, mIni, 0, 0);\n\n    const fimDia = new Date(dataAlvo);\n    fimDia.setHours(hFim, mFim, 0, 0);\n\n    let current = new Date(inicioDia);\n\n    while (current < fimDia) {\n      const next = new Date(current.getTime() + intervaloMin * 60000);\n      if (next > fimDia) break;\n\n      // Exclui qualquer slot do dia corrente (no fuso da agenda)\n      const currentDiaStr = current.toLocaleString(\"sv-SE\", { timeZone: tz }).slice(0,10);\n      if (currentDiaStr === hojeStr) { current = next; continue; }\n\n      // Checa conflito com eventos\n      const ocupado = eventos.some(ev => current < ev.end && next > ev.start);\n\n      if (!ocupado) {\n        slotsLivres.push({\n          day: dia.day,\n          start: current.toLocaleString(\"sv-SE\", { timeZone: tz }).replace(\" \", \"T\") + \":00.000Z\",\n          end:   next.toLocaleString(\"sv-SE\",   { timeZone: tz }).replace(\" \", \"T\") + \":00.000Z\",\n        });\n      }\n\n      current = next;\n    }\n  }\n}\n\nreturn slotsLivres;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[880,208],"id":"33ee8c47-f4ed-434b-aaae-3e5cc3ad1464","name":"Slots Disponiveis2"},{"parameters":{"operation":"getAll","calendar":{"__rl":true,"value":"nicolas.pereira022022@gmail.com","mode":"list","cachedResultName":"nicolas.pereira022022@gmail.com"},"returnAll":true,"timeMax":"={{ $now.plus({ week: 2 }) }}","options":{}},"type":"n8n-nodes-base.googleCalendar","typeVersion":1.3,"position":[672,208],"id":"1e13d284-578b-4853-be7f-e8c568018d33","name":"Listar Eventos2","credentials":{"googleCalendarOAuth2Api":{"id":"iXoqyD421T6fmy1X","name":"Google Calendar account"}}},{"parameters":{"jsCode":"// === Pega a agenda (objeto √∫nico) ===\nconst agenda = $node[\"Definir Agenda\"].json;\n\n// === Pega todos os eventos (array de items) ===\nconst eventosRaw = $items(\"Listar Eventos3\").map(item => item.json);\n\n// Normaliza eventos garantindo timezone coerente\nconst eventos = eventosRaw.map(ev => ({\n  start: new Date(ev.start.dateTime),\n  end: new Date(ev.end.dateTime),\n}));\n\nconst intervaloMin = agenda.timeBetweenMeetingsMinutes;\nconst diasSemana = { DOM: 0, SEG: 1, TER: 2, QUA: 3, QUI: 4, SEX: 5, SAB: 6 };\n\n// TZ e string do dia corrente (YYYY-MM-DD) no fuso da agenda\nconst tz = agenda.timezone || \"America/Sao_Paulo\";\nconst hojeStr = new Date().toLocaleString(\"sv-SE\", { timeZone: tz }).slice(0,10);\n\n// Fun√ß√£o auxiliar: pr√≥xima data para um dia da semana (pode retornar hoje)\nfunction getProximaData(dia) {\n  const hoje = new Date();\n  let data = new Date(hoje);\n  while (data.getDay() !== diasSemana[dia]) {\n    data.setDate(data.getDate() + 1);\n  }\n  return data;\n}\n\n// === Gera√ß√£o dos slots dispon√≠veis ===\nlet slotsLivres = [];\n\nfor (const dia of agenda.schedule) {\n  if (!dia.available) continue;\n\n  const dataAlvo = getProximaData(dia.day);\n\n  // Garante que hours seja sempre array\n  const faixas = Array.isArray(dia.hours) ? dia.hours : [dia.hours];\n\n  for (const faixa of faixas) {\n    const [hIni, mIni] = faixa.after.split(\":\").map(Number);\n    const [hFim, mFim] = faixa.before.split(\":\").map(Number);\n\n    const inicioDia = new Date(dataAlvo);\n    inicioDia.setHours(hIni, mIni, 0, 0);\n\n    const fimDia = new Date(dataAlvo);\n    fimDia.setHours(hFim, mFim, 0, 0);\n\n    let current = new Date(inicioDia);\n\n    while (current < fimDia) {\n      const next = new Date(current.getTime() + intervaloMin * 60000);\n      if (next > fimDia) break;\n\n      // Exclui qualquer slot do dia corrente (no fuso da agenda)\n      const currentDiaStr = current.toLocaleString(\"sv-SE\", { timeZone: tz }).slice(0,10);\n      if (currentDiaStr === hojeStr) { current = next; continue; }\n\n      // Checa conflito com eventos\n      const ocupado = eventos.some(ev => current < ev.end && next > ev.start);\n\n      if (!ocupado) {\n        slotsLivres.push({\n          day: dia.day,\n          start: current.toLocaleString(\"sv-SE\", { timeZone: tz }).replace(\" \", \"T\") + \":00.000Z\",\n          end:   next.toLocaleString(\"sv-SE\",   { timeZone: tz }).replace(\" \", \"T\") + \":00.000Z\",\n        });\n      }\n\n      current = next;\n    }\n  }\n}\n\nreturn slotsLivres;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[880,608],"id":"d437c475-0441-4e74-91af-d989b01ba705","name":"Slots Disponiveis3"},{"parameters":{"operation":"getAll","calendar":{"__rl":true,"value":"nicolas.pereira022022@gmail.com","mode":"list","cachedResultName":"nicolas.pereira022022@gmail.com"},"returnAll":true,"timeMax":"={{ $now.plus({ week: 2 }) }}","options":{}},"type":"n8n-nodes-base.googleCalendar","typeVersion":1.3,"position":[672,608],"id":"56e80058-0809-4fe8-82da-1d83697f1013","name":"Listar Eventos3","credentials":{"googleCalendarOAuth2Api":{"id":"iXoqyD421T6fmy1X","name":"Google Calendar account"}}},{"parameters":{"jsCode":"// === Pega o 1¬∫ item do trigger (se o Code estiver em \"Run Once for All Items\")\nconst input = $items(\"trigger\")[0].json;\n// Se seu Code estiver em \"Run Once for Each Item\", use:\n// const input = $json;\n\nconst { dia, horario, nome, empresa, email, telefone } = input;\n\n// === TZ e \"hoje\" no fuso de SP ===\nconst tz = \"America/Sao_Paulo\";\nconst hojeStr = new Date().toLocaleString(\"sv-SE\", { timeZone: tz }).slice(0, 10); // YYYY-MM-DD\n\n// === Pega a lista de slots dispon√≠veis (array de items) e remove os de hoje ===\n// Os slots j√° v√™m como \"YYYY-MM-DDTHH:MM:SS\" (sem timezone). Use compara√ß√£o por string.\nconst slots = $items(\"Slots Disponiveis3\")\n  .map(item => item.json)\n  .filter(slot => {\n    const slotDia = String(slot.start).slice(0, 10); // YYYY-MM-DD\n    return slotDia > hojeStr; // exclui o dia corrente\n  });\n\n// Normaliza slot solicitado (yyyy-mm-ddTHH:MM)\nconst solicitadoKey = `${dia}T${horario}`;\n\n// Procura se o slot solicitado est√° na lista\nconst encontrado = slots.find(slot => {\n  const sKey = String(slot.start).substring(0, 16); // yyyy-mm-ddTHH:MM\n  return sKey === solicitadoKey;\n});\n\n// Garante formato \"YYYY-MM-DDTHH:MM:SS\" (sem timezone)\nfunction toYYYYMMDDTHHMMSS(s) {\n  return String(s).substring(0, 19);\n}\n\nif (encontrado) {\n  return [{\n    json: {\n      status: \"ok\",\n      message: `Hor√°rio dispon√≠vel: ${dia} ${horario}. Pode agendar.`,\n      dados: {\n        nome,\n        empresa,\n        email,\n        telefone,\n        inicio: { dateTime: toYYYYMMDDTHHMMSS(encontrado.start), timeZone: tz },\n        fim:    { dateTime: toYYYYMMDDTHHMMSS(encontrado.end),   timeZone: tz }\n      }\n    }\n  }];\n} else {\n  // Agrupa slots por dia\n  const slotsPorDia = {};\n  for (const slot of slots) {\n    const d = String(slot.start).split(\"T\")[0];\n    (slotsPorDia[d] ||= []).push(slot);\n  }\n  // Ordena slots por hor√°rio dentro de cada dia\n  for (const d in slotsPorDia) {\n    slotsPorDia[d].sort((a, b) => new Date(a.start) - new Date(b.start));\n  }\n\n  // Descobre os dias alvo: anterior, mesmo, seguinte\n  const solicitadoDia = dia;\n  const diaAnterior = new Date(`${dia}T00:00:00`);\n  diaAnterior.setDate(diaAnterior.getDate() - 1);\n  const diaSeguinte = new Date(`${dia}T00:00:00`);\n  diaSeguinte.setDate(diaSeguinte.getDate() + 1);\n\n  const prev = diaAnterior.toISOString().split(\"T\")[0];\n  const next = diaSeguinte.toISOString().split(\"T\")[0];\n\n  // Pega no m√≠nimo 2 e no m√°ximo 6 alternativas\n  let alternativas = [\n    ...(slotsPorDia[prev]?.slice(0, 2) || []),\n    ...(slotsPorDia[solicitadoDia]?.slice(0, 2) || []),\n    ...(slotsPorDia[next]?.slice(0, 2) || []),\n  ];\n\n  // Se ainda n√£o tiver 2, expande at√© 7 dias\n  let offset = 2;\n  while (alternativas.length < 2 && offset <= 7) {\n    const before = new Date(`${dia}T00:00:00`); before.setDate(before.getDate() - offset);\n    const after  = new Date(`${dia}T00:00:00`); after.setDate(after.getDate() + offset);\n    alternativas = [\n      ...alternativas,\n      ...(slotsPorDia[before.toISOString().split(\"T\")[0]]?.slice(0, 2) || []),\n      ...(slotsPorDia[after.toISOString().split(\"T\")[0]]?.slice(0, 2) || []),\n    ];\n    offset++;\n  }\n\n  alternativas = alternativas.slice(0, 6).map(slot => ({\n    inicio: { dateTime: toYYYYMMDDTHHMMSS(slot.start), timeZone: tz },\n    fim:    { dateTime: toYYYYMMDDTHHMMSS(slot.end),   timeZone: tz }\n  }));\n\n  return [{\n    json: {\n      status: \"indisponivel\",\n      message: `O hor√°rio ${dia} ${horario} n√£o est√° dispon√≠vel.`,\n      alternativas\n    }\n  }];\n}\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1120,608],"id":"d13290a3-e28f-409a-9cdf-8f4b951bdada","name":"Code1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"597f2e89-0383-4155-ab3b-1a26a5037fc0","leftValue":"={{ $json.status }}","rightValue":"indisponivel","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1344,608],"id":"4dd077bf-7179-4abe-80bc-f766a783e617","name":"If"},{"parameters":{"assignments":{"assignments":[{"id":"ad1726fe-95a3-42ab-8b6c-836f7b37668e","name":"status","value":"={{ $json.message }}","type":"string"},{"id":"50e62759-8242-4df9-b4f7-b3891e645ff8","name":"alternativas","value":"={{ $json.alternativas }}","type":"array"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1648,480],"id":"e9669c9a-24ad-423d-bc54-d95d168f8016","name":"response1"}],"connections":{"Definir Agenda":{"main":[[{"node":"Switch2","type":"main","index":0}]]},"trigger":{"main":[[{"node":"Definir Agenda","type":"main","index":0}]]},"Switch2":{"main":[[{"node":"Listar Eventos2","type":"main","index":0}],[{"node":"Listar Eventos3","type":"main","index":0}],[{"node":"Listar Eventos4","type":"main","index":0}],[],[]]},"Listar Eventos4":{"main":[[{"node":"Filtrar Eventos","type":"main","index":0}]]},"Filtrar Eventos":{"main":[[{"node":"Response","type":"main","index":0}]]},"Response":{"main":[[{"node":"response2","type":"main","index":0}]]},"Listar Eventos2":{"main":[[{"node":"Slots Disponiveis2","type":"main","index":0}]]},"Slots Disponiveis3":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Listar Eventos3":{"main":[[{"node":"Slots Disponiveis3","type":"main","index":0}]]},"Code1":{"main":[[{"node":"If","type":"main","index":0}]]},"If":{"main":[[{"node":"response1","type":"main","index":0}],[{"node":"agendar consulta","type":"main","index":0}]]},"agendar consulta":{"main":[[]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"Cem9y3zmcggUQhrp"},"staticData":{"node:Stripe Trigger":{"webhookId":"we_1S45HZRuKlw6o0Hg4nRNx3O2","webhookEvents":["customer.subscription.created"],"webhookSecret":"whsec_u9SDEbFzkZY1tJcmw28bdoOkPw1RIb4p"}},"meta":{"templateCredsSetupCompleted":true},"pinData":{"trigger":[{"json":{"type":"agendarReuniao","tema":"imers√µes/club","dia":"2025-09-10","horario":"17:00","email":"lucas95_souza@hotmail.com","telefone":"11992486507","nome":"Lucas Andrade","empresa":"MDS"}}]},"versionId":"788497fd-cfab-4c6e-b682-02c1b7cb30c1","triggerCount":1,"tags":[]}