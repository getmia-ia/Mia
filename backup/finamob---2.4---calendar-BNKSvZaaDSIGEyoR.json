{"createdAt":"2025-09-07T15:29:16.927Z","updatedAt":"2025-10-06T14:39:58.982Z","id":"BNKSvZaaDSIGEyoR","name":"Finamob - 2.4 - Calendar","active":false,"isArchived":false,"nodes":[{"parameters":{"content":"## Preparacao de valores","height":1680,"width":1536,"color":7},"type":"n8n-nodes-base.stickyNote","position":[-992,48],"typeVersion":1,"id":"90d8d737-5b4d-4946-abad-35fe12cd14af","name":"Sticky Note"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('trigger').item.json.type }}","rightValue":"listarHorarios","operator":{"type":"string","operation":"equals"},"id":"2d821077-bb35-4636-ac10-7ad6c459876b"}],"combinator":"and"},"renameOutput":true,"outputKey":"listarHorarios"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2c971151-b71a-4f4e-9e2a-222c8047ce1a","leftValue":"={{ $('trigger').item.json.type }}","rightValue":"agendarReuniao","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"agendarReuniao"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[304,368],"id":"5136ca78-9f67-4fab-a2d6-19454e39d044","name":"Switch"},{"parameters":{"mode":"raw","jsonOutput":"{\n  \"timezone\": \"America/Sao_Paulo\",\n  \"timeBetweenMeetingsMinutes\": 30,\n  \"schedule\": [\n    {\n      \"day\": \"SEG\",\n      \"available\": true,\n      \"hours\": [\n        { \"after\": \"10:00\", \"before\": \"12:00\" },\n        { \"after\": \"14:00\", \"before\": \"18:00\" }\n      ]\n    },\n    {\n      \"day\": \"TER\",\n      \"available\": true,\n      \"hours\": [\n        { \"after\": \"10:00\", \"before\": \"12:00\" },\n        { \"after\": \"14:00\", \"before\": \"18:00\" }\n      ]\n    },\n    {\n      \"day\": \"QUA\",\n      \"available\": true,\n      \"hours\": [\n        { \"after\": \"10:00\", \"before\": \"12:00\" },\n        { \"after\": \"14:00\", \"before\": \"18:00\" }\n      ]\n    },\n    {\n      \"day\": \"QUI\",\n      \"available\": true,\n      \"hours\": [\n        { \"after\": \"10:00\", \"before\": \"12:00\" },\n        { \"after\": \"14:00\", \"before\": \"18:00\" }\n      ]\n    },\n    {\n      \"day\": \"SEX\",\n      \"available\": true,\n      \"hours\": [\n        { \"after\": \"10:00\", \"before\": \"12:00\" },\n        { \"after\": \"14:00\", \"before\": \"18:00\" }\n      ]\n    },\n    {\n      \"day\": \"SAB\",\n      \"available\": false,\n      \"hours\": []\n    },\n    {\n      \"day\": \"DOM\",\n      \"available\": false,\n      \"hours\": []\n    }\n  ]\n}\n","options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-672,816],"id":"e2c4319c-e4a7-462a-938d-19ba46a1c4a3","name":"Definir Agenda"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('trigger').item.json.type }}","rightValue":"listarHorarios","operator":{"type":"string","operation":"equals"},"id":"2d821077-bb35-4636-ac10-7ad6c459876b"}],"combinator":"and"},"renameOutput":true,"outputKey":"listarHorarios"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2c971151-b71a-4f4e-9e2a-222c8047ce1a","leftValue":"={{ $('trigger').item.json.type }}","rightValue":"agendarReuniao","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"agendarReuniao"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[272,1200],"id":"70956e57-43cc-4665-9d73-44429a6798f2","name":"Switch1"},{"parameters":{"content":"## Buscar Horarios","height":352,"width":1600,"color":5},"type":"n8n-nodes-base.stickyNote","position":[608,912],"typeVersion":1,"id":"27dbdc53-99d5-4295-aa9d-09d5c2638669","name":"Sticky Note4"},{"parameters":{"content":"## Marcar Consulta","height":432,"width":1600,"color":4},"type":"n8n-nodes-base.stickyNote","position":[608,1296],"typeVersion":1,"id":"973c15c8-d6d2-4f33-bad6-e37b96fd8b53","name":"Sticky Note5"},{"parameters":{"calendar":{"__rl":true,"value":"luizakrum@gmail.com","mode":"list","cachedResultName":"luizakrum@gmail.com"},"start":"={{ $json.dados.inicio.dateTime }}","end":"={{ $json.dados.fim.dateTime }}","additionalFields":{"attendees":["={{ $json.dados.email }}"],"description":"=whatsapp  {{ $json.dados.nome }}: {{ $json.dados.telefone }}","summary":"=Reunião Finamob com {{ $json.dados.nome }} - {{ $json.dados.empresa }}"}},"type":"n8n-nodes-base.googleCalendar","typeVersion":1.3,"position":[1648,1552],"id":"88a7a4cf-8ddb-4566-aedc-fe57910868d3","name":"agendar consulta1","credentials":{"googleCalendarOAuth2Api":{"id":"iXoqyD421T6fmy1X","name":"Google Calendar account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"47b114f4-f5eb-425b-81b3-6d8472f46cd7","leftValue":"={{ $('trigger').item.json.tema }}","rightValue":"imersões/club","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-32,768],"id":"7ed2bd74-c797-437c-b8ae-4d9058366496","name":"Definicao de Agenda"},{"parameters":{"jsCode":"// === Pega a agenda (objeto único) ===\nconst agenda = $node[\"Definir Agenda\"].json;\n\n// === Pega todos os eventos (array de items) ===\nconst eventosRaw = $items(\"Listar Eventos\").map(item => item.json);\n\n// Normaliza eventos garantindo timezone coerente\nconst eventos = eventosRaw.map(ev => ({\n  start: new Date(ev.start.dateTime),\n  end: new Date(ev.end.dateTime),\n}));\n\nconst intervaloMin = agenda.timeBetweenMeetingsMinutes;\nconst diasSemana = { DOM: 0, SEG: 1, TER: 2, QUA: 3, QUI: 4, SEX: 5, SAB: 6 };\n\n// TZ e string do dia corrente (YYYY-MM-DD) no fuso da agenda\nconst tz = agenda.timezone || \"America/Sao_Paulo\";\nconst hojeStr = new Date().toLocaleString(\"sv-SE\", { timeZone: tz }).slice(0,10);\n\n// Função auxiliar: próxima data para um dia da semana (pode retornar hoje)\nfunction getProximaData(dia) {\n  const hoje = new Date();\n  let data = new Date(hoje);\n  while (data.getDay() !== diasSemana[dia]) {\n    data.setDate(data.getDate() + 1);\n  }\n  return data;\n}\n\n// === Geração dos slots disponíveis ===\nlet slotsLivres = [];\n\nfor (const dia of agenda.schedule) {\n  if (!dia.available) continue;\n\n  const dataAlvo = getProximaData(dia.day);\n\n  // Garante que hours seja sempre array\n  const faixas = Array.isArray(dia.hours) ? dia.hours : [dia.hours];\n\n  for (const faixa of faixas) {\n    const [hIni, mIni] = faixa.after.split(\":\").map(Number);\n    const [hFim, mFim] = faixa.before.split(\":\").map(Number);\n\n    const inicioDia = new Date(dataAlvo);\n    inicioDia.setHours(hIni, mIni, 0, 0);\n\n    const fimDia = new Date(dataAlvo);\n    fimDia.setHours(hFim, mFim, 0, 0);\n\n    let current = new Date(inicioDia);\n\n    while (current < fimDia) {\n      const next = new Date(current.getTime() + intervaloMin * 60000);\n      if (next > fimDia) break;\n\n      // Exclui qualquer slot do dia corrente (no fuso da agenda)\n      const currentDiaStr = current.toLocaleString(\"sv-SE\", { timeZone: tz }).slice(0,10);\n      if (currentDiaStr === hojeStr) { current = next; continue; }\n\n      // Checa conflito com eventos\n      const ocupado = eventos.some(ev => current < ev.end && next > ev.start);\n\n      if (!ocupado) {\n        slotsLivres.push({\n          day: dia.day,\n          start: current.toLocaleString(\"sv-SE\", { timeZone: tz }).replace(\" \", \"T\") + \":00.000Z\",\n          end:   next.toLocaleString(\"sv-SE\",   { timeZone: tz }).replace(\" \", \"T\") + \":00.000Z\",\n        });\n      }\n\n      current = next;\n    }\n  }\n}\n\nreturn slotsLivres;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[880,1056],"id":"807a458f-b740-4cd1-b796-bd0c7c704f23","name":"Slots Disponiveis"},{"parameters":{"operation":"getAll","calendar":{"__rl":true,"value":"luizakrum@gmail.com","mode":"list","cachedResultName":"luizakrum@gmail.com"},"returnAll":true,"timeMax":"={{ $now.plus({ week: 2 }) }}","options":{}},"type":"n8n-nodes-base.googleCalendar","typeVersion":1.3,"position":[672,1056],"id":"2744591b-6826-4b4f-b62a-6e7d9e33aac5","name":"Listar Eventos","credentials":{"googleCalendarOAuth2Api":{"id":"iXoqyD421T6fmy1X","name":"Google Calendar account"}}},{"parameters":{"jsCode":"// === Pega a agenda (objeto único) ===\nconst agenda = $node[\"Definir Agenda\"].json;\n\n// === Pega todos os eventos (array de items) ===\nconst eventosRaw = $items(\"Listar Eventos1\").map(item => item.json);\n\n// Normaliza eventos garantindo timezone coerente\nconst eventos = eventosRaw.map(ev => ({\n  start: new Date(ev.start.dateTime),\n  end: new Date(ev.end.dateTime),\n}));\n\nconst intervaloMin = agenda.timeBetweenMeetingsMinutes;\nconst diasSemana = { DOM: 0, SEG: 1, TER: 2, QUA: 3, QUI: 4, SEX: 5, SAB: 6 };\n\n// TZ e string do dia corrente (YYYY-MM-DD) no fuso da agenda\nconst tz = agenda.timezone || \"America/Sao_Paulo\";\nconst hojeStr = new Date().toLocaleString(\"sv-SE\", { timeZone: tz }).slice(0,10);\n\n// Função auxiliar: próxima data para um dia da semana (pode retornar hoje)\nfunction getProximaData(dia) {\n  const hoje = new Date();\n  let data = new Date(hoje);\n  while (data.getDay() !== diasSemana[dia]) {\n    data.setDate(data.getDate() + 1);\n  }\n  return data;\n}\n\n// === Geração dos slots disponíveis ===\nlet slotsLivres = [];\n\nfor (const dia of agenda.schedule) {\n  if (!dia.available) continue;\n\n  const dataAlvo = getProximaData(dia.day);\n\n  // Garante que hours seja sempre array\n  const faixas = Array.isArray(dia.hours) ? dia.hours : [dia.hours];\n\n  for (const faixa of faixas) {\n    const [hIni, mIni] = faixa.after.split(\":\").map(Number);\n    const [hFim, mFim] = faixa.before.split(\":\").map(Number);\n\n    const inicioDia = new Date(dataAlvo);\n    inicioDia.setHours(hIni, mIni, 0, 0);\n\n    const fimDia = new Date(dataAlvo);\n    fimDia.setHours(hFim, mFim, 0, 0);\n\n    let current = new Date(inicioDia);\n\n    while (current < fimDia) {\n      const next = new Date(current.getTime() + intervaloMin * 60000);\n      if (next > fimDia) break;\n\n      // Exclui qualquer slot do dia corrente (no fuso da agenda)\n      const currentDiaStr = current.toLocaleString(\"sv-SE\", { timeZone: tz }).slice(0,10);\n      if (currentDiaStr === hojeStr) { current = next; continue; }\n\n      // Checa conflito com eventos\n      const ocupado = eventos.some(ev => current < ev.end && next > ev.start);\n\n      if (!ocupado) {\n        slotsLivres.push({\n          day: dia.day,\n          start: current.toLocaleString(\"sv-SE\", { timeZone: tz }).replace(\" \", \"T\") + \":00.000Z\",\n          end:   next.toLocaleString(\"sv-SE\",   { timeZone: tz }).replace(\" \", \"T\") + \":00.000Z\",\n        });\n      }\n\n      current = next;\n    }\n  }\n}\n\nreturn slotsLivres;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[880,1456],"id":"37008f81-5923-4083-91f1-8e6f2bea81fd","name":"Slots Disponiveis1"},{"parameters":{"operation":"getAll","calendar":{"__rl":true,"value":"luizakrum@gmail.com","mode":"list","cachedResultName":"luizakrum@gmail.com"},"returnAll":true,"timeMax":"={{ $now.plus({ week: 2 }) }}","options":{}},"type":"n8n-nodes-base.googleCalendar","typeVersion":1.3,"position":[672,1456],"id":"677936f9-b15b-4e57-a547-a70310c8b125","name":"Listar Eventos1","credentials":{"googleCalendarOAuth2Api":{"id":"iXoqyD421T6fmy1X","name":"Google Calendar account"}}},{"parameters":{"jsCode":"// === Pega o 1º item do trigger (se o Code estiver em \"Run Once for All Items\")\nconst input = $items(\"trigger\")[0].json;\n// Se seu Code estiver em \"Run Once for Each Item\", use:\n// const input = $json;\n\nconst { dia, horario, nome, empresa, email, telefone } = input;\n\n// === TZ e \"hoje\" no fuso de SP ===\nconst tz = \"America/Sao_Paulo\";\nconst hojeStr = new Date().toLocaleString(\"sv-SE\", { timeZone: tz }).slice(0, 10); // YYYY-MM-DD\n\n// === Pega a lista de slots disponíveis (array de items) e remove os de hoje ===\n// Os slots já vêm como \"YYYY-MM-DDTHH:MM:SS\" (sem timezone). Use comparação por string.\nconst slots = $items(\"Slots Disponiveis1\")\n  .map(item => item.json)\n  .filter(slot => {\n    const slotDia = String(slot.start).slice(0, 10); // YYYY-MM-DD\n    return slotDia > hojeStr; // exclui o dia corrente\n  });\n\n// Normaliza slot solicitado (yyyy-mm-ddTHH:MM)\nconst solicitadoKey = `${dia}T${horario}`;\n\n// Procura se o slot solicitado está na lista\nconst encontrado = slots.find(slot => {\n  const sKey = String(slot.start).substring(0, 16); // yyyy-mm-ddTHH:MM\n  return sKey === solicitadoKey;\n});\n\n// Garante formato \"YYYY-MM-DDTHH:MM:SS\" (sem timezone)\nfunction toYYYYMMDDTHHMMSS(s) {\n  return String(s).substring(0, 19);\n}\n\nif (encontrado) {\n  return [{\n    json: {\n      status: \"ok\",\n      message: `Horário disponível: ${dia} ${horario}. Pode agendar.`,\n      dados: {\n        nome,\n        empresa,\n        email,\n        telefone,\n        inicio: { dateTime: toYYYYMMDDTHHMMSS(encontrado.start), timeZone: tz },\n        fim:    { dateTime: toYYYYMMDDTHHMMSS(encontrado.end),   timeZone: tz }\n      }\n    }\n  }];\n} else {\n  // Agrupa slots por dia\n  const slotsPorDia = {};\n  for (const slot of slots) {\n    const d = String(slot.start).split(\"T\")[0];\n    (slotsPorDia[d] ||= []).push(slot);\n  }\n  // Ordena slots por horário dentro de cada dia\n  for (const d in slotsPorDia) {\n    slotsPorDia[d].sort((a, b) => new Date(a.start) - new Date(b.start));\n  }\n\n  // Descobre os dias alvo: anterior, mesmo, seguinte\n  const solicitadoDia = dia;\n  const diaAnterior = new Date(`${dia}T00:00:00`);\n  diaAnterior.setDate(diaAnterior.getDate() - 1);\n  const diaSeguinte = new Date(`${dia}T00:00:00`);\n  diaSeguinte.setDate(diaSeguinte.getDate() + 1);\n\n  const prev = diaAnterior.toISOString().split(\"T\")[0];\n  const next = diaSeguinte.toISOString().split(\"T\")[0];\n\n  // Pega no mínimo 2 e no máximo 6 alternativas\n  let alternativas = [\n    ...(slotsPorDia[prev]?.slice(0, 2) || []),\n    ...(slotsPorDia[solicitadoDia]?.slice(0, 2) || []),\n    ...(slotsPorDia[next]?.slice(0, 2) || []),\n  ];\n\n  // Se ainda não tiver 2, expande até 7 dias\n  let offset = 2;\n  while (alternativas.length < 2 && offset <= 7) {\n    const before = new Date(`${dia}T00:00:00`); before.setDate(before.getDate() - offset);\n    const after  = new Date(`${dia}T00:00:00`); after.setDate(after.getDate() + offset);\n    alternativas = [\n      ...alternativas,\n      ...(slotsPorDia[before.toISOString().split(\"T\")[0]]?.slice(0, 2) || []),\n      ...(slotsPorDia[after.toISOString().split(\"T\")[0]]?.slice(0, 2) || []),\n    ];\n    offset++;\n  }\n\n  alternativas = alternativas.slice(0, 6).map(slot => ({\n    inicio: { dateTime: toYYYYMMDDTHHMMSS(slot.start), timeZone: tz },\n    fim:    { dateTime: toYYYYMMDDTHHMMSS(slot.end),   timeZone: tz }\n  }));\n\n  return [{\n    json: {\n      status: \"indisponivel\",\n      message: `O horário ${dia} ${horario} não está disponível.`,\n      alternativas\n    }\n  }];\n}\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1120,1456],"id":"a5972f1a-cddb-443f-a949-e7eb6ceb24fd","name":"Code"},{"parameters":{"inputSource":"jsonExample","jsonExample":"{\n\"type\": \"listarHorarios\",\n\"tema\": \"imersões/club\",\n\"dia\": \"2025-09-10\",\n\"horario\": \"2025-09-10\",\n\"email\": \"usuario@email.com\",\n\"telefone\": \"5511999999999\",\n\"nome\": \"João da Silva\",\n\"empresa\": \"Empresa X\"\n}"},"type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1.1,"position":[-912,816],"id":"a6bb2ec0-a1ce-4f4a-a6eb-a392234da9ab","name":"trigger"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"597f2e89-0383-4155-ab3b-1a26a5037fc0","leftValue":"={{ $json.status }}","rightValue":"indisponivel","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1344,1456],"id":"2ac94f34-4a99-4c38-9d84-645c0dbf6be0","name":"If2"},{"parameters":{"assignments":{"assignments":[{"id":"ad1726fe-95a3-42ab-8b6c-836f7b37668e","name":"status","value":"={{ $json.message }}","type":"string"},{"id":"50e62759-8242-4df9-b4f7-b3891e645ff8","name":"alternativas","value":"={{ $json.alternativas }}","type":"array"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1648,1328],"id":"64891b6f-9d22-4b2d-85be-687361f8a9e1","name":"response"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('trigger').item.json.type }}","rightValue":"listarHorarios","operator":{"type":"string","operation":"equals"},"id":"2d821077-bb35-4636-ac10-7ad6c459876b"}],"combinator":"and"},"renameOutput":true,"outputKey":"listarHorarios"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2c971151-b71a-4f4e-9e2a-222c8047ce1a","leftValue":"={{ $('trigger').item.json.type }}","rightValue":"agendarReuniao","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"agendarReuniao"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"c547c9e1-f130-4390-9088-65fd9282edfc","leftValue":"={{ $('trigger').item.json.type }}","rightValue":"encontrarReuniao","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"encontrarReuniao"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"de18d8e3-b6df-4754-940b-2b534d4e4ce1","leftValue":"={{ $('trigger').item.json.type }}","rightValue":"mudarReuniao","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"mudarReuniao"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4260bfd0-cf2f-4f30-a395-69e4e4bc95be","leftValue":"={{ $('trigger').item.json.type }}","rightValue":"cancelarReuniao","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"cancelarReuniao"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-480,768],"id":"d99d6e0a-c3f6-4d56-be93-688d9873d5f4","name":"Switch2"},{"parameters":{"content":"## Mudar Evento","height":384,"width":1600,"color":2},"type":"n8n-nodes-base.stickyNote","position":[608,1760],"typeVersion":1,"id":"1cd86d2e-1f57-40c2-9696-e374aa739e56","name":"Sticky Note8"},{"parameters":{"operation":"getAll","calendar":{"__rl":true,"value":"luizakrum@gmail.com","mode":"list","cachedResultName":"luizakrum@gmail.com"},"returnAll":true,"timeMax":"={{ $now.plus({ week: 2 }) }}","options":{}},"type":"n8n-nodes-base.googleCalendar","typeVersion":1.3,"position":[672,1904],"id":"571d893b-45b7-4cb7-9c44-daab2b326478","name":"Listar Eventos4","credentials":{"googleCalendarOAuth2Api":{"id":"iXoqyD421T6fmy1X","name":"Google Calendar account"}}},{"parameters":{"jsCode":"// --- Email vindo do node \"trigger\" (flat) ou do próprio item atual como fallback\nconst emailTrigger = String(\n  $node[\"trigger\"]?.json?.email ?? $json?.email ?? \"\"\n).trim().toLowerCase();\n\nif (!emailTrigger) {\n  return [{ json: { error: \"email ausente no trigger\" } }];\n}\n\n// --- Todos os items que chegam neste Code (devem ser os eventos)\nconst items = await $input.all();\n\n// --- Mantém só eventos onde attendees contém o e-mail do trigger\nconst filtrados = items.filter(it => {\n  const attendees = it.json?.attendees;\n  return Array.isArray(attendees) &&\n    attendees.some(a => String(a.email || \"\").trim().toLowerCase() === emailTrigger);\n});\n\n// --- Saída\nreturn filtrados;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[880,1904],"id":"4204555f-d0fd-4930-b21b-18e51d1efbf5","name":"Filtrar Eventos"},{"parameters":{"jsCode":"// Entram aqui os eventos já filtrados (cada item = 1 evento)\nconst items = await $input.all();\n\nif (!items.length) {\n  return [{ json: { mensagem: \"Não encontrei eventos para esse e-mail.\", eventos: [] } }];\n}\n\nconst TZ = \"America/Sao_Paulo\";\n\n// helpers\nconst toDate = (d) => d ? new Date(d) : null;\nconst sameYmd = (a, b) => a.toLocaleString(\"sv-SE\", { timeZone: TZ }).slice(0,10) === b.toLocaleString(\"sv-SE\", { timeZone: TZ }).slice(0,10);\n\n// hoje (SP)\nconst agora = new Date();\nconst hojeSP = new Date(new Date().toLocaleString(\"en-US\", { timeZone: TZ }));\n\n// normaliza -> filtra inválidos -> filtra futuros e não-hoje -> ordena\nconst normalizados = items\n  .map((it) => it.json)\n  .map((ev) => {\n    const start = toDate(ev.start?.dateTime || ev.start);\n    const end   = toDate(ev.end?.dateTime   || ev.end);\n    return { ev, start, end, tz: ev.start?.timeZone || TZ };\n  })\n  .filter(x => x.ev?.id && x.start instanceof Date && !isNaN(x.start))\n  .filter(x => x.start > agora && !sameYmd(x.start, hojeSP))\n  .sort((a, b) => a.start - b.start);\n\nif (!normalizados.length) {\n  return [{ json: { mensagem: \"Não há eventos futuros (exceto hoje).\", eventos: [] } }];\n}\n\nfunction fmtLinha(x, i) {\n  const ev = x.ev;\n  const tz = x.tz;\n  const s = x.start;\n  const e = x.end instanceof Date && !isNaN(x.end) ? x.end : null;\n\n  const dia   = s.toLocaleDateString(\"pt-BR\", { timeZone: tz });\n  const hIni  = s.toLocaleTimeString(\"pt-BR\", { timeZone: tz, hour: \"2-digit\", minute: \"2-digit\" });\n  const hFim  = e ? e.toLocaleTimeString(\"pt-BR\", { timeZone: tz, hour: \"2-digit\", minute: \"2-digit\" }) : null;\n\n  return {\n    numero: i + 1,\n    id: ev.id,\n    assunto: ev.summary || \"Sem título\",\n    dia,\n    horaInicio: hIni,\n    horaFim: hFim,\n    timezone: tz,\n    link: ev.htmlLink || ev.hangoutLink || null,\n  };\n}\n\nconst essenciais = normalizados.map(fmtLinha);\n\n// monta mensagem (limita a 10 linhas para não estourar UI)\nconst linhasMsg = essenciais.slice(0, 10).map(e =>\n  `${e.numero} - ${e.assunto}, ${e.dia}, ${e.horaInicio}${e.horaFim ? \"-\" + e.horaFim : \"\"}, id ${e.id}`\n);\n\nconst mensagem =\n  `Temos os seguintes eventos nesse e-mail:\\n\\n` +\n  linhasMsg.join(\"\\n\") +\n  `\\n\\nMe informe o número do evento que você deseja alterar ou cancelar.`;\n\nreturn [{\n  json: {\n    mensagem,\n    eventos: essenciais,\n    numeroParaId: Object.fromEntries(essenciais.map(e => [String(e.numero), e.id]))\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1088,1904],"id":"07eaab0a-d1c3-481f-a71c-f9f9c83bf495","name":"Response"},{"parameters":{"operation":"update","calendar":{"__rl":true,"mode":"list","value":""},"updateFields":{}},"type":"n8n-nodes-base.googleCalendar","typeVersion":1.3,"position":[672,2336],"id":"714b415d-1e78-4cf5-933d-bb717b88a7e8","name":"Update an event","credentials":{"googleCalendarOAuth2Api":{"id":"iXoqyD421T6fmy1X","name":"Google Calendar account"}},"disabled":true},{"parameters":{"content":"## Reagendar Consulta","height":352,"width":1600,"color":2},"type":"n8n-nodes-base.stickyNote","position":[608,2192],"typeVersion":1,"id":"d37dd8f2-3fe4-4c49-a2dd-6729255a137c","name":"Sticky Note7"},{"parameters":{"content":"## Cancelar Consulta","height":352,"width":1600,"color":3},"type":"n8n-nodes-base.stickyNote","position":[608,2576],"typeVersion":1,"id":"da32b235-4f33-4a5f-a752-666276cac2cd","name":"Sticky Note6"},{"parameters":{"assignments":{"assignments":[{"id":"383df707-d58b-4770-a5d8-aa14b37d6d3d","name":"response","value":"Como você sabe, sou a Emi, uma agente de IA 😊. Ainda não me treinaram para reagendar ou cancelar reuniões por aqui. Pode fazer direto no Google Calendar ou falar com o especialista por e-mail — você consegue sugerir as mudanças por lá. Tenho certeza de que logo, logo chega o meu treinamento pra eu fazer isso por você por aqui!  Quer que eu te ajude com mais alguma coisa agora?","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1296,1904],"id":"a4e60aa9-928c-45d7-9155-9ef3de95a893","name":"response2"},{"parameters":{"resource":"messages-api","instanceName":"social-media-finamob-oficial","remoteJid":"5511992486507","messageText":"Evento criado","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[1904,704],"id":"be4a2104-ef66-445d-82fd-6f771ed55ba7","name":"Enviar texto","credentials":{"evolutionApi":{"id":"4JfTThlwBUF4KuNE","name":"Evolution - social-media-finamob-oficial"}}},{"parameters":{"content":"## Buscar Horarios","height":352,"width":1600,"color":5},"type":"n8n-nodes-base.stickyNote","position":[608,64],"typeVersion":1,"id":"4af69cf8-ce49-49d2-b586-8531c071f6b0","name":"Sticky Note9"},{"parameters":{"content":"## Marcar Consulta","height":432,"width":1600,"color":4},"type":"n8n-nodes-base.stickyNote","position":[608,448],"typeVersion":1,"id":"f8c583ff-5201-42dd-b56f-6734d9d78c68","name":"Sticky Note10"},{"parameters":{"calendar":{"__rl":true,"value":"nicolas.pereira022022@gmail.com","mode":"list","cachedResultName":"nicolas.pereira022022@gmail.com"},"start":"={{ $json.dados.inicio.dateTime }}","end":"={{ $json.dados.fim.dateTime }}","additionalFields":{"attendees":["={{ $json.dados.email }}"],"description":"=whatsapp  {{ $json.dados.nome }}: {{ $json.dados.telefone }}","summary":"=Reunião Finamob com {{ $json.dados.nome }} - {{ $json.dados.empresa }}"}},"type":"n8n-nodes-base.googleCalendar","typeVersion":1.3,"position":[1648,704],"id":"4c214b96-39e9-4cc4-b591-bfc1307f0bfc","name":"agendar consulta","credentials":{"googleCalendarOAuth2Api":{"id":"iXoqyD421T6fmy1X","name":"Google Calendar account"}}},{"parameters":{"jsCode":"// === Pega a agenda (objeto único) ===\nconst agenda = $node[\"Definir Agenda\"].json;\n\n// === Pega todos os eventos (array de items) ===\nconst eventosRaw = $items(\"Listar Eventos2\").map(item => item.json);\n\n// Normaliza eventos garantindo timezone coerente\nconst eventos = eventosRaw.map(ev => ({\n  start: new Date(ev.start.dateTime),\n  end: new Date(ev.end.dateTime),\n}));\n\nconst intervaloMin = agenda.timeBetweenMeetingsMinutes;\nconst diasSemana = { DOM: 0, SEG: 1, TER: 2, QUA: 3, QUI: 4, SEX: 5, SAB: 6 };\n\n// TZ e string do dia corrente (YYYY-MM-DD) no fuso da agenda\nconst tz = agenda.timezone || \"America/Sao_Paulo\";\nconst hojeStr = new Date().toLocaleString(\"sv-SE\", { timeZone: tz }).slice(0,10);\n\n// Função auxiliar: próxima data para um dia da semana (pode retornar hoje)\nfunction getProximaData(dia) {\n  const hoje = new Date();\n  let data = new Date(hoje);\n  while (data.getDay() !== diasSemana[dia]) {\n    data.setDate(data.getDate() + 1);\n  }\n  return data;\n}\n\n// === Geração dos slots disponíveis ===\nlet slotsLivres = [];\n\nfor (const dia of agenda.schedule) {\n  if (!dia.available) continue;\n\n  const dataAlvo = getProximaData(dia.day);\n\n  // Garante que hours seja sempre array\n  const faixas = Array.isArray(dia.hours) ? dia.hours : [dia.hours];\n\n  for (const faixa of faixas) {\n    const [hIni, mIni] = faixa.after.split(\":\").map(Number);\n    const [hFim, mFim] = faixa.before.split(\":\").map(Number);\n\n    const inicioDia = new Date(dataAlvo);\n    inicioDia.setHours(hIni, mIni, 0, 0);\n\n    const fimDia = new Date(dataAlvo);\n    fimDia.setHours(hFim, mFim, 0, 0);\n\n    let current = new Date(inicioDia);\n\n    while (current < fimDia) {\n      const next = new Date(current.getTime() + intervaloMin * 60000);\n      if (next > fimDia) break;\n\n      // Exclui qualquer slot do dia corrente (no fuso da agenda)\n      const currentDiaStr = current.toLocaleString(\"sv-SE\", { timeZone: tz }).slice(0,10);\n      if (currentDiaStr === hojeStr) { current = next; continue; }\n\n      // Checa conflito com eventos\n      const ocupado = eventos.some(ev => current < ev.end && next > ev.start);\n\n      if (!ocupado) {\n        slotsLivres.push({\n          day: dia.day,\n          start: current.toLocaleString(\"sv-SE\", { timeZone: tz }).replace(\" \", \"T\") + \":00.000Z\",\n          end:   next.toLocaleString(\"sv-SE\",   { timeZone: tz }).replace(\" \", \"T\") + \":00.000Z\",\n        });\n      }\n\n      current = next;\n    }\n  }\n}\n\nreturn slotsLivres;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[880,208],"id":"419b042c-ed31-4ee0-b20c-659d6ad2f429","name":"Slots Disponiveis2"},{"parameters":{"operation":"getAll","calendar":{"__rl":true,"value":"nicolas.pereira022022@gmail.com","mode":"list","cachedResultName":"nicolas.pereira022022@gmail.com"},"returnAll":true,"timeMax":"={{ $now.plus({ week: 2 }) }}","options":{}},"type":"n8n-nodes-base.googleCalendar","typeVersion":1.3,"position":[672,208],"id":"2790f205-2ca5-43ba-85d6-9799f6decca7","name":"Listar Eventos2","credentials":{"googleCalendarOAuth2Api":{"id":"iXoqyD421T6fmy1X","name":"Google Calendar account"}}},{"parameters":{"jsCode":"// === Pega a agenda (objeto único) ===\nconst agenda = $node[\"Definir Agenda\"].json;\n\n// === Pega todos os eventos (array de items) ===\nconst eventosRaw = $items(\"Listar Eventos3\").map(item => item.json);\n\n// Normaliza eventos garantindo timezone coerente\nconst eventos = eventosRaw.map(ev => ({\n  start: new Date(ev.start.dateTime),\n  end: new Date(ev.end.dateTime),\n}));\n\nconst intervaloMin = agenda.timeBetweenMeetingsMinutes;\nconst diasSemana = { DOM: 0, SEG: 1, TER: 2, QUA: 3, QUI: 4, SEX: 5, SAB: 6 };\n\n// TZ e string do dia corrente (YYYY-MM-DD) no fuso da agenda\nconst tz = agenda.timezone || \"America/Sao_Paulo\";\nconst hojeStr = new Date().toLocaleString(\"sv-SE\", { timeZone: tz }).slice(0,10);\n\n// Função auxiliar: próxima data para um dia da semana (pode retornar hoje)\nfunction getProximaData(dia) {\n  const hoje = new Date();\n  let data = new Date(hoje);\n  while (data.getDay() !== diasSemana[dia]) {\n    data.setDate(data.getDate() + 1);\n  }\n  return data;\n}\n\n// === Geração dos slots disponíveis ===\nlet slotsLivres = [];\n\nfor (const dia of agenda.schedule) {\n  if (!dia.available) continue;\n\n  const dataAlvo = getProximaData(dia.day);\n\n  // Garante que hours seja sempre array\n  const faixas = Array.isArray(dia.hours) ? dia.hours : [dia.hours];\n\n  for (const faixa of faixas) {\n    const [hIni, mIni] = faixa.after.split(\":\").map(Number);\n    const [hFim, mFim] = faixa.before.split(\":\").map(Number);\n\n    const inicioDia = new Date(dataAlvo);\n    inicioDia.setHours(hIni, mIni, 0, 0);\n\n    const fimDia = new Date(dataAlvo);\n    fimDia.setHours(hFim, mFim, 0, 0);\n\n    let current = new Date(inicioDia);\n\n    while (current < fimDia) {\n      const next = new Date(current.getTime() + intervaloMin * 60000);\n      if (next > fimDia) break;\n\n      // Exclui qualquer slot do dia corrente (no fuso da agenda)\n      const currentDiaStr = current.toLocaleString(\"sv-SE\", { timeZone: tz }).slice(0,10);\n      if (currentDiaStr === hojeStr) { current = next; continue; }\n\n      // Checa conflito com eventos\n      const ocupado = eventos.some(ev => current < ev.end && next > ev.start);\n\n      if (!ocupado) {\n        slotsLivres.push({\n          day: dia.day,\n          start: current.toLocaleString(\"sv-SE\", { timeZone: tz }).replace(\" \", \"T\") + \":00.000Z\",\n          end:   next.toLocaleString(\"sv-SE\",   { timeZone: tz }).replace(\" \", \"T\") + \":00.000Z\",\n        });\n      }\n\n      current = next;\n    }\n  }\n}\n\nreturn slotsLivres;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[880,608],"id":"764edef5-047a-488a-80bd-905e75e968a0","name":"Slots Disponiveis3"},{"parameters":{"operation":"getAll","calendar":{"__rl":true,"value":"nicolas.pereira022022@gmail.com","mode":"list","cachedResultName":"nicolas.pereira022022@gmail.com"},"returnAll":true,"timeMax":"={{ $now.plus({ week: 2 }) }}","options":{}},"type":"n8n-nodes-base.googleCalendar","typeVersion":1.3,"position":[672,608],"id":"7445ead3-5a63-43fc-9c3b-06a4584a9b22","name":"Listar Eventos3","credentials":{"googleCalendarOAuth2Api":{"id":"iXoqyD421T6fmy1X","name":"Google Calendar account"}}},{"parameters":{"jsCode":"// === Pega o 1º item do trigger (se o Code estiver em \"Run Once for All Items\")\nconst input = $items(\"trigger\")[0].json;\n// Se seu Code estiver em \"Run Once for Each Item\", use:\n// const input = $json;\n\nconst { dia, horario, nome, empresa, email, telefone } = input;\n\n// === TZ e \"hoje\" no fuso de SP ===\nconst tz = \"America/Sao_Paulo\";\nconst hojeStr = new Date().toLocaleString(\"sv-SE\", { timeZone: tz }).slice(0, 10); // YYYY-MM-DD\n\n// === Pega a lista de slots disponíveis (array de items) e remove os de hoje ===\n// Os slots já vêm como \"YYYY-MM-DDTHH:MM:SS\" (sem timezone). Use comparação por string.\nconst slots = $items(\"Slots Disponiveis3\")\n  .map(item => item.json)\n  .filter(slot => {\n    const slotDia = String(slot.start).slice(0, 10); // YYYY-MM-DD\n    return slotDia > hojeStr; // exclui o dia corrente\n  });\n\n// Normaliza slot solicitado (yyyy-mm-ddTHH:MM)\nconst solicitadoKey = `${dia}T${horario}`;\n\n// Procura se o slot solicitado está na lista\nconst encontrado = slots.find(slot => {\n  const sKey = String(slot.start).substring(0, 16); // yyyy-mm-ddTHH:MM\n  return sKey === solicitadoKey;\n});\n\n// Garante formato \"YYYY-MM-DDTHH:MM:SS\" (sem timezone)\nfunction toYYYYMMDDTHHMMSS(s) {\n  return String(s).substring(0, 19);\n}\n\nif (encontrado) {\n  return [{\n    json: {\n      status: \"ok\",\n      message: `Horário disponível: ${dia} ${horario}. Pode agendar.`,\n      dados: {\n        nome,\n        empresa,\n        email,\n        telefone,\n        inicio: { dateTime: toYYYYMMDDTHHMMSS(encontrado.start), timeZone: tz },\n        fim:    { dateTime: toYYYYMMDDTHHMMSS(encontrado.end),   timeZone: tz }\n      }\n    }\n  }];\n} else {\n  // Agrupa slots por dia\n  const slotsPorDia = {};\n  for (const slot of slots) {\n    const d = String(slot.start).split(\"T\")[0];\n    (slotsPorDia[d] ||= []).push(slot);\n  }\n  // Ordena slots por horário dentro de cada dia\n  for (const d in slotsPorDia) {\n    slotsPorDia[d].sort((a, b) => new Date(a.start) - new Date(b.start));\n  }\n\n  // Descobre os dias alvo: anterior, mesmo, seguinte\n  const solicitadoDia = dia;\n  const diaAnterior = new Date(`${dia}T00:00:00`);\n  diaAnterior.setDate(diaAnterior.getDate() - 1);\n  const diaSeguinte = new Date(`${dia}T00:00:00`);\n  diaSeguinte.setDate(diaSeguinte.getDate() + 1);\n\n  const prev = diaAnterior.toISOString().split(\"T\")[0];\n  const next = diaSeguinte.toISOString().split(\"T\")[0];\n\n  // Pega no mínimo 2 e no máximo 6 alternativas\n  let alternativas = [\n    ...(slotsPorDia[prev]?.slice(0, 2) || []),\n    ...(slotsPorDia[solicitadoDia]?.slice(0, 2) || []),\n    ...(slotsPorDia[next]?.slice(0, 2) || []),\n  ];\n\n  // Se ainda não tiver 2, expande até 7 dias\n  let offset = 2;\n  while (alternativas.length < 2 && offset <= 7) {\n    const before = new Date(`${dia}T00:00:00`); before.setDate(before.getDate() - offset);\n    const after  = new Date(`${dia}T00:00:00`); after.setDate(after.getDate() + offset);\n    alternativas = [\n      ...alternativas,\n      ...(slotsPorDia[before.toISOString().split(\"T\")[0]]?.slice(0, 2) || []),\n      ...(slotsPorDia[after.toISOString().split(\"T\")[0]]?.slice(0, 2) || []),\n    ];\n    offset++;\n  }\n\n  alternativas = alternativas.slice(0, 6).map(slot => ({\n    inicio: { dateTime: toYYYYMMDDTHHMMSS(slot.start), timeZone: tz },\n    fim:    { dateTime: toYYYYMMDDTHHMMSS(slot.end),   timeZone: tz }\n  }));\n\n  return [{\n    json: {\n      status: \"indisponivel\",\n      message: `O horário ${dia} ${horario} não está disponível.`,\n      alternativas\n    }\n  }];\n}\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1120,608],"id":"8a566269-0ed8-4dd1-bccc-a00fdf83e207","name":"Code1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"597f2e89-0383-4155-ab3b-1a26a5037fc0","leftValue":"={{ $json.status }}","rightValue":"indisponivel","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1344,608],"id":"14481c81-9f23-4197-b578-e78b879b4dcb","name":"If"},{"parameters":{"assignments":{"assignments":[{"id":"ad1726fe-95a3-42ab-8b6c-836f7b37668e","name":"status","value":"={{ $json.message }}","type":"string"},{"id":"50e62759-8242-4df9-b4f7-b3891e645ff8","name":"alternativas","value":"={{ $json.alternativas }}","type":"array"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1648,480],"id":"535baf97-6539-4f06-a0df-5cf7570d71b1","name":"response1"}],"connections":{"Definir Agenda":{"main":[[{"node":"Switch2","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Listar Eventos2","type":"main","index":0}],[{"node":"Listar Eventos3","type":"main","index":0}]]},"agendar consulta1":{"main":[[]]},"Definicao de Agenda":{"main":[[{"node":"Switch","type":"main","index":0}],[{"node":"Switch1","type":"main","index":0}]]},"Switch1":{"main":[[{"node":"Listar Eventos","type":"main","index":0}],[{"node":"Listar Eventos1","type":"main","index":0}]]},"Listar Eventos":{"main":[[{"node":"Slots Disponiveis","type":"main","index":0}]]},"Listar Eventos1":{"main":[[{"node":"Slots Disponiveis1","type":"main","index":0}]]},"Slots Disponiveis1":{"main":[[{"node":"Code","type":"main","index":0}]]},"trigger":{"main":[[{"node":"Definir Agenda","type":"main","index":0}]]},"Code":{"main":[[{"node":"If2","type":"main","index":0}]]},"If2":{"main":[[{"node":"response","type":"main","index":0}],[{"node":"agendar consulta1","type":"main","index":0}]]},"Switch2":{"main":[[{"node":"Definicao de Agenda","type":"main","index":0}],[{"node":"Definicao de Agenda","type":"main","index":0}],[{"node":"Listar Eventos4","type":"main","index":0}],[],[]]},"Listar Eventos4":{"main":[[{"node":"Filtrar Eventos","type":"main","index":0}]]},"Filtrar Eventos":{"main":[[{"node":"Response","type":"main","index":0}]]},"Response":{"main":[[{"node":"response2","type":"main","index":0}]]},"Listar Eventos2":{"main":[[{"node":"Slots Disponiveis2","type":"main","index":0}]]},"Slots Disponiveis3":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Listar Eventos3":{"main":[[{"node":"Slots Disponiveis3","type":"main","index":0}]]},"Code1":{"main":[[{"node":"If","type":"main","index":0}]]},"If":{"main":[[{"node":"response1","type":"main","index":0}],[{"node":"agendar consulta","type":"main","index":0}]]},"agendar consulta":{"main":[[]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"Cem9y3zmcggUQhrp"},"staticData":{"node:Stripe Trigger":{"webhookId":"we_1S45HZRuKlw6o0Hg4nRNx3O2","webhookEvents":["customer.subscription.created"],"webhookSecret":"whsec_u9SDEbFzkZY1tJcmw28bdoOkPw1RIb4p"}},"meta":{"templateCredsSetupCompleted":true},"pinData":{"trigger":[{"json":{"type":"agendarReuniao","tema":"imersões/club","dia":"2025-09-10","horario":"17:00","email":"lucas95_souza@hotmail.com","telefone":"11992486507","nome":"Lucas Andrade","empresa":"MDS"}}]},"versionId":"0447d55c-d40b-4d61-81df-72e5869c03b7","triggerCount":1,"tags":[]}