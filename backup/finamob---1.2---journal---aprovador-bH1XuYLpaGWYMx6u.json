{"createdAt":"2025-10-13T19:35:37.389Z","updatedAt":"2025-10-30T21:18:52.497Z","id":"bH1XuYLpaGWYMx6u","name":"Finamob - 1.2 - Journal - Aprovador","active":true,"isArchived":false,"nodes":[{"parameters":{"content":"# Fluxo de Aprova√ß√£o dos Posts\n\n### Esse fluxo roda sempre que existe uma alteracao no sheets de controle do journal\n### O AI Agent define se aprova ou rejeita um post baseado em sua imagem e se ja foi postado alguma vez um tema similar","height":784,"width":4768,"color":3},"type":"n8n-nodes-base.stickyNote","position":[-304,112],"typeVersion":1,"id":"69e894fa-068a-4d86-8b66-1d0b43d6bf01","name":"Sticky Note13"},{"parameters":{"promptType":"define","text":"=Voc√™ √© respons√°vel por analisar uma not√≠cia com status \"aguardando\" e decidir se ela deve ser \"aprovada\" ou \"reprovada\".\n\nüìú Hist√≥rico de not√≠cias j√° postadas (use para evitar duplicidade; compare por t√≠tulo/legenda/evento):\n{{ $('Code1').item.json.historico }}\n\nüì∞ Not√≠cia para an√°lise:\nID: {{ $('Code1').item.json.noticia_id }}\nT√≠tulo: {{ $('Code1').item.json.titulo }}\nLegenda: {{ $('Code1').item.json.legenda }}\nDescricao da Imagem: {{ $json.content }}\n\nREGRAS:\n1) Duplicidade:\n   - Reprove se falar do MESMO evento j√° postado (mesma decis√£o do Copom, mesmo projeto de lei, mesma a√ß√£o/julgamento, mesma divulga√ß√£o de resultado, etc.).\n   - Ao reprovar por duplicidade, CITE o ID correspondente do hist√≥rico.\n   - N√£o reprovar por tema amplo gen√©rico (ex.: ‚Äújuros‚Äù em abstrato) se n√£o for o mesmo evento.\n\n2) Imagem:\n   - Leia a descricao da imagem recebida e caso nao seja uma boa imagem para fazer a postagem reprove, uma imagem toda preta n√£o √© boa, ent√£o reprove.\n\n3) Relev√¢ncia (mercado imobili√°rio):\n   - Aprove somente se houver liga√ß√£o direta: pre√ßos de im√≥veis, financiamento/cr√©dito/juros que impactem im√≥veis, constru√ß√£o civil, habita√ß√£o, infraestrutura, FIIs, pol√≠ticas/leis do setor.\n   - N√£o aprove economia geral sem conex√£o pr√°tica com im√≥veis.\n\nSA√çDA (JSON PURO, sem texto extra):\n[\n  {\n    \"noticia_id\": \"{{ $('Code1').item.json.noticia_id }}\",\n    \"status\": \"aprovado\" | \"reprovado\",\n    \"justificativa\": \"motivo curto e objetivo; se duplicado, cite o ID original\"\n  }\n]\nREGRAS FINAIS:\n- N√£o altere noticia_id.\n- Retorne SOMENTE o array JSON.\n","options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[896,384],"id":"eec61705-f5af-4b77-968e-74d4a1ee2db2","name":"AI Agent","executeOnce":false},{"parameters":{"documentId":{"__rl":true,"value":"1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0","mode":"list","cachedResultName":"Finamob - Controle Journal","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"status","lookupValue":"aguardando"}]},"combineFilters":"OR","options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[-32,368],"id":"d8f5fc82-3158-4eea-ac35-5eff8990f270","name":"Noticias aguardando aprova√ß√£o","executeOnce":true,"credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}},"onError":"continueRegularOutput"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[896,560],"id":"b2e469f1-087a-4674-b85d-52679ddbd4da","name":"gpt-4.1-mini","credentials":{"openRouterApi":{"id":"o1ywdYlH64cgqSMT","name":"OpenRouter account"}}},{"parameters":{"operation":"update","documentId":{"__rl":true,"value":"1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0","mode":"list","cachedResultName":"Finamob - Controle Journal","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0/edit#gid=0"},"columns":{"mappingMode":"autoMapInputData","value":{},"matchingColumns":["noticia_id"],"schema":[{"id":"noticia_id","displayName":"noticia_id","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"data_processamento","displayName":"data_processamento","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"titulo","displayName":"titulo","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"legenda","displayName":"legenda","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"fonte","displayName":"fonte","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"imagem","displayName":"imagem","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"arquivo_base64","displayName":"arquivo_base64","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"imagem_url","displayName":"imagem_url","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"status","displayName":"status","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"nota","displayName":"nota","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"justificativa","displayName":"justificativa","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"output","displayName":"output","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"row_number","displayName":"row_number","required":false,"defaultMatch":false,"display":true,"type":"number","canBeUsedToMatch":true,"readOnly":true,"removed":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[1472,384],"id":"32bf72b6-aec0-48fa-81c8-6b8dad199948","name":"Atualizar status da noticia","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const raw = $json.output;\nconst parsed = JSON.parse(raw); // Isso vira um array com 1 objeto\n\n// Retorna o primeiro e √∫nico objeto do array\nreturn {\n  json: parsed[0]\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1232,384],"id":"326a3fc5-028b-4bbb-b6db-254469efead6","name":"Code"},{"parameters":{"jsCode":"const items = $input.all();\nif (!items.length) return [];\n\n// Pega o primeiro item que tenha hist√≥rico\nconst histItem = items.find(item => item.json?.historico);\nconst historico = histItem?.json?.historico || '';\n\n// Limita tamanho\nconst hist = historico.length > 15000 ? historico.slice(0, 15000) : historico;\n\n// Filtra apenas itens que s√£o not√≠cias (tem noticia_id)\nconst noticias = items.filter(item => item.json?.noticia_id);\n\n// Se n√£o h√° not√≠cias, retorna vazio\nif (!noticias.length) return [];\n\n// Injeta hist√≥rico\nreturn noticias.map(noticia => ({\n  json: {\n    ...noticia.json,\n    historico: hist\n  }\n}));"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[496,384],"id":"3021a656-60cf-4bc8-aa5f-375cf2436519","name":"Code1"},{"parameters":{"documentId":{"__rl":true,"value":"1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0","mode":"list","cachedResultName":"Finamob - Controle Journal","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"status","lookupValue":"postado"}]},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[-32,560],"id":"8673ac73-4036-42ea-bbc8-5985019dc5e6","name":"Noticias Postadas","executeOnce":true,"credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const DIAS = 3;\nconst corte = new Date(); \ncorte.setDate(corte.getDate() - DIAS);\n\nconsole.log('=== DEBUG HIST√ìRICO ===');\nconsole.log('Data de corte:', corte.toISOString());\n\nfunction parseBR(v){\n  if (!v) return NaN;\n  if (v instanceof Date) return v;\n  const m = String(v).trim().match(/^(\\d{2})\\/(\\d{2})\\/(\\d{4})$/);\n  if (!m) return NaN;\n  const [_, dd, mm, yyyy] = m.map(Number);\n  return new Date(yyyy, mm-1, dd);\n}\n\n// Debug: ver todas as not√≠cias recebidas\nconst todasNoticias = $input.all();\nconsole.log('Total not√≠cias recebidas:', todasNoticias.length);\n\ntodasNoticias.forEach((noticia, index) => {\n  const j = noticia.json || {};\n  console.log(`Noticia ${index}:`, {\n    id: j.noticia_id,\n    status: j.status,\n    data: j.data_processamento || j.data_proce || j.data_proces || j.data,\n    titulo: j.titulo?.substring(0, 50) + '...'\n  });\n});\n\n// filtra √∫ltimos DIAS\nconst recentes = todasNoticias.filter(i => {\n  const j = i.json || {};\n  const raw = j.data_processamento || j.data_proce || j.data_proces || j.data;\n  const d = parseBR(raw);\n  const statusOk = (j.status || '').toLowerCase() === 'postado';\n  const dataOk = d instanceof Date && !isNaN(d) && d >= corte;\n  \n  console.log(`Filtro - ID: ${j.noticia_id}, Status: ${j.status}, Data: ${raw}, DataOK: ${dataOk}, StatusOK: ${statusOk}`);\n  \n  return dataOk && statusOk;\n});\n\nconsole.log('Not√≠cias recentes encontradas:', recentes.length);\n\n// monta string\nlet historico = recentes.map(i => {\n  const j = i.json || {};\n  return `ID:${j.noticia_id} | ${j.titulo || ''} | ${j.legenda || ''}`;\n}).join('\\n');\n\nconsole.log('Hist√≥rico gerado:', historico.substring(0, 200) + '...');\n\n// limita tamanho (evita prompt gigante)\nif (historico.length > 15000) historico = historico.slice(0, 15000);\n\n// Se n√£o h√° hist√≥rico, cria um vazio mas identific√°vel\nif (!historico || historico.trim() === '') {\n  historico = 'Nenhuma not√≠cia postada nos √∫ltimos 3 dias';\n  console.log('Hist√≥rico VAZIO - usando placeholder');\n}\n\n// retorna **um √∫nico item**\nreturn [{ \n  json: { \n    historico,\n    _debug: {\n      total_noticias: todasNoticias.length,\n      noticias_recentes: recentes.length,\n      data_corte: corte.toISOString()\n    }\n  } \n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[144,560],"id":"620c1747-bff8-45cf-9826-41e8972b5ce7","name":"Code2","alwaysOutputData":true},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[304,384],"id":"d6903276-e6ae-4491-b786-6163aa8387ad","name":"Merge"},{"parameters":{"documentId":{"__rl":true,"value":"1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0","mode":"list","cachedResultName":"Finamob - Controle Journal","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Ze1MFqVlu21qakfTTE5ECfAu4iFOoeQMygOCjPW5nek/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"noticia_id","lookupValue":"={{ $json.noticia_id }}"}]},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[1968,368],"id":"150e4b84-9ea4-448f-88b1-c05acabbc01a","name":"Get row(s) in sheet","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"resource":"fileFolder","searchMethod":"query","queryString":"=name = '{{ $json.arquivo_base64 }}' and '1ufp07BeeG2fKZG43W_3Pgb0P5sgGv9sf' in parents and trashed = false\n","limit":1,"filter":{},"options":{}},"type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[2176,368],"id":"a00a2d05-ea5d-4652-97d0-d58a06ba0a83","name":"Search files and folders","credentials":{"googleDriveOAuth2Api":{"id":"ZkmaJh5Y8Zdz8ju7","name":"Google Drive - lucas@getmia.com.br"}}},{"parameters":{"operation":"download","fileId":{"__rl":true,"value":"={{ $json.id }}","mode":"id"},"options":{}},"type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[2384,368],"id":"1f24f15e-26da-4c80-9664-16a2e0450a07","name":"Download file","credentials":{"googleDriveOAuth2Api":{"id":"ZkmaJh5Y8Zdz8ju7","name":"Google Drive - lucas@getmia.com.br"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Executar: Run Once for Each Item\nconst i = $itemIndex;\n\n// 1) Buscar a legenda do Sheets alinhando pelo √≠ndice do item atual\nconst sheetItems = $items('Get row(s) in sheet');   // <- pega TODOS os itens do n√≥\nconst legenda = sheetItems?.[i]?.json?.legenda || '';  // usa o i como itemIndex\n\n// 2) Pegar o .txt baixado do Drive (base64 do ARQUIVO .txt)\nconst txtB64 = $input.item?.binary?.data?.data;\nif (!txtB64) {\n  throw new Error('Bin√°rio do .txt n√£o encontrado no node \"Download file\".');\n}\n\n// 3) .txt (base64) -> texto UTF-8 -> que cont√©m o base64 da IMAGEM\nconst content = Buffer.from(txtB64, 'base64').toString('utf8').trim();\n\n// 4) Se vier em dataURI, remover prefixo e capturar MIME\nconst m = content.match(/^data:([^;]+);base64,(.+)$/i);\nlet mimeType = m ? m[1] : null;\nlet base64 = (m ? m[2] : content).replace(/\\s+/g, ''); // remove quebras/espa√ßos\n\n// 5) Detectar MIME pelos \"magic bytes\" caso n√£o tenha\nconst buf = Buffer.from(base64, 'base64');\nif (!mimeType) {\n  const sig = buf.slice(0, 4).toString('hex');\n  if (sig.startsWith('ffd8ff')) mimeType = 'image/jpeg';\n  else if (sig === '89504e47') mimeType = 'image/png';\n  else if (sig.startsWith('47494638')) mimeType = 'image/gif';\n  else if (sig.startsWith('52494646')) mimeType = 'image/webp';\n  else mimeType = 'application/octet-stream';\n}\n\n// 6) Retornar o que outros n√≥s v√£o usar\nreturn {\n  json: {\n    index: i,\n    legenda,\n    mimeType,\n    base64\n    // Se o seu node de envio exigir com prefixo:\n    // base64WithPrefix: `data:${mimeType};base64,${base64}`\n  }\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2592,368],"id":"046de57c-4d1f-4a5d-8fa3-2dbd0f74c237","name":"Code3"},{"parameters":{"mode":"combine","combineBy":"combineAll","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[3584,352],"id":"d9e22197-edee-48b6-a31a-2571758235d2","name":"Merge1"},{"parameters":{"jsCode":"const COUNTRY = '55';\nconst onlyDigits = s => String(s ?? '').replace(/\\D/g, '').replace(/^0+/, '');\nconst toE164NoPlus = d => d ? (d.startsWith(COUNTRY) ? d : COUNTRY + d) : '';\nconst toJid = e164 => e164 ? `${e164}@s.whatsapp.net` : '';\n\nconst out = [];\nconst seen = new Set();\n\nfor (const { json } of items) {\n  // prioriza o j√° normalizado; cai para o bruto se precisar\n  const rawDigits = onlyDigits(json.phone_e164 || json.phone_raw);\n  if (!rawDigits) continue;\n\n  const e164 = toE164NoPlus(rawDigits); // sem sinal de +\n  if (!e164) continue;\n\n  if (seen.has(e164)) continue;\n  seen.add(e164);\n\n  const firstName = String(json.name || '').trim().split(/\\s+/)[0] || '';\n\n  out.push({\n    json: {\n      ...json,\n      e164,                  // ex: 5511999999999\n      jid: toJid(e164),      // ex: 5511999999999@s.whatsapp.net\n      firstName\n    }\n  });\n}\n\nreturn out;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3360,240],"id":"bebc2240-9366-4b71-99c6-26575fe1da07","name":"Normalizar telefone e criar JID"},{"parameters":{"batchSize":"=1","options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[3856,352],"id":"dfe2c2c5-6903-4e97-8788-f5c06b0f2066","name":"Loop Over Items1"},{"parameters":{"amount":"={{ 3 + Math.floor(Math.random() * 5) }}"},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[4096,368],"id":"7460f4e4-0b3f-4721-a041-3ddd215cff98","name":"Wait","webhookId":"6686e364-432c-466f-ac33-321c79f8a8a1"},{"parameters":{"url":"https://api.stripe.com/v1/subscriptions?status=active&price=price_1S1SraRuKlw6o0HgiTFNxo5L&expand[]=data.customer","authentication":"genericCredentialType","genericAuthType":"httpBasicAuth","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2928,240],"id":"6ffc6ba9-c86e-48b2-a255-30d73dafc3bf","name":"HTTP Request","credentials":{"httpBasicAuth":{"id":"PVN6vyGsqfocZ4rZ","name":"Stripe"}}},{"parameters":{"jsCode":"// items[0].json √© o objeto \"list\" do Stripe com data=[...]\nconst list = items[0].json;\nconst subs = Array.isArray(list?.data) ? list.data : [];\nconst now = Math.floor(Date.now() / 1000);\n\n// Valida√ß√£o estrita de telefone BR -> E.164, sem completar DDD.\n// Aceita: \"+55\" + 10 ou 11 d√≠gitos, ou \"55\" + 10/11 d√≠gitos (sem +).\nfunction toE164StrictBR(raw) {\n  const s = String(raw || '').trim();\n  if (!s) return { e164: '', ok: false, motivo: 'sem_telefone' };\n\n  // \"+55\" + 10/11 d√≠gitos\n  if (/^\\+55\\d{10,11}$/.test(s)) return { e164: s, ok: true, motivo: '' };\n\n  // \"55\" + 10/11 d√≠gitos (sem \"+\")\n  if (/^55\\d{10,11}$/.test(s)) return { e164: `+${s}`, ok: true, motivo: '' };\n\n  // qualquer outra coisa = inv√°lido / possivelmente sem DDD\n  return { e164: '', ok: false, motivo: 'telefone_mal_formatado_ou_sem_ddd' };\n}\n\nconst out = [];\n\nfor (const s of subs) {\n  const c = s.customer || {};\n  const phone_raw = c.phone || c.metadata?.whatsapp || '';\n\n  const { e164: phone_e164, ok: phone_ok, motivo: motivoFone } = toE164StrictBR(phone_raw);\n\n  const status_stripe = s.status || '';\n  const cancel_at     = s.cancel_at || null;\n  const period_end    = s.current_period_end || null;\n  const paid_until    = period_end ? new Date(period_end * 1000).toISOString().slice(0, 10) : '';\n\n  // Ativo no Stripe (sem considerar telefone)\n  const stripeAtivo = (status_stripe === 'active') &&\n                      (!cancel_at) &&\n                      (!period_end || period_end >= now);\n\n  // Deriva√ß√£o do status_final\n  let status_final = 'inativo';\n  let motivo = '';\n\n  if (!phone_raw) {\n    status_final = 'validar';\n    motivo = 'sem_telefone';\n  } else if (!phone_ok) {\n    status_final = 'validar';\n    motivo = motivoFone; // mal formatado / sem DDD\n  } else if (stripeAtivo) {\n    status_final = 'ativo';\n  } else {\n    status_final = 'inativo';\n    motivo = status_stripe !== 'active' ? `status_${status_stripe}` :\n             cancel_at ? 'cancelado_ao_fim_do_ciclo' :\n             (period_end && period_end < now) ? 'periodo_vencido' : '';\n  }\n\n  out.push({\n    json: {\n      name: c.name || '',\n      email: c.email || '',\n      phone_raw,              // exatamente como veio do Stripe\n      phone_e164,             // s√≥ se v√°lido sem \"chute\"\n      stripe_customer_id: c.id || '',\n      stripe_subscription_id: s.id,\n      status_stripe,\n      cancel_at,\n      paid_until,\n      status_final,           // ativo | inativo | validar\n      motivo                  // ajuda a entender por que est√° \"validar\" ou \"inativo\"\n    }\n  });\n}\n\nreturn out;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3136,240],"id":"a5a540e1-bcf4-4e1b-89c1-200c4d2e8cf6","name":"Code4"},{"parameters":{"resource":"messages-api","operation":"send-image","instanceName":"social-media-finamob-oficial","remoteJid":"={{ $json.phone_raw }}","media":"={{ $json.base64 }}","caption":"={{ $json.legenda }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[4272,368],"id":"3b898e75-72b4-40cb-a3ed-fd867a9dfa54","name":"Envio do post - Journal List","credentials":{"evolutionApi":{"id":"4JfTThlwBUF4KuNE","name":"Evolution - social-media-finamob-oficial"}},"onError":"continueRegularOutput"},{"parameters":{"resource":"image","operation":"analyze","modelId":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"GPT-4O-MINI"},"text":"\" Analise as TR√äS imagens fornecidas e para CADA UMA descreva se est√° adequada para post no Instagram.\n\nIMAGEM 1: {{ $json.imagem_url }}\nIMAGEM 2: {{ $json.imagem_url2 }}  \nIMAGEM 3: {{ $json.imagem_url3 }}\n\nPara cada imagem, informe:\n- Est√° clara, n√≠tida, completa e relevante?\n- Ou est√° cortada, vazia, sem sentido ou toda preta?\n\nRetorne a an√°lise de CADA imagem separadamente.Informe se a imagem est√° n√≠tida, completa e relevante, ou se est√° borrada, cortada, vazia, sem sentido ou **toda** preta.\n\nAs vezes vem uma imagem toda escura apenas com legenda, nesses casos pode rejeitar. O importante e analisar a imagem de fundo, todas sempre vem com legenda padrao, porem a imagem de fundo que deve ser avaliada.\n\nFundo totalmente escuro deve ser rejeitado\"","imageUrls":"={{ $json.imagem_url }},{{ $json.imagem_url2 }},{{ $json.imagem_url3 }}","options":{}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[688,384],"id":"1d31d334-33c9-4935-9070-d9f467a1247e","name":"Analyze image","credentials":{"openAiApi":{"id":"GLHn0uXL8dRQAYuS","name":"OpenAi account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"763c93d5-96c1-491e-b9dd-f1e2b7e83637","leftValue":"={{ $json.status }}","rightValue":"reprovado","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1696,384],"id":"a741385b-0254-4201-ad10-aacd2b2dc4b9","name":"Verifica o status da not√≠cia"},{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":30}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-240,464],"id":"4f5b6e7d-95fc-41e4-a577-3409f36ebb15","name":"Schedule Trigger1"}],"connections":{"AI Agent":{"main":[[{"node":"Code","type":"main","index":0}]]},"Noticias aguardando aprova√ß√£o":{"main":[[{"node":"Merge","type":"main","index":0}]]},"gpt-4.1-mini":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"Code":{"main":[[{"node":"Atualizar status da noticia","type":"main","index":0}]]},"Code1":{"main":[[{"node":"Analyze image","type":"main","index":0}]]},"Noticias Postadas":{"main":[[{"node":"Code2","type":"main","index":0}]]},"Code2":{"main":[[{"node":"Merge","type":"main","index":1}]]},"Merge":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Get row(s) in sheet":{"main":[[{"node":"Search files and folders","type":"main","index":0}]]},"Search files and folders":{"main":[[{"node":"Download file","type":"main","index":0}]]},"Download file":{"main":[[{"node":"Code3","type":"main","index":0}]]},"Code3":{"main":[[{"node":"Merge1","type":"main","index":1},{"node":"HTTP Request","type":"main","index":0}]]},"Normalizar telefone e criar JID":{"main":[[{"node":"Merge1","type":"main","index":0}]]},"Loop Over Items1":{"main":[[],[{"node":"Wait","type":"main","index":0}]]},"Merge1":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"Code4","type":"main","index":0}]]},"Code4":{"main":[[{"node":"Normalizar telefone e criar JID","type":"main","index":0}]]},"Wait":{"main":[[{"node":"Envio do post - Journal List","type":"main","index":0}]]},"Envio do post - Journal List":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"Analyze image":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"Atualizar status da noticia":{"main":[[{"node":"Verifica o status da not√≠cia","type":"main","index":0}]]},"Verifica o status da not√≠cia":{"main":[[{"node":"Get row(s) in sheet","type":"main","index":0}]]},"Schedule Trigger1":{"main":[[{"node":"Noticias aguardando aprova√ß√£o","type":"main","index":0},{"node":"Noticias Postadas","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"Cem9y3zmcggUQhrp"},"staticData":{"node:Trigger nova noticia no sheets":{"documentId":"1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0","sheetId":0,"lastRevision":2595,"lastRevisionLink":"https://docs.google.com/spreadsheets/export?id=1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0&revision=2595&exportFormat=xlsx"},"node:Schedule Trigger1":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{"Schedule Trigger1":[{"json":{"timestamp":"2025-10-14T10:16:24.879-03:00","Readable date":"October 14th 2025, 10:16:24 am","Readable time":"10:16:24 am","Day of week":"Tuesday","Year":"2025","Month":"October","Day of month":"14","Hour":"10","Minute":"16","Second":"24","Timezone":"America/Sao_Paulo (UTC-03:00)"}}]},"versionId":"963f64d4-9f9e-43ba-b19f-47769ed3c649","triggerCount":1,"tags":[]}