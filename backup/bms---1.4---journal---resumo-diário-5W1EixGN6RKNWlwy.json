{"createdAt":"2025-09-03T20:27:49.039Z","updatedAt":"2025-10-06T18:36:31.063Z","id":"5W1EixGN6RKNWlwy","name":"BMS - 1.4 - Journal - Resumo Diário","active":false,"isArchived":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"weeks","triggerAtDay":[1,2,3,4,5,6,0],"triggerAtHour":8}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[448,752],"id":"6fb726e5-b458-46c1-9d5e-4cc37435faa6","name":"Schedule Trigger1"},{"parameters":{"documentId":{"__rl":true,"value":"1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA","mode":"list","cachedResultName":"BMS - Controle Journal","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1hqVrO3gl7qnmgBRDNh20zB_VJm7aGigjuJS4rN3S2yA/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"base","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"data_processamento","lookupValue":"={{ $json.data_processamento }}"},{"lookupColumn":"status","lookupValue":"aprovado"}]},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[864,752],"id":"a9d3c3b3-9c67-48a9-9b92-eb167e164e26","name":"Get row(s) in sheet","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}},{"parameters":{"jsCode":"const ontem = new Date();\nontem.setDate(ontem.getDate() - 1);\n\nconst dia = String(ontem.getDate()).padStart(2, '0');\nconst mes = String(ontem.getMonth() + 1).padStart(2, '0');\nconst ano = ontem.getFullYear();\n\nreturn {\n  data_processamento: `${dia}/${mes}/${ano}`\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[656,752],"id":"ff61a681-991f-411b-a956-fdecbf7d2e7d","name":"Code"},{"parameters":{"model":"openai/gpt-4o","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenRouter","typeVersion":1,"position":[1296,976],"id":"4d07fb40-0190-40c8-98be-a5b11d51d2e9","name":"OpenRouter Chat Model1","credentials":{"openRouterApi":{"id":"o1ywdYlH64cgqSMT","name":"OpenRouter account"}}},{"parameters":{"jsCode":"const items = $input.all();\nif (!items.length) {\n  return [{ json: { prompt: \"Nenhuma notícia foi processada.\" } }];\n}\n\nconst data = items[0]?.json?.data_processamento || \"DATA_NÃO_ENCONTRADA\";\n\n// Contexto curto para guiar o modelo (sem ficar gigantesco)\nconst MAX = 500;\nconst cut = s => (s || '').trim().slice(0, MAX);\nconst contexto = items.map(it => `• ${(it.json.titulo||'').trim()}\\n${cut(it.json.legenda)}`).join(\"\\n\\n\");\n\n// Linhas FIXAS (não alterar)\nconst header1 = ``;\nconst header2 = `Segue resumo de notícias do mundo tributário do dia *${data}*:\\n\\n`;\n\nconst prompt = `\nVocê é editor do briefing matinal da BMS Consultoria tributario.\nProduza UMA mensagem concisa, didática e **visual**, com base nas notícias de *${data}*.\nNão liste notícia por notícia. Não inclua links. Não invente fatos.\n\nBASE (referência; não copie literalmente):\n${contexto}\n\nFORMATO EXATO DA SAÍDA (mantenha as linhas fixas e a ordem):\n${header1}${header2}[RESUMO CONECTADO EM BLOCOS]\n- Estruture em **2 a 3 blocos**, cada um com **título em negrito + emoji** \n- Cada bloco deve ter **2 a 3 frases curtas**, explicando *o que aconteceu* e *por que importa para o corretor*.\n- Use **1 emoji no título**. Separe os blocos com uma linha em branco.\n\n*Como isso impacta para o empresário?:*\n\n- Escreva entre 1 e 2 paragrafos sobre como essas noticias impactam a vida do empresario\n\n*Manchetes do dia:*\n- coloque em listas com emoji de 1️⃣,2️⃣, etc..\n\nAdicione um CTA Final: Acrescente exatamente uma linha final, separada por \\n\\n, somos uma consultoria tributaria, entao o CTA tem que ser para quem esta recebendo a mensagem marcar uma agenda com nossos especialistas que ajudamos em uma estrategia tributaria para otimizar seus resultados.\n\nREGRAS:\n- PT-BR, claro e objetivo; sem jargão.\n- Priorize números/dados quando existirem; se faltarem, não invente.\n- Não adicione seções além das especificadas.\n`.trim();\n\nreturn [{ json: { prompt } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1072,752],"id":"0abc2f74-4f39-4733-9b99-2ebf9296984b","name":"Code1"},{"parameters":{"content":"# Fluxo de Envio do Resumo Diário para comunidade Whatsapp\n### Esse fluxo roda todo dia de manhã as 08am\n### Envia um resumo das notícias processadas no dia anterior","height":752,"width":3152,"color":3},"type":"n8n-nodes-base.stickyNote","position":[384,416],"typeVersion":1,"id":"fd9ba954-494f-4b74-a88b-0035d45095a7","name":"Sticky Note15"},{"parameters":{"operation":"download","fileId":{"__rl":true,"value":"1K1BLNdsAoVhCCP-A7Ot7ILaNbRGkQcn1","mode":"id"},"options":{}},"type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[1632,752],"id":"638c2169-af2e-47e1-9a43-94d1123d8c20","name":"Download file","credentials":{"googleDriveOAuth2Api":{"id":"ZkmaJh5Y8Zdz8ju7","name":"Google Drive - lucas@getmia.com.br"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// n8n Code node – pega o base64 do arquivo baixado no \"Download file\"\n\nconst binAll = $input.item.binary || {};\n\n// tenta 'imagem_final', depois 'data', depois a 1ª chave disponível\nconst key =\n  binAll.imagem_final ? 'imagem_final' :\n  (binAll.data ? 'data' : Object.keys(binAll)[0]);\n\nif (!key) throw new Error('Nenhum binário encontrado no item.');\n\nconst bin = binAll[key];\nif (!bin?.data) throw new Error(`Binário na chave \"${key}\" não possui .data.`);\n\n// já vem em base64; não reconverta\nconst base64 = bin.data;\n\nreturn {\n  json: {\n    base64Image: base64,                          // use isto no Evolution (media)\n    mimeType: bin.mimeType || 'application/octet-stream',\n    fileName: bin.fileName || 'arquivo'\n  }\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1808,752],"id":"49fafeef-1a4b-4dac-95fe-0fb016b8ab60","name":"Code2"},{"parameters":{"promptType":"define","text":"={{ $json.prompt }}","options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.1,"position":[1296,752],"id":"8655d03d-2ba0-4c81-9c4f-4628f605b93c","name":"AI Agent1","executeOnce":true,"onError":"continueRegularOutput"},{"parameters":{"mode":"combine","combineBy":"combineAll","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[2656,736],"id":"10d5db9c-65eb-4778-8cf1-143302da09e3","name":"Merge1"},{"parameters":{"jsCode":"const COUNTRY = '55'; // ajuste se tiver outros países\nconst onlyDigits = s => String(s||'').replace(/\\D/g,'').replace(/^0+/, '');\nconst toE164 = d => d.startsWith(COUNTRY) ? d : COUNTRY + d;\n// Se sua instância Evolution usa @c.us, troque abaixo\nconst toJid = e164 => `${e164}@s.whatsapp.net`;\n\nconst out = [];\nconst seen = new Set();\n\nfor (const {json} of items) {\n  const raw = onlyDigits(json.telefone); // aqui corrigi\n  if (!raw) continue;\n\n  const e164 = toE164(raw);\n  if (seen.has(e164)) continue;\n  seen.add(e164);\n\n  const firstName = (json.nome || '').split(' ')[0]; // também padronizei pra minúsculo\n  out.push({ \n    json: { \n      ...json, \n      e164, \n      jid: toJid(e164), \n      firstName \n    } \n  });\n}\n\nreturn out;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2368,576],"id":"d8899101-0e4b-4de4-b2c0-1aad4c409d5b","name":"Normalizar telefone e criar JID"},{"parameters":{"batchSize":"=1","options":{}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[2928,736],"id":"dd093a42-fc40-4979-b089-8709bd5eadc9","name":"Loop Over Items1"},{"parameters":{"amount":"={{ 3 + Math.floor(Math.random() * 5) }}"},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[3168,752],"id":"c651da7a-bd45-4e3d-9700-5d474d4531f3","name":"Wait","webhookId":"a7e671af-8144-4798-8583-bf71e5d6eb03"},{"parameters":{"resource":"messages-api","operation":"send-image","instanceName":"bms-social-media","remoteJid":"={{ $json.jid }}","media":"={{ $json.base64Image }}","caption":"=Oi , {{ $json.nome }} tudo bem?\n\n{{ $('AI Agent1').item.json.output }}\n\nSe não quiser mais receber notícias no seu celular responda essa mensagem com \"opt-out\".","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[3360,752],"id":"7446cf57-01a6-400e-a02f-131190965d14","name":"Envio do Resumo","credentials":{"evolutionApi":{"id":"vy2ySY8uAchmjNnK","name":"bms"}},"onError":"continueRegularOutput"},{"parameters":{"documentId":{"__rl":true,"value":"1IDXSuMzMhUFDCmKkpS9qSfH3UuBKyoOD66M75UYcgSs","mode":"list","cachedResultName":"CRM - BMS","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1IDXSuMzMhUFDCmKkpS9qSfH3UuBKyoOD66M75UYcgSs/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"Página1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1IDXSuMzMhUFDCmKkpS9qSfH3UuBKyoOD66M75UYcgSs/edit#gid=0"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.6,"position":[2128,576],"id":"e0012e68-a20b-4a22-a16e-13dd81820166","name":"Get row(s) in sheet1","credentials":{"googleSheetsOAuth2Api":{"id":"de8CYZ2v6bGWBjAX","name":"Google Sheets - lucas@getmia.com.br"}}}],"connections":{"Schedule Trigger1":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Get row(s) in sheet","type":"main","index":0}]]},"Get row(s) in sheet":{"main":[[{"node":"Code1","type":"main","index":0}]]},"OpenRouter Chat Model1":{"ai_languageModel":[[{"node":"AI Agent1","type":"ai_languageModel","index":0}]]},"Code1":{"main":[[{"node":"AI Agent1","type":"main","index":0}]]},"Download file":{"main":[[{"node":"Code2","type":"main","index":0}]]},"Code2":{"main":[[{"node":"Merge1","type":"main","index":1},{"node":"Get row(s) in sheet1","type":"main","index":0}]]},"AI Agent1":{"main":[[{"node":"Download file","type":"main","index":0}]]},"Merge1":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"Normalizar telefone e criar JID":{"main":[[{"node":"Merge1","type":"main","index":0}]]},"Loop Over Items1":{"main":[[],[{"node":"Wait","type":"main","index":0}]]},"Wait":{"main":[[]]},"Envio do Resumo":{"main":[[{"node":"Loop Over Items1","type":"main","index":0}]]},"Get row(s) in sheet1":{"main":[[{"node":"Normalizar telefone e criar JID","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","executionTimeout":-1,"errorWorkflow":"GbORhS24Rzw7hHlt"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]},"node:Google Sheets Trigger":{"documentId":"1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0","sheetId":0,"lastRevision":271,"lastRevisionLink":"https://docs.google.com/spreadsheets/export?id=1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0&revision=271&exportFormat=xlsx"},"node:Schedule Trigger1":{"recurrenceRules":[]},"node:Trigger nova noticia no sheets":{"documentId":"1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0","sheetId":0,"lastRevision":271,"lastRevisionLink":"https://docs.google.com/spreadsheets/export?id=1fWo0JNzTrseQubx5O31tEJ5Yd4jHKUCGp_9xZMPfec0&revision=271&exportFormat=xlsx"}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"80d87d70-9d6f-4449-84aa-cad6d6d1cef4","triggerCount":1,"tags":[]}